name: Detect unknown terms

on:
  pull_request:
    paths:
      - "_games/**/*.md"

permissions:
  issues: write
  contents: read

jobs:
  detect:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Detect unknown terms
        id: detect
        run: |
          OUTPUT=$(node scripts/detect-unknown-terms.js 2>&1) || true
          
          # Check if unknown terms were found
          if echo "$OUTPUT" | grep -q "⚠️  Found"; then
            echo "has_unknown=true" >> $GITHUB_OUTPUT
            
            # Save report to file
            echo "$OUTPUT" > unknown-terms-report.md
          else
            echo "has_unknown=false" >> $GITHUB_OUTPUT
          fi

      - name: Read report
        if: steps.detect.outputs.has_unknown == 'true'
        id: report
        run: |
          REPORT=$(cat unknown-terms-report.md)
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or update issue
        if: steps.detect.outputs.has_unknown == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const title = `[Review] Unknown terms in PR #${prNumber}`;
            const body = `${{ steps.report.outputs.report }}
            
            ---
            
            **Source PR:** #${prNumber}
            
            **Action Required:**
            - [ ] Review each unknown term
            - [ ] Add approved terms to appropriate YAML files
            - [ ] Update PR with new terms
            - [ ] Re-run validation
            
            **Once approved terms are added, close this issue.**`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['unknown-terms', `pr-${prNumber}`],
            });

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body,
              });
              
              console.log(`Updated issue #${issues.data[0].number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['unknown-terms', `pr-${prNumber}`, 'needs-review'],
              });
              
              console.log(`Created issue #${issue.data.number}`);
              
              // Comment on PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `⚠️ Unknown terms detected. Please review issue #${issue.data.number} to add missing genres/platforms/challenges.`,
              });
            }

      - name: Comment on PR (no unknown terms)
        if: steps.detect.outputs.has_unknown == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: '✅ All genres, platforms, and challenges are recognized.',
            });
