name: Promote Approved Game

on:
  pull_request:
    types: [closed]
    paths:
      - "_queue_games/*.md"

  workflow_dispatch:
    inputs:
      game_id:
        description: "Game ID to promote (filename without .md)"
        required: true
        type: string

concurrency:
  group: promote-game
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  promote-game:
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event.pull_request.merged == true)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to latest origin/main
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin main
          git checkout main
          git reset --hard origin/main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Identify game to promote
        id: identify
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            GAME_ID="${{ inputs.game_id }}"
          else
            GAME_ID=""
            CHANGED_FILES="$(git diff --name-only \
              ${{ github.event.pull_request.base.sha }} \
              ${{ github.event.pull_request.merge_commit_sha }} \
              2>/dev/null || true)"

            echo "Changed files: ${CHANGED_FILES}"

            for file in ${CHANGED_FILES}; do
              if [[ "$file" == _queue_games/*.md ]] && [[ "$file" != *".gitkeep"* ]]; then
                GAME_ID="$(basename "$file" .md)"
                echo "Found queued game: ${GAME_ID}"
                break
              fi
            done
          fi

          if [ -z "${GAME_ID}" ]; then
            echo "::error::No game found to promote"
            exit 1
          fi

          echo "game_id=${GAME_ID}" >> "$GITHUB_OUTPUT"
          echo "Will promote: ${GAME_ID}"

      - name: Check if game file exists in queue
        id: check
        shell: bash
        env:
          GAME_ID: ${{ steps.identify.outputs.game_id }}
        run: |
          set -euo pipefail

          SOURCE="_queue_games/${GAME_ID}.md"

          if [ ! -f "${SOURCE}" ]; then
            echo "::warning::Source file not found: ${SOURCE} (already promoted or removed)"
            echo "exists=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "exists=true" >> "$GITHUB_OUTPUT"

          # Extract game name from front matter
          GAME_NAME="$(grep -m1 '^name:' "${SOURCE}" | sed 's/^name:[[:space:]]*//' | sed 's/^\"//; s/\"$//')"
          echo "game_name=${GAME_NAME}" >> "$GITHUB_OUTPUT"

      - name: Promote game file
        if: steps.check.outputs.exists == 'true'
        shell: bash
        env:
          GAME_ID: ${{ steps.identify.outputs.game_id }}
        run: |
          set -euo pipefail

          SOURCE="_queue_games/${GAME_ID}.md"
          DEST="_games/${GAME_ID}.md"

          echo "Moving ${SOURCE} -> ${DEST}"
          mv "${SOURCE}" "${DEST}"

          # Remove status line entirely (we no longer use it)
          sed -i '/^status:/d' "${DEST}"

          # Remove placeholder body text and reviewer notes blocks, if present
          sed -i '/^---$/,${
            /^Game submitted via form\. Awaiting review\.$/d
            /^<!-- REVIEWER NOTES$/,/^-->$/d
          }' "${DEST}"

          echo "âœ“ Game file promoted"

      - name: Generate game pages
        if: steps.check.outputs.exists == 'true'
        shell: bash
        env:
          GAME_ID: ${{ steps.identify.outputs.game_id }}
        run: |
          set -euo pipefail
          node scripts/generate-game-pages.js --game "${GAME_ID}"
          echo "âœ“ Game pages generated"

      - name: Generate run category pages
        if: steps.check.outputs.exists == 'true'
        shell: bash
        env:
          GAME_ID: ${{ steps.identify.outputs.game_id }}
        run: |
          set -euo pipefail
          node scripts/generate-run-category-pages.js --game "${GAME_ID}"
          echo "âœ“ Run category pages generated"

      - name: Regenerate CODEOWNERS
        if: steps.check.outputs.exists == 'true'
        shell: bash
        run: |
          set -euo pipefail
          node scripts/generate-codeowners.js
          echo "âœ“ CODEOWNERS updated"

      - name: Get first letter for image path
        if: steps.check.outputs.exists == 'true'
        id: letter
        shell: bash
        env:
          GAME_ID: ${{ steps.identify.outputs.game_id }}
        run: |
          set -euo pipefail
          FIRST_LETTER="$(echo "${GAME_ID}" | cut -c1)"
          echo "first_letter=${FIRST_LETTER}" >> "$GITHUB_OUTPUT"

      - name: Create PR for promotion (required by repo rules)
        if: steps.check.outputs.exists == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: promote-game/${{ steps.identify.outputs.game_id }}
          delete-branch: true
          title: "feat: Promote game ${{ steps.identify.outputs.game_id }}"
          commit-message: "feat: Promote game ${{ steps.identify.outputs.game_id }}"
          body: |
            - Moved `_queue_games/${{ steps.identify.outputs.game_id }}.md` â†’ `_games/${{ steps.identify.outputs.game_id }}.md`
            - Generated pages in `games/${{ steps.identify.outputs.game_id }}/`
            - Updated CODEOWNERS

            Next step:
            - Add a cover image to `assets/img/games/${{ steps.letter.outputs.first_letter }}/`

      - name: Send Discord notification
        if: steps.check.outputs.exists == 'true'
        shell: bash
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GAMES }}
          GAME_ID: ${{ steps.identify.outputs.game_id }}
          GAME_NAME: ${{ steps.check.outputs.game_name }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK}" ]; then
            echo "::notice::DISCORD_WEBHOOK_GAMES is not set; skipping Discord notification."
            exit 0
          fi

          GAME_URL="https://challengerun.net/games/${GAME_ID}/"

          PAYLOAD="$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸŽ® Game promotion PR created: ${GAME_NAME}",
              "description": "A PR was created to promote this game. Once merged, the game will be live.",
              "fields": [
                { "name": "PR", "value": "${PR_URL}", "inline": false },
                { "name": "Game Page (after merge)", "value": "${GAME_URL}", "inline": false }
              ],
              "footer": { "text": "Challenge Run Community" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )"

          curl -fSs -X POST "${DISCORD_WEBHOOK}" \
            -H "Content-Type: application/json" \
            -d "${PAYLOAD}"

          echo "âœ“ Discord notification sent"

      - name: Summary
        if: steps.check.outputs.exists == 'true'
        shell: bash
        env:
          GAME_ID: ${{ steps.identify.outputs.game_id }}
          GAME_NAME: ${{ steps.check.outputs.game_name }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
        run: |
          {
            echo "## Promotion PR created ðŸŽ®"
            echo ""
            echo "**Game:** ${GAME_NAME}"
            echo "**Game ID:** \`${GAME_ID}\`"
            echo ""
            echo "**PR:** ${PR_URL}"
            echo ""
            echo "After the PR merges, the game will be promoted on main."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Skip message
        if: steps.check.outputs.exists != 'true'
        shell: bash
        run: |
          {
            echo "## Skipped - Game already promoted"
            echo ""
            echo "The game file was not found in \`_queue_games/\`."
          } >> "$GITHUB_STEP_SUMMARY"
