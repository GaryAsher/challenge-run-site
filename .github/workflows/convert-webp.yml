name: Convert Images to WebP

on:
  push:
    paths:
      - "assets/img/**/*.jpg"
      - "assets/img/**/*.jpeg"
      - "assets/img/**/*.png"
  workflow_dispatch:
    inputs:
      convert_all:
        description: "Convert ALL existing JPG/PNG files (not just new ones)"
        required: false
        type: boolean
        default: true

concurrency:
  group: webp-conversion
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install WebP tools
        run: sudo apt-get update && sudo apt-get install -y webp

      - name: Convert images to WebP
        id: convert
        run: |
          set -euo pipefail
          
          converted=0
          total_saved=0
          
          # Determine which files to process
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.convert_all }}" = "true" ]; then
            echo "Mode: Converting ALL existing JPG/PNG files"
            FILES=$(find assets/img -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | sort)
          else
            echo "Mode: Converting only changed files from this push"
            FILES=$(git diff --name-only HEAD~1 HEAD -- 'assets/img/**/*.jpg' 'assets/img/**/*.jpeg' 'assets/img/**/*.png' 2>/dev/null || true)
          fi
          
          if [ -z "$FILES" ]; then
            echo "No image files to convert."
            echo "converted=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          for src in $FILES; do
            # Skip if file doesn't exist (may have been deleted)
            [ -f "$src" ] || continue
            
            # Skip placeholder files (< 100 bytes)
            size=$(stat -c%s "$src")
            if [ "$size" -lt 100 ]; then
              echo "SKIP (placeholder): $src ($size bytes)"
              continue
            fi
            
            # Convert to WebP
            webp_path="${src%.*}.webp"
            cwebp -q 80 "$src" -o "$webp_path" 2>/dev/null
            
            new_size=$(stat -c%s "$webp_path")
            saved=$((size - new_size))
            echo "CONVERTED: $src → $webp_path (${size}B → ${new_size}B, saved ${saved}B)"
            
            # Update all references in source files
            grep -rl "$src" \
              --include="*.html" --include="*.md" --include="*.yml" --include="*.yaml" \
              --include="*.scss" --include="*.css" --include="*.js" \
              . 2>/dev/null | while read -r file; do
              sed -i "s|$src|$webp_path|g" "$file"
              echo "  ↳ Updated ref in: $file"
            done || true
            
            # Remove original
            rm "$src"
            
            converted=$((converted + 1))
            total_saved=$((total_saved + saved))
          done
          
          echo "converted=$converted" >> "$GITHUB_OUTPUT"
          echo "total_saved=$total_saved" >> "$GITHUB_OUTPUT"
          echo ""
          echo "=== Summary ==="
          echo "Converted: $converted files"
          echo "Total saved: $total_saved bytes"

      - name: Create Pull Request
        if: steps.convert.outputs.converted != '0'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: convert ${{ steps.convert.outputs.converted }} image(s) to WebP"
          branch: auto/webp-conversion
          delete-branch: true
          title: "chore: convert ${{ steps.convert.outputs.converted }} image(s) to WebP"
          body: |
            Automated WebP conversion.

            **Converted:** ${{ steps.convert.outputs.converted }} file(s)
            **Saved:** ~${{ steps.convert.outputs.total_saved }} bytes

            All references in HTML, MD, YML, SCSS, CSS, and JS files have been updated.
          labels: automated

      - name: Summary
        run: |
          echo "## WebP Conversion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.convert.outputs.converted }}" = "0" ]; then
            echo "No images needed conversion." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Converted:** ${{ steps.convert.outputs.converted }} files" >> $GITHUB_STEP_SUMMARY
            echo "**Saved:** ~${{ steps.convert.outputs.total_saved }} bytes" >> $GITHUB_STEP_SUMMARY
          fi
