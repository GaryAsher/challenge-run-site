name: Check for Duplicate Game

on:
  pull_request:
    types: [opened]
    paths:
      - '_queue_games/*.md'

permissions:
  pull-requests: write
  contents: read

jobs:
  check-duplicate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for existing game
        id: check
        run: |
          # Get list of new files in this PR
          NEW_FILES=$(git diff --name-only --diff-filter=A origin/main...HEAD -- '_queue_games/*.md' 2>/dev/null || echo "")
          
          echo "New queue files: ${NEW_FILES}"
          
          DUPLICATES=""
          SIMILAR=""
          
          for file in ${NEW_FILES}; do
            if [ -f "$file" ]; then
              # Extract game_id from the new file
              GAME_ID=$(grep -m1 "^game_id:" "$file" | sed 's/game_id: *//' | tr -d '"' | tr -d "'")
              GAME_NAME=$(grep -m1 "^name:" "$file" | sed 's/name: *//' | tr -d '"' | tr -d "'")
              
              echo "Checking: ${GAME_ID} (${GAME_NAME})"
              
              # Check if exact game_id exists in _games/
              if [ -f "_games/${GAME_ID}.md" ]; then
                DUPLICATES="${DUPLICATES}${GAME_ID} "
                echo "::warning::Duplicate found: ${GAME_ID} already exists in _games/"
              fi
              
              # Check if already in queue (different PR)
              QUEUE_COUNT=$(ls -1 _queue_games/*.md 2>/dev/null | grep -v "$(basename $file)" | wc -l)
              for existing in _queue_games/*.md; do
                if [ "$existing" != "$file" ] && [ -f "$existing" ]; then
                  EXISTING_ID=$(grep -m1 "^game_id:" "$existing" | sed 's/game_id: *//' | tr -d '"' | tr -d "'")
                  if [ "$EXISTING_ID" = "$GAME_ID" ]; then
                    SIMILAR="${SIMILAR}${GAME_ID} (already in queue) "
                  fi
                fi
              done
            fi
          done
          
          echo "duplicates=${DUPLICATES}" >> "$GITHUB_OUTPUT"
          echo "similar=${SIMILAR}" >> "$GITHUB_OUTPUT"
          
          if [ -n "${DUPLICATES}" ]; then
            echo "has_duplicates=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_duplicates=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on PR if duplicate found
        if: steps.check.outputs.has_duplicates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const duplicates = '${{ steps.check.outputs.duplicates }}'.trim();
            const similar = '${{ steps.check.outputs.similar }}'.trim();
            
            let body = `## ⚠️ Potential Duplicate Detected\n\n`;
            
            if (duplicates) {
              body += `**The following game(s) already exist in \`_games/\`:**\n`;
              body += `- ${duplicates.split(' ').filter(Boolean).join('\n- ')}\n\n`;
              body += `### What to do:\n`;
              body += `1. If you want to **update** the existing game, please close this PR and [create a Game Change Request](../../issues/new?template=game-change-request.yml) instead.\n`;
              body += `2. If this is a **different game** with a similar name, please update the \`game_id\` to be unique.\n`;
              body += `3. If the existing game is outdated and needs replacement, a moderator will handle the merge.\n\n`;
            }
            
            if (similar) {
              body += `**Note:** Similar submissions already in queue: ${similar}\n`;
            }
            
            body += `---\n*This is an automated check. A moderator will review this PR.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Add duplicate label if needed
        if: steps.check.outputs.has_duplicates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['potential-duplicate']
            });
