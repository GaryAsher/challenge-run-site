# .github/workflows/new-game-submission.yml

name: Process New Game Submission

"on":
  repository_dispatch:
    types:
      - new-game-submission
  workflow_dispatch:
    inputs:
      game_name:
        description: "Game Name"
        required: true
        type: string
      game_id:
        description: "Game ID (slug)"
        required: false
        type: string
      tags:
        description: "Tags (comma-separated or newline-separated)"
        required: true
        type: string
      categories:
        description: "Categories (comma-separated or newline-separated)"
        required: true
        type: string
      challenges:
        description: "Challenge types (comma-separated or newline-separated)"
        required: true
        type: string
      character_column:
        description: "Enable character column? (true/false)"
        required: false
        default: "false"
        type: string
      character_label:
        description: "Character column label"
        required: false
        default: "Character"
        type: string
      submitter_handle:
        description: "Submitter Discord name or internet handle"
        required: false
        default: ""
        type: string

jobs:
  create-game-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate game file
        id: generate
        shell: bash
        run: |
          set -euo pipefail

          split_list() {
            # Reads a string that may contain commas and/or newlines
            # Outputs one cleaned item per line
            printf '%s' "$1" \
              | tr '\r' '\n' \
              | sed 's/,/\n/g' \
              | sed 's/^[[:space:]]*//; s/[[:space:]]*$//' \
              | sed '/^$/d'
          }

          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            GAME_NAME="${{ github.event.client_payload.game_name }}"
            GAME_ID="${{ github.event.client_payload.game_id }}"
            TAGS="${{ github.event.client_payload.tags }}"
            CATEGORIES="${{ github.event.client_payload.categories }}"
            CHALLENGES="${{ github.event.client_payload.challenges }}"
            CHAR_ENABLED="${{ github.event.client_payload.character_column }}"
            CHAR_LABEL="${{ github.event.client_payload.character_label }}"
            SUBMITTER="${{ github.event.client_payload.submitter_handle }}"
          else
            GAME_NAME="${{ inputs.game_name }}"
            GAME_ID="${{ inputs.game_id }}"
            TAGS="${{ inputs.tags }}"
            CATEGORIES="${{ inputs.categories }}"
            CHALLENGES="${{ inputs.challenges }}"
            CHAR_ENABLED="${{ inputs.character_column }}"
            CHAR_LABEL="${{ inputs.character_label }}"
            SUBMITTER="${{ inputs.submitter_handle }}"
          fi

          if [ -z "${GAME_ID}" ]; then
            GAME_ID="$(echo "$GAME_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g; s/--*/-/g; s/^-//; s/-$//')"
          fi

          FIRST_LETTER="$(echo "$GAME_ID" | cut -c1)"

          mkdir -p _queue_games

          cat > "_queue_games/${GAME_ID}.md" <<EOF
          ---
          layout: game
          game_id: ${GAME_ID}
          reviewers: []
          name: "${GAME_NAME}"
          status: "Pending review - submitted by ${SUBMITTER}"
          tags:
          EOF

          while IFS= read -r tag; do
            [ -n "$tag" ] && echo "  - ${tag}" >> "_queue_games/${GAME_ID}.md"
          done < <(split_list "$TAGS")

          cat >> "_queue_games/${GAME_ID}.md" <<EOF
          cover: /assets/img/games/${FIRST_LETTER}/${GAME_ID}.jpg
          cover_position: center

          tabs:
            overview: true
            runs: true
            history: true
            challenges: true
            guides: true
            resources: true
            rules: true
            forum: false
            extra_1: false
            extra_2: false

          character_column:
            enabled: ${CHAR_ENABLED:-false}
            label: "${CHAR_LABEL:-Character}"

          challenges:
          EOF

          while IFS= read -r ch; do
            [ -n "$ch" ] && echo "  - ${ch}" >> "_queue_games/${GAME_ID}.md"
          done < <(split_list "$CHALLENGES")

          cat >> "_queue_games/${GAME_ID}.md" <<EOF

          categories_data:
          EOF

          while IFS= read -r cat_name; do
            [ -z "$cat_name" ] && continue
            cat_slug="$(echo "$cat_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g; s/--*/-/g; s/^-//; s/-$//')"
            echo "  - slug: ${cat_slug}" >> "_queue_games/${GAME_ID}.md"
            echo "    label: ${cat_name}" >> "_queue_games/${GAME_ID}.md"
          done < <(split_list "$CATEGORIES")

          echo "---" >> "_queue_games/${GAME_ID}.md"
          echo "" >> "_queue_games/${GAME_ID}.md"
          echo "Game submitted via form. Awaiting review." >> "_queue_games/${GAME_ID}.md"

          echo "game_id=${GAME_ID}" >> "$GITHUB_OUTPUT"
          echo "game_name=${GAME_NAME}" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: Add new game - ${{ steps.generate.outputs.game_name }}"
          title: "ðŸŽ® New Game Submission: ${{ steps.generate.outputs.game_name }}"
          body: |
            ## New Game Submission

            **Game:** ${{ steps.generate.outputs.game_name }}
            **Game ID:** ${{ steps.generate.outputs.game_id }}

            ### Checklist for Reviewers
            - [ ] Game name and ID are correct
            - [ ] Tags are appropriate
            - [ ] Categories make sense
            - [ ] Challenge types are valid
            - [ ] Cover image uploaded to `assets/img/games/`
            - [ ] Move file from `_queue_games/` to `_games/`

            ### To Complete This Submission
            1. Upload a cover image (1280x720 recommended)
            2. Move the game file: `mv _queue_games/${{ steps.generate.outputs.game_id }}.md _games/`
            3. Update the status field
            4. Merge this PR

            ---
            *Submitted via Google Form*
          branch: "new-game/${{ steps.generate.outputs.game_id }}"
          delete-branch: true
          labels: |
            new-game
            needs-review

      - name: Notify Discord forum (new game submission PR)
        continue-on-error: true
        if: ${{ steps.cpr.outputs.pull-request-url != '' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          GAME_ID: ${{ steps.generate.outputs.game_id }}
          GAME_NAME: ${{ steps.generate.outputs.game_name }}
        shell: bash
        run: |
          set -euo pipefail

          pr_list="https://github.com/GaryAsher/challenge-run-site/pulls"

          payload="$(python - <<'PY'
          import json, os
          game_name = os.environ.get("GAME_NAME","").strip()
          game_id = os.environ.get("GAME_ID","").strip()
          pr_url = os.environ.get("PR_URL","").strip()
          pr_list = "https://github.com/GaryAsher/challenge-run-site/pulls"

          FORUM_TAG_ID = "1459087089021882561"
          
          data = {
            "thread_name": f"Game submission: {game_name} ({game_id})",
            "content": (
              "ðŸ†• **New game submission PR**\n"
              f"**{game_name}** (`{game_id}`)\n"
              f"PR: {pr_url}\n"
              f"All submissions: <{pr_list}>"
            ),
            "applied_tags": [FORUM_TAG_ID]
          }

          print(json.dumps(data))
          PY
          )"

          curl -sS -X POST "${DISCORD_WEBHOOK_URL}?wait=true" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHubActions-CRC" \
            --data "$payload" \
            --fail-with-body
