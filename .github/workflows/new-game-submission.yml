name: Process New Game Submission

on:
  repository_dispatch:
    types: [new-game-submission]
  workflow_dispatch:
    inputs:
      game_name:
        description: "Game Name"
        required: true
        type: string
      game_id:
        description: "Game ID (slug)"
        required: false
        type: string
      categories:
        description: "Categories (newline separated)"
        required: true
        type: string
      challenges:
        description: "Challenge types (comma separated)"
        required: true
        type: string
      character_column:
        description: "Enable character column? (true/false)"
        required: false
        default: "false"
        type: string
      character_label:
        description: "Character column label"
        required: false
        default: "Character"
        type: string
      submitter_handle:
        description: "Submitter Discord name"
        required: false
        default: ""
        type: string
      credit_requested:
        description: "Credit requested? (true/false)"
        required: false
        default: "false"
        type: string
      details:
        description: "JSON details"
        required: false
        default: "{}"
        type: string

concurrency:
  group: new-game-submission
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  create-game-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate queued game file
        id: generate
        env:
          DETAILS_IN: ${{ github.event.client_payload.details || inputs.details || '{}' }}
          GAME_NAME: ${{ github.event.client_payload.game_name || inputs.game_name }}
          GAME_ID_INPUT: ${{ github.event.client_payload.game_id || inputs.game_id }}
          CATEGORIES: ${{ github.event.client_payload.categories || inputs.categories }}
          CHALLENGES: ${{ github.event.client_payload.challenges || inputs.challenges }}
          CHAR_ENABLED: ${{ github.event.client_payload.character_column || inputs.character_column || 'false' }}
          CHAR_LABEL: ${{ github.event.client_payload.character_label || inputs.character_label || 'Character' }}
          SUBMITTER: ${{ github.event.client_payload.submitter_handle || inputs.submitter_handle }}
          CREDIT_REQUESTED: ${{ github.event.client_payload.credit_requested || inputs.credit_requested || 'false' }}
        run: |
          set -euo pipefail
          
          if [ -z "${GAME_NAME:-}" ]; then 
            echo "::error::GAME_NAME is empty"
            exit 1
          fi
          
          if [ -z "${CATEGORIES:-}" ]; then 
            echo "::error::CATEGORIES is empty"
            exit 1
          fi
          
          if [ -z "${CHALLENGES:-}" ]; then 
            echo "::error::CHALLENGES is empty"
            exit 1
          fi
          
          if [ -z "${GAME_ID_INPUT:-}" ]; then
            GAME_ID=$(echo "${GAME_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g; s/--*/-/g; s/^-//; s/-$//')
          else
            GAME_ID="${GAME_ID_INPUT}"
          fi
          
          if [ -z "${GAME_ID:-}" ]; then 
            echo "::error::GAME_ID resolved to empty"
            exit 1
          fi
          
          FIRST_LETTER=$(echo "${GAME_ID}" | cut -c1)
          
          CHAR_ENABLED=$(echo "${CHAR_ENABLED:-false}" | tr '[:upper:]' '[:lower:]')
          case "${CHAR_ENABLED}" in true|false) ;; *) CHAR_ENABLED="false" ;; esac
          
          CREDIT_REQUESTED=$(echo "${CREDIT_REQUESTED:-false}" | tr '[:upper:]' '[:lower:]')
          case "${CREDIT_REQUESTED}" in true|false) ;; *) CREDIT_REQUESTED="false" ;; esac
          
          mkdir -p _queue_games
          OUT_FILE="_queue_games/${GAME_ID}.md"
          
          if [ -z "${DETAILS_IN:-}" ] || [ "${DETAILS_IN:-}" = "null" ]; then
            DETAILS_IN="{}"
          fi
          
          export GAME_NAME GAME_ID FIRST_LETTER CATEGORIES CHALLENGES
          export CHAR_ENABLED CHAR_LABEL SUBMITTER CREDIT_REQUESTED
          export DETAILS_IN OUT_FILE
          
          python3 scripts/generate-game-file.py
          
          echo "game_id=${GAME_ID}" >> "$GITHUB_OUTPUT"
          echo "game_name=${GAME_NAME}" >> "$GITHUB_OUTPUT"
          echo "first_letter=${FIRST_LETTER}" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: |
            _queue_games/**
          commit-message: "feat: Add new game - ${{ steps.generate.outputs.game_name }}"
          title: "ðŸŽ® New Game Submission: ${{ steps.generate.outputs.game_name }}"
          body: |
            ## New Game Submission

            **Game:** ${{ steps.generate.outputs.game_name }}
            **Game ID:** `${{ steps.generate.outputs.game_id }}`
            **File:** `_queue_games/${{ steps.generate.outputs.game_id }}.md`

            ---

            ### ðŸ“‹ Reviewer Checklist

            - [ ] Verify game info looks correct.
            - [ ] Edit file and add genre tags.
            - [ ] Find game image, compress via https://tinypng.com/, then upload it to  
            `assets/img/games/${{ steps.generate.outputs.first_letter }}/${{ steps.generate.outputs.game_id }}.jpg`

            ---
            *Submitted via Google Form*
          branch: "new-game/${{ steps.generate.outputs.game_id }}-${{ github.run_id }}"
          delete-branch: true
          labels: |
            new-game
            needs-review
