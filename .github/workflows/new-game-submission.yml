name: Process New Game Submission

on:
  repository_dispatch:
    types:
      - new-game-submission
  workflow_dispatch:
    inputs:
      game_name:
        description: "Game Name"
        required: true
        type: string
      game_id:
        description: "Game ID (slug)"
        required: false
        type: string
      tags:
        description: "Tags (comma, semicolon, pipe, or newline separated)"
        required: false
        default: ""
        type: string
      categories:
        description: "Categories (comma, semicolon, pipe, or newline separated)"
        required: true
        type: string
      challenges:
        description: "Challenge types (comma, semicolon, pipe, or newline separated)"
        required: true
        type: string
      character_column:
        description: "Enable character column? (true/false)"
        required: false
        default: "false"
        type: string
      character_label:
        description: "Character column label"
        required: false
        default: "Character"
        type: string
      submitter_handle:
        description: "Submitter Discord name or internet handle"
        required: false
        default: ""
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-game-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate game file
        id: generate
        shell: bash
        run: |
          set -euo pipefail

          split_list() {
            # Accepts commas, semicolons, pipes, and/or newlines.
            # Outputs one cleaned item per line.
            printf '%s' "$1" \
              | tr '\r' '\n' \
              | sed 's/[;,|]/\n/g' \
              | sed 's/^[[:space:]]*//; s/[[:space:]]*$//' \
              | sed '/^$/d'
          }

          yaml_quote() {
            python - <<'PY'
          import sys, json
          s = sys.stdin.read()
          s = s.strip("\n")
          # Emit a YAML-safe double-quoted string
          print(json.dumps(s))
          PY
          }

          # Collect inputs from dispatch vs manual
          DETAILS_JSON="{}"
          CREDIT_REQUESTED="false"

          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            GAME_NAME="${{ github.event.client_payload.game_name }}"
            GAME_ID="${{ github.event.client_payload.game_id }}"
            TAGS="${{ github.event.client_payload.tags }}"
            CATEGORIES="${{ github.event.client_payload.categories }}"
            CHALLENGES="${{ github.event.client_payload.challenges }}"
            CHAR_ENABLED="${{ github.event.client_payload.character_column }}"
            CHAR_LABEL="${{ github.event.client_payload.character_label }}"
            SUBMITTER="${{ github.event.client_payload.submitter_handle }}"
            CREDIT_REQUESTED="${{ github.event.client_payload.credit_requested }}"
            DETAILS_JSON='${{ github.event.client_payload.details }}'
          else
            GAME_NAME="${{ inputs.game_name }}"
            GAME_ID="${{ inputs.game_id }}"
            TAGS="${{ inputs.tags }}"
            CATEGORIES="${{ inputs.categories }}"
            CHALLENGES="${{ inputs.challenges }}"
            CHAR_ENABLED="${{ inputs.character_column }}"
            CHAR_LABEL="${{ inputs.character_label }}"
            SUBMITTER="${{ inputs.submitter_handle }}"
            DETAILS_JSON="{}"
          fi

          if [ -z "${GAME_ID}" ]; then
            GAME_ID="$(echo "$GAME_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g; s/--*/-/g; s/^-//; s/-$//')"
          fi

          FIRST_LETTER="$(echo "$GAME_ID" | cut -c1)"

          # Parse details JSON safely (may be empty string)
          if [ -z "${DETAILS_JSON}" ] || [ "${DETAILS_JSON}" = "null" ]; then
            DETAILS_JSON="{}"
          fi

          DETAILS_OUT="$(python - <<'PY'
          import json, os, sys

          raw = os.environ.get("DETAILS_JSON", "{}")
          try:
            d = json.loads(raw) if raw.strip() else {}
          except Exception:
            d = {}

          def get(k):
            v = d.get(k, "")
            if v is None:
              return ""
            return str(v)

          # Print as KEY=VALUE lines
          keys = [
            "name_aliases",
            "platforms",
            "subcategories",
            "glitch_categories",
            "notable_glitches",
            "glitchless_bans",
            "restrictions",
            "timing_primary",
            "timing_secondary",
            "moderate_interest",
            "feedback",
            "character_options",
          ]

          for k in keys:
            print(f"{k}={get(k)}")
          PY
          )"

          # Load parsed values into variables
          while IFS= read -r line; do
            key="${line%%=*}"
            val="${line#*=}"
            case "$key" in
              name_aliases) ALIASES_RAW="$val" ;;
              platforms) PLATFORMS_RAW="$val" ;;
              subcategories) SUBCATS_RAW="$val" ;;
              glitch_categories) GLITCH_CATS_RAW="$val" ;;
              notable_glitches) NOTABLE_GLITCHES_RAW="$val" ;;
              glitchless_bans) GLITCHLESS_BANS_RAW="$val" ;;
              restrictions) RESTRICTIONS_RAW="$val" ;;
              timing_primary) TIMING_PRIMARY_RAW="$val" ;;
              timing_secondary) TIMING_SECONDARY_RAW="$val" ;;
              moderate_interest) MOD_INTEREST_RAW="$val" ;;
              feedback) FEEDBACK_RAW="$val" ;;
              character_options) CHAR_OPTIONS_RAW="$val" ;;
            esac
          done <<< "$DETAILS_OUT"

          mkdir -p _queue_games

          STATUS_TEXT="Pending review - submitted by ${SUBMITTER}"
          CHAR_LABEL_SAFE="${CHAR_LABEL:-Character}"

          # Start front matter
          {
            echo "---"
            echo "layout: game"
            echo "game_id: ${GAME_ID}"
            echo "reviewers: []"
            echo "name: $(printf '%s' "$GAME_NAME" | yaml_quote)"
            echo "status: $(printf '%s' "$STATUS_TEXT" | yaml_quote)"
            echo "credit_requested: ${CREDIT_REQUESTED:-false}"

            # Aliases
            if [ -n "${ALIASES_RAW:-}" ] && [ -n "$(split_list "$ALIASES_RAW" | head -n 1)" ]; then
              echo "aliases:"
              while IFS= read -r a; do
                [ -n "$a" ] && echo "  - $(printf '%s' "$a" | yaml_quote)"
              done < <(split_list "$ALIASES_RAW")
            fi

            # tags
            if [ -z "$(split_list "$TAGS" | head -n 1)" ]; then
              echo "tags: []"
            else
              echo "tags:"
              while IFS= read -r tag; do
                [ -n "$tag" ] && echo "  - $(printf '%s' "$tag" | yaml_quote)"
              done < <(split_list "$TAGS")
            fi

            # platforms
            if [ -z "$(split_list "${PLATFORMS_RAW:-}" | head -n 1)" ]; then
              echo "platforms: []"
            else
              echo "platforms:"
              while IFS= read -r p; do
                [ -n "$p" ] && echo "  - $(printf '%s' "$p" | yaml_quote)"
              done < <(split_list "${PLATFORMS_RAW:-}")
            fi

            echo "release_year:"
            echo ""

            # glitches_data
            if [ -n "${GLITCH_CATS_RAW:-}" ] && [ -n "$(split_list "$GLITCH_CATS_RAW" | head -n 1)" ]; then
              echo "glitches_data:"
              while IFS= read -r gc; do
                [ -z "$gc" ] && continue
                slug="$(echo "$gc" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g; s/--*/-/g; s/^-//; s/-$//')"
                echo "  - slug: ${slug}"
                echo "    label: $(printf '%s' "$gc" | yaml_quote)"
              done < <(split_list "$GLITCH_CATS_RAW")
            else
              cat <<'EOF'
          # Glitch categories placeholder (reviewers fill this in if applicable)
          glitches_data:
            - slug: unrestricted
              label: Unrestricted
            - slug: glitchless
              label: Glitchless
          EOF
            fi

            # Reviewer notes from form
            if [ -n "${NOTABLE_GLITCHES_RAW:-}" ]; then
              echo "notable_glitches: |"
              while IFS= read -r l; do echo "  ${l}"; done <<< "${NOTABLE_GLITCHES_RAW}"
            fi
            if [ -n "${GLITCHLESS_BANS_RAW:-}" ]; then
              echo "glitchless_bans: |"
              while IFS= read -r l; do echo "  ${l}"; done <<< "${GLITCHLESS_BANS_RAW}"
            fi

            echo ""
            echo "cover: /assets/img/games/${FIRST_LETTER}/${GAME_ID}.jpg"
            echo "cover_position: center"
            echo ""

            cat <<'EOF'
          tabs:
            overview: true
            runs: true
            history: true
            challenges: true
            guides: true
            resources: true
            rules: true
            forum: false
            extra_1: false
            extra_2: false
          EOF

            # Character column
            echo ""
            echo "character_column:"
            echo "  enabled: ${CHAR_ENABLED:-false}"
            echo "  label: $(printf '%s' "$CHAR_LABEL_SAFE" | yaml_quote)"
            if [ "${CHAR_ENABLED:-false}" = "true" ] && [ -n "${CHAR_OPTIONS_RAW:-}" ] && [ -n "$(split_list "$CHAR_OPTIONS_RAW" | head -n 1)" ]; then
              echo "  options:"
              while IFS= read -r opt; do
                [ -n "$opt" ] && echo "    - $(printf '%s' "$opt" | yaml_quote)"
              done < <(split_list "$CHAR_OPTIONS_RAW")
            fi

            # challenges
            echo ""
            echo "challenges:"
            while IFS= read -r ch; do
              [ -n "$ch" ] && echo "  - $(printf '%s' "$ch" | yaml_quote)"
            done < <(split_list "$CHALLENGES")

            # restrictions
            if [ -n "${RESTRICTIONS_RAW:-}" ] && [ -n "$(split_list "$RESTRICTIONS_RAW" | head -n 1)" ]; then
              echo ""
              echo "restrictions:"
              while IFS= read -r r; do
                [ -n "$r" ] && echo "  - $(printf '%s' "$r" | yaml_quote)"
              done < <(split_list "$RESTRICTIONS_RAW")
            fi

            # timing
            if [ -n "${TIMING_PRIMARY_RAW:-}" ] || [ -n "${TIMING_SECONDARY_RAW:-}" ]; then
              echo ""
              echo "timing:"
              [ -n "${TIMING_PRIMARY_RAW:-}" ] && echo "  primary: $(printf '%s' "$TIMING_PRIMARY_RAW" | yaml_quote)"
              [ -n "${TIMING_SECONDARY_RAW:-}" ] && echo "  secondary: $(printf '%s' "$TIMING_SECONDARY_RAW" | yaml_quote)"
            fi

            # categories
            echo ""
            echo "categories_data:"
            while IFS= read -r cat_name; do
              [ -z "$cat_name" ] && continue
              cat_slug="$(echo "$cat_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g; s/--*/-/g; s/^-//; s/-$//')"
              echo "  - slug: ${cat_slug}"
              echo "    label: $(printf '%s' "$cat_name" | yaml_quote)"
            done < <(split_list "$CATEGORIES")

            echo "---"
            echo ""
            echo "Game submitted via form. Awaiting review."
            echo ""
            echo "Reviewer notes:"
            [ -n "${SUBCATS_RAW:-}" ] && echo "- Sub-categories:\n${SUBCATS_RAW}"
            [ -n "${MOD_INTEREST_RAW:-}" ] && echo "- Moderate interest: ${MOD_INTEREST_RAW}"
            [ -n "${FEEDBACK_RAW:-}" ] && echo "- Feedback:\n${FEEDBACK_RAW}"
          } > "_queue_games/${GAME_ID}.md"

          echo "game_id=${GAME_ID}" >> "$GITHUB_OUTPUT"
          echo "game_name=${GAME_NAME}" >> "$GITHUB_OUTPUT"

        env:
          DETAILS_JSON: ${{ github.event.client_payload.details }}

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: Add new game - ${{ steps.generate.outputs.game_name }}"
          title: "ðŸŽ® New Game Submission: ${{ steps.generate.outputs.game_name }}"
          body: |
            ## New Game Submission

            **Game:** ${{ steps.generate.outputs.game_name }}
            **Game ID:** ${{ steps.generate.outputs.game_id }}

            ### Checklist for Reviewers
            - [ ] Game name and ID are correct
            - [ ] Add tags (moderators add genres)
            - [ ] Add platforms
            - [ ] Add release year
            - [ ] Review glitch categories (`glitches_data`) and adjust as needed
            - [ ] Categories make sense
            - [ ] Challenge types are valid
            - [ ] Cover image uploaded to `assets/img/games/`
            - [ ] Move file from `_queue_games/` to `_games/`

            ---
            *Submitted via Google Form*
          branch: "new-game/${{ steps.generate.outputs.game_id }}"
          delete-branch: true
          labels: |
            new-game
            needs-review

      - name: Notify Discord forum (new game submission PR)
        continue-on-error: true
        if: ${{ steps.cpr.outputs.pull-request-url != '' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          GAME_ID: ${{ steps.generate.outputs.game_id }}
          GAME_NAME: ${{ steps.generate.outputs.game_name }}
        shell: bash
        run: |
          set -euo pipefail

          pr_list="https://github.com/GaryAsher/challenge-run-site/pulls"

          payload="$(python - <<'PY'
          import json, os
          game_name = os.environ.get("GAME_NAME","").strip()
          game_id = os.environ.get("GAME_ID","").strip()
          pr_url = os.environ.get("PR_URL","").strip()
          pr_list = "https://github.com/GaryAsher/challenge-run-site/pulls"

          FORUM_TAG_ID = "1459087089021882561"

          data = {
            "thread_name": f"Game submission: {game_name} ({game_id})",
            "content": (
              "ðŸ†• **New game submission PR**\n"
              f"**{game_name}** (`{game_id}`)\n"
              f"PR: {pr_url}\n"
              f"All submissions: <{pr_list}>"
            ),
            "applied_tags": [FORUM_TAG_ID]
          }

          print(json.dumps(data))
          PY
          )"

          curl -sS -X POST "${DISCORD_WEBHOOK_URL}?wait=true" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHubActions-CRC" \
            --data "$payload" \
            --fail-with-body
