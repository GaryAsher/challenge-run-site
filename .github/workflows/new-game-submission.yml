name: Process New Game Submission

on:
  repository_dispatch:
    types: [new-game-submission]
  workflow_dispatch:
    inputs:
      game_name:
        description: "Game Name"
        required: true
        type: string
      game_id:
        description: "Game ID (slug)"
        required: false
        type: string
      tags:
        description: "Tags (comma, semicolon, pipe, or newline separated)"
        required: false
        default: ""
        type: string
      categories:
        description: "Categories (comma, semicolon, pipe, or newline separated)"
        required: true
        type: string
      challenges:
        description: "Challenge types (comma, semicolon, pipe, or newline separated)"
        required: true
        type: string
      character_column:
        description: "Enable character column? (true/false)"
        required: false
        default: "false"
        type: string
      character_label:
        description: "Character column label"
        required: false
        default: "Character"
        type: string
      submitter_handle:
        description: "Submitter Discord name or internet handle"
        required: false
        default: ""
        type: string
      credit_requested:
        description: "Credit requested? (true/false)"
        required: false
        default: "false"
        type: string
      details:
        description: "Optional JSON details (advanced). If blank, defaults to {}"
        required: false
        default: "{}"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-game-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate queued game file
        id: generate
        shell: bash
        env:
          # IMPORTANT: details is already a JSON string coming from Apps Script
          DETAILS_FROM_DISPATCH: ${{ github.event.client_payload.details }}
        run: |
          set -euo pipefail

          split_list() {
            printf '%s' "${1-}" \
              | tr '\r' '\n' \
              | sed 's/[;,|]/\n/g' \
              | sed 's/^[[:space:]]*//; s/[[:space:]]*$//' \
              | sed '/^$/d'
          }

          slugify() {
            printf '%s' "${1-}" \
              | tr '[:upper:]' '[:lower:]' \
              | sed 's/[^a-z0-9]/-/g; s/--*/-/g; s/^-//; s/-$//'
          }

          yaml_quote() {
            python -c 'import json,sys; print(json.dumps(sys.argv[1]))' "${1-}"
          }

          DETAILS_IN="{}"

          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            GAME_NAME="${{ github.event.client_payload.game_name }}"
            GAME_ID="${{ github.event.client_payload.game_id }}"
            TAGS="${{ github.event.client_payload.tags }}"
            CATEGORIES="${{ github.event.client_payload.categories }}"
            CHALLENGES="${{ github.event.client_payload.challenges }}"
            CHAR_ENABLED="${{ github.event.client_payload.character_column }}"
            CHAR_LABEL="${{ github.event.client_payload.character_label }}"
            SUBMITTER="${{ github.event.client_payload.submitter_handle }}"
            CREDIT_REQUESTED="${{ github.event.client_payload.credit_requested }}"
            DETAILS_IN="${DETAILS_FROM_DISPATCH:-}"
          else
            GAME_NAME="${{ inputs.game_name }}"
            GAME_ID="${{ inputs.game_id }}"
            TAGS="${{ inputs.tags }}"
            CATEGORIES="${{ inputs.categories }}"
            CHALLENGES="${{ inputs.challenges }}"
            CHAR_ENABLED="${{ inputs.character_column }}"
            CHAR_LABEL="${{ inputs.character_label }}"
            SUBMITTER="${{ inputs.submitter_handle }}"
            CREDIT_REQUESTED="${{ inputs.credit_requested }}"
            DETAILS_IN="${{ inputs.details }}"
          fi

          if [ -z "${GAME_NAME:-}" ]; then
            echo "ERROR: GAME_NAME is empty"
            exit 1
          fi
          if [ -z "${CATEGORIES:-}" ]; then
            echo "ERROR: CATEGORIES is empty"
            exit 1
          fi
          if [ -z "${CHALLENGES:-}" ]; then
            echo "ERROR: CHALLENGES is empty"
            exit 1
          fi

          CHAR_ENABLED="$(printf '%s' "${CHAR_ENABLED:-false}" | tr '[:upper:]' '[:lower:]')"
          case "${CHAR_ENABLED}" in true|false) ;; *) CHAR_ENABLED="false" ;; esac

          CREDIT_REQUESTED="$(printf '%s' "${CREDIT_REQUESTED:-false}" | tr '[:upper:]' '[:lower:]')"
          case "${CREDIT_REQUESTED}" in true|false) ;; *) CREDIT_REQUESTED="false" ;; esac

          if [ -z "${GAME_ID:-}" ]; then
            GAME_ID="$(slugify "$GAME_NAME")"
          fi
          if [ -z "${GAME_ID:-}" ]; then
            echo "ERROR: GAME_ID resolved to empty"
            exit 1
          fi

          FIRST_LETTER="$(printf '%s' "$GAME_ID" | cut -c1)"

          if [ -z "${DETAILS_IN:-}" ] || [ "${DETAILS_IN:-}" = "null" ]; then
            DETAILS_IN="{}"
          fi

          export DETAILS_IN
          DETAILS_OUT="$(python - <<'PY'
          import json, os
          raw = os.environ.get("DETAILS_IN", "{}")
          try:
            d = json.loads(raw) if raw.strip() else {}
          except Exception:
            d = {}
          def get(k):
            v = d.get(k, "")
            if v is None:
              return ""
            return str(v)
          keys = [
            "name_aliases",
            "subcategories",
            "glitch_categories",
            "glitches_doc",
            "restrictions",
            "timing_primary",
            "timing_secondary",
            "moderate_interest",
            "feedback",
            "character_options",
          ]
          for k in keys:
            print(f"{k}={get(k)}")
          PY
          )"

          NAME_ALIASES_RAW=""
          SUBCATS_RAW=""
          GLITCH_CATS_RAW=""
          GLITCHES_DOC_RAW=""
          RESTRICTIONS_RAW=""
          TIMING_PRIMARY_RAW=""
          TIMING_SECONDARY_RAW=""
          MOD_INTEREST_RAW=""
          FEEDBACK_RAW=""
          CHAR_OPTIONS_RAW=""

          while IFS= read -r line; do
            key="${line%%=*}"
            val="${line#*=}"
            case "$key" in
              name_aliases) NAME_ALIASES_RAW="$val" ;;
              subcategories) SUBCATS_RAW="$val" ;;
              glitch_categories) GLITCH_CATS_RAW="$val" ;;
              glitches_doc) GLITCHES_DOC_RAW="$val" ;;
              restrictions) RESTRICTIONS_RAW="$val" ;;
              timing_primary) TIMING_PRIMARY_RAW="$val" ;;
              timing_secondary) TIMING_SECONDARY_RAW="$val" ;;
              moderate_interest) MOD_INTEREST_RAW="$val" ;;
              feedback) FEEDBACK_RAW="$val" ;;
              character_options) CHAR_OPTIONS_RAW="$val" ;;
            esac
          done <<< "$DETAILS_OUT"

          mkdir -p _queue_games

          STATUS_TEXT="Pending review - submitted by ${SUBMITTER:-}"
          CHAR_LABEL_SAFE="${CHAR_LABEL:-Character}"
          out="_queue_games/${GAME_ID}.md"

          TIMING_METHOD_RAW="${TIMING_PRIMARY_RAW:-}"
          if [ -z "${TIMING_METHOD_RAW}" ]; then
            TIMING_METHOD_RAW="${TIMING_SECONDARY_RAW:-}"
          fi
          TIMING_METHOD_SLUG="$(slugify "${TIMING_METHOD_RAW}")"
          case "${TIMING_METHOD_SLUG}" in
            igt*) TIMING_METHOD="IGT" ;;
            lrt*) TIMING_METHOD="LRT" ;;
            rta*) TIMING_METHOD="RTA" ;;
            *) TIMING_METHOD="RTA" ;;
          esac

          # Build categories_data with optional children from SUBCATS_RAW ("Parent - Child")
          CATEGORIES_YAML="$(python - <<'PY'
          import os, re, json

          def split_list(s):
            s = (s or "").replace("\r\n","\n").replace("\r","\n").strip()
            if not s:
              return []
            if "\n" in s:
              items = [x.strip() for x in s.split("\n")]
            else:
              items = [x.strip() for x in re.split(r"[;,|]", s)]
            return [x for x in items if x]

          def slugify(s):
            s = (s or "").strip().lower()
            s = re.sub(r"[^a-z0-9]+", "-", s)
            s = re.sub(r"-{2,}", "-", s).strip("-")
            return s

          cats_raw = os.environ.get("CATEGORIES","")
          sub_raw = os.environ.get("SUBCATS_RAW","")

          cats = split_list(cats_raw)
          pairs = split_list(sub_raw)

          children_by_parent = {}
          for p in pairs:
            if " - " in p:
              parent, child = p.split(" - ", 1)
            elif "-" in p:
              parent, child = p.split("-", 1)
            else:
              continue
            parent = parent.strip()
            child = child.strip()
            if not parent or not child:
              continue
            children_by_parent.setdefault(parent, []).append(child)

          lines = []
          lines.append("categories_data:")
          for c in cats:
            lines.append(f"  - slug: {slugify(c)}")
            lines.append(f"    label: {json.dumps(c)}")
            kids = children_by_parent.get(c) or []
            if kids:
              lines.append("    children:")
              for k in kids:
                lines.append(f"      - slug: {slugify(k)}")
                lines.append(f"        label: {json.dumps(k)}")

          print("\n".join(lines))
          PY
          )"

          export CATEGORIES SUBCATS_RAW

          {
            echo "---"
            echo "layout: game"
            echo "game_id: ${GAME_ID}"
            echo "reviewers: []"
            echo "name: $(yaml_quote "$GAME_NAME")"
            echo "name_aliases:"
            if [ -n "${NAME_ALIASES_RAW:-}" ] && [ -n "$(split_list "$NAME_ALIASES_RAW" | head -n 1 || true)" ]; then
              while IFS= read -r a; do
                [ -n "$a" ] && echo "  - $(yaml_quote "$a")"
              done < <(split_list "$NAME_ALIASES_RAW")
            else
              echo "  - $(yaml_quote "$GAME_NAME")"
            fi

            echo "status: $(yaml_quote "$STATUS_TEXT")"

            if [ -z "$(split_list "${TAGS:-}" | head -n 1 || true)" ]; then
              echo "tags: []"
            else
              echo "tags:"
              while IFS= read -r tag; do
                [ -n "$tag" ] && echo "  - $(yaml_quote "$(slugify "$tag")")"
              done < <(split_list "$TAGS")
            fi

            echo "platforms: []"
            echo "cover: /assets/img/games/${FIRST_LETTER}/${GAME_ID}.jpg"
            echo "cover_position: center"
            echo ""
            echo "timing_method: ${TIMING_METHOD}"
            echo ""
            echo "tabs:"
            echo "  overview: true"
            echo "  runs: true"
            echo "  history: true"
            echo "  resources: true"
            echo "  forum: true"
            echo "  extra_1: false"
            echo "  extra_2: false"
            echo ""
            echo "character_column:"
            echo "  enabled: ${CHAR_ENABLED}"
            echo "  label: $(yaml_quote "$CHAR_LABEL_SAFE")"

            echo ""
            echo "challenges:"
            while IFS= read -r ch; do
              [ -n "$ch" ] && echo "  - $(yaml_quote "$(slugify "$ch")")"
            done < <(split_list "$CHALLENGES")

            echo ""
            if [ -n "${SUBCATS_RAW:-}" ] && [ -n "$(split_list "$SUBCATS_RAW" | head -n 1 || true)" ]; then
              echo "subcategories:"
              while IFS= read -r sc; do
                [ -n "$sc" ] && echo "  - $(yaml_quote "$sc")"
              done < <(split_list "$SUBCATS_RAW")
            fi

            echo ""
            if [ -n "${GLITCH_CATS_RAW:-}" ] && [ -n "$(split_list "$GLITCH_CATS_RAW" | head -n 1 || true)" ]; then
              echo "glitches_data:"
              while IFS= read -r gc; do
                [ -z "$gc" ] && continue
                echo "  - slug: $(slugify "$gc")"
                echo "    label: $(yaml_quote "$gc")"
              done < <(split_list "$GLITCH_CATS_RAW")
            else
              echo "glitches_data:"
              echo "  - slug: unrestricted"
              echo "    label: $(yaml_quote Unrestricted)"
              echo "  - slug: glitchless"
              echo "    label: $(yaml_quote Glitchless)"
            fi

            echo ""
            if [ -n "${GLITCHES_DOC_RAW:-}" ] && [ -n "$(split_list "$GLITCHES_DOC_RAW" | head -n 1 || true)" ]; then
              echo "glitches_doc: |"
              while IFS= read -r l; do echo "  ${l}"; done < <(split_list "$GLITCHES_DOC_RAW")
            fi

            echo ""
            if [ -n "${RESTRICTIONS_RAW:-}" ] && [ -n "$(split_list "$RESTRICTIONS_RAW" | head -n 1 || true)" ]; then
              echo "restrictions:"
              while IFS= read -r r; do
                [ -n "$r" ] && echo "  - $(yaml_quote "$r")"
              done < <(split_list "$RESTRICTIONS_RAW")
            fi

            echo ""
            printf '%s\n' "$CATEGORIES_YAML"

            echo "---"
          } > "$out"

          echo "WROTE: $out"
          echo "game_id=${GAME_ID}" >> "$GITHUB_OUTPUT"
          echo "game_name=${GAME_NAME}" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: |
            _queue_games/**
          commit-message: "feat: Add new game - ${{ steps.generate.outputs.game_name }}"
          title: "ðŸŽ® New Game Submission: ${{ steps.generate.outputs.game_name }}"
          body: |
            ## New Game Submission

            **Game:** ${{ steps.generate.outputs.game_name }}
            **Game ID:** ${{ steps.generate.outputs.game_id }}

            ### Checklist for Reviewers
            - [ ] Game name and ID are correct
            - [ ] Fill in platforms, year, tags if needed
            - [ ] Confirm timing method
            - [ ] Confirm glitch categories and glitch notes
            - [ ] Confirm categories and subcategories
            - [ ] Confirm challenge IDs (slugified)
            - [ ] Upload cover image to assets/img/games/
            - [ ] Move the game file from _queue_games/ to _games/

            ---
            *Submitted via Google Form*
          branch: "new-game/${{ steps.generate.outputs.game_id }}-${{ github.run_id }}"
          delete-branch: true
          labels: |
            new-game
            needs-review

      - name: Notify Discord forum (new game submission PR)
        continue-on-error: true
        if: ${{ steps.cpr.outputs.pull-request-url != '' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          GAME_ID: ${{ steps.generate.outputs.game_id }}
          GAME_NAME: ${{ steps.generate.outputs.game_name }}
        shell: bash
        run: |
          set -euo pipefail

          pr_list="https://github.com/GaryAsher/challenge-run-site/pulls"

          payload="$(python - <<'PY'
          import json, os
          game_name = os.environ.get("GAME_NAME","").strip()
          game_id = os.environ.get("GAME_ID","").strip()
          pr_url = os.environ.get("PR_URL","").strip()
          pr_list = "https://github.com/GaryAsher/challenge-run-site/pulls"
          FORUM_TAG_ID = "1459087089021882561"

          data = {
            "thread_name": f"Game submission: {game_name} ({game_id})",
            "content": (
              "ðŸ†• **New game submission PR**\n"
              f"**{game_name}** (`{game_id}`)\n"
              f"PR: {pr_url}\n"
              f"All submissions: <{pr_list}>"
            ),
            "applied_tags": [FORUM_TAG_ID]
          }

          print(json.dumps(data))
          PY
          )"

          curl -sS -X POST "${DISCORD_WEBHOOK_URL}?wait=true" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHubActions-CRC" \
            --data "$payload" \
            --fail-with-body
