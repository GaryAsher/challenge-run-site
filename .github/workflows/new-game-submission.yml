name: Process New Game Submission

on:
  repository_dispatch:
    types: [new-game-submission]
  workflow_dispatch:
    inputs:
      game_name:
        description: "Game Name"
        required: true
        type: string
      game_id:
        description: "Game ID (slug)"
        required: false
        type: string
      full_run_categories:
        description: "Full Run Categories (newline separated)"
        required: true
        type: string
      challenges:
        description: "Challenge types for Full Runs (comma separated)"
        required: true
        type: string
      character_column:
        description: "Enable character column? (true/false)"
        required: false
        default: "false"
        type: string
      character_label:
        description: "Character column label"
        required: false
        default: "Character"
        type: string
      is_modded:
        description: "Is this a modded version of another game? (true/false)"
        required: false
        default: "false"
        type: string
      base_game:
        description: "Game ID of the base/parent game (required if is_modded is true)"
        required: false
        default: ""
        type: string
      submitter_handle:
        description: "Submitter Discord name"
        required: false
        default: ""
        type: string
      credit_requested:
        description: "Credit requested? (true/false)"
        required: false
        default: "false"
        type: string
      details:
        description: "JSON details"
        required: false
        default: "{}"
        type: string

concurrency:
  group: new-game-submission
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  create-game-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate queued game file
        id: generate
        env:
          DETAILS_IN: ${{ github.event.client_payload.details || inputs.details || '{}' }}
          GAME_NAME: ${{ github.event.client_payload.game_name || inputs.game_name }}
          GAME_ID_INPUT: ${{ github.event.client_payload.game_id || inputs.game_id }}
          FULL_RUN_CATEGORIES: ${{ github.event.client_payload.full_run_categories || inputs.full_run_categories }}
          CHALLENGES: ${{ github.event.client_payload.challenges || inputs.challenges }}
          CHAR_ENABLED: ${{ github.event.client_payload.character_column || inputs.character_column || 'false' }}
          CHAR_LABEL: ${{ github.event.client_payload.character_label || inputs.character_label || 'Character' }}
          IS_MODDED: ${{ github.event.client_payload.is_modded || inputs.is_modded || 'false' }}
          BASE_GAME: ${{ github.event.client_payload.base_game || inputs.base_game || '' }}
          SUBMITTER: ${{ github.event.client_payload.submitter_handle || inputs.submitter_handle }}
          CREDIT_REQUESTED: ${{ github.event.client_payload.credit_requested || inputs.credit_requested || 'false' }}
        run: |
          set -euo pipefail
          
          if [ -z "${GAME_NAME:-}" ]; then 
            echo "::error::GAME_NAME is empty"
            exit 1
          fi
          
          if [ -z "${FULL_RUN_CATEGORIES:-}" ]; then 
            echo "::error::FULL_RUN_CATEGORIES is empty"
            exit 1
          fi
          
          if [ -z "${CHALLENGES:-}" ]; then 
            echo "::error::CHALLENGES is empty"
            exit 1
          fi
          
          if [ -z "${GAME_ID_INPUT:-}" ]; then
            GAME_ID=$(echo "${GAME_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g; s/--*/-/g; s/^-//; s/-$//')
          else
            GAME_ID="${GAME_ID_INPUT}"
          fi
          
          if [ -z "${GAME_ID:-}" ]; then 
            echo "::error::GAME_ID resolved to empty"
            exit 1
          fi
          
          FIRST_LETTER=$(echo "${GAME_ID}" | cut -c1)
          
          CHAR_ENABLED=$(echo "${CHAR_ENABLED:-false}" | tr '[:upper:]' '[:lower:]')
          case "${CHAR_ENABLED}" in true|false) ;; *) CHAR_ENABLED="false" ;; esac
          
          CREDIT_REQUESTED=$(echo "${CREDIT_REQUESTED:-false}" | tr '[:upper:]' '[:lower:]')
          case "${CREDIT_REQUESTED}" in true|false) ;; *) CREDIT_REQUESTED="false" ;; esac
          
          IS_MODDED=$(echo "${IS_MODDED:-false}" | tr '[:upper:]' '[:lower:]')
          case "${IS_MODDED}" in true|false) ;; *) IS_MODDED="false" ;; esac
          
          if [ "${IS_MODDED}" = "true" ] && [ -z "${BASE_GAME:-}" ]; then
            echo "::error::BASE_GAME is required when IS_MODDED is true"
            exit 1
          fi
          
          mkdir -p _queue_games
          OUT_FILE="_queue_games/${GAME_ID}.md"
          
          if [ -z "${DETAILS_IN:-}" ] || [ "${DETAILS_IN:-}" = "null" ]; then
            DETAILS_IN="{}"
          fi
          
          export GAME_NAME GAME_ID FIRST_LETTER FULL_RUN_CATEGORIES CHALLENGES
          export CHAR_ENABLED CHAR_LABEL IS_MODDED BASE_GAME SUBMITTER CREDIT_REQUESTED
          export DETAILS_IN OUT_FILE
          
          python3 scripts/generate-game-file.py
          
          echo "game_id=${GAME_ID}" >> "$GITHUB_OUTPUT"
          echo "game_name=${GAME_NAME}" >> "$GITHUB_OUTPUT"
          echo "first_letter=${FIRST_LETTER}" >> "$GITHUB_OUTPUT"
          echo "submitter=${SUBMITTER}" >> "$GITHUB_OUTPUT"
          echo "is_modded=${IS_MODDED}" >> "$GITHUB_OUTPUT"
          echo "base_game=${BASE_GAME}" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: |
            _queue_games/**
          commit-message: "feat: Add new game - ${{ steps.generate.outputs.game_name }}"
          title: "ðŸŽ® New Game Submission: ${{ steps.generate.outputs.game_name }}"
          body: |
            ## New Game Submission

            **Game:** ${{ steps.generate.outputs.game_name }}
            **Game ID:** `${{ steps.generate.outputs.game_id }}`
            **File:** `_queue_games/${{ steps.generate.outputs.game_id }}.md`
            **Submitted by:** ${{ steps.generate.outputs.submitter || 'Anonymous' }}
            **Modded:** ${{ steps.generate.outputs.is_modded == 'true' && 'âœ… Yes' || 'No' }}
            ${{ steps.generate.outputs.is_modded == 'true' && format('**Base Game:** `{0}`', steps.generate.outputs.base_game) || '' }}

            ---

            ### ðŸ“‹ Reviewer Checklist

            - [ ] Verify game info looks correct.
            ${{ steps.generate.outputs.is_modded == 'true' && format('- [ ] Verify base game `{0}` exists in `_games/`.', steps.generate.outputs.base_game) || '' }}
            - [ ] Edit file and add genre tags.
            - [ ] Configure Mini-Challenge allowed challenges (if Mini-Challenges exist).
            - [ ] Find game image, compress via https://tinypng.com/, then upload it to  
            `assets/img/games/${{ steps.generate.outputs.first_letter }}/${{ steps.generate.outputs.game_id }}.jpg`

            ---
            *Submitted via Google Form*
          branch: "new-game/${{ steps.generate.outputs.game_id }}-${{ github.run_id }}"
          delete-branch: true
          labels: |
            new-game
            needs-review

      - name: Send Discord Notification
        if: steps.cpr.outputs.pull-request-number
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_NEW_GAME_SUBMISSION }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
          GAME_NAME: ${{ steps.generate.outputs.game_name }}
          GAME_ID: ${{ steps.generate.outputs.game_id }}
          SUBMITTER: ${{ steps.generate.outputs.submitter }}
          IS_MODDED: ${{ steps.generate.outputs.is_modded }}
          BASE_GAME: ${{ steps.generate.outputs.base_game }}
        run: |
          if [ -z "${DISCORD_WEBHOOK:-}" ]; then
            echo "No Discord webhook configured, skipping notification"
            exit 0
          fi
          
          SUBMITTER_TEXT="${SUBMITTER:-Anonymous}"
          
          # Build modded field if applicable
          MODDED_FIELD=""
          if [ "${IS_MODDED}" = "true" ]; then
            MODDED_FIELD=",{\"name\": \"Type\", \"value\": \"ðŸ”§ Modded (base: \`${BASE_GAME}\`)\", \"inline\": true}"
          fi
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ðŸŽ® New Game Submission\",
                \"color\": 5814783,
                \"fields\": [
                  {\"name\": \"Game\", \"value\": \"**${GAME_NAME}**\", \"inline\": true},
                  {\"name\": \"Game ID\", \"value\": \"\`${GAME_ID}\`\", \"inline\": true},
                  {\"name\": \"Submitted by\", \"value\": \"${SUBMITTER_TEXT}\", \"inline\": true}${MODDED_FIELD},
                  {\"name\": \"Review PR\", \"value\": \"[PR #${PR_NUMBER}](${PR_URL})\", \"inline\": false}
                ],
                \"footer\": {\"text\": \"Merge PR to add game â€¢ Close PR to reject\"}
              }]
            }" \
            "$DISCORD_WEBHOOK" || echo "Discord notification failed"

      - name: Summary
        run: |
          echo "## Game Submission Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Game:** ${{ steps.generate.outputs.game_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ steps.cpr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.cpr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
