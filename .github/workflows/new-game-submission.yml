name: Process New Game Submission

on:
  repository_dispatch:
    types: [new-game-submission]
  workflow_dispatch:
    inputs:
      game_name:
        description: "Game Name"
        required: true
        type: string
      game_id:
        description: "Game ID (slug)"
        required: false
        type: string
      tags:
        description: "Tags (comma, semicolon, pipe, or newline separated)"
        required: false
        default: ""
        type: string
      categories:
        description: "Categories (comma, semicolon, pipe, or newline separated)"
        required: true
        type: string
      challenges:
        description: "Challenge types (comma, semicolon, pipe, or newline separated)"
        required: true
        type: string
      character_column:
        description: "Enable character column? (true/false)"
        required: false
        default: "false"
        type: string
      character_label:
        description: "Character column label"
        required: false
        default: "Character"
        type: string
      submitter_handle:
        description: "Submitter Discord name or internet handle"
        required: false
        default: ""
        type: string
      credit_requested:
        description: "Credit requested? (true/false)"
        required: false
        default: "false"
        type: string
      details:
        description: "Optional JSON details (advanced). If blank, defaults to {}"
        required: false
        default: "{}"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-game-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug - Show incoming payload
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "=== INCOMING PAYLOAD DEBUG ==="
          echo "game_name: ${{ github.event.client_payload.game_name }}"
          echo "game_id: ${{ github.event.client_payload.game_id }}"
          echo "categories: ${{ github.event.client_payload.categories }}"
          echo "challenges: ${{ github.event.client_payload.challenges }}"
          echo "character_column: ${{ github.event.client_payload.character_column }}"
          echo "character_label: ${{ github.event.client_payload.character_label }}"
          echo "submitter_handle: ${{ github.event.client_payload.submitter_handle }}"
          echo "credit_requested: ${{ github.event.client_payload.credit_requested }}"
          echo "details (raw): ${{ github.event.client_payload.details }}"
          echo "=== END PAYLOAD DEBUG ==="

      - name: Generate queued game file
        id: generate
        shell: bash
        env:
          DETAILS_FROM_DISPATCH: ${{ github.event.client_payload.details }}
        run: |
          set -euo pipefail

          # =====================================================================
          # HELPER FUNCTIONS
          # =====================================================================
          
          split_list() {
            printf '%s' "${1-}" \
              | tr '\r' '\n' \
              | sed 's/[;,|]/\n/g' \
              | sed 's/^[[:space:]]*//; s/[[:space:]]*$//' \
              | sed '/^$/d'
          }

          slugify() {
            printf '%s' "${1-}" \
              | tr '[:upper:]' '[:lower:]' \
              | sed 's/[^a-z0-9]/-/g; s/--*/-/g; s/^-//; s/-$//'
          }

          yaml_quote() {
            python3 -c 'import json,sys; print(json.dumps(sys.argv[1]))' "${1-}"
          }

          # =====================================================================
          # LOAD INPUTS (dispatch vs workflow_dispatch)
          # =====================================================================
          
          DETAILS_IN="{}"

          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            GAME_NAME="${{ github.event.client_payload.game_name }}"
            GAME_ID="${{ github.event.client_payload.game_id }}"
            TAGS="${{ github.event.client_payload.tags }}"
            CATEGORIES="${{ github.event.client_payload.categories }}"
            CHALLENGES="${{ github.event.client_payload.challenges }}"
            CHAR_ENABLED="${{ github.event.client_payload.character_column }}"
            CHAR_LABEL="${{ github.event.client_payload.character_label }}"
            SUBMITTER="${{ github.event.client_payload.submitter_handle }}"
            CREDIT_REQUESTED="${{ github.event.client_payload.credit_requested }}"
            DETAILS_IN="${DETAILS_FROM_DISPATCH:-}"
          else
            GAME_NAME="${{ inputs.game_name }}"
            GAME_ID="${{ inputs.game_id }}"
            TAGS="${{ inputs.tags }}"
            CATEGORIES="${{ inputs.categories }}"
            CHALLENGES="${{ inputs.challenges }}"
            CHAR_ENABLED="${{ inputs.character_column }}"
            CHAR_LABEL="${{ inputs.character_label }}"
            SUBMITTER="${{ inputs.submitter_handle }}"
            CREDIT_REQUESTED="${{ inputs.credit_requested }}"
            DETAILS_IN="${{ inputs.details }}"
          fi

          # =====================================================================
          # VALIDATION
          # =====================================================================
          
          echo "=== VALIDATION ==="
          
          if [ -z "${GAME_NAME:-}" ]; then 
            echo "::error::GAME_NAME is empty"
            exit 1
          fi
          echo "âœ“ GAME_NAME: ${GAME_NAME}"
          
          if [ -z "${CATEGORIES:-}" ]; then 
            echo "::error::CATEGORIES is empty"
            exit 1
          fi
          echo "âœ“ CATEGORIES: ${CATEGORIES:0:50}..."
          
          if [ -z "${CHALLENGES:-}" ]; then 
            echo "::error::CHALLENGES is empty"
            exit 1
          fi
          echo "âœ“ CHALLENGES: ${CHALLENGES:0:50}..."

          # =====================================================================
          # NORMALIZE INPUTS
          # =====================================================================

          # Normalize booleans
          CHAR_ENABLED="$(printf '%s' "${CHAR_ENABLED:-false}" | tr '[:upper:]' '[:lower:]')"
          case "${CHAR_ENABLED}" in true|false) ;; *) CHAR_ENABLED="false" ;; esac

          CREDIT_REQUESTED="$(printf '%s' "${CREDIT_REQUESTED:-false}" | tr '[:upper:]' '[:lower:]')"
          case "${CREDIT_REQUESTED}" in true|false) ;; *) CREDIT_REQUESTED="false" ;; esac

          # Generate game ID if not provided
          if [ -z "${GAME_ID:-}" ]; then 
            GAME_ID="$(slugify "$GAME_NAME")"
          fi
          
          if [ -z "${GAME_ID:-}" ]; then 
            echo "::error::GAME_ID resolved to empty"
            exit 1
          fi
          
          echo "âœ“ GAME_ID: ${GAME_ID}"
          echo "âœ“ CHAR_ENABLED: ${CHAR_ENABLED}"
          echo "âœ“ CHAR_LABEL: ${CHAR_LABEL:-Character}"

          FIRST_LETTER="$(printf '%s' "$GAME_ID" | cut -c1)"

          # =====================================================================
          # PARSE DETAILS JSON
          # =====================================================================
          
          echo "=== PARSING DETAILS JSON ==="
          
          # Handle empty/null details
          if [ -z "${DETAILS_IN:-}" ] || [ "${DETAILS_IN:-}" = "null" ]; then
            DETAILS_IN="{}"
          fi

          export DETAILS_IN
          DETAILS_OUT="$(python3 - <<'PY'
          import json, os, sys

          raw = os.environ.get("DETAILS_IN", "{}").strip()
          print(f"DEBUG: Raw details input: {raw[:200]}...", file=sys.stderr)

          def load_details(s):
              if not s or s == "null":
                  return {}
              try:
                  obj = json.loads(s)
              except json.JSONDecodeError as e:
                  print(f"DEBUG: JSON parse error: {e}", file=sys.stderr)
                  return {}
              
              # Handle double-encoded JSON
              if isinstance(obj, str):
                  try:
                      obj2 = json.loads(obj)
                      if isinstance(obj2, dict):
                          print("DEBUG: Unwrapped double-encoded JSON", file=sys.stderr)
                          return obj2
                  except:
                      pass
                  return {}
              
              if isinstance(obj, dict):
                  return obj
              return {}

          d = load_details(raw)
          print(f"DEBUG: Parsed {len(d)} fields from details", file=sys.stderr)

          def get(k):
              v = d.get(k, "")
              if v is None:
                  return ""
              return str(v)

          keys = [
              "name_aliases",
              "platforms",
              "subcategories",
              "glitch_categories",
              "glitches_doc",
              "restrictions",
              "timing_primary",
              "timing_secondary",
              "moderate_interest",
              "feedback",
              "character_options",
          ]

          for k in keys:
              val = get(k)
              print(f"{k}={val}")
              if val:
                  print(f"DEBUG: {k} = {val[:50]}...", file=sys.stderr)
          PY
          )"

          # Load parsed values into shell variables
          ALIASES_RAW=""
          PLATFORMS_RAW=""
          SUBCATS_RAW=""
          GLITCH_CATS_RAW=""
          GLITCHES_DOC_RAW=""
          RESTRICTIONS_RAW=""
          TIMING_PRIMARY_RAW=""
          TIMING_SECONDARY_RAW=""
          MOD_INTEREST_RAW=""
          FEEDBACK_RAW=""
          CHAR_OPTIONS_RAW=""

          while IFS= read -r line; do
            key="${line%%=*}"
            val="${line#*=}"
            case "$key" in
              name_aliases) ALIASES_RAW="$val" ;;
              platforms) PLATFORMS_RAW="$val" ;;
              subcategories) SUBCATS_RAW="$val" ;;
              glitch_categories) GLITCH_CATS_RAW="$val" ;;
              glitches_doc) GLITCHES_DOC_RAW="$val" ;;
              restrictions) RESTRICTIONS_RAW="$val" ;;
              timing_primary) TIMING_PRIMARY_RAW="$val" ;;
              timing_secondary) TIMING_SECONDARY_RAW="$val" ;;
              moderate_interest) MOD_INTEREST_RAW="$val" ;;
              feedback) FEEDBACK_RAW="$val" ;;
              character_options) CHAR_OPTIONS_RAW="$val" ;;
            esac
          done <<< "$DETAILS_OUT"

          echo "âœ“ Parsed details fields"

          # =====================================================================
          # BUILD CATEGORIES YAML (with subcategory children)
          # =====================================================================

          mkdir -p _queue_games
          
          STATUS_TEXT="Pending review - submitted by ${SUBMITTER:-anonymous}"
          CHAR_LABEL_SAFE="${CHAR_LABEL:-Character}"

          out="_queue_games/${GAME_ID}.md"

          # Build categories_data YAML with children from subcategories
          export CATEGORIES SUBCATS_RAW
          CATEGORIES_YAML="$(python3 - <<'PY'
          import os, re, json

          def split_list(s):
              s = (s or "").replace("\r\n", "\n").replace("\r", "\n")
              s = re.sub(r"[;,|]", "\n", s)
              out = []
              for line in s.split("\n"):
                  line = line.strip()
                  if line:
                      out.append(line)
              return out

          def slugify(s):
              s = (s or "").strip().lower()
              s = re.sub(r"[^a-z0-9]+", "-", s)
              s = re.sub(r"-+", "-", s).strip("-")
              return s

          cats = split_list(os.environ.get("CATEGORIES", ""))
          rels = split_list(os.environ.get("SUBCATS_RAW", ""))

          # Build parent -> children map
          children = {}
          for r in rels:
              if " - " in r:
                  parent, child = r.split(" - ", 1)
              elif "-" in r:
                  parts = r.split("-", 1)
                  parent, child = parts[0].strip(), parts[1].strip() if len(parts) > 1 else ""
              else:
                  continue
              
              parent = parent.strip()
              child = child.strip()
              
              if parent and child:
                  children.setdefault(parent, []).append((slugify(child), child))

          # Generate YAML
          lines = ["categories_data:"]
          for c in cats:
              cslug = slugify(c)
              lines.append(f"  - slug: {cslug}")
              lines.append(f"    label: {json.dumps(c)}")
              
              kids = children.get(c, [])
              if kids:
                  lines.append("    children:")
                  for kslug, klabel in kids:
                      lines.append(f"      - slug: {kslug}")
                      lines.append(f"        label: {json.dumps(klabel)}")

          print("\n".join(lines))
          PY
          )"

          echo "âœ“ Built categories YAML"

          # =====================================================================
          # GENERATE THE GAME FILE
          # =====================================================================
          
          echo "=== GENERATING ${out} ==="

          {
            echo "---"
            echo "layout: game"
            echo "game_id: ${GAME_ID}"
            echo "reviewers: []"
            echo "name: $(yaml_quote "$GAME_NAME")"

            # name_aliases
            if [ -n "$(split_list "${ALIASES_RAW:-}" | head -n 1 || true)" ]; then
              echo "name_aliases:"
              while IFS= read -r a; do
                [ -n "$a" ] && echo "  - $(yaml_quote "$a")"
              done < <(split_list "$ALIASES_RAW")
            else
              echo "name_aliases: []"
            fi

            echo "status: $(yaml_quote "$STATUS_TEXT")"
            echo ""
            echo "# TODO (Moderators): Add tags, platforms, and upload cover image"
            echo "tags: []"
            echo "platforms: []"
            echo ""
            echo "cover: /assets/img/games/${FIRST_LETTER}/${GAME_ID}.jpg"
            echo "cover_position: center"
            echo ""
            echo "timing_method: $(yaml_quote "${TIMING_PRIMARY_RAW:-RTA}")"
            echo ""
            
            cat <<'TABS_EOF'
          tabs:
            overview: true
            runs: true
            history: true
            resources: true
            forum: true
            extra_1: false
            extra_2: false
          TABS_EOF

            echo ""
            echo "character_column:"
            echo "  enabled: ${CHAR_ENABLED}"
            echo "  label: $(yaml_quote "$CHAR_LABEL_SAFE")"

            # Character options (for reviewer reference)
            if [ "${CHAR_ENABLED}" = "true" ] && [ -n "$(split_list "${CHAR_OPTIONS_RAW:-}" | head -n 1 || true)" ]; then
              echo "  # Submitted options:"
              while IFS= read -r opt; do
                [ -n "$opt" ] && echo "  #   - ${opt}"
              done < <(split_list "$CHAR_OPTIONS_RAW")
            fi

            # Challenges
            echo ""
            echo "challenges:"
            while IFS= read -r ch; do
              [ -z "$ch" ] && continue
              echo "  - $(slugify "$ch")"
            done < <(split_list "$CHALLENGES")

            # Glitch categories
            echo ""
            if [ -n "$(split_list "${GLITCH_CATS_RAW:-}" | head -n 1 || true)" ]; then
              echo "glitches_data:"
              while IFS= read -r gc; do
                [ -z "$gc" ] && continue
                echo "  - slug: $(slugify "$gc")"
                echo "    label: $(yaml_quote "$gc")"
              done < <(split_list "$GLITCH_CATS_RAW")
            else
              echo "glitches_data:"
              echo "  - slug: unrestricted"
              echo "    label: \"Unrestricted\""
              echo "  - slug: glitchless"
              echo "    label: \"Glitchless\""
            fi

            # Glitches documentation
            if [ -n "${GLITCHES_DOC_RAW:-}" ]; then
              echo ""
              echo "# Glitch documentation provided by submitter:"
              echo "glitches_doc: |"
              while IFS= read -r l; do 
                echo "  ${l}"
              done <<< "${GLITCHES_DOC_RAW}"
            fi

            # Restrictions
            echo ""
            if [ -n "$(split_list "${RESTRICTIONS_RAW:-}" | head -n 1 || true)" ]; then
              echo "restrictions:"
              while IFS= read -r r; do
                [ -n "$r" ] && echo "  - $(yaml_quote "$r")"
              done < <(split_list "$RESTRICTIONS_RAW")
            else
              echo "restrictions: []"
            fi

            # Categories data
            echo ""
            printf '%s\n' "$CATEGORIES_YAML"

            echo "---"
            echo ""
            echo "Game submitted via form. Awaiting review."
            echo ""
            
            # Reviewer notes section
            echo "<!-- REVIEWER NOTES"
            echo ""
            if [ -n "${SUBMITTER:-}" ]; then
              echo "Submitted by: ${SUBMITTER}"
            fi
            if [ "${CREDIT_REQUESTED}" = "true" ]; then
              echo "Credit requested: Yes"
            fi
            if [ -n "${MOD_INTEREST_RAW:-}" ]; then
              echo "Moderation interest: ${MOD_INTEREST_RAW}"
            fi
            if [ -n "$(split_list "${SUBCATS_RAW:-}" | head -n 1 || true)" ]; then
              echo ""
              echo "Subcategory relationships (Parent - Child):"
              echo "${SUBCATS_RAW}"
            fi
            if [ -n "${TIMING_SECONDARY_RAW:-}" ]; then
              echo ""
              echo "Secondary timing method: ${TIMING_SECONDARY_RAW}"
            fi
            if [ -n "${FEEDBACK_RAW:-}" ]; then
              echo ""
              echo "Submitter feedback:"
              echo "${FEEDBACK_RAW}"
            fi
            echo ""
            echo "-->"
          } > "$out"

          echo "âœ“ Wrote ${out}"
          
          # Output for next steps
          echo "game_id=${GAME_ID}" >> "$GITHUB_OUTPUT"
          echo "game_name=${GAME_NAME}" >> "$GITHUB_OUTPUT"
          echo "first_letter=${FIRST_LETTER}" >> "$GITHUB_OUTPUT"

      - name: Verify generated file
        run: |
          echo "=== GENERATED FILE CONTENTS ==="
          cat "_queue_games/${{ steps.generate.outputs.game_id }}.md"
          echo ""
          echo "=== YAML VALIDATION ==="
          python3 -c "
          import yaml
          with open('_queue_games/${{ steps.generate.outputs.game_id }}.md', 'r') as f:
              content = f.read()
              # Extract front matter
              parts = content.split('---')
              if len(parts) >= 3:
                  front_matter = parts[1]
                  try:
                      data = yaml.safe_load(front_matter)
                      print('âœ“ YAML is valid')
                      print(f'  - game_id: {data.get(\"game_id\")}')
                      print(f'  - name: {data.get(\"name\")}')
                      print(f'  - challenges: {data.get(\"challenges\", [])}')
                      print(f'  - categories_data count: {len(data.get(\"categories_data\", []))}')
                  except yaml.YAMLError as e:
                      print(f'âœ— YAML Error: {e}')
                      exit(1)
          "

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: |
            _queue_games/**
          commit-message: "feat: Add new game - ${{ steps.generate.outputs.game_name }}"
          title: "ðŸŽ® New Game Submission: ${{ steps.generate.outputs.game_name }}"
          body: |
            ## New Game Submission

            **Game:** ${{ steps.generate.outputs.game_name }}
            **Game ID:** `${{ steps.generate.outputs.game_id }}`

            ### Checklist for Reviewers
            
            Before merging, please complete these tasks:
            
            - [ ] Game name and ID are correct
            - [ ] Add tags (genres: action, roguelike, rpg, etc.)
            - [ ] Add platforms (steam, playstation, xbox, nintendo-switch, etc.)
            - [ ] Review categories and subcategories
            - [ ] Review glitch categories (`glitches_data`)
            - [ ] Review challenge types
            - [ ] Upload cover image to `assets/img/games/${{ steps.generate.outputs.first_letter }}/`
            - [ ] Move file from `_queue_games/` to `_games/`

            ### File Location
            
            ```
            _queue_games/${{ steps.generate.outputs.game_id }}.md
            ```
            
            ---
            *Submitted via Google Form*
          branch: "new-game/${{ steps.generate.outputs.game_id }}-${{ github.run_id }}"
          delete-branch: true
          labels: |
            new-game
            needs-review

      - name: Notify Discord forum (new game submission PR)
        continue-on-error: true
        if: ${{ steps.cpr.outputs.pull-request-url != '' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          GAME_ID: ${{ steps.generate.outputs.game_id }}
          GAME_NAME: ${{ steps.generate.outputs.game_name }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "DISCORD_WEBHOOK_URL not set, skipping Discord notification"
            exit 0
          fi

          payload="$(python3 - <<'PY'
          import json, os
          
          game_name = os.environ.get("GAME_NAME", "").strip()
          game_id = os.environ.get("GAME_ID", "").strip()
          pr_url = os.environ.get("PR_URL", "").strip()
          pr_list = "https://github.com/GaryAsher/challenge-run-site/pulls"
          FORUM_TAG_ID = "1459087089021882561"

          data = {
              "thread_name": f"Game submission: {game_name} ({game_id})",
              "content": (
                  "ðŸ†• **New game submission PR**\n"
                  f"**{game_name}** (`{game_id}`)\n"
                  f"PR: {pr_url}\n"
                  f"All submissions: <{pr_list}>"
              ),
              "applied_tags": [FORUM_TAG_ID]
          }
          print(json.dumps(data))
          PY
          )"

          curl -sS -X POST "${DISCORD_WEBHOOK_URL}?wait=true" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHubActions-CRC" \
            --data "$payload" \
            --fail-with-body
          
          echo "âœ“ Discord notification sent"
