name: Promote Approved Runs

# Run daily at midnight UTC, or manually
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Run Promote Script
        id: promote
        env:
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            echo "Running in dry-run mode..."
            npm run promote:runs -- --dry-run 2>&1 | tee promote-output.txt
          else
            npm run promote:runs 2>&1 | tee promote-output.txt
          fi
          
          # Check if any runs were promoted
          if grep -q "approved=" promote-output.txt; then
            APPROVED=$(grep "approved=" promote-output.txt | sed 's/.*approved=\([0-9]*\).*/\1/')
            REJECTED=$(grep "rejected=" promote-output.txt | sed 's/.*rejected=\([0-9]*\).*/\1/')
            PENDING=$(grep "pending=" promote-output.txt | sed 's/.*pending=\([0-9]*\).*/\1/')
            
            echo "approved=$APPROVED" >> $GITHUB_OUTPUT
            echo "rejected=$REJECTED" >> $GITHUB_OUTPUT
            echo "pending=$PENDING" >> $GITHUB_OUTPUT
            
            if [ "$APPROVED" -gt 0 ] || [ "$REJECTED" -gt 0 ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.promote.outputs.has_changes == 'true' && inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Promote runs: ${{ steps.promote.outputs.approved }} approved, ${{ steps.promote.outputs.rejected }} rejected
          title: "[Auto] Promote Runs (${{ steps.promote.outputs.approved }} approved, ${{ steps.promote.outputs.rejected }} rejected)"
          body: |
            ## Automated Run Promotion
            
            | Status | Count |
            |--------|-------|
            | ✅ Approved | ${{ steps.promote.outputs.approved }} |
            | ❌ Rejected | ${{ steps.promote.outputs.rejected }} |
            | ⏳ Pending | ${{ steps.promote.outputs.pending }} |
            
            This PR was automatically generated by the promote-runs workflow.
            
            ---
            
            <details>
            <summary>Promotion Output</summary>
            
            ```
            $(cat promote-output.txt)
            ```
            
            </details>
          branch: "auto/promote-runs"
          labels: |
            auto-generated
            run-promotion
          delete-branch: true

      - name: Summary
        run: |
          echo "## Run Promotion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ✅ Approved | ${{ steps.promote.outputs.approved || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ❌ Rejected | ${{ steps.promote.outputs.rejected || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ⏳ Pending | ${{ steps.promote.outputs.pending || 0 }} |" >> $GITHUB_STEP_SUMMARY
