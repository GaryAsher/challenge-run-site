name: Verify Run

on:
  repository_dispatch:
    types: [verify-run]
  workflow_dispatch:
    inputs:
      game_id:
        description: "Game ID"
        required: true
        type: string
      run_filename:
        description: "Run filename (without .md)"
        required: true
        type: string
      verifier_discord:
        description: "Verifier Discord username"
        required: true
        type: string
      verifier_github:
        description: "Verifier GitHub username"
        required: false
        type: string
      note:
        description: "Verification note"
        required: false
        type: string
      action:
        description: "Action"
        required: true
        type: choice
        options:
          - verify
          - unverify

permissions:
  contents: write

jobs:
  verify-run:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate permissions
        id: validate
        env:
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
          VERIFIER_DISCORD: ${{ github.event.client_payload.verifier_discord || inputs.verifier_discord }}
          VERIFIER_GITHUB: ${{ github.event.client_payload.verifier_github || inputs.verifier_github }}
        run: |
          # Check if verifier is a GM for this game or an admin
          if [ -f "_data/game-moderators.yml" ]; then
            IS_ADMIN=$(grep -A5 "^_admins:" _data/game-moderators.yml | grep -c "${VERIFIER_DISCORD}\|${VERIFIER_GITHUB}" || echo "0")
            IS_GM=$(grep -A20 "^${GAME_ID}:" _data/game-moderators.yml | grep -c "${VERIFIER_DISCORD}\|${VERIFIER_GITHUB}" || echo "0")
            
            if [ "$IS_ADMIN" -eq 0 ] && [ "$IS_GM" -eq 0 ]; then
              echo "::error::User is not authorized to verify runs for ${GAME_ID}"
              exit 1
            fi
          fi
          
          echo "authorized=true" >> "$GITHUB_OUTPUT"

      - name: Update run file
        id: update
        env:
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
          RUN_FILENAME: ${{ github.event.client_payload.run_filename || inputs.run_filename }}
          ACTION: ${{ github.event.client_payload.action || inputs.action }}
          VERIFIER_DISCORD: ${{ github.event.client_payload.verifier_discord || inputs.verifier_discord }}
          VERIFIER_GITHUB: ${{ github.event.client_payload.verifier_github || inputs.verifier_github }}
        run: |
          RUN_FILE="_runs/${GAME_ID}/${RUN_FILENAME}.md"
          
          if [ ! -f "$RUN_FILE" ]; then
            echo "::error::Run file not found: ${RUN_FILE}"
            exit 1
          fi
          
          if [ "$ACTION" = "verify" ]; then
            # Add or update verified fields
            if grep -q "^verified:" "$RUN_FILE"; then
              sed -i "s/^verified:.*/verified: true/" "$RUN_FILE"
            else
              sed -i "/^---$/,/^---$/s/^---$/verified: true\n---/" "$RUN_FILE"
            fi
            
            # Add verified_by
            if grep -q "^verified_by:" "$RUN_FILE"; then
              sed -i "s/^verified_by:.*/verified_by: \"${VERIFIER_DISCORD}\"/" "$RUN_FILE"
            else
              sed -i "/^verified: true/a verified_by: \"${VERIFIER_DISCORD}\"" "$RUN_FILE"
            fi
            
            # Add verified_at
            TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            if grep -q "^verified_at:" "$RUN_FILE"; then
              sed -i "s/^verified_at:.*/verified_at: \"${TIMESTAMP}\"/" "$RUN_FILE"
            else
              sed -i "/^verified_by:/a verified_at: \"${TIMESTAMP}\"" "$RUN_FILE"
            fi
            
            echo "action_done=verified" >> "$GITHUB_OUTPUT"
            
          else
            # Remove verification
            sed -i "s/^verified:.*/verified: false/" "$RUN_FILE"
            sed -i "/^verified_by:/d" "$RUN_FILE"
            sed -i "/^verified_at:/d" "$RUN_FILE"
            
            echo "action_done=unverified" >> "$GITHUB_OUTPUT"
          fi
          
          echo "run_file=${RUN_FILE}" >> "$GITHUB_OUTPUT"

      - name: Log to history
        env:
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
          RUN_FILENAME: ${{ github.event.client_payload.run_filename || inputs.run_filename }}
          ACTION_DONE: ${{ steps.update.outputs.action_done }}
          VERIFIER_DISCORD: ${{ github.event.client_payload.verifier_discord || inputs.verifier_discord }}
          VERIFIER_GITHUB: ${{ github.event.client_payload.verifier_github || inputs.verifier_github }}
          NOTE: ${{ github.event.client_payload.note || inputs.note }}
        run: |
          HISTORY_FILE="_data/history/${GAME_ID}.yml"
          mkdir -p "_data/history"
          
          if [ ! -f "$HISTORY_FILE" ]; then
            echo "# History log for ${GAME_ID}" > "$HISTORY_FILE"
          fi
          
          ACTION_TYPE="run_verified"
          if [ "$ACTION_DONE" = "unverified" ]; then
            ACTION_TYPE="run_unverified"
          fi
          
          cat >> "$HISTORY_FILE" << ENDOFENTRY

- date: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  action: ${ACTION_TYPE}
  target: "${RUN_FILENAME}"
  by:
    discord: "${VERIFIER_DISCORD}"
    github: "${VERIFIER_GITHUB:-}"
  note: "${NOTE:-}"
ENDOFENTRY

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add _runs/ _data/history/
          git commit -m "feat: ${{ steps.update.outputs.action_done }} run - ${{ inputs.run_filename || github.event.client_payload.run_filename }}"
          git push

      - name: Notify Discord
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_FORUM }}
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
          RUN_FILENAME: ${{ github.event.client_payload.run_filename || inputs.run_filename }}
          ACTION_DONE: ${{ steps.update.outputs.action_done }}
          VERIFIER: ${{ github.event.client_payload.verifier_discord || inputs.verifier_discord }}
        run: |
          if [ "$ACTION_DONE" = "verified" ]; then
            COLOR=3066993
            TITLE="✅ Run Verified"
          else
            COLOR=15158332
            TITLE="❌ Verification Removed"
          fi
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"${TITLE}\",
                \"color\": ${COLOR},
                \"fields\": [
                  {\"name\": \"Game\", \"value\": \"\`${GAME_ID}\`\", \"inline\": true},
                  {\"name\": \"Run\", \"value\": \"\`${RUN_FILENAME}\`\", \"inline\": true},
                  {\"name\": \"By\", \"value\": \"${VERIFIER}\", \"inline\": true}
                ]
              }]
            }" \
            "$DISCORD_WEBHOOK" || true
