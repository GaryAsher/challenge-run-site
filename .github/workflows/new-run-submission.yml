name: Process Run Submission

on:
  repository_dispatch:
    types: [new-run-submission]
  workflow_dispatch:
    inputs:
      game_id:
        description: "Game ID (slug)"
        required: true
        type: string
      runner_id:
        description: "Runner ID (slug)"
        required: true
        type: string
      category:
        description: "Category slug"
        required: true
        type: string
      video_url:
        description: "Video URL"
        required: true
        type: string
      date_completed:
        description: "Date completed (YYYY-MM-DD)"
        required: true
        type: string
      standard_challenges:
        description: "Standard challenges (comma-separated slugs)"
        required: false
        type: string
      community_challenge:
        description: "Community challenge slug"
        required: false
        type: string
      character:
        description: "Character/weapon slug"
        required: false
        type: string
      glitch_id:
        description: "Glitch category slug"
        required: false
        type: string
      restrictions:
        description: "Restrictions (comma-separated slugs)"
        required: false
        type: string
      submission_id:
        description: "Unique submission ID"
        required: false
        type: string

concurrency:
  group: run-submission-${{ github.event.client_payload.submission_id || inputs.submission_id || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  create-run-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.cpr.outputs.pull-request-number }}
      pr_url: ${{ steps.cpr.outputs.pull-request-url }}
      game_id: ${{ steps.create.outputs.game_id }}
      runner_id: ${{ steps.create.outputs.runner_id }}
      filename: ${{ steps.create.outputs.filename }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check for duplicates
        id: dedup
        env:
          VIDEO_URL: ${{ github.event.client_payload.video_url || inputs.video_url }}
        run: |
          EXISTING=$(grep -rl "$VIDEO_URL" _runs/ _queue_runs/ 2>/dev/null | head -1 || true)
          
          if [ -n "$EXISTING" ]; then
            echo "duplicate=true" >> "$GITHUB_OUTPUT"
            echo "existing_file=$EXISTING" >> "$GITHUB_OUTPUT"
          else
            echo "duplicate=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if duplicate
        if: steps.dedup.outputs.duplicate == 'true'
        run: |
          echo "::error::Duplicate submission - video already exists in ${{ steps.dedup.outputs.existing_file }}"
          exit 1

      - name: Validate game exists
        env:
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
        run: |
          if [ ! -f "_games/${GAME_ID}.md" ]; then
            echo "::error::Game not found: ${GAME_ID}"
            exit 1
          fi

      - name: Get game moderators
        id: gm
        env:
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
        run: |
          # Extract GM info from game-moderators.yml
          if [ -f "_data/game-moderators.yml" ]; then
            # Get discord tag for the game
            DISCORD_TAG=$(grep -A3 "^${GAME_ID}:" _data/game-moderators.yml | grep "discord_tag:" | sed 's/.*discord_tag: *"\{0,1\}\([^"]*\)"\{0,1\}/\1/' | head -1 || echo "$GAME_ID")
            
            # Get GitHub usernames for PR assignment - fallback to admin
            GITHUB_REVIEWERS="GaryAsher"
            
            echo "discord_tag=${DISCORD_TAG:-$GAME_ID}" >> "$GITHUB_OUTPUT"
            echo "github_reviewers=$GITHUB_REVIEWERS" >> "$GITHUB_OUTPUT"
          else
            echo "discord_tag=$GAME_ID" >> "$GITHUB_OUTPUT"
            echo "github_reviewers=GaryAsher" >> "$GITHUB_OUTPUT"
          fi

      - name: Create run file in queue
        id: create
        env:
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
          RUNNER_ID: ${{ github.event.client_payload.runner_id || inputs.runner_id }}
          CATEGORY: ${{ github.event.client_payload.category || inputs.category }}
          VIDEO_URL: ${{ github.event.client_payload.video_url || inputs.video_url }}
          DATE_COMPLETED: ${{ github.event.client_payload.date_completed || inputs.date_completed }}
          STANDARD_CHALLENGES: ${{ github.event.client_payload.standard_challenges || inputs.standard_challenges }}
          COMMUNITY_CHALLENGE: ${{ github.event.client_payload.community_challenge || inputs.community_challenge }}
          CHARACTER: ${{ github.event.client_payload.character || inputs.character }}
          GLITCH_ID: ${{ github.event.client_payload.glitch_id || inputs.glitch_id }}
          RESTRICTIONS: ${{ github.event.client_payload.restrictions || inputs.restrictions }}
          SUBMISSION_ID: ${{ github.event.client_payload.submission_id || inputs.submission_id || github.run_id }}
        run: |
          set -euo pipefail
          
          # Create queue directory
          mkdir -p "_queue_runs/${GAME_ID}"
          
          # Generate filename
          BASENAME="${DATE_COMPLETED}__${GAME_ID}__${RUNNER_ID}__${CATEGORY}"
          COUNTER=1
          while [ -f "_queue_runs/${GAME_ID}/${BASENAME}__$(printf '%02d' $COUNTER).md" ] || \
                [ -f "_runs/${GAME_ID}/${BASENAME}__$(printf '%02d' $COUNTER).md" ]; do
            COUNTER=$((COUNTER + 1))
          done
          
          FILENAME="${BASENAME}__$(printf '%02d' $COUNTER).md"
          FILEPATH="_queue_runs/${GAME_ID}/${FILENAME}"
          
          # Build challenges array
          CHALLENGES_YAML="standard_challenges:"
          if [ -n "${STANDARD_CHALLENGES:-}" ]; then
            IFS=',' read -ra CHALLENGES <<< "$STANDARD_CHALLENGES"
            for c in "${CHALLENGES[@]}"; do
              c=$(echo "$c" | xargs)
              [ -n "$c" ] && CHALLENGES_YAML="${CHALLENGES_YAML}
  - \"$c\""
            done
          else
            CHALLENGES_YAML="standard_challenges: []"
          fi
          
          # Build restrictions array
          RESTRICTIONS_YAML="restrictions:"
          if [ -n "${RESTRICTIONS:-}" ]; then
            IFS=',' read -ra RESTS <<< "$RESTRICTIONS"
            for r in "${RESTS[@]}"; do
              r=$(echo "$r" | xargs)
              [ -n "$r" ] && RESTRICTIONS_YAML="${RESTRICTIONS_YAML}
  - \"$r\""
            done
          else
            RESTRICTIONS_YAML="restrictions: []"
          fi
          
          # Create the run file
          cat > "$FILEPATH" << ENDOFFILE
---
layout: run
game_id: "${GAME_ID}"
runner_id: "${RUNNER_ID}"
category: "${CATEGORY}"
video_url: "${VIDEO_URL}"
date: "${DATE_COMPLETED}"
${CHALLENGES_YAML}
community_challenge: "${COMMUNITY_CHALLENGE:-}"
character: "${CHARACTER:-}"
glitch_id: "${GLITCH_ID:-}"
${RESTRICTIONS_YAML}
verified: false
submission_id: "${SUBMISSION_ID}"
submitted_at: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
---
ENDOFFILE
          
          # Clean up empty optional fields
          sed -i '/^community_challenge: ""$/d' "$FILEPATH"
          sed -i '/^character: ""$/d' "$FILEPATH"
          sed -i '/^glitch_id: ""$/d' "$FILEPATH"
          
          echo "filepath=$FILEPATH" >> "$GITHUB_OUTPUT"
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"
          echo "game_id=$GAME_ID" >> "$GITHUB_OUTPUT"
          echo "runner_id=$RUNNER_ID" >> "$GITHUB_OUTPUT"
          echo "category=$CATEGORY" >> "$GITHUB_OUTPUT"
          echo "video_url=$VIDEO_URL" >> "$GITHUB_OUTPUT"
          
          cat "$FILEPATH"

      - name: Log submission to history
        env:
          GAME_ID: ${{ steps.create.outputs.game_id }}
          FILENAME: ${{ steps.create.outputs.filename }}
          RUNNER_ID: ${{ steps.create.outputs.runner_id }}
        run: |
          mkdir -p "_data/history"
          HISTORY_FILE="_data/history/${GAME_ID}.yml"
          
          # Create file if doesn't exist
          if [ ! -f "$HISTORY_FILE" ]; then
            echo "# History log for ${GAME_ID}" > "$HISTORY_FILE"
            echo "# Auto-generated - do not edit manually" >> "$HISTORY_FILE"
            echo "" >> "$HISTORY_FILE"
          fi
          
          # Append new entry
          cat >> "$HISTORY_FILE" << ENDOFENTRY

- date: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  action: run_submitted
  target: "${FILENAME}"
  by:
    discord: "anonymous"
    github: ""
  note: "Run submitted by ${RUNNER_ID}, awaiting approval"
ENDOFENTRY

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: |
            _queue_runs/**
            _data/history/**
          commit-message: "feat: New run submission - ${{ steps.create.outputs.game_id }} by ${{ steps.create.outputs.runner_id }}"
          title: "ðŸƒ [${{ steps.create.outputs.game_id }}] Run by ${{ steps.create.outputs.runner_id }}"
          body: |
            ## New Run Submission
            
            | Field | Value |
            |-------|-------|
            | **Game** | `${{ steps.create.outputs.game_id }}` |
            | **Runner** | `${{ steps.create.outputs.runner_id }}` |
            | **Category** | `${{ steps.create.outputs.category }}` |
            | **Video** | ${{ steps.create.outputs.video_url }} |
            | **File** | `_queue_runs/${{ steps.create.outputs.game_id }}/${{ steps.create.outputs.filename }}` |
            
            ---
            
            ### ðŸ“‹ Moderator Checklist
            
            Before approving, please verify:
            - [ ] Video is accessible
            - [ ] Run appears complete
            - [ ] Category and challenges are correct
            - [ ] No obvious rule violations
            
            ### Actions
            - **Approve**: Merge this PR
            - **Reject**: Close this PR with a comment explaining why
            
            ---
            *Game Moderators: @${{ steps.gm.outputs.github_reviewers }}*
          branch: "run/${{ steps.create.outputs.game_id }}-${{ steps.create.outputs.runner_id }}-${{ github.run_id }}"
          delete-branch: true
          labels: |
            run-submission
            needs-review
            game/${{ steps.create.outputs.game_id }}

      - name: Send Discord Notification
        if: steps.cpr.outputs.pull-request-number
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_NEW_RUN_SUBMISSION }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
          GAME_ID: ${{ steps.create.outputs.game_id }}
          GAME_TAG: ${{ steps.gm.outputs.discord_tag }}
          RUNNER_ID: ${{ steps.create.outputs.runner_id }}
          CATEGORY: ${{ steps.create.outputs.category }}
          VIDEO_URL: ${{ steps.create.outputs.video_url }}
        run: |
          if [ -z "${DISCORD_WEBHOOK:-}" ]; then
            echo "No Discord webhook configured, skipping notification"
            exit 0
          fi
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ðŸƒ New Run Submission\",
                \"color\": 3447003,
                \"fields\": [
                  {\"name\": \"Game\", \"value\": \"**${GAME_TAG}**\", \"inline\": true},
                  {\"name\": \"Runner\", \"value\": \"\`${RUNNER_ID}\`\", \"inline\": true},
                  {\"name\": \"Category\", \"value\": \"\`${CATEGORY}\`\", \"inline\": true},
                  {\"name\": \"Video\", \"value\": \"${VIDEO_URL}\", \"inline\": false},
                  {\"name\": \"Review PR\", \"value\": \"[PR #${PR_NUMBER}](${PR_URL})\", \"inline\": false}
                ],
                \"footer\": {\"text\": \"Merge PR to approve â€¢ Close PR to reject\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK" || echo "Discord notification failed"

      - name: Summary
        run: |
          echo "## Run Submission Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ steps.cpr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.cpr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
