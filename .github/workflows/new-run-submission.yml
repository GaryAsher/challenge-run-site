name: Process Run Submission

on:
  repository_dispatch:
    types: [new-run-submission]
  workflow_dispatch:
    inputs:
      game_id:
        description: "Game ID (slug)"
        required: true
        type: string
      runner_id:
        description: "Runner ID (slug)"
        required: true
        type: string
      category:
        description: "Category slug"
        required: true
        type: string
      video_url:
        description: "Video URL"
        required: true
        type: string
      date_completed:
        description: "Date completed (YYYY-MM-DD)"
        required: true
        type: string
      challenges:
        description: "Challenges (format: standard1,standard2|community)"
        required: false
        type: string
      modifiers:
        description: "Modifiers (format: character|glitch_id|restriction1,restriction2)"
        required: false
        type: string
      submission_id:
        description: "Unique submission ID"
        required: false
        type: string

# GLOBAL QUEUE: Only one run submission processes at a time
# This prevents race conditions and ensures runs are processed in order
concurrency:
  group: run-submission-queue
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  create-run-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.cpr.outputs.pull-request-number }}
      pr_url: ${{ steps.cpr.outputs.pull-request-url }}
      game_id: ${{ steps.create.outputs.game_id }}
      runner_id: ${{ steps.create.outputs.runner_id }}
      filename: ${{ steps.create.outputs.filename }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch latest to avoid conflicts with other queued submissions
          fetch-depth: 0

      - name: Pull latest changes
        run: |
          git pull origin main --rebase || git pull origin main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Parse combined fields
        id: parse
        env:
          CHALLENGES_RAW: ${{ github.event.client_payload.challenges || inputs.challenges || '' }}
          MODIFIERS_RAW: ${{ github.event.client_payload.modifiers || inputs.modifiers || '' }}
        run: |
          # Parse challenges: "standard1,standard2|community"
          # Split on pipe - first part is standard challenges, second is community
          STANDARD_CHALLENGES="${CHALLENGES_RAW%%|*}"
          COMMUNITY_CHALLENGE="${CHALLENGES_RAW#*|}"
          # If no pipe was found, community will equal the whole string - clear it
          if [ "$COMMUNITY_CHALLENGE" = "$CHALLENGES_RAW" ]; then
            COMMUNITY_CHALLENGE=""
          fi
          
          # Parse modifiers: "character|glitch_id|restrictions"
          # Split on pipe
          IFS='|' read -r CHARACTER GLITCH_ID RESTRICTIONS <<< "$MODIFIERS_RAW"
          
          # Output parsed values
          echo "standard_challenges=${STANDARD_CHALLENGES}" >> "$GITHUB_OUTPUT"
          echo "community_challenge=${COMMUNITY_CHALLENGE}" >> "$GITHUB_OUTPUT"
          echo "character=${CHARACTER:-}" >> "$GITHUB_OUTPUT"
          echo "glitch_id=${GLITCH_ID:-}" >> "$GITHUB_OUTPUT"
          echo "restrictions=${RESTRICTIONS:-}" >> "$GITHUB_OUTPUT"
          
          # Debug output
          echo "Parsed challenges:"
          echo "  Standard: $STANDARD_CHALLENGES"
          echo "  Community: $COMMUNITY_CHALLENGE"
          echo "Parsed modifiers:"
          echo "  Character: $CHARACTER"
          echo "  Glitch ID: $GLITCH_ID"
          echo "  Restrictions: $RESTRICTIONS"

      - name: Check for duplicates
        id: dedup
        env:
          VIDEO_URL: ${{ github.event.client_payload.video_url || inputs.video_url }}
        run: |
          EXISTING=$(grep -rl "$VIDEO_URL" _runs/ _queue_runs/ 2>/dev/null | head -1 || true)
          
          if [ -n "$EXISTING" ]; then
            echo "duplicate=true" >> "$GITHUB_OUTPUT"
            echo "existing_file=$EXISTING" >> "$GITHUB_OUTPUT"
          else
            echo "duplicate=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if duplicate
        if: steps.dedup.outputs.duplicate == 'true'
        run: |
          echo "::error::Duplicate submission - video already exists in ${{ steps.dedup.outputs.existing_file }}"
          exit 1

      - name: Validate game exists
        id: validate_game
        env:
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
        run: |
          if [ ! -f "_games/${GAME_ID}.md" ]; then
            echo "::error::Game not found: ${GAME_ID}"
            exit 1
          fi
          
          # Extract game name from front matter
          GAME_NAME=$(grep -m1 "^game_name:" "_games/${GAME_ID}.md" | sed 's/game_name: *"\{0,1\}\([^"]*\)"\{0,1\}/\1/' || echo "$GAME_ID")
          if [ -z "$GAME_NAME" ]; then
            GAME_NAME=$(grep -m1 "^name:" "_games/${GAME_ID}.md" | sed 's/name: *"\{0,1\}\([^"]*\)"\{0,1\}/\1/' || echo "$GAME_ID")
          fi
          echo "game_name=${GAME_NAME:-$GAME_ID}" >> "$GITHUB_OUTPUT"

      - name: Get game moderators
        id: gm
        env:
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
        run: |
          if [ -f "_data/game-moderators.yml" ]; then
            DISCORD_TAG=$(grep -A3 "^${GAME_ID}:" _data/game-moderators.yml | grep "discord_tag:" | sed 's/.*discord_tag: *"\{0,1\}\([^"]*\)"\{0,1\}/\1/' | head -1 || echo "$GAME_ID")
            GITHUB_REVIEWERS="GaryAsher"
            echo "discord_tag=${DISCORD_TAG:-$GAME_ID}" >> "$GITHUB_OUTPUT"
            echo "github_reviewers=$GITHUB_REVIEWERS" >> "$GITHUB_OUTPUT"
          else
            echo "discord_tag=$GAME_ID" >> "$GITHUB_OUTPUT"
            echo "github_reviewers=GaryAsher" >> "$GITHUB_OUTPUT"
          fi

      - name: Create run file in queue
        id: create
        env:
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
          GAME_NAME: ${{ steps.validate_game.outputs.game_name }}
          RUNNER_ID: ${{ github.event.client_payload.runner_id || inputs.runner_id }}
          CATEGORY: ${{ github.event.client_payload.category || inputs.category }}
          VIDEO_URL: ${{ github.event.client_payload.video_url || inputs.video_url }}
          DATE_COMPLETED: ${{ github.event.client_payload.date_completed || inputs.date_completed }}
          STANDARD_CHALLENGES: ${{ steps.parse.outputs.standard_challenges }}
          COMMUNITY_CHALLENGE: ${{ steps.parse.outputs.community_challenge }}
          CHARACTER: ${{ steps.parse.outputs.character }}
          GLITCH_ID: ${{ steps.parse.outputs.glitch_id }}
          RESTRICTIONS: ${{ steps.parse.outputs.restrictions }}
          SUBMISSION_ID: ${{ github.event.client_payload.submission_id || inputs.submission_id || github.run_id }}
        run: |
          set -euo pipefail
          
          mkdir -p "_queue_runs/${GAME_ID}"
          
          BASENAME="${DATE_COMPLETED}__${GAME_ID}__${RUNNER_ID}__${CATEGORY}"
          COUNTER=1
          while [ -f "_queue_runs/${GAME_ID}/${BASENAME}__$(printf '%02d' $COUNTER).md" ] || \
                [ -f "_runs/${GAME_ID}/${BASENAME}__$(printf '%02d' $COUNTER).md" ]; do
            COUNTER=$((COUNTER + 1))
          done
          
          FILENAME="${BASENAME}__$(printf '%02d' $COUNTER).md"
          FILEPATH="_queue_runs/${GAME_ID}/${FILENAME}"
          
          # Build the file using echo statements instead of heredoc
          echo "---" > "$FILEPATH"
          echo "layout: run" >> "$FILEPATH"
          echo "game_id: \"${GAME_ID}\"" >> "$FILEPATH"
          echo "runner_id: \"${RUNNER_ID}\"" >> "$FILEPATH"
          echo "category: \"${CATEGORY}\"" >> "$FILEPATH"
          echo "video_url: \"${VIDEO_URL}\"" >> "$FILEPATH"
          echo "date: \"${DATE_COMPLETED}\"" >> "$FILEPATH"
          
          # Build challenges array
          if [ -n "${STANDARD_CHALLENGES:-}" ]; then
            echo "standard_challenges:" >> "$FILEPATH"
            IFS=',' read -ra CHALLENGES <<< "$STANDARD_CHALLENGES"
            for c in "${CHALLENGES[@]}"; do
              c=$(echo "$c" | xargs)
              [ -n "$c" ] && echo "  - \"$c\"" >> "$FILEPATH"
            done
          else
            echo "standard_challenges: []" >> "$FILEPATH"
          fi
          
          [ -n "${COMMUNITY_CHALLENGE:-}" ] && echo "community_challenge: \"${COMMUNITY_CHALLENGE}\"" >> "$FILEPATH"
          [ -n "${CHARACTER:-}" ] && echo "character: \"${CHARACTER}\"" >> "$FILEPATH"
          [ -n "${GLITCH_ID:-}" ] && echo "glitch_id: \"${GLITCH_ID}\"" >> "$FILEPATH"
          
          # Build restrictions array
          if [ -n "${RESTRICTIONS:-}" ]; then
            echo "restrictions:" >> "$FILEPATH"
            IFS=',' read -ra RESTS <<< "$RESTRICTIONS"
            for r in "${RESTS[@]}"; do
              r=$(echo "$r" | xargs)
              [ -n "$r" ] && echo "  - \"$r\"" >> "$FILEPATH"
            done
          else
            echo "restrictions: []" >> "$FILEPATH"
          fi
          
          echo "verified: false" >> "$FILEPATH"
          echo "submission_id: \"${SUBMISSION_ID}\"" >> "$FILEPATH"
          echo "submitted_at: \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> "$FILEPATH"
          echo "---" >> "$FILEPATH"
          
          echo "filepath=$FILEPATH" >> "$GITHUB_OUTPUT"
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"
          echo "game_id=$GAME_ID" >> "$GITHUB_OUTPUT"
          echo "game_name=$GAME_NAME" >> "$GITHUB_OUTPUT"
          echo "runner_id=$RUNNER_ID" >> "$GITHUB_OUTPUT"
          echo "category=$CATEGORY" >> "$GITHUB_OUTPUT"
          echo "video_url=$VIDEO_URL" >> "$GITHUB_OUTPUT"
          echo "date_completed=$DATE_COMPLETED" >> "$GITHUB_OUTPUT"
          echo "standard_challenges=$STANDARD_CHALLENGES" >> "$GITHUB_OUTPUT"
          echo "community_challenge=$COMMUNITY_CHALLENGE" >> "$GITHUB_OUTPUT"
          echo "character=$CHARACTER" >> "$GITHUB_OUTPUT"
          echo "glitch_id=$GLITCH_ID" >> "$GITHUB_OUTPUT"
          echo "restrictions=$RESTRICTIONS" >> "$GITHUB_OUTPUT"
          
          cat "$FILEPATH"

      - name: Log submission to history
        env:
          GAME_ID: ${{ steps.create.outputs.game_id }}
          FILENAME: ${{ steps.create.outputs.filename }}
          RUNNER_ID: ${{ steps.create.outputs.runner_id }}
        run: |
          mkdir -p "_data/history"
          HISTORY_FILE="_data/history/${GAME_ID}.yml"
          
          if [ ! -f "$HISTORY_FILE" ]; then
            echo "# History log for ${GAME_ID}" > "$HISTORY_FILE"
            echo "# Auto-generated - do not edit manually" >> "$HISTORY_FILE"
            echo "" >> "$HISTORY_FILE"
          fi
          
          # Use echo instead of heredoc to avoid YAML parsing issues
          echo "" >> "$HISTORY_FILE"
          echo "- date: \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> "$HISTORY_FILE"
          echo "  action: run_submitted" >> "$HISTORY_FILE"
          echo "  target: \"${FILENAME}\"" >> "$HISTORY_FILE"
          echo "  by:" >> "$HISTORY_FILE"
          echo "    discord: \"anonymous\"" >> "$HISTORY_FILE"
          echo "    github: \"\"" >> "$HISTORY_FILE"
          echo "  note: \"Run submitted by ${RUNNER_ID}, awaiting approval\"" >> "$HISTORY_FILE"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: |
            _queue_runs/**
            _data/history/**
          commit-message: "feat: New run submission - ${{ steps.create.outputs.game_id }} by ${{ steps.create.outputs.runner_id }}"
          title: "ðŸƒ [${{ steps.create.outputs.game_id }}] Run by ${{ steps.create.outputs.runner_id }}"
          body: |
            ## New Run Submission
            
            | Field | Value |
            |-------|-------|
            | **Game** | ${{ steps.create.outputs.game_name }} (`${{ steps.create.outputs.game_id }}`) |
            | **Runner** | `${{ steps.create.outputs.runner_id }}` |
            | **Category** | `${{ steps.create.outputs.category }}` |
            | **Date Completed** | ${{ steps.create.outputs.date_completed }} |
            | **Video** | ${{ steps.create.outputs.video_url }} |
            | **Standard Challenges** | ${{ steps.create.outputs.standard_challenges || '(none)' }} |
            | **Community Challenge** | ${{ steps.create.outputs.community_challenge || '(none)' }} |
            | **Character** | ${{ steps.create.outputs.character || '(none)' }} |
            | **Glitch Category** | ${{ steps.create.outputs.glitch_id || '(none)' }} |
            | **Restrictions** | ${{ steps.create.outputs.restrictions || '(none)' }} |
            | **File** | `_queue_runs/${{ steps.create.outputs.game_id }}/${{ steps.create.outputs.filename }}` |
            
            ---
            
            ### ðŸ“‹ Moderator Checklist
            
            Before approving, please verify:
            - [ ] Video is accessible and shows the complete run
            - [ ] Run matches the claimed category and challenges
            - [ ] No obvious rule violations
            - [ ] Runner information is correct
            
            ### Actions
            - **âœ… Approve**: Merge this PR to add the run to the site
            - **âŒ Reject**: Close this PR with a comment explaining why
            
            ---
            *Game Moderators: @${{ steps.gm.outputs.github_reviewers }}*
          branch: "run/${{ steps.create.outputs.game_id }}-${{ steps.create.outputs.runner_id }}-${{ github.run_id }}"
          delete-branch: true
          labels: |
            run-submission
            needs-review
            game/${{ steps.create.outputs.game_id }}

      - name: Send Discord Forum Notification
        if: steps.cpr.outputs.pull-request-number
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_NEW_RUN_SUBMISSION }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
          GAME_ID: ${{ steps.create.outputs.game_id }}
          GAME_NAME: ${{ steps.create.outputs.game_name }}
          RUNNER_ID: ${{ steps.create.outputs.runner_id }}
          CATEGORY: ${{ steps.create.outputs.category }}
          VIDEO_URL: ${{ steps.create.outputs.video_url }}
          DATE_COMPLETED: ${{ steps.create.outputs.date_completed }}
          STANDARD_CHALLENGES: ${{ steps.create.outputs.standard_challenges }}
          COMMUNITY_CHALLENGE: ${{ steps.create.outputs.community_challenge }}
          CHARACTER: ${{ steps.create.outputs.character }}
          GLITCH_ID: ${{ steps.create.outputs.glitch_id }}
          RESTRICTIONS: ${{ steps.create.outputs.restrictions }}
          # Forum tag ID for "Needs Review" or similar
          FORUM_TAG_ID: "1463724226644152362"
        run: |
          if [ -z "${DISCORD_WEBHOOK:-}" ]; then
            echo "No Discord webhook configured, skipping notification"
            exit 0
          fi
          
          # Build description with all fields
          DESCRIPTION="**Runner:** \`${RUNNER_ID}\`\\n"
          DESCRIPTION+="**Category:** \`${CATEGORY}\`\\n"
          DESCRIPTION+="**Date:** ${DATE_COMPLETED}\\n"
          DESCRIPTION+="**Video:** ${VIDEO_URL}\\n\\n"
          
          if [ -n "${STANDARD_CHALLENGES:-}" ]; then
            DESCRIPTION+="**Standard Challenges:** ${STANDARD_CHALLENGES}\\n"
          fi
          if [ -n "${COMMUNITY_CHALLENGE:-}" ]; then
            DESCRIPTION+="**Community Challenge:** ${COMMUNITY_CHALLENGE}\\n"
          fi
          if [ -n "${CHARACTER:-}" ]; then
            DESCRIPTION+="**Character:** ${CHARACTER}\\n"
          fi
          if [ -n "${GLITCH_ID:-}" ]; then
            DESCRIPTION+="**Glitch Category:** ${GLITCH_ID}\\n"
          fi
          if [ -n "${RESTRICTIONS:-}" ]; then
            DESCRIPTION+="**Restrictions:** ${RESTRICTIONS}\\n"
          fi
          
          DESCRIPTION+="\\n---\\n[Review PR #${PR_NUMBER}](${PR_URL})"
          
          # Discord Forum webhook requires thread_name to create a new forum post
          # and applied_tags array for forum tags
          curl -H "Content-Type: application/json" \
            -d "{
              \"thread_name\": \"New run submission for ${GAME_NAME} - ${RUNNER_ID}\",
              \"applied_tags\": [\"${FORUM_TAG_ID}\"],
              \"content\": \"\",
              \"embeds\": [{
                \"title\": \"ðŸƒ Run Submission Details\",
                \"description\": \"${DESCRIPTION}\",
                \"color\": 3447003,
                \"footer\": {\"text\": \"Merge PR to approve â€¢ Close PR to reject\"}
              }]
            }" \
            "$DISCORD_WEBHOOK" || echo "Discord notification failed (this is non-fatal)"

      - name: Summary
        run: |
          echo "## Run Submission Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ steps.cpr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.cpr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Submission Details" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Game | ${{ steps.create.outputs.game_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Runner | ${{ steps.create.outputs.runner_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Category | ${{ steps.create.outputs.category }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Challenges | ${{ steps.create.outputs.standard_challenges }} |" >> $GITHUB_STEP_SUMMARY
