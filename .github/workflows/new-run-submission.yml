name: Process New Run Submission

on:
  repository_dispatch:
    types: [new-run-submission]
  workflow_dispatch:
    inputs:
      game_id:
        description: "Game ID (slug)"
        required: true
        type: string
      runner_id:
        description: "Runner ID (slug)"
        required: true
        type: string
      category:
        description: "Category slug"
        required: true
        type: string
      video_url:
        description: "Video URL"
        required: true
        type: string
      date_completed:
        description: "Date completed (YYYY-MM-DD)"
        required: true
        type: string
      standard_challenges:
        description: "Standard challenges (comma-separated slugs)"
        required: false
        type: string
      community_challenge:
        description: "Community challenge slug"
        required: false
        type: string
      character:
        description: "Character/weapon slug"
        required: false
        type: string
      glitch_id:
        description: "Glitch category slug"
        required: false
        type: string
      restrictions:
        description: "Restrictions (comma-separated slugs)"
        required: false
        type: string
      submission_id:
        description: "Unique submission ID (for dedup)"
        required: false
        type: string

concurrency:
  group: run-submission-${{ github.event.client_payload.submission_id || inputs.submission_id || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  create-run-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check for duplicates
        id: dedup
        env:
          VIDEO_URL: ${{ github.event.client_payload.video_url || inputs.video_url }}
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
        run: |
          # Check if this video URL already exists in _runs/ or _queue_runs/
          VIDEO_HASH=$(echo -n "$VIDEO_URL" | sha256sum | cut -c1-16)
          
          EXISTING=$(grep -rl "$VIDEO_URL" _runs/ _queue_runs/ 2>/dev/null | head -1 || true)
          
          if [ -n "$EXISTING" ]; then
            echo "duplicate=true" >> "$GITHUB_OUTPUT"
            echo "existing_file=$EXISTING" >> "$GITHUB_OUTPUT"
            echo "::warning::Duplicate submission detected: $VIDEO_URL already exists in $EXISTING"
          else
            echo "duplicate=false" >> "$GITHUB_OUTPUT"
          fi
          
          echo "video_hash=$VIDEO_HASH" >> "$GITHUB_OUTPUT"

      - name: Skip if duplicate
        if: steps.dedup.outputs.duplicate == 'true'
        run: |
          echo "âš ï¸ Skipping duplicate submission"
          echo "Video URL already exists in: ${{ steps.dedup.outputs.existing_file }}"
          exit 0

      - name: Validate game exists
        if: steps.dedup.outputs.duplicate != 'true'
        id: validate
        env:
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
        run: |
          if [ ! -f "_games/${GAME_ID}.md" ]; then
            echo "::error::Game not found: ${GAME_ID}"
            exit 1
          fi
          echo "game_valid=true" >> "$GITHUB_OUTPUT"

      - name: Generate run file
        if: steps.dedup.outputs.duplicate != 'true'
        id: generate
        env:
          GAME_ID: ${{ github.event.client_payload.game_id || inputs.game_id }}
          RUNNER_ID: ${{ github.event.client_payload.runner_id || inputs.runner_id }}
          CATEGORY: ${{ github.event.client_payload.category || inputs.category }}
          VIDEO_URL: ${{ github.event.client_payload.video_url || inputs.video_url }}
          DATE_COMPLETED: ${{ github.event.client_payload.date_completed || inputs.date_completed }}
          STANDARD_CHALLENGES: ${{ github.event.client_payload.standard_challenges || inputs.standard_challenges }}
          COMMUNITY_CHALLENGE: ${{ github.event.client_payload.community_challenge || inputs.community_challenge }}
          CHARACTER: ${{ github.event.client_payload.character || inputs.character }}
          GLITCH_ID: ${{ github.event.client_payload.glitch_id || inputs.glitch_id }}
          RESTRICTIONS: ${{ github.event.client_payload.restrictions || inputs.restrictions }}
          SUBMISSION_ID: ${{ github.event.client_payload.submission_id || inputs.submission_id || github.run_id }}
        run: |
          set -euo pipefail
          
          # Validate required fields
          if [ -z "${GAME_ID:-}" ]; then echo "::error::GAME_ID is required"; exit 1; fi
          if [ -z "${RUNNER_ID:-}" ]; then echo "::error::RUNNER_ID is required"; exit 1; fi
          if [ -z "${CATEGORY:-}" ]; then echo "::error::CATEGORY is required"; exit 1; fi
          if [ -z "${VIDEO_URL:-}" ]; then echo "::error::VIDEO_URL is required"; exit 1; fi
          if [ -z "${DATE_COMPLETED:-}" ]; then echo "::error::DATE_COMPLETED is required"; exit 1; fi
          
          # Ensure queue directory exists
          mkdir -p "_queue_runs/${GAME_ID}"
          
          # Generate unique filename
          # Format: DATE__GAME__RUNNER__CATEGORY__NN.md
          BASENAME="${DATE_COMPLETED}__${GAME_ID}__${RUNNER_ID}__${CATEGORY}"
          
          # Find next available number
          COUNTER=1
          while [ -f "_queue_runs/${GAME_ID}/${BASENAME}__$(printf '%02d' $COUNTER).md" ] || \
                [ -f "_runs/${GAME_ID}/${BASENAME}__$(printf '%02d' $COUNTER).md" ]; do
            COUNTER=$((COUNTER + 1))
          done
          
          FILENAME="${BASENAME}__$(printf '%02d' $COUNTER).md"
          FILEPATH="_queue_runs/${GAME_ID}/${FILENAME}"
          
          # Build standard_challenges array
          CHALLENGES_YAML=""
          if [ -n "${STANDARD_CHALLENGES:-}" ]; then
            CHALLENGES_YAML="standard_challenges:"
            IFS=',' read -ra CHALLENGES <<< "$STANDARD_CHALLENGES"
            for c in "${CHALLENGES[@]}"; do
              c=$(echo "$c" | xargs)  # trim whitespace
              if [ -n "$c" ]; then
                CHALLENGES_YAML="${CHALLENGES_YAML}
  - \"$c\""
              fi
            done
          else
            CHALLENGES_YAML="standard_challenges: []"
          fi
          
          # Build restrictions array
          RESTRICTIONS_YAML=""
          if [ -n "${RESTRICTIONS:-}" ]; then
            RESTRICTIONS_YAML="restrictions:"
            IFS=',' read -ra RESTS <<< "$RESTRICTIONS"
            for r in "${RESTS[@]}"; do
              r=$(echo "$r" | xargs)
              if [ -n "$r" ]; then
                RESTRICTIONS_YAML="${RESTRICTIONS_YAML}
  - \"$r\""
              fi
            done
          else
            RESTRICTIONS_YAML="restrictions: []"
          fi
          
          # Generate the run file
          cat > "$FILEPATH" << ENDOFFILE
          ---
          layout: run
          game_id: "${GAME_ID}"
          runner_id: "${RUNNER_ID}"
          category: "${CATEGORY}"
          video_url: "${VIDEO_URL}"
          date: "${DATE_COMPLETED}"
          ${CHALLENGES_YAML}
          community_challenge: "${COMMUNITY_CHALLENGE:-}"
          character: "${CHARACTER:-}"
          glitch_id: "${GLITCH_ID:-}"
          ${RESTRICTIONS_YAML}
          status: pending
          submission_id: "${SUBMISSION_ID}"
          ---
          ENDOFFILE
          
          # Clean up empty fields and fix indentation
          sed -i 's/^          //' "$FILEPATH"
          sed -i '/^[a-z_]*: ""$/d' "$FILEPATH"
          
          echo "filepath=$FILEPATH" >> "$GITHUB_OUTPUT"
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"
          echo "game_id=$GAME_ID" >> "$GITHUB_OUTPUT"
          echo "runner_id=$RUNNER_ID" >> "$GITHUB_OUTPUT"
          echo "category=$CATEGORY" >> "$GITHUB_OUTPUT"
          
          echo "âœ… Created: $FILEPATH"
          cat "$FILEPATH"

      - name: Get game reviewers
        if: steps.dedup.outputs.duplicate != 'true'
        id: reviewers
        env:
          GAME_ID: ${{ steps.generate.outputs.game_id }}
        run: |
          # Extract reviewers from game file
          REVIEWERS=$(grep -A20 "^reviewers:" "_games/${GAME_ID}.md" | grep "^\s*-" | sed 's/.*- *//' | tr -d '"' | tr '\n' ',' | sed 's/,$//')
          
          if [ -z "$REVIEWERS" ]; then
            # Fallback to global owner
            REVIEWERS="GaryAsher"
          fi
          
          echo "reviewers=$REVIEWERS" >> "$GITHUB_OUTPUT"
          echo "Game reviewers: $REVIEWERS"

      - name: Create Pull Request
        if: steps.dedup.outputs.duplicate != 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: |
            _queue_runs/**
          commit-message: "feat: New run submission - ${{ steps.generate.outputs.game_id }} by ${{ steps.generate.outputs.runner_id }}"
          title: "ðŸƒ Run Submission: ${{ steps.generate.outputs.game_id }} - ${{ steps.generate.outputs.runner_id }}"
          body: |
            ## New Run Submission
            
            | Field | Value |
            |-------|-------|
            | **Game** | `${{ steps.generate.outputs.game_id }}` |
            | **Runner** | `${{ steps.generate.outputs.runner_id }}` |
            | **Category** | `${{ steps.generate.outputs.category }}` |
            | **Video** | ${{ github.event.client_payload.video_url || inputs.video_url }} |
            | **Date** | ${{ github.event.client_payload.date_completed || inputs.date_completed }} |
            
            ---
            
            ### ðŸ“‹ Moderator Checklist
            
            - [ ] Video is accessible and shows a complete run
            - [ ] Category and challenges are correct
            - [ ] Runner ID matches an existing runner (or create new runner file)
            - [ ] No rule violations detected
            
            ---
            
            **Game Moderators:** @${{ steps.reviewers.outputs.reviewers }}
            
            *Merge this PR to approve the run, or close it to reject.*
          branch: "run/${{ steps.generate.outputs.game_id }}-${{ steps.generate.outputs.runner_id }}-${{ github.run_id }}"
          delete-branch: true
          labels: |
            run-submission
            needs-review
            game/${{ steps.generate.outputs.game_id }}

      - name: Send Discord Notification
        if: steps.dedup.outputs.duplicate != 'true' && steps.cpr.outputs.pull-request-number
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_RUNS }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
          GAME_ID: ${{ steps.generate.outputs.game_id }}
          RUNNER_ID: ${{ steps.generate.outputs.runner_id }}
          CATEGORY: ${{ steps.generate.outputs.category }}
          VIDEO_URL: ${{ github.event.client_payload.video_url || inputs.video_url }}
        run: |
          if [ -z "${DISCORD_WEBHOOK:-}" ]; then
            echo "âš ï¸ No Discord webhook configured, skipping notification"
            exit 0
          fi
          
          # Send Discord embed
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ðŸƒ New Run Submission\",
                \"color\": 3447003,
                \"fields\": [
                  {\"name\": \"Game\", \"value\": \"\`${GAME_ID}\`\", \"inline\": true},
                  {\"name\": \"Runner\", \"value\": \"\`${RUNNER_ID}\`\", \"inline\": true},
                  {\"name\": \"Category\", \"value\": \"\`${CATEGORY}\`\", \"inline\": true},
                  {\"name\": \"Video\", \"value\": \"${VIDEO_URL}\", \"inline\": false},
                  {\"name\": \"Review PR\", \"value\": \"[PR #${PR_NUMBER}](${PR_URL})\", \"inline\": false}
                ],
                \"footer\": {\"text\": \"Awaiting moderator review\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK"
          
          echo "âœ… Discord notification sent"

      - name: Summary
        if: always()
        run: |
          echo "## Run Submission Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.dedup.outputs.duplicate }}" = "true" ]; then
            echo "âš ï¸ **Duplicate detected** - submission skipped" >> $GITHUB_STEP_SUMMARY
            echo "Video already exists in: \`${{ steps.dedup.outputs.existing_file }}\`" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ steps.cpr.outputs.pull-request-number }}" ]; then
            echo "âœ… **PR Created:** #${{ steps.cpr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Ž ${{ steps.cpr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Failed to create PR**" >> $GITHUB_STEP_SUMMARY
          fi
