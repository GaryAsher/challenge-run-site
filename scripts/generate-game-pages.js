#!/usr/bin/env node
/**
 * scripts/generate-game-pages.js
 *
 * Generates the non-runs sub-pages for a game:
 * - forum/index.html
 * - guides/index.html
 * - history/index.html
 * - resources/index.html
 * - rules/index.html
 * - submit/index.html
 *
 * NOTE: Runs pages (index + all category pages) are generated by
 * generate-run-category-pages.js, which handles the tiered structure
 * (full_runs, mini_challenges, player_made).
 *
 * Usage:
 *   node scripts/generate-game-pages.js                    # All games
 *   node scripts/generate-game-pages.js --game hades-2     # Specific game
 *   node scripts/generate-game-pages.js --check            # Verify pages exist (no writes)
 */

const fs = require('fs');
const path = require('path');

// Import shared utilities
const {
  parseFrontMatter,
  isDir,
  isFile,
  readText,
} = require('./lib');

const ROOT = process.cwd();
const GAMES_DIR = path.join(ROOT, '_games');
const OUTPUT_DIR = path.join(ROOT, 'games');

// ============================================================
// Helpers
// ============================================================
function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

function ensureDir(dir) {
  if (!isDir(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
}

/**
 * Check if either index.html or index.md exists
 */
function indexExists(dir) {
  return isFile(path.join(dir, 'index.html')) || isFile(path.join(dir, 'index.md'));
}

function writeIfNotExists(filePath, content, checkOnly = false) {
  if (isFile(filePath)) {
    return false; // Already exists
  }
  
  if (checkOnly) {
    console.log(`MISSING: ${path.relative(ROOT, filePath)}`);
    return true; // Would need to create
  }
  
  ensureDir(path.dirname(filePath));
  fs.writeFileSync(filePath, content, 'utf8');
  console.log(`Created: ${path.relative(ROOT, filePath)}`);
  return true;
}

/**
 * Check for index page (either .html or .md), create .html if missing
 */
function ensureIndexPage(dir, template, checkOnly = false, forceOverwrite = false) {
  if (!forceOverwrite && indexExists(dir)) {
    return false; // Already exists
  }
  
  const indexPath = path.join(dir, 'index.html');
  
  if (checkOnly) {
    if (!indexExists(dir)) {
      console.log(`MISSING: ${path.relative(ROOT, indexPath)}`);
      return true; // Would need to create
    }
    return false;
  }
  
  ensureDir(dir);
  fs.writeFileSync(indexPath, template, 'utf8');
  console.log(`${forceOverwrite && indexExists(dir) ? 'Overwrote' : 'Created'}: ${path.relative(ROOT, indexPath)}`);
  return true;
}

// ============================================================
// Template Generators
// ============================================================
function generateSubPageTemplate(gameId, section, gameName) {
  const titles = {
    forum: 'Forum',
    guides: 'Guides',
    history: 'History',
    resources: 'Resources',
    rules: 'Rules',
    submit: 'Submit Run'
  };

  const descriptions = {
    forum: 'Community discussions and announcements.',
    guides: 'Strategy guides and tutorials.',
    history: 'Historical records and milestones.',
    resources: 'Useful tools, mods, and external resources.',
    rules: 'Official rules and category definitions.',
    submit: 'Submit your challenge run for review.'
  };

  const title = titles[section] || capitalize(section);
  const description = descriptions[section] || '';

  // Rules page uses special include with Rule Builder
  if (section === 'rules') {
    return `---
layout: default
title: "${gameName} - ${title}"
game_id: ${gameId}
---

{% assign game = site.games | where: "game_id", page.game_id | first %}
{% include game-header-tabs.html game=game active="${section}" %}

<div class="page-width">
  <div class="game-shell">
    <section class="tab-panel active" data-panel="${section}">
      {% include game-rules.html game=game %}
    </section>
  </div>
</div>
`;
  }

  // Submit page uses the submit-run-form include with preset game
  if (section === 'submit') {
    return `---
layout: default
title: "${gameName} - ${title}"
game_id: ${gameId}
---

{% assign game = site.games | where: "game_id", page.game_id | first %}
{% include game-header-tabs.html game=game active="${section}" %}

<div class="page-width">
  <div class="game-shell">
    <section class="tab-panel active" data-panel="${section}">
      {% include submit-run-form.html game=game %}
    </section>
  </div>
</div>
`;
  }

  // History page uses the game-history include
  if (section === 'history') {
    return `---
layout: default
title: "${gameName} - ${title}"
game_id: ${gameId}
---

{% assign game = site.games | where: "game_id", page.game_id | first %}
{% include game-header-tabs.html game=game active="${section}" %}

<div class="page-width">
  <div class="game-shell">
    <section class="tab-panel active" data-panel="${section}">
      <h2 class="mb-3">${title}</h2>
      <p class="muted mb-4">${description}</p>
      {% include game-history.html game=game %}
    </section>
  </div>
</div>
`;
  }

  // Resources page
  if (section === 'resources') {
    return `---
layout: default
title: "${gameName} - ${title}"
game_id: ${gameId}
---

{% assign game = site.games | where: "game_id", page.game_id | first %}
{% include game-header-tabs.html game=game active="${section}" %}

<div class="page-width">
  <div class="game-shell">
    <section class="tab-panel active" data-panel="${section}">
      <h2 class="mb-3">${title}</h2>
      <p class="muted mb-4">${description}</p>
      
      {% if game.resources and game.resources.size > 0 %}
        <div class="resources-list">
          {% for resource in game.resources %}
            <div class="resource-item">
              <a href="{{ resource.url }}" target="_blank" rel="noopener">
                <strong>{{ resource.name }}</strong>
              </a>
              {% if resource.description %}
                <p class="muted">{{ resource.description }}</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted"><em>No resources have been added yet. Want to contribute? Contact a moderator!</em></p>
      {% endif %}
    </section>
  </div>
</div>
`;
  }

  // Guides page (matches Hades 2 format: card wrapper with h1)
  if (section === 'guides') {
    return `---
layout: default
title: "${gameName} - ${title}"
game_id: ${gameId}
---

{% assign game = site.games | where: "game_id", page.game_id | first %}
{% include game-header-tabs.html game=game active="${section}" %}

<div class="page-width">
  <div class="game-shell">
    <div class="card">
      <h1>${title}</h1>
      <p class="muted">${description}</p>
    </div>
  </div>
</div>
`;
  }

  // Forum page
  if (section === 'forum') {
    return `---
layout: default
title: "${gameName} - ${title}"
game_id: ${gameId}
---

{% assign game = site.games | where: "game_id", page.game_id | first %}
{% include game-header-tabs.html game=game active="${section}" %}

<div class="page-width">
  <div class="game-shell">
    <section class="tab-panel active" data-panel="${section}">
      <h2 class="mb-3">${title}</h2>
      <p class="muted mb-4">${description}</p>
      
      <p class="muted"><em>Forum functionality coming soon!</em></p>
    </section>
  </div>
</div>
`;
  }

  // Default template for any other section
  return `---
layout: default
title: "${gameName} - ${title}"
game_id: ${gameId}
---

{% assign game = site.games | where: "game_id", page.game_id | first %}
{% include game-header-tabs.html game=game active="${section}" %}

<div class="page-width">
  <div class="game-shell">
    <section class="tab-panel active" data-panel="${section}">
      <h2 class="mb-3">${title}</h2>
      <p class="muted">${description}</p>
    </section>
  </div>
</div>
`;
}



// ============================================================
// Main Generation Logic
// ============================================================
function generatePagesForGame(gameFile, checkOnly = false, forceOverwrite = false) {
  const md = readText(gameFile);
  const { data: fm } = parseFrontMatter(md);
  
  const gameId = fm.game_id;
  if (!gameId) {
    console.warn(`Skipping ${gameFile} - no game_id`);
    return 0;
  }

  const gameName = fm.game_name || fm.title || gameId;
  const tabs = fm.tabs || {};
  const gameDir = path.join(OUTPUT_DIR, gameId);
  
  let missingCount = 0;

  // Sub-pages to generate based on tabs config
  const sections = ['rules']; // Always generate rules
  
  // Add optional sections if enabled
  if (tabs.resources !== false) sections.push('resources');
  if (tabs.history !== false) sections.push('history');
  if (tabs.forum) sections.push('forum');
  
  // Always generate guides and submit pages
  sections.push('guides');
  sections.push('submit');
  
  for (const section of sections) {
    const sectionDir = path.join(gameDir, section);
    const template = generateSubPageTemplate(gameId, section, gameName);
    
    if (ensureIndexPage(sectionDir, template, checkOnly, forceOverwrite)) {
      missingCount++;
    }
  }

  // NOTE: Runs pages (index + categories) are generated by generate-run-category-pages.js
  // which handles the tiered structure (full_runs, mini_challenges, player_made)

  return missingCount;
}

// ============================================================
// CLI Entry Point
// ============================================================
function main() {
  const args = process.argv.slice(2);
  const checkOnly = args.includes('--check');
  const forceOverwrite = args.includes('--force');
  
  let specificGame = null;
  const gameIndex = args.indexOf('--game');
  if (gameIndex !== -1 && args[gameIndex + 1]) {
    specificGame = args[gameIndex + 1];
  }

  if (!isDir(GAMES_DIR)) {
    console.error('_games directory not found');
    process.exit(1);
  }

  const gameFiles = fs.readdirSync(GAMES_DIR)
    .filter(f => f.endsWith('.md'))
    .map(f => path.join(GAMES_DIR, f));

  let totalMissing = 0;
  let gamesProcessed = 0;

  for (const gameFile of gameFiles) {
    const gameId = path.basename(gameFile, '.md');
    
    if (specificGame && gameId !== specificGame) {
      continue;
    }

    const missing = generatePagesForGame(gameFile, checkOnly, forceOverwrite);
    totalMissing += missing;
    gamesProcessed++;
  }

  if (checkOnly) {
    console.log(`\nChecked ${gamesProcessed} game(s). ${totalMissing} page(s) missing.`);
    process.exit(totalMissing > 0 ? 1 : 0);
  } else {
    console.log(`\nProcessed ${gamesProcessed} game(s). ${totalMissing} page(s) created.`);
  }
}

main();
