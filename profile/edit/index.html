---
layout: default
title: "Edit Profile"
---

<div class="page-width">
  <p class="muted mb-3">
    <a href="javascript:history.back()">‚Üê Back</a>
  </p>

  <div class="profile-edit">
    <!-- Loading state -->
    <div id="loading-state" class="card">
      <div class="sign-in-loading">
        <div class="spinner"></div>
        <p class="muted">Loading profile...</p>
      </div>
    </div>

    <!-- Not signed in -->
    <div id="not-signed-in" class="card" hidden>
      <h1>Edit Profile</h1>
      <p class="muted">You need to sign in to edit your profile.</p>
      <a href="{{ '/sign-in/' | relative_url }}" class="btn btn--primary">Sign In</a>
    </div>

    <!-- No profile yet -->
    <div id="no-profile" class="card" hidden>
      <h1>No Profile Found</h1>
      <p class="muted">You haven't created a runner profile yet.</p>
      <a href="{{ '/profile/create/' | relative_url }}" class="btn btn--primary">Create Profile</a>
    </div>

    <!-- Edit form -->
    <div id="edit-content" hidden>
      <h1>Edit Profile</h1>
      <p class="muted mb-4">Update your runner profile information. Changes are saved to the database and will sync to the site.</p>
      
      <form id="profile-form" class="profile-form">
        <!-- Profile Preview -->
        <div class="card mb-4">
          <h2>üñºÔ∏è Profile Preview</h2>
          <div class="profile-preview">
            <div class="profile-preview__banner" id="preview-banner">
              <img src="/assets/img/site/default-banner.jpg" alt="" id="preview-banner-img" />
            </div>
            <div class="profile-preview__content">
              <div class="profile-preview__avatar-wrap">
                <img src="/assets/img/site/default-runner.png" alt="" class="profile-preview__avatar" id="preview-avatar" />
              </div>
              <div class="profile-preview__info">
                <span class="profile-preview__name" id="preview-name">Display Name</span>
                <span class="profile-preview__pronouns muted" id="preview-pronouns"></span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tab Navigation -->
        <nav class="runner-tabs game-tabs profile-edit-tabs">
          <button class="tab active" data-tab="basic" type="button">üë§ Basic Info</button>
          <button class="tab" data-tab="customization" type="button">üé® Customize</button>
          <button class="tab" data-tab="socials" type="button">üîó Socials</button>
          <button class="tab" data-tab="goals" type="button">üéØ Goals</button>
          <button class="tab" data-tab="highlights" type="button">üìå Highlights</button>
        </nav>
        
        <!-- Basic Info -->
        <section class="tab-panel active" data-panel="basic">
        <div class="card mb-4">
          <h2>üë§ Basic Info</h2>
          
          <div class="form-group">
            <label class="form-label">Runner ID</label>
            <input type="text" id="runner-id" class="form-input" disabled />
            <p class="form-help">Your unique identifier (cannot be changed)</p>
          </div>
          
          <div class="form-row">
            <div class="form-group form-group--flex">
              <label class="form-label" for="display-name">Display Name *</label>
              <input type="text" id="display-name" name="display_name" class="form-input" required maxlength="50" />
              <p class="form-help">The name shown on your profile</p>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="pronouns">Pronouns</label>
              <input type="text" id="pronouns" name="pronouns" class="form-input" maxlength="30" placeholder="e.g., they/them" />
              <p class="form-help">Optional, displayed next to your name</p>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="location">Location</label>
            <input type="text" id="location" name="location" class="form-input" maxlength="50" placeholder="e.g., United States" />
            <p class="form-help">Country or region (optional)</p>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="bio">Bio</label>
            <textarea id="bio" name="bio" class="form-textarea" rows="4" maxlength="1000" placeholder="Tell others about yourself and your challenge run journey..."></textarea>
            <p class="form-help"><span id="bio-count">0</span>/1000 characters</p>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="status-message">Status Message</label>
            <input type="text" id="status-message" name="status_message" class="form-input" maxlength="100" placeholder="Finishing my profile, then back to runs!" />
            <p class="form-help">A short status shown on your profile</p>
          </div>
        </div>
        </section>
        
        <!-- Avatar & Accent Color -->
        <section class="tab-panel" data-panel="customization">
        <div class="card mb-4">
          <h2>üé® Customization</h2>
          <p class="muted mb-3">Customize your profile appearance.</p>
          
          <div class="form-group">
            <label class="form-label">Avatar</label>
            
            <!-- Avatar Preview & Upload -->
            <div class="avatar-upload">
              <div class="avatar-upload__preview">
                <img src="/assets/img/site/default-runner.png" alt="Avatar preview" id="avatar-preview" />
                <div class="avatar-upload__overlay" id="avatar-overlay">
                  <span>üì∑</span>
                </div>
              </div>
              
              <div class="avatar-upload__controls">
                <input type="file" id="avatar-file" accept="image/png,image/jpeg,image/jpg" hidden />
                <button type="button" class="btn btn--small" id="avatar-upload-btn">
                  <span class="btn__text">üì§ Upload Image</span>
                  <span class="btn__loading" hidden>
                    <span class="spinner spinner--small"></span>
                    Uploading...
                  </span>
                </button>
                <button type="button" class="btn btn--small btn--outline" id="avatar-remove-btn" hidden>
                  üóëÔ∏è Remove
                </button>
                
                <p class="form-help mt-2">
                  PNG or JPG, max 2MB<br>
                  Recommended: 200√ó200px or larger (square)
                </p>
              </div>
            </div>
            
            <!-- Hidden input for the actual URL (set by upload) -->
            <input type="hidden" id="avatar-url" name="avatar_url" />
            
            <!-- Upload status message -->
            <div id="avatar-message" class="avatar-message" hidden></div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="accent-color">Accent Color</label>
            <div class="accent-color-input">
              <input type="color" id="accent-color-picker" value="#3BC36E" />
              <input type="text" id="accent-color" name="accent_color" class="form-input" placeholder="#3BC36E" maxlength="7" />
            </div>
            <p class="form-help">Hex color code for your profile accent (e.g., #3BC36E)</p>
          </div>
        </div>
        </section>
        
        <!-- Social Links -->
        <section class="tab-panel" data-panel="socials">
        <div class="card mb-4">
          <h2>üîó Social Links</h2>
          <p class="muted mb-3">Add links to your streaming and social accounts.</p>
          
          <div class="form-row">
            <div class="form-group form-group--flex">
              <label class="form-label" for="twitch">Twitch</label>
              <input type="url" id="twitch" name="twitch" class="form-input social-input" data-domain="twitch.tv" placeholder="https://twitch.tv/username" />
              <span class="form-validation" id="twitch-validation"></span>
            </div>
            
            <div class="form-group form-group--flex">
              <label class="form-label" for="youtube">YouTube</label>
              <input type="url" id="youtube" name="youtube" class="form-input social-input" data-domain="youtube.com,youtu.be" placeholder="https://youtube.com/@channel" />
              <span class="form-validation" id="youtube-validation"></span>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group form-group--flex">
              <label class="form-label" for="discord">Discord</label>
              <input type="url" id="discord" name="discord" class="form-input social-input" data-domain="discord.gg,discord.com" placeholder="https://discord.gg/invite" />
              <span class="form-validation" id="discord-validation"></span>
            </div>
            
            <div class="form-group form-group--flex">
              <label class="form-label" for="twitter">Twitter/X</label>
              <input type="url" id="twitter" name="twitter" class="form-input social-input" data-domain="twitter.com,x.com" placeholder="https://twitter.com/username" />
              <span class="form-validation" id="twitter-validation"></span>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group form-group--flex">
              <label class="form-label" for="bluesky">Bluesky</label>
              <input type="url" id="bluesky" name="bluesky" class="form-input social-input" data-domain="bsky.app" placeholder="https://bsky.app/profile/username" />
              <span class="form-validation" id="bluesky-validation"></span>
            </div>
            
            <div class="form-group form-group--flex">
              <label class="form-label" for="instagram">Instagram</label>
              <input type="url" id="instagram" name="instagram" class="form-input social-input" data-domain="instagram.com" placeholder="https://instagram.com/username" />
              <span class="form-validation" id="instagram-validation"></span>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group form-group--flex">
              <label class="form-label" for="speedruncom">Speedrun.com</label>
              <input type="url" id="speedruncom" name="speedruncom" class="form-input social-input" data-domain="speedrun.com" placeholder="https://speedrun.com/users/username" />
              <span class="form-validation" id="speedruncom-validation"></span>
            </div>
            
            <div class="form-group form-group--flex">
              <label class="form-label" for="steam">Steam</label>
              <input type="url" id="steam" name="steam" class="form-input social-input" data-domain="steamcommunity.com" placeholder="https://steamcommunity.com/id/username" />
              <span class="form-validation" id="steam-validation"></span>
            </div>
          </div>
          
          <!-- Other Links -->
          <div class="other-links-section">
            <label class="form-label">Other Links</label>
            <div class="approval-notice">
              <span class="approval-icon">‚ö†Ô∏è</span>
              <span>Other links require moderator approval before appearing on your profile.</span>
            </div>
            <div id="other-links-container"></div>
            <button type="button" class="btn btn--small mt-2" id="add-other-link">+ Add Link</button>
            <p class="form-help">Up to 3 additional links (must be valid URLs)</p>
          </div>
        </div>
        </section>
        
        <!-- Personal Goals -->
        <section class="tab-panel" data-panel="goals">
        <div class="card mb-4">
          <h2>üéØ Personal Goals</h2>
          <p class="muted mb-3">Set personal challenges and milestones to track your progress. These are visible on your profile.</p>
          
          <div id="personal-goals-editor">
            <div id="goals-list" class="goals-editor-list">
              <!-- Goals populated by JavaScript -->
            </div>
            
            <button type="button" class="btn btn--small mt-3" id="add-goal-btn">
              + Add Personal Goal
            </button>
            <p class="form-help">You can add up to 10 personal goals.</p>
          </div>
          
          <!-- Hidden input to store goals JSON -->
          <input type="hidden" id="personal-goals-data" name="personal_goals" value="[]" />
        </div>
        
        <!-- Goal Editor Template (hidden) -->
        <template id="goal-template">
          <div class="goal-editor-item" data-goal-index="">
            <div class="goal-editor-item__header">
              <button type="button" class="goal-editor-item__drag" title="Drag to reorder">‚ãÆ‚ãÆ</button>
              <span class="goal-editor-item__number">#1</span>
              <button type="button" class="goal-editor-item__remove" title="Remove goal">√ó</button>
            </div>
            
            <div class="goal-editor-item__content">
              <div class="form-row">
                <div class="form-group form-group--small">
                  <label class="form-label">Icon</label>
                  <input type="text" class="form-input goal-icon" maxlength="2" placeholder="üéØ" />
                </div>
                <div class="form-group form-group--flex">
                  <label class="form-label">Title *</label>
                  <input type="text" class="form-input goal-title" maxlength="100" placeholder="e.g., 100 Hitless Runs" required />
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input goal-description" maxlength="300" rows="2" placeholder="Describe your goal..."></textarea>
              </div>
              
              <div class="form-row">
                <div class="form-group form-group--flex">
                  <label class="form-label">Game (optional)</label>
                  <div class="goal-game-wrap" style="position:relative">
                    <input type="text" class="form-input goal-game" maxlength="100" placeholder="Start typing a game name..." autocomplete="off" />
                    <div class="goal-game-results" hidden></div>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Status</label>
                  <select class="form-input goal-completed">
                    <option value="false">In Progress</option>
                    <option value="true">Completed</option>
                  </select>
                </div>
              </div>
              
              <div class="form-row goal-progress-row">
                <div class="form-group">
                  <label class="form-label">Progress (current)</label>
                  <input type="number" class="form-input goal-current" min="0" placeholder="0" />
                </div>
                <div class="form-group">
                  <label class="form-label">Progress (total)</label>
                  <input type="number" class="form-input goal-total" min="0" placeholder="100" />
                </div>
                <div class="form-group form-group--flex goal-date-group">
                  <label class="form-label">Date Completed</label>
                  <input type="date" class="form-input goal-date" />
                </div>
              </div>
            </div>
          </div>
        </template>
        
        <style>
        .goals-editor-list {
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }
        
        .goal-editor-item {
          background: var(--surface);
          border: 1px solid var(--border);
          border-radius: var(--radius-sm);
          overflow: hidden;
        }
        
        .goal-editor-item__header {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.5rem 0.75rem;
          background: var(--bg);
          border-bottom: 1px solid var(--border);
        }
        
        .goal-editor-item__drag {
          cursor: grab;
          background: none;
          border: none;
          color: var(--text-muted);
          font-size: 1rem;
          padding: 0.25rem;
          line-height: 1;
        }
        
        .goal-editor-item__drag:active {
          cursor: grabbing;
        }
        
        .goal-editor-item__number {
          font-size: 0.8rem;
          font-weight: 600;
          color: var(--text-muted);
        }
        
        .goal-editor-item__remove {
          margin-left: auto;
          background: none;
          border: none;
          color: var(--text-muted);
          font-size: 1.25rem;
          padding: 0.25rem 0.5rem;
          cursor: pointer;
          line-height: 1;
          border-radius: 4px;
        }
        
        .goal-editor-item__remove:hover {
          background: rgba(239, 68, 68, 0.1);
          color: #ef4444;
        }
        
        .goal-editor-item__content {
          padding: 1rem;
        }
        
        .goal-editor-item__content .form-row {
          display: flex;
          gap: 1rem;
        }
        
        .goal-editor-item__content .form-group {
          margin-bottom: 0.75rem;
        }
        
        .goal-editor-item__content .form-group--small {
          flex: 0 0 70px;
        }
        
        .goal-editor-item__content .form-group--flex {
          flex: 1;
        }
        
        .goal-editor-item__content .form-label {
          font-size: 0.8rem;
          margin-bottom: 0.25rem;
        }
        
        .goal-editor-item__content .form-input {
          font-size: 0.9rem;
          padding: 0.5rem 0.75rem;
        }
        
        .goal-progress-row {
          padding-top: 0.5rem;
          border-top: 1px dashed var(--border);
          margin-top: 0.5rem;
        }
        
        .goal-icon {
          text-align: center;
          font-size: 1.25rem;
        }
        
        .goal-date-group.is-disabled {
          opacity: 0.4;
          pointer-events: none;
        }
        
        .goal-game-results {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          z-index: 50;
          background: var(--surface);
          border: 1px solid var(--border);
          border-top: none;
          border-radius: 0 0 var(--radius-sm) var(--radius-sm);
          max-height: 180px;
          overflow-y: auto;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .goal-game-result {
          padding: 0.5rem 0.75rem;
          cursor: pointer;
          font-size: 0.9rem;
          border-bottom: 1px solid var(--border);
        }
        
        .goal-game-result:last-child {
          border-bottom: none;
        }
        
        .goal-game-result:hover,
        .goal-game-result.is-active {
          background: var(--accent);
          color: var(--bg);
        }
        
        .goal-game-result__id {
          font-size: 0.75rem;
          opacity: 0.7;
          margin-left: 0.5rem;
        }
        
        @media (max-width: 600px) {
          .goal-editor-item__content .form-row {
            flex-direction: column;
            gap: 0;
          }
          
          .goal-editor-item__content .form-group--small {
            flex: none;
            width: 100%;
          }
        }
        </style>
        
        <script>
        (function() {
          const MAX_GOALS = 10;
          let goals = [];
          
          // Build games list from Jekyll data for autocomplete
          const ALL_GAMES = [
            {% for game in site.games %}
              { name: {{ game.game_name | jsonify }}, id: {{ game.game_id | jsonify }} }{% unless forloop.last %},{% endunless %}
            {% endfor %}
          ];
          
          const goalsList = document.getElementById('goals-list');
          const goalsDataInput = document.getElementById('personal-goals-data');
          const addBtn = document.getElementById('add-goal-btn');
          const template = document.getElementById('goal-template');
          
          if (!goalsList || !template) return;
          
          // Initialize with existing goals from form
          function initGoals(existingGoals) {
            goals = existingGoals || [];
            renderGoals();
          }
          
          function renderGoals() {
            goalsList.innerHTML = '';
            
            goals.forEach((goal, index) => {
              const item = template.content.cloneNode(true).querySelector('.goal-editor-item');
              item.dataset.goalIndex = index;
              item.querySelector('.goal-editor-item__number').textContent = `#${index + 1}`;
              
              // Populate fields
              item.querySelector('.goal-icon').value = goal.icon || '';
              item.querySelector('.goal-title').value = goal.title || '';
              item.querySelector('.goal-description').value = goal.description || '';
              item.querySelector('.goal-game').value = goal.game || '';
              item.querySelector('.goal-completed').value = goal.completed ? 'true' : 'false';
              item.querySelector('.goal-current').value = goal.current || '';
              item.querySelector('.goal-total').value = goal.total || '';
              item.querySelector('.goal-date').value = goal.date_completed || '';
              
              // Status ‚Üí date completed toggle
              const statusSelect = item.querySelector('.goal-completed');
              const dateGroup = item.querySelector('.goal-date-group');
              updateDateState(statusSelect, dateGroup);
              
              statusSelect.addEventListener('change', () => {
                updateDateState(statusSelect, dateGroup);
                updateGoalFromDOM(index, item);
              });
              
              // Game search autocomplete
              setupGameSearch(item.querySelector('.goal-game'), item.querySelector('.goal-game-results'));
              
              // Add event listeners
              item.querySelector('.goal-editor-item__remove').addEventListener('click', () => removeGoal(index));
              
              // Update on change
              item.querySelectorAll('input, textarea, select').forEach(input => {
                input.addEventListener('change', () => updateGoalFromDOM(index, item));
                input.addEventListener('input', () => updateGoalFromDOM(index, item));
              });
              
              goalsList.appendChild(item);
            });
            
            updateGoalsData();
            updateAddButton();
          }
          
          function updateDateState(statusSelect, dateGroup) {
            if (!dateGroup) return;
            if (statusSelect.value === 'false') {
              dateGroup.classList.add('is-disabled');
              const dateInput = dateGroup.querySelector('.goal-date');
              if (dateInput) dateInput.value = '';
            } else {
              dateGroup.classList.remove('is-disabled');
            }
          }
          
          function setupGameSearch(input, resultsEl) {
            if (!input || !resultsEl) return;
            let activeIndex = -1;
            
            input.addEventListener('input', () => {
              const query = input.value.trim().toLowerCase();
              activeIndex = -1;
              
              if (query.length < 3) {
                resultsEl.hidden = true;
                return;
              }
              
              const matches = ALL_GAMES.filter(g => 
                g.name.toLowerCase().includes(query) || g.id.toLowerCase().includes(query)
              ).slice(0, 8);
              
              if (matches.length === 0) {
                resultsEl.hidden = true;
                return;
              }
              
              resultsEl.innerHTML = matches.map((g, i) => 
                `<div class="goal-game-result" data-index="${i}" data-name="${g.name}">${g.name}<span class="goal-game-result__id">${g.id}</span></div>`
              ).join('');
              resultsEl.hidden = false;
              
              resultsEl.querySelectorAll('.goal-game-result').forEach(el => {
                el.addEventListener('mousedown', (e) => {
                  e.preventDefault();
                  input.value = el.dataset.name;
                  resultsEl.hidden = true;
                  input.dispatchEvent(new Event('change'));
                });
              });
            });
            
            input.addEventListener('keydown', (e) => {
              const items = resultsEl.querySelectorAll('.goal-game-result');
              if (resultsEl.hidden || items.length === 0) return;
              
              if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIndex = Math.min(activeIndex + 1, items.length - 1);
                items.forEach((el, i) => el.classList.toggle('is-active', i === activeIndex));
              } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = Math.max(activeIndex - 1, 0);
                items.forEach((el, i) => el.classList.toggle('is-active', i === activeIndex));
              } else if (e.key === 'Enter' && activeIndex >= 0) {
                e.preventDefault();
                input.value = items[activeIndex].dataset.name;
                resultsEl.hidden = true;
                input.dispatchEvent(new Event('change'));
              } else if (e.key === 'Escape') {
                resultsEl.hidden = true;
              }
            });
            
            input.addEventListener('blur', () => {
              setTimeout(() => { resultsEl.hidden = true; }, 200);
            });
          }
          
          function updateGoalFromDOM(index, item) {
            const isCompleted = item.querySelector('.goal-completed').value === 'true';
            goals[index] = {
              icon: item.querySelector('.goal-icon').value.trim() || 'üéØ',
              title: item.querySelector('.goal-title').value.trim(),
              description: item.querySelector('.goal-description').value.trim(),
              game: item.querySelector('.goal-game').value.trim() || null,
              completed: isCompleted,
              current: parseInt(item.querySelector('.goal-current').value) || 0,
              total: parseInt(item.querySelector('.goal-total').value) || 0,
              date_completed: isCompleted ? (item.querySelector('.goal-date').value || null) : null
            };
            updateGoalsData();
          }
          
          function addGoal() {
            if (goals.length >= MAX_GOALS) return;
            
            goals.push({
              icon: 'üéØ',
              title: '',
              description: '',
              game: null,
              completed: false,
              current: 0,
              total: 0,
              date_completed: null
            });
            
            renderGoals();
            
            // Focus the new goal's title
            const lastItem = goalsList.lastElementChild;
            if (lastItem) {
              lastItem.querySelector('.goal-title').focus();
            }
          }
          
          function removeGoal(index) {
            goals.splice(index, 1);
            renderGoals();
          }
          
          function updateGoalsData() {
            // Filter out goals without titles
            const validGoals = goals.filter(g => g.title && g.title.trim());
            goalsDataInput.value = JSON.stringify(validGoals);
          }
          
          function updateAddButton() {
            addBtn.disabled = goals.length >= MAX_GOALS;
            if (goals.length >= MAX_GOALS) {
              addBtn.textContent = `Maximum ${MAX_GOALS} goals reached`;
            } else {
              addBtn.textContent = '+ Add Personal Goal';
            }
          }
          
          // Event listeners
          addBtn.addEventListener('click', addGoal);
          
          // Expose init function for profile edit page to call
          window.initPersonalGoalsEditor = initGoals;
        })();
        </script>
        </section>
        
        <!-- Highlights / Featured Runs -->
        <section class="tab-panel" data-panel="highlights">
        <div class="card mb-4">
          <h2>üìå Highlights</h2>
          <p class="muted mb-3">Pin up to 3 of your best runs to the top of your profile. These show as cards with the game cover art.</p>
          
          <div id="highlights-editor">
            <div id="highlights-list" class="highlights-editor-list">
              <!-- Populated by JavaScript -->
            </div>
            
            <button type="button" class="btn btn--small mt-3" id="add-highlight-btn">
              + Add Highlight
            </button>
            <p class="form-help">You can pin up to 3 highlights.</p>
          </div>
          
          <input type="hidden" id="featured-runs-data" name="featured_runs" value="[]" />
        </div>
        </section>
        
        <!-- Submit -->
        <div class="form-actions">
          <button type="submit" class="btn btn--primary" id="save-btn">
            <span class="btn__text">Save Changes</span>
            <span class="btn__loading" hidden>
              <span class="spinner"></span>
              Saving...
            </span>
          </button>
          <a href="/profile/settings/" class="btn">Cancel</a>
        </div>
        
        <div id="form-message" class="form-message" hidden></div>
      </form>
    </div>
  </div>
</div>

{% include profile-form-styles.html %}

<style>
.profile-edit {
  max-width: 700px;
  margin: 0 auto;
}

/* Profile Preview */
.profile-preview {
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
}

.profile-preview__banner {
  height: 120px;
  background: linear-gradient(135deg, var(--accent), #1a1a2e);
  position: relative;
}

.profile-preview__banner img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-preview__content {
  display: flex;
  align-items: flex-end;
  padding: 0 1rem 1rem;
  margin-top: -40px;
  position: relative;
}

.profile-preview__avatar-wrap {
  flex-shrink: 0;
}

.profile-preview__avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 4px solid var(--surface);
  background: var(--surface);
  object-fit: cover;
}

.profile-preview__info {
  padding: 0.5rem 0 0 1rem;
}

.profile-preview__name {
  font-size: 1.25rem;
  font-weight: 700;
  display: block;
}

.profile-preview__pronouns {
  font-size: 0.85rem;
}

/* Form Layout */
.form-group {
  margin-bottom: 1.25rem;
}

.form-group--flex {
  flex: 1;
}

.form-row {
  display: flex;
  gap: 1rem;
}

@media (max-width: 600px) {
  .form-row {
    flex-direction: column;
  }
}

.accent-color-input {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.accent-color-input input[type="color"] {
  width: 48px;
  height: 40px;
  padding: 0;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  background: transparent;
}

.accent-color-input .form-input {
  flex: 1;
  max-width: 120px;
  font-family: monospace;
  text-transform: uppercase;
}

.form-label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.form-input,
.form-textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--surface);
  color: var(--fg);
  font-size: 1rem;
  transition: border-color 0.15s ease;
}

.form-input:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--accent);
}

.form-input:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.form-help {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-top: 0.35rem;
}

/* Color Picker */
.color-picker-wrap {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.form-color {
  width: 50px;
  height: 40px;
  padding: 0;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
}

.form-input--color {
  width: 100px;
  font-family: monospace;
}

/* Other Links */
.other-links-section {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border);
}

.other-link-row {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.other-link-row input {
  flex: 1;
}

.other-link-row .btn {
  flex-shrink: 0;
}

/* Privacy Toggles */
.privacy-toggles {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.toggle-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  cursor: pointer;
}

.toggle-row input[type="checkbox"] {
  width: 44px;
  height: 24px;
  appearance: none;
  background: var(--border);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.2s ease;
}

.toggle-row input[type="checkbox"]::before {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: transform 0.2s ease;
}

.toggle-row input[type="checkbox"]:checked {
  background: var(--accent);
}

.toggle-row input[type="checkbox"]:checked::before {
  transform: translateX(20px);
}

.toggle-label {
  font-size: 0.95rem;
}

/* Form Actions */
.form-actions {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.form-message {
  margin-top: 1rem;
  padding: 0.75rem 1rem;
  border-radius: var(--radius-sm);
}

.form-message.is-success {
  background: rgba(40, 167, 69, 0.1);
  color: #28a745;
  border: 1px solid rgba(40, 167, 69, 0.3);
}

.form-message.is-error {
  background: rgba(220, 53, 69, 0.1);
  color: #dc3545;
  border: 1px solid rgba(220, 53, 69, 0.3);
}

/* Highlights Editor */
.highlights-editor-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.highlight-editor-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
}

.highlight-editor-item__header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
}

.highlight-editor-item__number {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--accent);
}

.highlight-editor-item__remove {
  margin-left: auto;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1.25rem;
  cursor: pointer;
  padding: 0 0.25rem;
  line-height: 1;
}

.highlight-editor-item__remove:hover {
  color: var(--danger, #ef4444);
}

.highlight-editor-item__content {
  padding: 0.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.highlight-editor-item .form-row {
  display: flex;
  gap: 0.75rem;
}

.highlight-editor-item .form-row > * {
  flex: 1;
}

.highlight-game-dropdown {
  position: relative;
}

.highlight-game-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--panel, var(--surface));
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  max-height: 180px;
  overflow-y: auto;
  z-index: 20;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.highlight-game-suggestions button {
  display: block;
  width: 100%;
  padding: 0.5rem 0.75rem;
  text-align: left;
  font-size: 0.9rem;
  color: var(--fg);
  background: transparent;
  border: none;
  cursor: pointer;
}

.highlight-game-suggestions button:hover {
  background: var(--bg-soft);
}

.highlight-game-suggestions button .game-id-hint {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-left: 0.5rem;
}

@media (max-width: 560px) {
  .highlight-editor-item .form-row {
    flex-direction: column;
  }
}

/* Social Input Validation */
.form-validation {
  display: block;
  font-size: 0.75rem;
  margin-top: 0.25rem;
  min-height: 1rem;
}
.form-validation.is-valid {
  color: #10b981;
}
.form-validation.is-invalid {
  color: #ef4444;
}
.social-input.is-invalid {
  border-color: #ef4444;
}
.social-input.is-valid {
  border-color: #10b981;
}

/* Approval Notice */
.approval-notice {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  background: rgba(245, 158, 11, 0.1);
  border: 1px solid rgba(245, 158, 11, 0.3);
  border-radius: var(--radius-sm);
  margin-bottom: 1rem;
  font-size: 0.85rem;
  color: #f59e0b;
}
.approval-icon {
  flex-shrink: 0;
}

/* Pending Links Notice */
.pending-links-notice {
  padding: 0.75rem 1rem;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: var(--radius-sm);
  margin-bottom: 1rem;
  font-size: 0.85rem;
}
.pending-links-notice p {
  margin: 0 0 0.5rem 0;
}
.pending-links-notice ul {
  margin: 0;
  padding-left: 1.25rem;
}
.pending-links-notice li {
  font-size: 0.8rem;
  color: var(--text-muted);
  word-break: break-all;
}

/* Avatar Upload */
.avatar-upload {
  display: flex;
  gap: 1.5rem;
  align-items: flex-start;
}

.avatar-upload__preview {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  overflow: hidden;
  background: var(--surface);
  border: 3px solid var(--border);
  cursor: pointer;
  flex-shrink: 0;
}

.avatar-upload__preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.avatar-upload__overlay {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s ease;
  font-size: 1.5rem;
}

.avatar-upload__preview:hover .avatar-upload__overlay {
  opacity: 1;
}

.avatar-upload__controls {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.avatar-upload__controls .btn {
  width: fit-content;
}

.avatar-message {
  margin-top: 0.75rem;
  padding: 0.5rem 0.75rem;
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
}

.avatar-message.is-success {
  background: rgba(16, 185, 129, 0.1);
  color: #10b981;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.avatar-message.is-error {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.avatar-message.is-info {
  background: rgba(59, 130, 246, 0.1);
  color: #3b82f6;
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.spinner--small {
  width: 14px;
  height: 14px;
  border-width: 2px;
}

@media (max-width: 480px) {
  .avatar-upload {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  
  .avatar-upload__controls {
    align-items: center;
  }
}

/* Profile Edit Tabs */
.profile-edit-tabs {
  margin-top: 1rem;
  margin-bottom: 0;
  flex-wrap: wrap;
}

.profile-edit-tabs + .tab-panel {
  border-top-left-radius: 0;
}

.profile-edit-tabs ~ .tab-panel {
  min-height: auto;
  padding: 1.25rem;
}

.profile-edit-tabs ~ .tab-panel > .card {
  border: none;
  background: transparent;
  padding: 0;
  margin: 0;
  box-shadow: none;
}

.profile-edit-tabs ~ .tab-panel > .card > h2 {
  display: none;
}

.profile-edit-tabs ~ .form-actions {
  margin-top: 1.25rem;
}

@media (max-width: 560px) {
  .profile-edit-tabs .tab {
    font-size: 0.8rem;
    padding: 0.45rem 0.55rem;
  }
}
</style>

<script>
// Profile edit tab switching
(function(){
  var tabs = Array.from(document.querySelectorAll('.profile-edit-tabs .tab'));
  var panels = Array.from(document.querySelectorAll('.profile-edit-tabs ~ .tab-panel[data-panel]'));
  function switchTab(name) {
    tabs.forEach(function(t) { t.classList.toggle('active', t.dataset.tab === name); });
    panels.forEach(function(p) { p.classList.toggle('active', p.dataset.panel === name); });
  }
  tabs.forEach(function(t) {
    t.addEventListener('click', function() { switchTab(t.dataset.tab); });
  });
})();
</script>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

const loadingState = document.getElementById('loading-state');
const notSignedIn = document.getElementById('not-signed-in');
const noProfile = document.getElementById('no-profile');
const editContent = document.getElementById('edit-content');
const form = document.getElementById('profile-form');
const formMessage = document.getElementById('form-message');

let supabase = null;
let currentProfile = null;
let otherLinks = [];
let highlightsData = []; // { game_id, game_name, category, achievement }
let formIndexGames = []; // loaded from form-index.json for autocomplete
const MAX_OTHER_LINKS = 3;

// Avatar upload constants
const AVATAR_BUCKET = 'avatars';
const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB
const ALLOWED_TYPES = ['image/png', 'image/jpeg', 'image/jpg'];

function showState(state) {
  loadingState.hidden = state !== 'loading';
  notSignedIn.hidden = state !== 'not-signed-in';
  noProfile.hidden = state !== 'no-profile';
  editContent.hidden = state !== 'edit';
}

function showMessage(text, type) {
  formMessage.textContent = text;
  formMessage.className = `form-message is-${type}`;
  formMessage.hidden = false;
  formMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function hideMessage() {
  formMessage.hidden = true;
}

// ============================================
// Avatar Upload
// ============================================
const avatarPreview = document.getElementById('avatar-preview');
const avatarFile = document.getElementById('avatar-file');
const avatarUploadBtn = document.getElementById('avatar-upload-btn');
const avatarRemoveBtn = document.getElementById('avatar-remove-btn');
const avatarOverlay = document.getElementById('avatar-overlay');
const avatarUrlInput = document.getElementById('avatar-url');
const avatarMessage = document.getElementById('avatar-message');

function showAvatarMessage(text, type) {
  if (!avatarMessage) return;
  avatarMessage.textContent = text;
  avatarMessage.className = `avatar-message is-${type}`;
  avatarMessage.hidden = false;
}

function hideAvatarMessage() {
  if (avatarMessage) avatarMessage.hidden = true;
}

function setAvatarLoading(isLoading) {
  if (!avatarUploadBtn) return;
  const textEl = avatarUploadBtn.querySelector('.btn__text');
  const loadingEl = avatarUploadBtn.querySelector('.btn__loading');
  
  avatarUploadBtn.disabled = isLoading;
  if (textEl) textEl.hidden = isLoading;
  if (loadingEl) loadingEl.hidden = !isLoading;
}

function updateAvatarPreview(url) {
  if (avatarPreview) {
    avatarPreview.src = url || '/assets/img/site/default-runner.png';
  }
  if (avatarUrlInput) {
    avatarUrlInput.value = url || '';
  }
  // Update the profile preview too
  const previewAvatar = document.getElementById('preview-avatar');
  if (previewAvatar) {
    previewAvatar.src = url || '/assets/img/site/default-runner.png';
  }
  // Show/hide remove button
  if (avatarRemoveBtn) {
    avatarRemoveBtn.hidden = !url;
  }
}

async function uploadAvatar(file) {
  hideAvatarMessage();
  
  // Validate file type
  if (!ALLOWED_TYPES.includes(file.type)) {
    showAvatarMessage('Please upload a PNG or JPG image.', 'error');
    return null;
  }
  
  // Validate file size
  if (file.size > MAX_FILE_SIZE) {
    showAvatarMessage('Image must be less than 2MB.', 'error');
    return null;
  }
  
  setAvatarLoading(true);
  
  try {
    const user = CRCAuth.getUser();
    if (!user) throw new Error('Not signed in');
    
    // Generate unique filename: user_id/timestamp.ext
    const ext = file.type === 'image/png' ? 'png' : 'jpg';
    const timestamp = Date.now();
    const filePath = `${user.id}/${timestamp}.${ext}`;
    
    // Delete old avatar if exists (clean up old files)
    if (currentProfile?.avatar_url) {
      try {
        const oldUrl = new URL(currentProfile.avatar_url);
        // Extract the path from the URL if it's from our storage
        if (oldUrl.hostname.includes('supabase')) {
          const pathMatch = oldUrl.pathname.match(/\/storage\/v1\/object\/public\/avatars\/(.+)/);
          if (pathMatch) {
            await supabase.storage.from(AVATAR_BUCKET).remove([pathMatch[1]]);
          }
        }
      } catch (e) {
        // Ignore errors when deleting old avatar
        console.log('Could not delete old avatar:', e);
      }
    }
    
    // Upload new avatar
    const { data, error } = await supabase.storage
      .from(AVATAR_BUCKET)
      .upload(filePath, file, {
        cacheControl: '3600',
        upsert: true
      });
    
    if (error) throw error;
    
    // Get public URL
    const { data: urlData } = supabase.storage
      .from(AVATAR_BUCKET)
      .getPublicUrl(filePath);
    
    const publicUrl = urlData.publicUrl;
    
    updateAvatarPreview(publicUrl);
    showAvatarMessage('Avatar uploaded! Remember to save your profile.', 'success');
    
    return publicUrl;
    
  } catch (err) {
    console.error('Avatar upload error:', err);
    showAvatarMessage(`Upload failed: ${err.message}`, 'error');
    return null;
  } finally {
    setAvatarLoading(false);
  }
}

async function removeAvatar() {
  hideAvatarMessage();
  
  try {
    const user = CRCAuth.getUser();
    if (!user) return;
    
    // Try to delete from storage if it's our hosted image
    if (currentProfile?.avatar_url) {
      try {
        const oldUrl = new URL(currentProfile.avatar_url);
        if (oldUrl.hostname.includes('supabase')) {
          const pathMatch = oldUrl.pathname.match(/\/storage\/v1\/object\/public\/avatars\/(.+)/);
          if (pathMatch) {
            await supabase.storage.from(AVATAR_BUCKET).remove([pathMatch[1]]);
          }
        }
      } catch (e) {
        console.log('Could not delete avatar from storage:', e);
      }
    }
    
    updateAvatarPreview(null);
    showAvatarMessage('Avatar removed. Remember to save your profile.', 'info');
    
  } catch (err) {
    showAvatarMessage(`Error: ${err.message}`, 'error');
  }
}

// Avatar event listeners
avatarUploadBtn?.addEventListener('click', () => {
  avatarFile?.click();
});

avatarOverlay?.addEventListener('click', () => {
  avatarFile?.click();
});

avatarFile?.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (file) {
    await uploadAvatar(file);
  }
  // Reset file input so same file can be selected again
  e.target.value = '';
});

avatarRemoveBtn?.addEventListener('click', removeAvatar);

// ============================================
// Social URL Validation
// ============================================
const SOCIAL_DOMAINS = {
  twitch: ['twitch.tv'],
  youtube: ['youtube.com', 'youtu.be', 'www.youtube.com'],
  discord: ['discord.gg', 'discord.com'],
  twitter: ['twitter.com', 'x.com'],
  bluesky: ['bsky.app'],
  instagram: ['instagram.com', 'www.instagram.com'],
  speedruncom: ['speedrun.com', 'www.speedrun.com'],
  steam: ['steamcommunity.com']
};

function validateSocialUrl(input) {
  const value = input.value.trim();
  const id = input.id;
  const validationEl = document.getElementById(`${id}-validation`);
  
  // If empty, clear validation
  if (!value) {
    input.classList.remove('is-valid', 'is-invalid');
    if (validationEl) validationEl.textContent = '';
    return { valid: true, empty: true };
  }
  
  // Check if it's a valid URL first
  let url;
  try {
    url = new URL(value);
  } catch {
    input.classList.remove('is-valid');
    input.classList.add('is-invalid');
    if (validationEl) {
      validationEl.textContent = '‚úó Invalid URL format';
      validationEl.className = 'form-validation is-invalid';
    }
    return { valid: false, error: 'Invalid URL format' };
  }
  
  // Check domain
  const allowedDomains = SOCIAL_DOMAINS[id] || [];
  const hostname = url.hostname.replace('www.', '');
  
  if (allowedDomains.length > 0 && !allowedDomains.some(d => hostname === d || hostname === 'www.' + d)) {
    input.classList.remove('is-valid');
    input.classList.add('is-invalid');
    if (validationEl) {
      validationEl.textContent = `‚úó Must be a ${allowedDomains[0]} link`;
      validationEl.className = 'form-validation is-invalid';
    }
    return { valid: false, error: `Invalid domain for ${id}` };
  }
  
  // Valid!
  input.classList.remove('is-invalid');
  input.classList.add('is-valid');
  if (validationEl) {
    validationEl.textContent = '‚úì Valid';
    validationEl.className = 'form-validation is-valid';
  }
  return { valid: true };
}

function validateAllSocials() {
  const socialInputs = document.querySelectorAll('.social-input');
  const errors = [];
  
  socialInputs.forEach(input => {
    const result = validateSocialUrl(input);
    if (!result.valid) {
      errors.push(`${input.id}: ${result.error}`);
    }
  });
  
  return errors;
}

// Add validation listeners to all social inputs
document.querySelectorAll('.social-input').forEach(input => {
  input.addEventListener('blur', () => validateSocialUrl(input));
  input.addEventListener('input', () => {
    // Clear invalid state on typing
    if (input.classList.contains('is-invalid')) {
      input.classList.remove('is-invalid');
      const validationEl = document.getElementById(`${input.id}-validation`);
      if (validationEl) validationEl.textContent = '';
    }
  });
});

// ============================================
// Schema Validation
// ============================================
const VALIDATION_SCHEMA = {
  display_name: {
    required: true,
    minLength: 2,
    maxLength: 50,
    pattern: /^[^<>{}[\]\\\/]+$/,
    errorMsg: 'Display name must be 2-50 characters, no special symbols'
  },
  pronouns: {
    maxLength: 30,
    pattern: /^[a-zA-Z\/\s]*$/,
    errorMsg: 'Pronouns can only contain letters, slashes, and spaces'
  },
  location: {
    maxLength: 50,
    pattern: /^[^<>{}[\]\\]*$/,
    errorMsg: 'Location contains invalid characters'
  },
  bio: {
    maxLength: 1000
  },
  status_message: {
    maxLength: 100,
    pattern: /^[^<>{}[\]\\]*$/,
    errorMsg: 'Status message contains invalid characters'
  },
  avatar_url: {
    pattern: /^(https?:\/\/|$)/,
    errorMsg: 'Avatar must be a valid URL starting with http:// or https://'
  },
  accent_color: {
    pattern: /^(#[0-9A-Fa-f]{6}|)$/,
    errorMsg: 'Accent color must be a hex code like #3BC36E'
  }
};

function validateField(name, value) {
  const schema = VALIDATION_SCHEMA[name];
  if (!schema) return { valid: true };
  
  if (schema.required && !value) {
    return { valid: false, error: `${name} is required` };
  }
  
  if (value) {
    if (schema.minLength && value.length < schema.minLength) {
      return { valid: false, error: schema.errorMsg || `${name} is too short` };
    }
    if (schema.maxLength && value.length > schema.maxLength) {
      return { valid: false, error: `${name} is too long (max ${schema.maxLength})` };
    }
    if (schema.pattern && !schema.pattern.test(value)) {
      return { valid: false, error: schema.errorMsg || `${name} contains invalid characters` };
    }
  }
  
  return { valid: true };
}

function validateForm() {
  const errors = [];
  
  // Validate basic fields
  const fields = ['display_name', 'pronouns', 'location', 'bio', 'status_message', 'avatar_url', 'accent_color'];
  fields.forEach(field => {
    const input = document.getElementById(field.replace(/_/g, '-'));
    if (input) {
      const result = validateField(field, input.value.trim());
      if (!result.valid) {
        errors.push(result.error);
      }
    }
  });
  
  // Validate display name specifically
  const displayName = document.getElementById('display-name')?.value.trim();
  if (!displayName) {
    errors.push('Display name is required');
  }
  
  // Validate social URLs
  const socialErrors = validateAllSocials();
  errors.push(...socialErrors);
  
  // Validate other links (must be valid URLs)
  otherLinks.forEach((link, i) => {
    if (link.trim()) {
      try {
        new URL(link);
      } catch {
        errors.push(`Other link ${i + 1} is not a valid URL`);
      }
    }
  });
  
  return errors;
}

// Live preview updates
document.getElementById('display-name')?.addEventListener('input', (e) => {
  document.getElementById('preview-name').textContent = e.target.value || 'Display Name';
});

document.getElementById('pronouns')?.addEventListener('input', (e) => {
  const pronounsEl = document.getElementById('preview-pronouns');
  pronounsEl.textContent = e.target.value ? `(${e.target.value})` : '';
});

document.getElementById('avatar-url')?.addEventListener('change', (e) => {
  const url = e.target.value;
  if (url) {
    document.getElementById('preview-avatar').src = url;
  }
});

document.getElementById('banner-url')?.addEventListener('change', (e) => {
  const url = e.target.value;
  if (url) {
    document.getElementById('preview-banner-img').src = url;
  }
});

// Color picker sync
document.getElementById('accent-color-picker')?.addEventListener('input', (e) => {
  document.getElementById('accent-color').value = e.target.value;
});

document.getElementById('accent-color')?.addEventListener('input', (e) => {
  const val = e.target.value;
  if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
    document.getElementById('accent-color-picker').value = val;
  }
});

// Bio character counter
document.getElementById('bio')?.addEventListener('input', (e) => {
  document.getElementById('bio-count').textContent = e.target.value.length;
});

// Other links management
function renderOtherLinks() {
  const container = document.getElementById('other-links-container');
  container.innerHTML = otherLinks.map((link, i) => `
    <div class="other-link-row">
      <input type="url" value="${link}" placeholder="https://..." data-index="${i}" class="form-input other-link-input" />
      <button type="button" class="btn btn--small btn--danger" data-remove="${i}">‚úï</button>
    </div>
  `).join('');
  
  container.querySelectorAll('.other-link-input').forEach(input => {
    input.addEventListener('input', (e) => {
      otherLinks[parseInt(e.target.dataset.index)] = e.target.value;
    });
  });
  
  container.querySelectorAll('[data-remove]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      otherLinks.splice(parseInt(e.target.dataset.remove), 1);
      renderOtherLinks();
    });
  });
  
  document.getElementById('add-other-link').hidden = otherLinks.length >= MAX_OTHER_LINKS;
}

document.getElementById('add-other-link')?.addEventListener('click', () => {
  if (otherLinks.length < MAX_OTHER_LINKS) {
    otherLinks.push('');
    renderOtherLinks();
  }
});

// =========================================================
// Highlights Editor
// =========================================================

// Load game list from form-index.json for autocomplete
async function loadFormIndex() {
  try {
    const resp = await fetch('/assets/generated/form-index.json');
    if (!resp.ok) return;
    const data = await resp.json();
    formIndexGames = (data.games || []).map(g => ({
      game_id: g.game_id,
      title: g.title,
      categories: [
        ...(g.category_tiers?.full_runs || []).map(c => c.name),
        ...(g.category_tiers?.mini_challenges || []).map(c => c.name)
      ]
    }));
  } catch (e) {
    console.warn('[Highlights] Could not load form-index.json:', e);
  }
}

const MAX_HIGHLIGHTS = 3;

function initHighlightsEditor(existing) {
  highlightsData = (existing || []).map(h => ({
    game_id: h.game_id || '',
    game_name: h.game_name || '',
    category: h.category || '',
    achievement: h.achievement || ''
  }));
  renderHighlightsEditor();
}

function renderHighlightsEditor() {
  const listEl = document.getElementById('highlights-list');
  const addBtn = document.getElementById('add-highlight-btn');
  if (!listEl) return;
  
  listEl.innerHTML = '';
  
  highlightsData.forEach((hl, idx) => {
    const item = document.createElement('div');
    item.className = 'highlight-editor-item';
    item.innerHTML = `
      <div class="highlight-editor-item__header">
        <span class="highlight-editor-item__number">#${idx + 1}</span>
        <button type="button" class="highlight-editor-item__remove" title="Remove highlight">√ó</button>
      </div>
      <div class="highlight-editor-item__content">
        <div class="form-row">
          <div class="highlight-game-dropdown">
            <label class="form-label">Game</label>
            <input type="text" class="form-input highlight-game-input" 
                   value="${escapeAttr(hl.game_name || hl.game_id)}" 
                   placeholder="Type a game name..." autocomplete="off" />
            <div class="highlight-game-suggestions" hidden></div>
            <input type="hidden" class="highlight-game-id" value="${escapeAttr(hl.game_id)}" />
          </div>
          <div>
            <label class="form-label">Category</label>
            <input type="text" class="form-input highlight-category-input" 
                   value="${escapeAttr(hl.category)}" 
                   placeholder="e.g., Underworld Any%" />
          </div>
        </div>
        <div>
          <label class="form-label">Note <span class="muted">(optional)</span></label>
          <input type="text" class="form-input highlight-achievement-input" 
                 value="${escapeAttr(hl.achievement)}" 
                 placeholder="e.g., First hitless clear" maxlength="100" />
        </div>
      </div>
    `;
    
    // Remove button
    item.querySelector('.highlight-editor-item__remove').addEventListener('click', () => {
      highlightsData.splice(idx, 1);
      renderHighlightsEditor();
    });
    
    // Game autocomplete
    const gameInput = item.querySelector('.highlight-game-input');
    const gameIdInput = item.querySelector('.highlight-game-id');
    const sugBox = item.querySelector('.highlight-game-suggestions');
    
    gameInput.addEventListener('input', () => {
      const q = gameInput.value.toLowerCase().trim();
      gameIdInput.value = '';
      highlightsData[idx].game_id = '';
      highlightsData[idx].game_name = gameInput.value;
      
      if (!q || formIndexGames.length === 0) {
        sugBox.hidden = true;
        return;
      }
      
      const matches = formIndexGames
        .filter(g => g.title.toLowerCase().includes(q) || g.game_id.includes(q))
        .slice(0, 8);
      
      if (matches.length === 0) {
        sugBox.hidden = true;
        return;
      }
      
      sugBox.innerHTML = matches.map(g => 
        `<button type="button" data-id="${escapeAttr(g.game_id)}" data-title="${escapeAttr(g.title)}">
          ${escapeHtml(g.title)}<span class="game-id-hint">${escapeHtml(g.game_id)}</span>
        </button>`
      ).join('');
      sugBox.hidden = false;
      
      sugBox.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const gid = btn.dataset.id;
          const gtitle = btn.dataset.title;
          gameInput.value = gtitle;
          gameIdInput.value = gid;
          highlightsData[idx].game_id = gid;
          highlightsData[idx].game_name = gtitle;
          sugBox.hidden = true;
          
          // Auto-fill category suggestions
          const game = formIndexGames.find(g => g.game_id === gid);
          if (game && game.categories.length > 0) {
            const catInput = item.querySelector('.highlight-category-input');
            if (!catInput.value) catInput.placeholder = game.categories[0];
          }
        });
      });
    });
    
    gameInput.addEventListener('focus', () => {
      if (gameInput.value && !gameIdInput.value) {
        gameInput.dispatchEvent(new Event('input'));
      }
    });
    
    // Close suggestions on outside click
    document.addEventListener('pointerdown', (e) => {
      if (!item.querySelector('.highlight-game-dropdown').contains(e.target)) {
        sugBox.hidden = true;
      }
    }, true);
    
    // Category + achievement sync
    const catInput = item.querySelector('.highlight-category-input');
    const achInput = item.querySelector('.highlight-achievement-input');
    
    catInput.addEventListener('input', () => {
      highlightsData[idx].category = catInput.value;
    });
    achInput.addEventListener('input', () => {
      highlightsData[idx].achievement = achInput.value;
    });
    
    listEl.appendChild(item);
  });
  
  // Update hidden input
  syncHighlightsData();
  
  // Toggle add button
  if (addBtn) {
    addBtn.disabled = highlightsData.length >= MAX_HIGHLIGHTS;
    addBtn.textContent = highlightsData.length >= MAX_HIGHLIGHTS 
      ? `Maximum ${MAX_HIGHLIGHTS} highlights reached` 
      : '+ Add Highlight';
  }
}

function syncHighlightsData() {
  const clean = highlightsData
    .filter(h => h.game_id && h.category)
    .map(h => ({
      game_id: h.game_id,
      game_name: h.game_name || '',
      category: h.category,
      achievement: h.achievement || ''
    }));
  const el = document.getElementById('featured-runs-data');
  if (el) el.value = JSON.stringify(clean);
}

function escapeAttr(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Add highlight button
document.getElementById('add-highlight-btn')?.addEventListener('click', () => {
  if (highlightsData.length >= MAX_HIGHLIGHTS) return;
  highlightsData.push({ game_id: '', game_name: '', category: '', achievement: '' });
  renderHighlightsEditor();
  // Focus the new game input
  const inputs = document.querySelectorAll('.highlight-game-input');
  if (inputs.length) inputs[inputs.length - 1].focus();
});


// Populate form with current profile data
function populateForm(profile) {
  document.getElementById('runner-id').value = profile.runner_id || '';
  document.getElementById('display-name').value = profile.display_name || '';
  document.getElementById('pronouns').value = profile.pronouns || '';
  document.getElementById('location').value = profile.location || '';
  document.getElementById('bio').value = profile.bio || '';
  document.getElementById('status-message').value = profile.status_message || '';
  
  // Customization - Avatar
  document.getElementById('avatar-url').value = profile.avatar_url || '';
  updateAvatarPreview(profile.avatar_url);
  
  // Update profile card preview
  document.getElementById('preview-name').textContent = profile.display_name || 'Display Name';
  document.getElementById('preview-pronouns').textContent = profile.pronouns ? `(${profile.pronouns})` : '';
  if (profile.avatar_url) document.getElementById('preview-avatar').src = profile.avatar_url;
  
  // Update bio counter
  document.getElementById('bio-count').textContent = (profile.bio || '').length;
  
  // Accent color (from theme_settings)
  const themeSettings = profile.theme_settings || {};
  const accentColor = themeSettings.accent || '#3BC36E';
  document.getElementById('accent-color').value = accentColor;
  document.getElementById('accent-color-picker').value = accentColor;
  
  // Social links
  const socials = profile.socials || {};
  document.getElementById('twitch').value = socials.twitch || '';
  document.getElementById('youtube').value = socials.youtube || '';
  document.getElementById('discord').value = socials.discord || '';
  document.getElementById('twitter').value = socials.twitter || '';
  document.getElementById('bluesky').value = socials.bluesky || '';
  document.getElementById('instagram').value = socials.instagram || '';
  document.getElementById('speedruncom').value = socials.speedruncom || '';
  document.getElementById('steam').value = socials.steam || '';
  
  // Other links (show approved ones, or pending for editing)
  otherLinks = socials.other || [];
  renderOtherLinks();
  
  // Show pending notice if there are pending other links
  if (profile.other_links_pending && profile.other_links_pending.length > 0) {
    showPendingLinksNotice(profile.other_links_pending);
  }
  
  // Personal Goals - load into editor
  if (window.initPersonalGoalsEditor) {
    window.initPersonalGoalsEditor(profile.personal_goals || []);
  }
  
  // Highlights / Featured Runs - load into editor
  initHighlightsEditor(profile.featured_runs || []);
}

function showPendingLinksNotice(pendingLinks) {
  const container = document.getElementById('other-links-container');
  const notice = document.createElement('div');
  notice.className = 'pending-links-notice';
  notice.innerHTML = `
    <p><strong>Pending approval:</strong></p>
    <ul>${pendingLinks.map(l => `<li>${l}</li>`).join('')}</ul>
  `;
  container.parentNode.insertBefore(notice, container);
}

// Handle form submission
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  hideMessage();
  
  const saveBtn = document.getElementById('save-btn');
  const btnText = saveBtn.querySelector('.btn__text');
  const btnLoading = saveBtn.querySelector('.btn__loading');
  
  saveBtn.disabled = true;
  btnText.hidden = true;
  btnLoading.hidden = false;
  
  try {
    // Get current theme_settings to preserve other theme options
    const user = CRCAuth.getUser();
    let currentThemeSettings = {};
    try {
      const { data: profileData } = await supabase
        .from('runner_profiles')
        .select('theme_settings')
        .eq('user_id', user.id)
        .single();
      currentThemeSettings = profileData?.theme_settings || {};
    } catch (e) {
      // Ignore - will use empty object
    }
    
    // Update accent color in theme_settings
    const accentColor = document.getElementById('accent-color').value.trim();
    if (accentColor && /^#[0-9A-Fa-f]{6}$/.test(accentColor)) {
      currentThemeSettings.accent = accentColor;
      // Calculate RGB for CSS variable
      const r = parseInt(accentColor.slice(1, 3), 16);
      const g = parseInt(accentColor.slice(3, 5), 16);
      const b = parseInt(accentColor.slice(5, 7), 16);
      currentThemeSettings.accentRgb = `${r}, ${g}, ${b}`;
    }
    
    // Run validation first
    const validationErrors = validateForm();
    if (validationErrors.length > 0) {
      throw new Error(validationErrors[0]);
    }
    
    // Get the current approved other links from the profile
    const currentOtherLinks = currentProfile?.socials?.other || [];
    const newOtherLinks = otherLinks.filter(l => l.trim());
    
    // Check if other links changed - if so, put them in pending
    const otherLinksChanged = JSON.stringify(currentOtherLinks) !== JSON.stringify(newOtherLinks);
    
    const formData = {
      display_name: document.getElementById('display-name').value.trim(),
      pronouns: document.getElementById('pronouns').value.trim() || null,
      location: document.getElementById('location').value.trim() || null,
      bio: document.getElementById('bio').value.trim() || null,
      status_message: document.getElementById('status-message').value.trim() || null,
      avatar_url: document.getElementById('avatar-url').value.trim() || null,
      theme_settings: currentThemeSettings,
      socials: {
        twitch: document.getElementById('twitch').value.trim() || null,
        youtube: document.getElementById('youtube').value.trim() || null,
        discord: document.getElementById('discord').value.trim() || null,
        twitter: document.getElementById('twitter').value.trim() || null,
        bluesky: document.getElementById('bluesky').value.trim() || null,
        instagram: document.getElementById('instagram').value.trim() || null,
        speedruncom: document.getElementById('speedruncom').value.trim() || null,
        steam: document.getElementById('steam').value.trim() || null,
        // Keep current approved links, new ones go to pending
        other: otherLinksChanged ? currentOtherLinks : newOtherLinks
      },
      updated_at: new Date().toISOString()
    };
    
    // Personal goals
    try {
      const goalsJson = document.getElementById('personal-goals-data')?.value || '[]';
      formData.personal_goals = JSON.parse(goalsJson);
    } catch (e) {
      formData.personal_goals = [];
    }
    
    // Featured runs / highlights
    try {
      const highlightsJson = document.getElementById('featured-runs-data')?.value || '[]';
      formData.featured_runs = JSON.parse(highlightsJson);
    } catch (e) {
      formData.featured_runs = [];
    }
    
    // If other links changed, add them to pending for approval
    if (otherLinksChanged && newOtherLinks.length > 0) {
      formData.other_links_pending = newOtherLinks;
    }
    
    if (!formData.display_name) {
      throw new Error('Display name is required');
    }
    
    const { error } = await supabase
      .from('runner_profiles')
      .update(formData)
      .eq('user_id', user.id);
    
    if (error) throw error;
    
    // Also update localStorage theme
    localStorage.setItem('crc-theme', JSON.stringify(currentThemeSettings));
    
    if (otherLinksChanged && newOtherLinks.length > 0) {
      showMessage('Profile saved! Other links submitted for approval.', 'success');
    } else {
      showMessage('Profile saved successfully!', 'success');
    }
    await CRCAuth.init();
    
  } catch (err) {
    showMessage(`Error: ${err.message}`, 'error');
  } finally {
    saveBtn.disabled = false;
    btnText.hidden = false;
    btnLoading.hidden = true;
  }
});

// Initialize
(async function() {
  showState('loading');
  
  await CRCAuth.init();
  
  if (!CRCAuth.isSignedIn()) {
    showState('not-signed-in');
    return;
  }
  
  supabase = CRCAuth.getSupabaseClient();
  if (!supabase) {
    showMessage('Could not initialize database connection', 'error');
    showState('not-signed-in');
    return;
  }
  
  const user = CRCAuth.getUser();
  const { data: profile, error } = await supabase
    .from('runner_profiles')
    .select('*')
    .eq('user_id', user.id)
    .single();
  
  if (error || !profile) {
    showState('no-profile');
    return;
  }
  
  currentProfile = profile;
  populateForm(profile);
  
  if (profile.runner_id) {
    loadFormIndex(); // Load game data for highlight autocomplete
  }
  
  showState('edit');
})();
</script>
