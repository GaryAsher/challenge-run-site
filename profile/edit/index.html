---
layout: default
title: "Edit Profile"
---

<div class="page-width">
  <p class="muted mb-3">
    <a href="javascript:history.back()">‚Üê Back</a>
  </p>

  <div class="profile-edit">
    <!-- Loading state -->
    <div id="loading-state" class="card">
      <div class="sign-in-loading">
        <div class="spinner"></div>
        <p class="muted">Loading profile...</p>
      </div>
    </div>

    <!-- Not signed in -->
    <div id="not-signed-in" class="card" hidden>
      <h1>Edit Profile</h1>
      <p class="muted">You need to sign in to edit your profile.</p>
      <a href="{{ '/sign-in/' | relative_url }}" class="btn btn--primary">Sign In</a>
    </div>

    <!-- No profile yet -->
    <div id="no-profile" class="card" hidden>
      <h1>No Profile Found</h1>
      <p class="muted">You haven't created a runner profile yet.</p>
      <a href="{{ '/profile/create/' | relative_url }}" class="btn btn--primary">Create Profile</a>
    </div>

    <!-- Edit form -->
    <div id="edit-content" hidden>
      <h1>Edit Profile</h1>
      <p class="muted mb-4">Update your runner profile information. Changes are saved to the database and will sync to the site.</p>
      
      <form id="profile-form" class="profile-form">
        <!-- Profile Preview -->
        <div class="card mb-4">
          <h2>üñºÔ∏è Profile Preview</h2>
          <div class="profile-preview">
            <div class="profile-preview__banner" id="preview-banner">
              <img src="/assets/img/site/default-banner.jpg" alt="" id="preview-banner-img" />
            </div>
            <div class="profile-preview__content">
              <div class="profile-preview__avatar-wrap">
                <img src="/assets/img/site/default-runner.png" alt="" class="profile-preview__avatar" id="preview-avatar" />
              </div>
              <div class="profile-preview__info">
                <span class="profile-preview__name" id="preview-name">Display Name</span>
                <span class="profile-preview__pronouns muted" id="preview-pronouns"></span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Basic Info -->
        <div class="card mb-4">
          <h2>üë§ Basic Info</h2>
          
          <div class="form-group">
            <label class="form-label">Runner ID</label>
            <input type="text" id="runner-id" class="form-input" disabled />
            <p class="form-help">Your unique identifier (cannot be changed)</p>
          </div>
          
          <div class="form-row">
            <div class="form-group form-group--flex">
              <label class="form-label" for="display-name">Display Name *</label>
              <input type="text" id="display-name" name="display_name" class="form-input" required maxlength="50" />
              <p class="form-help">The name shown on your profile</p>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="pronouns">Pronouns</label>
              <input type="text" id="pronouns" name="pronouns" class="form-input" maxlength="30" placeholder="e.g., they/them" />
              <p class="form-help">Optional, displayed next to your name</p>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="location">Location</label>
            <input type="text" id="location" name="location" class="form-input" maxlength="50" placeholder="e.g., United States" />
            <p class="form-help">Country or region (optional)</p>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="bio">Bio</label>
            <textarea id="bio" name="bio" class="form-textarea" rows="4" maxlength="1000" placeholder="Tell others about yourself and your challenge run journey..."></textarea>
            <p class="form-help"><span id="bio-count">0</span>/1000 characters</p>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="status-message">Status Message</label>
            <input type="text" id="status-message" name="status_message" class="form-input" maxlength="100" placeholder="Finishing my profile, then back to runs!" />
            <p class="form-help">A short status message shown on your profile (not approval status)</p>
          </div>
        </div>
        
        <!-- Avatar & Accent Color -->
        <div class="card mb-4">
          <h2>üé® Customization</h2>
          <p class="muted mb-3">Customize your profile appearance.</p>
          
          <div class="form-group">
            <label class="form-label" for="avatar-url">Avatar URL</label>
            <input type="url" id="avatar-url" name="avatar_url" class="form-input" placeholder="https://example.com/avatar.png" />
            <p class="form-help">
              Direct link to your avatar image (recommended: 200x200px, PNG or JPG)<br>
              <span class="muted">Tip: Upload your image to <a href="https://imgur.com" target="_blank" rel="noopener">Imgur</a> or <a href="https://imgbb.com" target="_blank" rel="noopener">ImgBB</a> and paste the direct link here</span>
            </p>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="accent-color">Accent Color</label>
            <div class="accent-color-input">
              <input type="color" id="accent-color-picker" value="#3BC36E" />
              <input type="text" id="accent-color" name="accent_color" class="form-input" placeholder="#3BC36E" maxlength="7" />
            </div>
            <p class="form-help">Hex color code for your profile accent (e.g., #3BC36E)</p>
          </div>
        </div>
        
        <!-- Social Links -->
        <div class="card mb-4">
          <h2>üîó Social Links</h2>
          <p class="muted mb-3">Add links to your streaming and social accounts.</p>
          
          <div class="form-row">
            <div class="form-group form-group--flex">
              <label class="form-label" for="twitch">Twitch</label>
              <input type="url" id="twitch" name="twitch" class="form-input social-input" data-domain="twitch.tv" placeholder="https://twitch.tv/username" />
              <span class="form-validation" id="twitch-validation"></span>
            </div>
            
            <div class="form-group form-group--flex">
              <label class="form-label" for="youtube">YouTube</label>
              <input type="url" id="youtube" name="youtube" class="form-input social-input" data-domain="youtube.com,youtu.be" placeholder="https://youtube.com/@channel" />
              <span class="form-validation" id="youtube-validation"></span>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group form-group--flex">
              <label class="form-label" for="discord">Discord</label>
              <input type="url" id="discord" name="discord" class="form-input social-input" data-domain="discord.gg,discord.com" placeholder="https://discord.gg/invite" />
              <span class="form-validation" id="discord-validation"></span>
            </div>
            
            <div class="form-group form-group--flex">
              <label class="form-label" for="twitter">Twitter/X</label>
              <input type="url" id="twitter" name="twitter" class="form-input social-input" data-domain="twitter.com,x.com" placeholder="https://twitter.com/username" />
              <span class="form-validation" id="twitter-validation"></span>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group form-group--flex">
              <label class="form-label" for="bluesky">Bluesky</label>
              <input type="url" id="bluesky" name="bluesky" class="form-input social-input" data-domain="bsky.app" placeholder="https://bsky.app/profile/username" />
              <span class="form-validation" id="bluesky-validation"></span>
            </div>
            
            <div class="form-group form-group--flex">
              <label class="form-label" for="instagram">Instagram</label>
              <input type="url" id="instagram" name="instagram" class="form-input social-input" data-domain="instagram.com" placeholder="https://instagram.com/username" />
              <span class="form-validation" id="instagram-validation"></span>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group form-group--flex">
              <label class="form-label" for="speedruncom">Speedrun.com</label>
              <input type="url" id="speedruncom" name="speedruncom" class="form-input social-input" data-domain="speedrun.com" placeholder="https://speedrun.com/users/username" />
              <span class="form-validation" id="speedruncom-validation"></span>
            </div>
            
            <div class="form-group form-group--flex">
              <label class="form-label" for="steam">Steam</label>
              <input type="url" id="steam" name="steam" class="form-input social-input" data-domain="steamcommunity.com" placeholder="https://steamcommunity.com/id/username" />
              <span class="form-validation" id="steam-validation"></span>
            </div>
          </div>
          
          <!-- Other Links -->
          <div class="other-links-section">
            <label class="form-label">Other Links</label>
            <div class="approval-notice">
              <span class="approval-icon">‚ö†Ô∏è</span>
              <span>Other links require moderator approval before appearing on your profile.</span>
            </div>
            <div id="other-links-container"></div>
            <button type="button" class="btn btn--small mt-2" id="add-other-link">+ Add Link</button>
            <p class="form-help">Up to 3 additional links (must be valid URLs)</p>
          </div>
        </div>
        
        <!-- Submit -->
        <div class="form-actions">
          <button type="submit" class="btn btn--primary" id="save-btn">
            <span class="btn__text">Save Changes</span>
            <span class="btn__loading" hidden>
              <span class="spinner"></span>
              Saving...
            </span>
          </button>
          <a href="/profile/settings/" class="btn">Cancel</a>
        </div>
        
        <div id="form-message" class="form-message" hidden></div>
      </form>
    </div>
  </div>
</div>

{% include profile-form-styles.html %}

<style>
.profile-edit {
  max-width: 700px;
  margin: 0 auto;
}

/* Profile Preview */
.profile-preview {
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
}

.profile-preview__banner {
  height: 120px;
  background: linear-gradient(135deg, var(--accent), #1a1a2e);
  position: relative;
}

.profile-preview__banner img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-preview__content {
  display: flex;
  align-items: flex-end;
  padding: 0 1rem 1rem;
  margin-top: -40px;
  position: relative;
}

.profile-preview__avatar-wrap {
  flex-shrink: 0;
}

.profile-preview__avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 4px solid var(--surface);
  background: var(--surface);
  object-fit: cover;
}

.profile-preview__info {
  padding: 0.5rem 0 0 1rem;
}

.profile-preview__name {
  font-size: 1.25rem;
  font-weight: 700;
  display: block;
}

.profile-preview__pronouns {
  font-size: 0.85rem;
}

/* Form Layout */
.form-group {
  margin-bottom: 1.25rem;
}

.form-group--flex {
  flex: 1;
}

.form-row {
  display: flex;
  gap: 1rem;
}

@media (max-width: 600px) {
  .form-row {
    flex-direction: column;
  }
}

.accent-color-input {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.accent-color-input input[type="color"] {
  width: 48px;
  height: 40px;
  padding: 0;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  background: transparent;
}

.accent-color-input .form-input {
  flex: 1;
  max-width: 120px;
  font-family: monospace;
  text-transform: uppercase;
}

.form-label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.form-input,
.form-textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--surface);
  color: var(--fg);
  font-size: 1rem;
  transition: border-color 0.15s ease;
}

.form-input:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--accent);
}

.form-input:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.form-help {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-top: 0.35rem;
}

/* Color Picker */
.color-picker-wrap {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.form-color {
  width: 50px;
  height: 40px;
  padding: 0;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
}

.form-input--color {
  width: 100px;
  font-family: monospace;
}

/* Other Links */
.other-links-section {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border);
}

.other-link-row {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.other-link-row input {
  flex: 1;
}

.other-link-row .btn {
  flex-shrink: 0;
}

/* Privacy Toggles */
.privacy-toggles {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.toggle-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  cursor: pointer;
}

.toggle-row input[type="checkbox"] {
  width: 44px;
  height: 24px;
  appearance: none;
  background: var(--border);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.2s ease;
}

.toggle-row input[type="checkbox"]::before {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: transform 0.2s ease;
}

.toggle-row input[type="checkbox"]:checked {
  background: var(--accent);
}

.toggle-row input[type="checkbox"]:checked::before {
  transform: translateX(20px);
}

.toggle-label {
  font-size: 0.95rem;
}

/* Form Actions */
.form-actions {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.form-message {
  margin-top: 1rem;
  padding: 0.75rem 1rem;
  border-radius: var(--radius-sm);
}

.form-message.is-success {
  background: rgba(40, 167, 69, 0.1);
  color: #28a745;
  border: 1px solid rgba(40, 167, 69, 0.3);
}

.form-message.is-error {
  background: rgba(220, 53, 69, 0.1);
  color: #dc3545;
  border: 1px solid rgba(220, 53, 69, 0.3);
}

/* Featured Runs */
.featured-runs-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.featured-run-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s ease;
}

.featured-run-item:hover {
  border-color: var(--accent);
}

.featured-run-item.is-selected {
  border-color: var(--accent);
  background: rgba(99, 102, 241, 0.1);
}

.featured-run-item__checkbox {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
}

.featured-run-item__info {
  flex: 1;
  min-width: 0;
}

.featured-run-item__game {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.featured-run-item__details {
  font-size: 0.85rem;
  color: var(--text-muted);
}

.featured-run-item__order {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--accent);
  min-width: 20px;
  text-align: center;
}

.no-runs-message {
  padding: 1rem;
  text-align: center;
  color: var(--text-muted);
}

/* Social Input Validation */
.form-validation {
  display: block;
  font-size: 0.75rem;
  margin-top: 0.25rem;
  min-height: 1rem;
}
.form-validation.is-valid {
  color: #10b981;
}
.form-validation.is-invalid {
  color: #ef4444;
}
.social-input.is-invalid {
  border-color: #ef4444;
}
.social-input.is-valid {
  border-color: #10b981;
}

/* Approval Notice */
.approval-notice {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  background: rgba(245, 158, 11, 0.1);
  border: 1px solid rgba(245, 158, 11, 0.3);
  border-radius: var(--radius-sm);
  margin-bottom: 1rem;
  font-size: 0.85rem;
  color: #f59e0b;
}
.approval-icon {
  flex-shrink: 0;
}

/* Pending Links Notice */
.pending-links-notice {
  padding: 0.75rem 1rem;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: var(--radius-sm);
  margin-bottom: 1rem;
  font-size: 0.85rem;
}
.pending-links-notice p {
  margin: 0 0 0.5rem 0;
}
.pending-links-notice ul {
  margin: 0;
  padding-left: 1.25rem;
}
.pending-links-notice li {
  font-size: 0.8rem;
  color: var(--text-muted);
  word-break: break-all;
}
</style>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

const loadingState = document.getElementById('loading-state');
const notSignedIn = document.getElementById('not-signed-in');
const noProfile = document.getElementById('no-profile');
const editContent = document.getElementById('edit-content');
const form = document.getElementById('profile-form');
const formMessage = document.getElementById('form-message');

let supabase = null;
let currentProfile = null;
let userRuns = [];
let selectedFeatured = [];
let otherLinks = [];
const MAX_OTHER_LINKS = 3;

function showState(state) {
  loadingState.hidden = state !== 'loading';
  notSignedIn.hidden = state !== 'not-signed-in';
  noProfile.hidden = state !== 'no-profile';
  editContent.hidden = state !== 'edit';
}

function showMessage(text, type) {
  formMessage.textContent = text;
  formMessage.className = `form-message is-${type}`;
  formMessage.hidden = false;
  formMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function hideMessage() {
  formMessage.hidden = true;
}

// ============================================
// Social URL Validation
// ============================================
const SOCIAL_DOMAINS = {
  twitch: ['twitch.tv'],
  youtube: ['youtube.com', 'youtu.be', 'www.youtube.com'],
  discord: ['discord.gg', 'discord.com'],
  twitter: ['twitter.com', 'x.com'],
  bluesky: ['bsky.app'],
  instagram: ['instagram.com', 'www.instagram.com'],
  speedruncom: ['speedrun.com', 'www.speedrun.com'],
  steam: ['steamcommunity.com']
};

function validateSocialUrl(input) {
  const value = input.value.trim();
  const id = input.id;
  const validationEl = document.getElementById(`${id}-validation`);
  
  // If empty, clear validation
  if (!value) {
    input.classList.remove('is-valid', 'is-invalid');
    if (validationEl) validationEl.textContent = '';
    return { valid: true, empty: true };
  }
  
  // Check if it's a valid URL first
  let url;
  try {
    url = new URL(value);
  } catch {
    input.classList.remove('is-valid');
    input.classList.add('is-invalid');
    if (validationEl) {
      validationEl.textContent = '‚úó Invalid URL format';
      validationEl.className = 'form-validation is-invalid';
    }
    return { valid: false, error: 'Invalid URL format' };
  }
  
  // Check domain
  const allowedDomains = SOCIAL_DOMAINS[id] || [];
  const hostname = url.hostname.replace('www.', '');
  
  if (allowedDomains.length > 0 && !allowedDomains.some(d => hostname === d || hostname === 'www.' + d)) {
    input.classList.remove('is-valid');
    input.classList.add('is-invalid');
    if (validationEl) {
      validationEl.textContent = `‚úó Must be a ${allowedDomains[0]} link`;
      validationEl.className = 'form-validation is-invalid';
    }
    return { valid: false, error: `Invalid domain for ${id}` };
  }
  
  // Valid!
  input.classList.remove('is-invalid');
  input.classList.add('is-valid');
  if (validationEl) {
    validationEl.textContent = '‚úì Valid';
    validationEl.className = 'form-validation is-valid';
  }
  return { valid: true };
}

function validateAllSocials() {
  const socialInputs = document.querySelectorAll('.social-input');
  const errors = [];
  
  socialInputs.forEach(input => {
    const result = validateSocialUrl(input);
    if (!result.valid) {
      errors.push(`${input.id}: ${result.error}`);
    }
  });
  
  return errors;
}

// Add validation listeners to all social inputs
document.querySelectorAll('.social-input').forEach(input => {
  input.addEventListener('blur', () => validateSocialUrl(input));
  input.addEventListener('input', () => {
    // Clear invalid state on typing
    if (input.classList.contains('is-invalid')) {
      input.classList.remove('is-invalid');
      const validationEl = document.getElementById(`${input.id}-validation`);
      if (validationEl) validationEl.textContent = '';
    }
  });
});

// ============================================
// Schema Validation
// ============================================
const VALIDATION_SCHEMA = {
  display_name: {
    required: true,
    minLength: 2,
    maxLength: 50,
    pattern: /^[^<>{}[\]\\\/]+$/,
    errorMsg: 'Display name must be 2-50 characters, no special symbols'
  },
  pronouns: {
    maxLength: 30,
    pattern: /^[a-zA-Z\/\s]*$/,
    errorMsg: 'Pronouns can only contain letters, slashes, and spaces'
  },
  location: {
    maxLength: 50,
    pattern: /^[^<>{}[\]\\]*$/,
    errorMsg: 'Location contains invalid characters'
  },
  bio: {
    maxLength: 1000
  },
  status_message: {
    maxLength: 100,
    pattern: /^[^<>{}[\]\\]*$/,
    errorMsg: 'Status message contains invalid characters'
  },
  avatar_url: {
    pattern: /^(https?:\/\/|$)/,
    errorMsg: 'Avatar must be a valid URL starting with http:// or https://'
  },
  accent_color: {
    pattern: /^(#[0-9A-Fa-f]{6}|)$/,
    errorMsg: 'Accent color must be a hex code like #3BC36E'
  }
};

function validateField(name, value) {
  const schema = VALIDATION_SCHEMA[name];
  if (!schema) return { valid: true };
  
  if (schema.required && !value) {
    return { valid: false, error: `${name} is required` };
  }
  
  if (value) {
    if (schema.minLength && value.length < schema.minLength) {
      return { valid: false, error: schema.errorMsg || `${name} is too short` };
    }
    if (schema.maxLength && value.length > schema.maxLength) {
      return { valid: false, error: `${name} is too long (max ${schema.maxLength})` };
    }
    if (schema.pattern && !schema.pattern.test(value)) {
      return { valid: false, error: schema.errorMsg || `${name} contains invalid characters` };
    }
  }
  
  return { valid: true };
}

function validateForm() {
  const errors = [];
  
  // Validate basic fields
  const fields = ['display_name', 'pronouns', 'location', 'bio', 'status_message', 'avatar_url', 'accent_color'];
  fields.forEach(field => {
    const input = document.getElementById(field.replace(/_/g, '-'));
    if (input) {
      const result = validateField(field, input.value.trim());
      if (!result.valid) {
        errors.push(result.error);
      }
    }
  });
  
  // Validate display name specifically
  const displayName = document.getElementById('display-name')?.value.trim();
  if (!displayName) {
    errors.push('Display name is required');
  }
  
  // Validate social URLs
  const socialErrors = validateAllSocials();
  errors.push(...socialErrors);
  
  // Validate other links (must be valid URLs)
  otherLinks.forEach((link, i) => {
    if (link.trim()) {
      try {
        new URL(link);
      } catch {
        errors.push(`Other link ${i + 1} is not a valid URL`);
      }
    }
  });
  
  return errors;
}

// Live preview updates
document.getElementById('display-name')?.addEventListener('input', (e) => {
  document.getElementById('preview-name').textContent = e.target.value || 'Display Name';
});

document.getElementById('pronouns')?.addEventListener('input', (e) => {
  const pronounsEl = document.getElementById('preview-pronouns');
  pronounsEl.textContent = e.target.value ? `(${e.target.value})` : '';
});

document.getElementById('avatar-url')?.addEventListener('change', (e) => {
  const url = e.target.value;
  if (url) {
    document.getElementById('preview-avatar').src = url;
  }
});

document.getElementById('banner-url')?.addEventListener('change', (e) => {
  const url = e.target.value;
  if (url) {
    document.getElementById('preview-banner-img').src = url;
  }
});

// Color picker sync
document.getElementById('accent-color-picker')?.addEventListener('input', (e) => {
  document.getElementById('accent-color').value = e.target.value;
});

document.getElementById('accent-color')?.addEventListener('input', (e) => {
  const val = e.target.value;
  if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
    document.getElementById('accent-color-picker').value = val;
  }
});

// Bio character counter
document.getElementById('bio')?.addEventListener('input', (e) => {
  document.getElementById('bio-count').textContent = e.target.value.length;
});

// Other links management
function renderOtherLinks() {
  const container = document.getElementById('other-links-container');
  container.innerHTML = otherLinks.map((link, i) => `
    <div class="other-link-row">
      <input type="url" value="${link}" placeholder="https://..." data-index="${i}" class="form-input other-link-input" />
      <button type="button" class="btn btn--small btn--danger" data-remove="${i}">‚úï</button>
    </div>
  `).join('');
  
  container.querySelectorAll('.other-link-input').forEach(input => {
    input.addEventListener('input', (e) => {
      otherLinks[parseInt(e.target.dataset.index)] = e.target.value;
    });
  });
  
  container.querySelectorAll('[data-remove]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      otherLinks.splice(parseInt(e.target.dataset.remove), 1);
      renderOtherLinks();
    });
  });
  
  document.getElementById('add-other-link').hidden = otherLinks.length >= MAX_OTHER_LINKS;
}

document.getElementById('add-other-link')?.addEventListener('click', () => {
  if (otherLinks.length < MAX_OTHER_LINKS) {
    otherLinks.push('');
    renderOtherLinks();
  }
});

// Load user's runs for featured selection
async function loadUserRuns(runnerId) {
  const listEl = document.getElementById('featured-runs-list');
  
  try {
    const { data, error } = await supabase
      .from('runs')
      .select('id, game_id, category, date_completed, time, video_url')
      .eq('runner_id', runnerId)
      .order('date_completed', { ascending: false })
      .limit(20);
    
    if (error) {
      listEl.innerHTML = `
        <div class="no-runs-message">
          <p>Run data sync coming soon!</p>
          <p class="muted">Your completed runs will appear here once the sync is set up.</p>
        </div>
      `;
      return;
    }
    
    userRuns = data || [];
    
    if (userRuns.length === 0) {
      listEl.innerHTML = `
        <div class="no-runs-message">
          <p>No completed runs yet.</p>
          <p class="muted">Submit some runs to feature them on your profile!</p>
        </div>
      `;
      return;
    }
    
    renderRunsList();
  } catch (err) {
    listEl.innerHTML = `<p class="muted">Could not load runs.</p>`;
  }
}

function renderRunsList() {
  const listEl = document.getElementById('featured-runs-list');
  
  listEl.innerHTML = userRuns.map(run => {
    const isSelected = selectedFeatured.includes(run.id);
    const orderNum = isSelected ? selectedFeatured.indexOf(run.id) + 1 : '';
    
    return `
      <label class="featured-run-item ${isSelected ? 'is-selected' : ''}" data-run-id="${run.id}">
        <input type="checkbox" class="featured-run-item__checkbox" 
               ${isSelected ? 'checked' : ''} 
               ${!isSelected && selectedFeatured.length >= 3 ? 'disabled' : ''} />
        <div class="featured-run-item__info">
          <div class="featured-run-item__game">${run.game_id}</div>
          <div class="featured-run-item__details">
            ${run.category || 'Any%'} ¬∑ ${run.time || 'No time'} ¬∑ ${run.date_completed || ''}
          </div>
        </div>
        <span class="featured-run-item__order">${orderNum}</span>
      </label>
    `;
  }).join('');
  
  listEl.querySelectorAll('.featured-run-item').forEach(item => {
    const checkbox = item.querySelector('input');
    const runId = item.dataset.runId;
    
    checkbox.addEventListener('change', () => {
      if (checkbox.checked) {
        if (selectedFeatured.length < 3) {
          selectedFeatured.push(runId);
        }
      } else {
        selectedFeatured = selectedFeatured.filter(id => id !== runId);
      }
      
      document.getElementById('featured-runs').value = JSON.stringify(selectedFeatured);
      renderRunsList();
    });
  });
}

// Populate form with current profile data
function populateForm(profile) {
  document.getElementById('runner-id').value = profile.runner_id || '';
  document.getElementById('display-name').value = profile.display_name || '';
  document.getElementById('pronouns').value = profile.pronouns || '';
  document.getElementById('location').value = profile.location || '';
  document.getElementById('bio').value = profile.bio || '';
  document.getElementById('status-message').value = profile.status_message || '';
  
  // Customization
  document.getElementById('avatar-url').value = profile.avatar_url || '';
  
  // Update preview
  document.getElementById('preview-name').textContent = profile.display_name || 'Display Name';
  document.getElementById('preview-pronouns').textContent = profile.pronouns ? `(${profile.pronouns})` : '';
  if (profile.avatar_url) document.getElementById('preview-avatar').src = profile.avatar_url;
  
  // Update bio counter
  document.getElementById('bio-count').textContent = (profile.bio || '').length;
  
  // Accent color (from theme_settings)
  const themeSettings = profile.theme_settings || {};
  const accentColor = themeSettings.accent || '#3BC36E';
  document.getElementById('accent-color').value = accentColor;
  document.getElementById('accent-color-picker').value = accentColor;
  
  // Social links
  const socials = profile.socials || {};
  document.getElementById('twitch').value = socials.twitch || '';
  document.getElementById('youtube').value = socials.youtube || '';
  document.getElementById('discord').value = socials.discord || '';
  document.getElementById('twitter').value = socials.twitter || '';
  document.getElementById('bluesky').value = socials.bluesky || '';
  document.getElementById('instagram').value = socials.instagram || '';
  document.getElementById('speedruncom').value = socials.speedruncom || '';
  document.getElementById('steam').value = socials.steam || '';
  
  // Other links (show approved ones, or pending for editing)
  otherLinks = socials.other || [];
  renderOtherLinks();
  
  // Show pending notice if there are pending other links
  if (profile.other_links_pending && profile.other_links_pending.length > 0) {
    showPendingLinksNotice(profile.other_links_pending);
  }
}

function showPendingLinksNotice(pendingLinks) {
  const container = document.getElementById('other-links-container');
  const notice = document.createElement('div');
  notice.className = 'pending-links-notice';
  notice.innerHTML = `
    <p><strong>Pending approval:</strong></p>
    <ul>${pendingLinks.map(l => `<li>${l}</li>`).join('')}</ul>
  `;
  container.parentNode.insertBefore(notice, container);
}

// Handle form submission
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  hideMessage();
  
  const saveBtn = document.getElementById('save-btn');
  const btnText = saveBtn.querySelector('.btn__text');
  const btnLoading = saveBtn.querySelector('.btn__loading');
  
  saveBtn.disabled = true;
  btnText.hidden = true;
  btnLoading.hidden = false;
  
  try {
    // Get current theme_settings to preserve other theme options
    const user = CRCAuth.getUser();
    let currentThemeSettings = {};
    try {
      const { data: profileData } = await supabase
        .from('runner_profiles')
        .select('theme_settings')
        .eq('user_id', user.id)
        .single();
      currentThemeSettings = profileData?.theme_settings || {};
    } catch (e) {
      // Ignore - will use empty object
    }
    
    // Update accent color in theme_settings
    const accentColor = document.getElementById('accent-color').value.trim();
    if (accentColor && /^#[0-9A-Fa-f]{6}$/.test(accentColor)) {
      currentThemeSettings.accent = accentColor;
      // Calculate RGB for CSS variable
      const r = parseInt(accentColor.slice(1, 3), 16);
      const g = parseInt(accentColor.slice(3, 5), 16);
      const b = parseInt(accentColor.slice(5, 7), 16);
      currentThemeSettings.accentRgb = `${r}, ${g}, ${b}`;
    }
    
    // Run validation first
    const validationErrors = validateForm();
    if (validationErrors.length > 0) {
      throw new Error(validationErrors[0]);
    }
    
    // Get the current approved other links from the profile
    const currentOtherLinks = currentProfile?.socials?.other || [];
    const newOtherLinks = otherLinks.filter(l => l.trim());
    
    // Check if other links changed - if so, put them in pending
    const otherLinksChanged = JSON.stringify(currentOtherLinks) !== JSON.stringify(newOtherLinks);
    
    const formData = {
      display_name: document.getElementById('display-name').value.trim(),
      pronouns: document.getElementById('pronouns').value.trim() || null,
      location: document.getElementById('location').value.trim() || null,
      bio: document.getElementById('bio').value.trim() || null,
      status_message: document.getElementById('status-message').value.trim() || null,
      avatar_url: document.getElementById('avatar-url').value.trim() || null,
      theme_settings: currentThemeSettings,
      socials: {
        twitch: document.getElementById('twitch').value.trim() || null,
        youtube: document.getElementById('youtube').value.trim() || null,
        discord: document.getElementById('discord').value.trim() || null,
        twitter: document.getElementById('twitter').value.trim() || null,
        bluesky: document.getElementById('bluesky').value.trim() || null,
        instagram: document.getElementById('instagram').value.trim() || null,
        speedruncom: document.getElementById('speedruncom').value.trim() || null,
        steam: document.getElementById('steam').value.trim() || null,
        // Keep current approved links, new ones go to pending
        other: otherLinksChanged ? currentOtherLinks : newOtherLinks
      },
      updated_at: new Date().toISOString()
    };
    
    // If other links changed, add them to pending for approval
    if (otherLinksChanged && newOtherLinks.length > 0) {
      formData.other_links_pending = newOtherLinks;
    }
    
    if (!formData.display_name) {
      throw new Error('Display name is required');
    }
    
    const { error } = await supabase
      .from('runner_profiles')
      .update(formData)
      .eq('user_id', user.id);
    
    if (error) throw error;
    
    // Also update localStorage theme
    localStorage.setItem('crc-theme', JSON.stringify(currentThemeSettings));
    
    if (otherLinksChanged && newOtherLinks.length > 0) {
      showMessage('Profile saved! Other links submitted for approval.', 'success');
    } else {
      showMessage('Profile saved successfully!', 'success');
    }
    await CRCAuth.init();
    
  } catch (err) {
    showMessage(`Error: ${err.message}`, 'error');
  } finally {
    saveBtn.disabled = false;
    btnText.hidden = false;
    btnLoading.hidden = true;
  }
});

// Initialize
(async function() {
  showState('loading');
  
  await CRCAuth.init();
  
  if (!CRCAuth.isSignedIn()) {
    showState('not-signed-in');
    return;
  }
  
  supabase = CRCAuth.getSupabaseClient();
  if (!supabase) {
    showMessage('Could not initialize database connection', 'error');
    showState('not-signed-in');
    return;
  }
  
  const user = CRCAuth.getUser();
  const { data: profile, error } = await supabase
    .from('runner_profiles')
    .select('*')
    .eq('user_id', user.id)
    .single();
  
  if (error || !profile) {
    showState('no-profile');
    return;
  }
  
  currentProfile = profile;
  populateForm(profile);
  
  if (profile.runner_id) {
    loadUserRuns(profile.runner_id);
  }
  
  showState('edit');
})();
</script>
