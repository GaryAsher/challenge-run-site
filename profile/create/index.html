---
layout: default
title: "Create Runner Profile"
---

<div class="page-width">
  <p class="muted mb-3">
    <a href="{{ '/sign-in/' | relative_url }}">‚Üê Back to Sign In</a>
  </p>

  <div class="profile-create">
    <!-- Loading state -->
    <div id="loading-state" class="card">
      <div class="sign-in-loading">
        <div class="spinner"></div>
        <p class="muted">Loading...</p>
      </div>
    </div>

    <!-- Not signed in state -->
    <div id="not-signed-in" class="card" hidden>
      <h1>Create Runner Profile</h1>
      <p class="muted">You need to sign in before creating a profile.</p>
      <a href="{{ '/sign-in/' | relative_url }}" class="btn btn--primary">Sign In</a>
    </div>

    <!-- Already has profile state -->
    <div id="has-profile" class="card" hidden>
      <h1>You Already Have a Profile</h1>
      <p class="muted">You can view or edit your existing profile.</p>
      <div class="profile-create__actions">
        <a href="#" id="view-profile-link" class="btn btn--primary">View Profile</a>
        <a href="{{ '/profile/edit/' | relative_url }}" class="btn">Edit Profile</a>
      </div>
    </div>

    <!-- Has pending profile state -->
    <div id="has-pending" class="card" hidden>
      <h1>Profile Pending Approval</h1>
      <p class="muted">Your profile is awaiting moderator review. You'll be notified once it's approved.</p>
      <a href="{{ '/profile/status/' | relative_url }}" class="btn btn--primary">Check Status</a>
    </div>

    <!-- Create profile form -->
    <div id="create-form-container" hidden>
      <div class="card">
        <h1>Create Your Runner Profile</h1>
        <p class="muted mb-4">
          Fill out the form below to create your runner profile. Your profile will be reviewed by a moderator before it goes live.
          <span class="required-hint"><span class="required-marker">*</span> indicates required fields</span>
        </p>

        <form id="create-profile-form" class="profile-form" novalidate>
          <!-- Account Info (from OAuth) -->
          <div class="profile-form__section">
            <h2 class="profile-form__section-title">Linked Account</h2>
            <div class="profile-form__oauth-info">
              <img id="oauth-avatar" class="profile-form__oauth-avatar" src="/assets/img/site/default-runner.png" alt="" />
              <div class="profile-form__oauth-details">
                <p class="profile-form__oauth-name" id="oauth-name">Loading...</p>
                <p class="profile-form__oauth-provider muted" id="oauth-provider">via Discord</p>
              </div>
            </div>
          </div>

          <!-- Basic Info -->
          <div class="profile-form__section">
            <h2 class="profile-form__section-title">Basic Info</h2>

            <div class="profile-form__field">
              <label for="runner_id" class="profile-form__label">
                Runner ID <span class="required-marker">*</span>
              </label>
              <div class="profile-form__hint">
                This will be your unique URL: <code>challengerun.net/runners/<span id="runner-id-preview">your-id</span>/</code>
              </div>
              <input 
                type="text" 
                id="runner_id" 
                name="runner_id"
                class="profile-form__input"
                placeholder="your-runner-id"
                required
                autocomplete="off"
                minlength="3"
              />
              <div class="profile-form__char-rules" id="runner-id-rules">
                <strong>Allowed characters:</strong> lowercase letters (a-z), numbers (0-9), hyphens (-)<br>
                <strong>Rules:</strong> Minimum 3 characters. Cannot start or end with a hyphen.
              </div>
              <div class="profile-form__validation" id="runner-id-validation"></div>
            </div>

            <div class="profile-form__field">
              <label for="display_name" class="profile-form__label">
                Display Name <span class="required-marker">*</span>
              </label>
              <div class="profile-form__hint">How your name appears on the site (2-50 characters)</div>
              <input 
                type="text" 
                id="display_name" 
                name="display_name"
                class="profile-form__input"
                placeholder="Your Display Name"
                minlength="2"
                maxlength="50"
                required
              />
            </div>

            <div class="profile-form__row">
              <div class="profile-form__field">
                <label for="pronouns" class="profile-form__label">Pronouns</label>
                <input 
                  type="text" 
                  id="pronouns" 
                  name="pronouns"
                  class="profile-form__input"
                  placeholder="e.g., they/them"
                  maxlength="30"
                />
              </div>

              <div class="profile-form__field">
                <label for="location" class="profile-form__label">Location</label>
                <input 
                  type="text" 
                  id="location" 
                  name="location"
                  class="profile-form__input"
                  placeholder="e.g., United States"
                  maxlength="50"
                />
              </div>
            </div>

            <div class="profile-form__field">
              <label for="bio" class="profile-form__label">Bio</label>
              <div class="profile-form__hint">Tell us about yourself (max 1000 characters)</div>
              <textarea 
                id="bio" 
                name="bio"
                class="profile-form__textarea"
                placeholder="A short bio about yourself..."
                maxlength="1000"
                rows="4"
              ></textarea>
              <div class="profile-form__char-count"><span id="bio-count">0</span>/1000</div>
            </div>
          </div>

          <!-- Social Links -->
          <div class="profile-form__section">
            <h2 class="profile-form__section-title">Social Links</h2>
            <p class="muted mb-3">Add links to your social profiles (all optional)</p>

            <div class="profile-form__field">
              <label for="social_twitch" class="profile-form__label">Twitch</label>
              <input type="url" id="social_twitch" name="social_twitch" class="profile-form__input" placeholder="https://www.twitch.tv/your_username" />
            </div>

            <div class="profile-form__field">
              <label for="social_youtube" class="profile-form__label">YouTube</label>
              <input type="url" id="social_youtube" name="social_youtube" class="profile-form__input" placeholder="https://www.youtube.com/@your_channel" />
            </div>

            <div class="profile-form__field">
              <label for="social_twitter" class="profile-form__label">Twitter / X</label>
              <input type="url" id="social_twitter" name="social_twitter" class="profile-form__input" placeholder="https://twitter.com/your_handle" />
            </div>

            <div class="profile-form__field">
              <label for="social_bluesky" class="profile-form__label">Bluesky</label>
              <input type="url" id="social_bluesky" name="social_bluesky" class="profile-form__input" placeholder="https://bsky.app/profile/your.handle" />
            </div>

            <div class="profile-form__field">
              <label for="social_instagram" class="profile-form__label">Instagram</label>
              <input type="url" id="social_instagram" name="social_instagram" class="profile-form__input" placeholder="https://www.instagram.com/your_username" />
            </div>

            <!-- Other Links (up to 3) -->
            <div class="profile-form__other-links" id="other-links-container">
              <div class="profile-form__field other-link-field" data-index="1">
                <label for="social_other_1" class="profile-form__label">Other (optional)</label>
                <input type="url" id="social_other_1" name="social_other_1" class="profile-form__input" placeholder="https://your-website-or-social.com" />
              </div>
            </div>
            
            <button type="button" class="btn btn--small" id="add-other-link" style="margin-top: 0.5rem;">
              + Add Another Link
            </button>
            <span class="muted" id="other-links-count" style="margin-left: 0.5rem; font-size: 0.85rem;">(1/3)</span>
          </div>

          <!-- Submit -->
          <div class="profile-form__section">
            <div class="profile-form__notice">
              <strong>üìã Moderation Notice</strong>
              <p class="muted mb-0">
                Your profile will be reviewed by a moderator before it appears on the site. 
                This usually takes 1-2 days. You'll be able to submit runs once approved.
              </p>
            </div>

            <div class="profile-form__actions">
              <button type="submit" class="btn btn--primary" id="submit-btn">
                <span class="btn__text">Submit for Review</span>
                <span class="btn__loading" hidden>
                  <span class="spinner" aria-hidden="true"></span>
                  Submitting...
                </span>
              </button>
            </div>

            <div class="profile-form__message" id="form-message" hidden></div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% include profile-form-styles.html %}

<style>
.profile-form__char-rules {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
  margin-bottom: 0.5rem;
  padding: 0.5rem 0.75rem;
  background: var(--surface);
  border-radius: var(--radius-sm);
  border-left: 3px solid var(--accent);
  line-height: 1.5;
}

.profile-form__validation {
  font-size: 0.85rem;
  margin-top: 0.25rem;
  min-height: 1.25rem;
}

.profile-form__validation.is-valid {
  color: #28a745;
}

.profile-form__validation.is-invalid {
  color: #dc3545;
}

.profile-form__validation.is-checking {
  color: var(--text-muted);
}

.profile-form__input.is-valid {
  border-color: #28a745;
}

.profile-form__input.is-invalid {
  border-color: #dc3545;
}

.btn--small {
  padding: 0.4rem 0.75rem;
  font-size: 0.85rem;
}

.other-link-field {
  position: relative;
}

.other-link-remove {
  position: absolute;
  right: 0;
  top: 0;
  background: none;
  border: none;
  color: #dc3545;
  cursor: pointer;
  font-size: 0.85rem;
  padding: 0.25rem 0.5rem;
}

.other-link-remove:hover {
  text-decoration: underline;
}
</style>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';
import { BannedTermsChecker } from '{{ "/assets/js/banned-terms.js" | relative_url }}';

(async function() {
  const notSignedIn = document.getElementById('not-signed-in');
  const hasProfile = document.getElementById('has-profile');
  const hasPending = document.getElementById('has-pending');
  const createFormContainer = document.getElementById('create-form-container');
  const loadingState = document.getElementById('loading-state');
  
  const form = document.getElementById('create-profile-form');
  const runnerIdInput = document.getElementById('runner_id');
  const runnerIdPreview = document.getElementById('runner-id-preview');
  const runnerIdValidation = document.getElementById('runner-id-validation');
  const displayNameInput = document.getElementById('display_name');
  const bioInput = document.getElementById('bio');
  const bioCount = document.getElementById('bio-count');
  const submitBtn = document.getElementById('submit-btn');
  const formMessage = document.getElementById('form-message');
  
  const oauthAvatar = document.getElementById('oauth-avatar');
  const oauthName = document.getElementById('oauth-name');
  const oauthProvider = document.getElementById('oauth-provider');
  const viewProfileLink = document.getElementById('view-profile-link');
  
  // Other links management
  const otherLinksContainer = document.getElementById('other-links-container');
  const addOtherLinkBtn = document.getElementById('add-other-link');
  const otherLinksCount = document.getElementById('other-links-count');
  let currentOtherLinks = 1;
  const MAX_OTHER_LINKS = 3;
  
  let runnerIdCheckTimeout = null;
  let isRunnerIdAvailable = false;
  let isRunnerIdValid = false;
  
  function showState(state) {
    loadingState.hidden = state !== 'loading';
    notSignedIn.hidden = state !== 'not-signed-in';
    hasProfile.hidden = state !== 'has-profile';
    hasPending.hidden = state !== 'has-pending';
    createFormContainer.hidden = state !== 'create-form';
  }
  
  /**
   * Generate a runner ID from username
   * - Converts to lowercase
   * - Replaces spaces and underscores with hyphens
   * - Removes invalid characters
   * - Trims leading/trailing hyphens
   */
  function generateRunnerId(username) {
    if (!username) return '';
    
    return username
      .toLowerCase()
      .replace(/[\s_]+/g, '-')        // spaces and underscores to hyphens
      .replace(/[^a-z0-9-]/g, '')     // remove invalid chars (only a-z, 0-9, -)
      .replace(/^-+|-+$/g, '')        // trim leading/trailing hyphens
      .replace(/-{2,}/g, '-');        // collapse multiple hyphens
  }
  
  /**
   * Validate runner ID format
   * Only allows: lowercase letters, numbers, hyphens
   * Returns { valid: boolean, error: string|null }
   */
  function validateRunnerIdFormat(value) {
    if (!value) {
      return { valid: false, error: 'Runner ID is required' };
    }
    
    if (value.length < 3) {
      return { valid: false, error: 'Must be at least 3 characters' };
    }
    
    // Check for invalid characters (only allow a-z, 0-9, -)
    if (!/^[a-z0-9-]+$/.test(value)) {
      return { valid: false, error: 'Only lowercase letters, numbers, and hyphens allowed' };
    }
    
    // Check for leading/trailing hyphens
    if (/^-|-$/.test(value)) {
      return { valid: false, error: 'Cannot start or end with a hyphen' };
    }
    
    return { valid: true, error: null };
  }
  
  // Other links management
  function updateOtherLinksUI() {
    otherLinksCount.textContent = `(${currentOtherLinks}/${MAX_OTHER_LINKS})`;
    addOtherLinkBtn.disabled = currentOtherLinks >= MAX_OTHER_LINKS;
    if (currentOtherLinks >= MAX_OTHER_LINKS) {
      addOtherLinkBtn.style.opacity = '0.5';
    } else {
      addOtherLinkBtn.style.opacity = '1';
    }
  }
  
  function addOtherLinkField() {
    if (currentOtherLinks >= MAX_OTHER_LINKS) return;
    
    currentOtherLinks++;
    const index = currentOtherLinks;
    
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'profile-form__field other-link-field';
    fieldDiv.dataset.index = index;
    fieldDiv.innerHTML = `
      <label for="social_other_${index}" class="profile-form__label">Other (optional)</label>
      <button type="button" class="other-link-remove" data-index="${index}">Remove</button>
      <input type="url" id="social_other_${index}" name="social_other_${index}" class="profile-form__input" placeholder="https://your-website-or-social.com" />
    `;
    
    otherLinksContainer.appendChild(fieldDiv);
    
    // Add remove handler
    fieldDiv.querySelector('.other-link-remove').addEventListener('click', () => {
      fieldDiv.remove();
      currentOtherLinks--;
      updateOtherLinksUI();
    });
    
    updateOtherLinksUI();
  }
  
  addOtherLinkBtn.addEventListener('click', addOtherLinkField);
  
  // Initialize
  try {
    showState('loading');
    await CRCAuth.init();
    
    const isSignedIn = CRCAuth.isSignedIn();
    
    if (!isSignedIn) {
      showState('not-signed-in');
      return;
    }
    
    const profile = CRCAuth.getProfile();
    
    if (profile && !profile._isPending) {
      viewProfileLink.href = `/runners/${profile.runner_id}/`;
      showState('has-profile');
      return;
    }
    
    if (profile && profile._isPending) {
      showState('has-pending');
      return;
    }
    
    // Show create form
    const metadata = CRCAuth.getProviderMetadata();
    oauthAvatar.src = metadata.providerAvatar || '/assets/img/site/default-runner.png';
    oauthName.textContent = metadata.providerUsername || 'User';
    oauthProvider.textContent = `via ${metadata.provider ? metadata.provider.charAt(0).toUpperCase() + metadata.provider.slice(1) : 'OAuth'}`;
    
    // Auto-fill display name from provider
    if (metadata.providerUsername) {
      displayNameInput.value = metadata.providerUsername;
      
      // Auto-generate runner ID from username (converts underscores to hyphens)
      const generatedId = generateRunnerId(metadata.providerUsername);
      if (generatedId.length >= 3) {
        runnerIdInput.value = generatedId;
        runnerIdPreview.textContent = generatedId;
        
        // Trigger validation
        runnerIdInput.dispatchEvent(new Event('input'));
      }
    }
    
    showState('create-form');
  } catch (error) {
    console.error('Profile create page init error:', error);
    showState('not-signed-in');
  }
  
  // Runner ID validation
  runnerIdInput.addEventListener('input', (e) => {
    // Only allow: lowercase letters, numbers, hyphens
    // Convert to lowercase, convert underscores to hyphens
    let value = e.target.value.toLowerCase()
      .replace(/_/g, '-')              // convert underscores to hyphens
      .replace(/[^a-z0-9-]/g, '');     // remove everything else
    
    // Collapse multiple consecutive hyphens
    value = value.replace(/-{2,}/g, '-');
    
    e.target.value = value;
    runnerIdPreview.textContent = value || 'your-id';
    
    // Clear previous state
    runnerIdInput.classList.remove('is-valid', 'is-invalid');
    runnerIdValidation.textContent = '';
    runnerIdValidation.className = 'profile-form__validation';
    isRunnerIdAvailable = false;
    isRunnerIdValid = false;
    
    clearTimeout(runnerIdCheckTimeout);
    
    // Validate format
    const formatCheck = validateRunnerIdFormat(value);
    
    if (!formatCheck.valid) {
      runnerIdInput.classList.add('is-invalid');
      runnerIdValidation.innerHTML = '<span style="color: #dc3545;">‚úó</span> ' + formatCheck.error;
      runnerIdValidation.className = 'profile-form__validation is-invalid';
      return;
    }
    
    // Check for banned terms
    const bannedCheck = BannedTermsChecker.checkField('runner_id', value);
    if (!bannedCheck.ok) {
      runnerIdInput.classList.add('is-invalid');
      runnerIdValidation.innerHTML = '<span style="color: #dc3545;">‚úó</span> ' + bannedCheck.reason;
      runnerIdValidation.className = 'profile-form__validation is-invalid';
      return;
    }
    
    // Format is valid - show green check for format
    runnerIdValidation.innerHTML = '<span style="color: #28a745;">‚úì</span> Valid format. Checking availability...';
    runnerIdValidation.className = 'profile-form__validation is-checking';
    isRunnerIdValid = true;
    
    // Check availability
    runnerIdCheckTimeout = setTimeout(async () => {
      const available = await CRCAuth.isRunnerIdAvailable(value);
      if (available) {
        runnerIdInput.classList.add('is-valid');
        runnerIdValidation.innerHTML = '<span style="color: #28a745;">‚úì</span> <span style="color: #28a745;">Available!</span>';
        runnerIdValidation.className = 'profile-form__validation is-valid';
        isRunnerIdAvailable = true;
      } else {
        runnerIdInput.classList.add('is-invalid');
        runnerIdValidation.innerHTML = '<span style="color: #28a745;">‚úì</span> Valid format, but <span style="color: #dc3545;">already taken</span>';
        runnerIdValidation.className = 'profile-form__validation is-invalid';
        isRunnerIdAvailable = false;
      }
    }, 500);
  });
  
  bioInput.addEventListener('input', () => {
    bioCount.textContent = bioInput.value.length;
  });
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Final validation on the runner ID (strip trailing hyphens)
    let finalRunnerId = runnerIdInput.value.replace(/-+$/, '');
    
    const formatCheck = validateRunnerIdFormat(finalRunnerId);
    if (!formatCheck.valid) {
      showMessage(formatCheck.error, 'error');
      runnerIdInput.focus();
      return;
    }
    
    if (!isRunnerIdAvailable) {
      showMessage('Please choose an available Runner ID.', 'error');
      runnerIdInput.focus();
      return;
    }
    
    if (!displayNameInput.value.trim()) {
      showMessage('Display Name is required.', 'error');
      displayNameInput.focus();
      return;
    }
    
    // Check for banned terms in all fields
    const bannedCheck = BannedTermsChecker.checkFields({
      runner_id: finalRunnerId,
      display_name: displayNameInput.value,
      bio: bioInput.value
    });
    
    if (!bannedCheck.ok) {
      const firstError = Object.entries(bannedCheck.errors)[0];
      const fieldNames = { runner_id: 'Runner ID', display_name: 'Display Name', bio: 'Bio' };
      showMessage(`${fieldNames[firstError[0]] || firstError[0]}: ${firstError[1]}`, 'error');
      return;
    }
    
    const formData = new FormData(form);
    const profileData = {
      runner_id: finalRunnerId,
      display_name: formData.get('display_name'),
      pronouns: formData.get('pronouns') || null,
      location: formData.get('location') || null,
      bio: formData.get('bio') || null,
      socials: {},
      games: []
    };
    
    // Collect social links
    ['twitch', 'youtube', 'twitter', 'bluesky', 'instagram'].forEach(key => {
      const val = formData.get(`social_${key}`);
      if (val) profileData.socials[key] = val;
    });
    
    // Collect other links
    const otherLinks = [];
    for (let i = 1; i <= MAX_OTHER_LINKS; i++) {
      const val = formData.get(`social_other_${i}`);
      if (val) otherLinks.push(val);
    }
    if (otherLinks.length > 0) {
      profileData.socials.other = otherLinks;
    }
    
    setSubmitting(true);
    
    try {
      const { data, error } = await CRCAuth.submitProfile(profileData);
      if (error) {
        showMessage(error.message, 'error');
        return;
      }
      showMessage('Profile submitted successfully! Redirecting...', 'success');
      setTimeout(() => { window.location.href = '/profile/status/'; }, 1500);
    } catch (err) {
      showMessage(err.message || 'An error occurred. Please try again.', 'error');
    } finally {
      setSubmitting(false);
    }
  });
  
  function setSubmitting(isSubmitting) {
    submitBtn.disabled = isSubmitting;
    submitBtn.querySelector('.btn__text').hidden = isSubmitting;
    submitBtn.querySelector('.btn__loading').hidden = !isSubmitting;
  }
  
  function showMessage(text, type) {
    formMessage.textContent = text;
    formMessage.className = `profile-form__message is-${type}`;
    formMessage.hidden = false;
    if (type === 'error') formMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
})();
</script>
