<!-- =========================================================
     Game Rules Include  
     
     FEATURES:
     - Rule Builder shows rules panel below selections
     - "Remove all filters" button positioned like Advanced Filters
     - "See runners" button at bottom right with spacing
     - Highlight animation on first visit
     - Credits section support
     ========================================================= -->
{% assign game = include.game %}
{% assign game_id = game.game_id %}

<!-- Determine which data exists -->
{% assign has_categories = false %}
{% assign has_challenges = false %}
{% assign has_community_challenges = false %}
{% assign has_restrictions = false %}
{% assign has_glitches = false %}
{% assign has_character = false %}
{% assign character_label = "Character" %}

{% if game.categories_data and game.categories_data.size > 0 %}
  {% assign has_categories = true %}
{% endif %}

{% if game.challenges_data and game.challenges_data.size > 0 %}
  {% assign has_challenges = true %}
{% endif %}

{% if game.community_challenges and game.community_challenges.size > 0 %}
  {% assign has_community_challenges = true %}
{% endif %}

{% if game.restrictions_data and game.restrictions_data.size > 0 %}
  {% assign has_restrictions = true %}
{% endif %}

{% if game.glitches_data and game.glitches_data.size > 0 %}
  {% assign has_glitches = true %}
{% endif %}

{% if game.character_column and game.character_column.enabled %}
  {% assign has_character = true %}
  {% if game.character_column.label %}
    {% assign character_label = game.character_column.label %}
  {% endif %}
{% endif %}

<!-- Rule Builder should show if we have categories AND at least one filter type -->
{% assign show_rule_builder = false %}
{% if has_categories and has_challenges %}
  {% assign show_rule_builder = true %}
{% endif %}

<section class="tab-panel active">
  <h1>Rules & Definitions</h1>
  <p class="muted mb-4">Official rules, category definitions, and challenge guidelines for {{ game.name }}.</p>

  {% if show_rule_builder %}
  <!-- =========================================================
       Rule Builder - Collapsible Version
       ORDERING: Run Categories -> Community Challenges -> Character -> Standard Challenge -> Restrictions -> Glitches
       ========================================================= -->
  <div class="card card--compact mb-4 rule-builder-highlight" id="rule-builder-card">
    <div class="rule-builder-header">
      <span class="muted rule-builder-subtitle">üìå Rule Builder ‚Äî Build your ruleset and find runners</span>
      <button class="btn btn--filter-toggle" id="rb-toggle" type="button" aria-expanded="false" aria-controls="rule-builder-content">
        <span class="filter-toggle__icon">‚ñº</span>
        <span class="filter-toggle__text">Open</span>
      </button>
    </div>

    <div class="rule-builder-content" id="rule-builder-content" hidden>
      <div class="rule-builder__selections">
        
        <!-- 1. Run Category Dropdown -->
        {% if has_categories %}
        <div class="rule-builder__group" data-rb-order="1">
          <label class="rule-builder__label">Run Category</label>
          <select class="rule-builder__select" id="rb-category">
            <option value="" data-description="">-- Select Category --</option>
            {% for cat in game.categories_data %}
              <option value="{{ cat.slug }}" data-label="{{ cat.label }}" data-description="{{ cat.description | escape }}">{{ cat.label }}</option>
              {% if cat.children %}
                {% for child in cat.children %}
                  <option value="{{ cat.slug }}/{{ child.slug }}" data-label="{{ child.label }}" data-description="{{ child.description | escape }}">  ‚Ü≥ {{ child.label }}</option>
                {% endfor %}
              {% endif %}
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <!-- 2. Community Challenges Dropdown (if applicable) -->
        {% if has_community_challenges %}
        <div class="rule-builder__group" data-rb-order="2">
          <label class="rule-builder__label">Community Challenge</label>
          <select class="rule-builder__select" id="rb-community-challenge">
            <option value="" data-description="">-- Select Community Challenge --</option>
            {% for cc in game.community_challenges %}
              <option value="{{ cc.slug }}" data-label="{{ cc.label }}" data-description="{{ cc.description | escape }}">{{ cc.label }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <!-- 3. Character/Weapon/Aspect Dropdown (if applicable) -->
        {% if has_character and game.characters_data and game.characters_data.size > 0 %}
        <div class="rule-builder__group" data-rb-order="3">
          <label class="rule-builder__label">{{ character_label }}</label>
          <select class="rule-builder__select" id="rb-character">
            <option value="" data-description="">-- Select {{ character_label }} --</option>
            {% for char in game.characters_data %}
              <option value="{{ char.slug }}" data-label="{{ char.label }}" data-description="{{ char.description | escape }}">{{ char.label }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <!-- 4. Standard Challenge Type Dropdown (Multi-select) -->
        {% if has_challenges %}
        <div class="rule-builder__group" data-rb-order="4">
          <label class="rule-builder__label">Standard Challenge Type(s)</label>
          <select class="rule-builder__select" id="rb-challenge">
            <option value="" data-description="">-- Add Challenge --</option>
            {% for ch in game.challenges_data %}
              <option value="{{ ch.slug }}" data-label="{{ ch.label }}" data-description="{{ ch.description | escape }}">{{ ch.label }}</option>
            {% endfor %}
          </select>
          <div class="rule-builder__selected" id="rb-selected-challenges"></div>
        </div>
        {% endif %}

        <!-- 5. Restrictions Dropdown (Multi-select style) -->
        {% if has_restrictions %}
        <div class="rule-builder__group" data-rb-order="5">
          <label class="rule-builder__label">Restrictions</label>
          <select class="rule-builder__select" id="rb-restriction">
            <option value="" data-description="" data-incompatible="">-- Add Restriction --</option>
            {% for res in game.restrictions_data %}
              <option value="{{ res.slug }}" 
                      data-label="{{ res.label }}"
                      data-description="{{ res.description | escape }}"
                      data-incompatible="{{ res.incompatible_with | join: ',' | escape }}">
                {{ res.label }}
              </option>
            {% endfor %}
          </select>
          <div class="rule-builder__selected" id="rb-selected-restrictions"></div>
        </div>
        {% endif %}

        <!-- 6. Glitch Rules Dropdown -->
        {% if has_glitches %}
        <div class="rule-builder__group" data-rb-order="6">
          <label class="rule-builder__label">Glitch Rules</label>
          <select class="rule-builder__select" id="rb-glitch">
            <option value="" data-label="" data-description="" data-allowed="" data-banned="">-- Select Glitch Category --</option>
            {% for glitch in game.glitches_data %}
              <option value="{{ glitch.slug }}" 
                      data-label="{{ glitch.label }}"
                      data-description="{{ glitch.description | escape }}"
                      data-allowed="{{ glitch.allowed | join: '|' | escape }}"
                      data-banned="{{ glitch.banned | join: '|' | escape }}"
                      data-notes="{{ glitch.notes | escape }}">
                {{ glitch.label }}
              </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <!-- Reset Button - positioned like Advanced Filters -->
        <div class="rule-builder__group rule-builder__group--reset">
          <button type="button" class="btn btn--outline btn--reset" id="rb-reset">
            Remove all filters
          </button>
        </div>
      </div>

      <!-- Active Selections Display (tags) -->
      <div class="rule-builder__active" id="rb-active-filters"></div>

      <!-- =========================================================
           Rules Summary Panel - Shows all selected rules
           ========================================================= -->
      <div class="rule-builder__summary" id="rb-summary" style="display: none;">
        <h3 class="rule-builder__summary-title">üìã Your Ruleset</h3>
        <div class="rule-builder__summary-content" id="rb-summary-content">
          <!-- Rules will be populated here by JavaScript -->
        </div>
      </div>

      <!-- Validation Warnings -->
      <div class="rule-builder__validation" id="rb-validation" style="display: none;">
        <p class="rule-builder__warning">‚ö†Ô∏è <span id="rb-warning-text"></span></p>
      </div>

      <!-- See Runners Button - at bottom right with spacing -->
      <div class="rule-builder__actions" id="rb-actions">
        <a href="#" class="btn btn--accent" id="rb-find-runners" style="display: none;">
          üîç See runners who completed this
        </a>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- =========================================================
       Rules Accordions
       ORDERING: General Rules -> Run Categories -> Community Challenges -> Character -> Standard Challenges -> Restrictions -> Glitches
       ========================================================= -->

  <!-- 1. General Rules -->
  <div class="rules-section" data-section-order="1">
    <details class="accordion-item accordion-item--section">
      <summary class="accordion-header accordion-header--section">
        <span class="accordion-title">üìã General Rules</span>
        <span class="accordion-icon">‚ñº</span>
      </summary>
      <div class="accordion-content">
        {% if game.general_rules and game.general_rules.size > 0 %}
          <!-- Game-specific general rules -->
          <ul>
            {% for rule in game.general_rules %}
              <li>{{ rule | markdownify | remove: '<p>' | remove: '</p>' }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <!-- Default general rules -->
          <ul>
            <li><strong>Timing Method:</strong> {{ game.timing_method | default: "RTA (Real Time Attack)" }}</li>
            <li><strong>Video Required:</strong> All submissions must include video proof</li>
            <li><strong>No Cheats/Mods:</strong> External tools or gameplay-altering mods are not allowed</li>
          </ul>
        {% endif %}
      </div>
    </details>
  </div>

  <!-- 2. Run Categories -->
  {% if has_categories %}
  <div class="rules-section mt-4" data-section-order="2">
    <details class="accordion-item accordion-item--section">
      <summary class="accordion-header accordion-header--section">
        <span class="accordion-title">üèÉ Run Categories</span>
        <span class="accordion-icon">‚ñº</span>
      </summary>
      <div class="accordion-content">
        <div class="accordion">
          {% for cat in game.categories_data %}
            <details class="accordion-item">
              <summary class="accordion-header">
                <span class="accordion-title">{{ cat.label }}</span>
                <span class="accordion-icon">‚ñº</span>
              </summary>
              <div class="accordion-content">
                {% if cat.description %}<p>{{ cat.description | markdownify }}</p>{% else %}<p class="muted">See resources for rules.</p>{% endif %}
                {% if cat.children and cat.children.size > 0 %}
                  <div class="mt-3"><strong>Subcategories:</strong>
                    <ul class="mt-2">{% for child in cat.children %}<li><strong>{{ child.label }}</strong>{% if child.description %} - {{ child.description }}{% endif %}</li>{% endfor %}</ul>
                  </div>
                {% endif %}
              </div>
            </details>
          {% endfor %}
        </div>
      </div>
    </details>
  </div>
  {% endif %}

  <!-- 3. Community Challenges -->
  {% if has_community_challenges %}
  <div class="rules-section mt-4" data-section-order="3">
    <details class="accordion-item accordion-item--section">
      <summary class="accordion-header accordion-header--section">
        <span class="accordion-title">üåü Community Challenges</span>
        <span class="accordion-icon">‚ñº</span>
      </summary>
      <div class="accordion-content">
        <div class="accordion">
          {% for cc in game.community_challenges %}
            <details class="accordion-item">
              <summary class="accordion-header">
                <span class="accordion-title">{{ cc.label }}</span>
                <span class="accordion-icon">‚ñº</span>
              </summary>
              <div class="accordion-content">
                {% if cc.description %}<p>{{ cc.description | markdownify }}</p>{% else %}<p class="muted">No description available.</p>{% endif %}
              </div>
            </details>
          {% endfor %}
        </div>
      </div>
    </details>
  </div>
  {% endif %}

  <!-- 4. Character/Weapon/Aspect (if applicable) -->
  {% if has_character and game.characters_data and game.characters_data.size > 0 %}
  <div class="rules-section mt-4" data-section-order="4">
    <details class="accordion-item accordion-item--section">
      <summary class="accordion-header accordion-header--section">
        <span class="accordion-title">üé≠ {{ character_label }}s</span>
        <span class="accordion-icon">‚ñº</span>
      </summary>
      <div class="accordion-content">
        <div class="accordion">
          {% for char in game.characters_data %}
            <details class="accordion-item">
              <summary class="accordion-header">
                <span class="accordion-title">{{ char.label }}</span>
                <span class="accordion-icon">‚ñº</span>
              </summary>
              <div class="accordion-content">
                {% if char.description %}<p>{{ char.description | markdownify }}</p>{% else %}<p class="muted">No description available.</p>{% endif %}
              </div>
            </details>
          {% endfor %}
        </div>
      </div>
    </details>
  </div>
  {% endif %}

  <!-- 5. Standard Challenge Types -->
  {% if has_challenges %}
  <div class="rules-section mt-4" data-section-order="5">
    <details class="accordion-item accordion-item--section">
      <summary class="accordion-header accordion-header--section">
        <span class="accordion-title">üéØ Standard Challenge Types</span>
        <span class="accordion-icon">‚ñº</span>
      </summary>
      <div class="accordion-content">
        <div class="accordion">
          {% for ch in game.challenges_data %}
            <details class="accordion-item">
              <summary class="accordion-header">
                <span class="accordion-title">{{ ch.label }}</span>
                <span class="accordion-icon">‚ñº</span>
              </summary>
              <div class="accordion-content">
                {% if ch.description %}<p>{{ ch.description | markdownify }}</p>{% else %}<p class="muted">See resources for detailed rules.</p>{% endif %}
              </div>
            </details>
          {% endfor %}
        </div>
      </div>
    </details>
  </div>
  {% endif %}

  <!-- 6. Optional Restrictions -->
  {% if has_restrictions %}
  <div class="rules-section mt-4" data-section-order="6">
    <details class="accordion-item accordion-item--section">
      <summary class="accordion-header accordion-header--section">
        <span class="accordion-title">‚õî Optional Restrictions</span>
        <span class="accordion-icon">‚ñº</span>
      </summary>
      <div class="accordion-content">
        <div class="accordion">
          {% for res in game.restrictions_data %}
            <details class="accordion-item">
              <summary class="accordion-header">
                <span class="accordion-title">{{ res.label }}</span>
                <span class="accordion-icon">‚ñº</span>
              </summary>
              <div class="accordion-content">
                {% if res.description %}<p>{{ res.description | markdownify }}</p>{% else %}<p class="muted">Can be combined with any category.</p>{% endif %}
                {% if res.incompatible_with and res.incompatible_with.size > 0 %}
                  <p class="mt-2 muted"><em>‚ö†Ô∏è Cannot be combined with: {{ res.incompatible_with | join: ", " }}</em></p>
                {% endif %}
              </div>
            </details>
          {% endfor %}
        </div>
      </div>
    </details>
  </div>
  {% endif %}

  <!-- 7. Glitch Categories -->
  {% if has_glitches %}
  <div class="rules-section mt-4" data-section-order="7">
    <details class="accordion-item accordion-item--section">
      <summary class="accordion-header accordion-header--section">
        <span class="accordion-title">üîß Glitch Categories</span>
        <span class="accordion-icon">‚ñº</span>
      </summary>
      <div class="accordion-content">
        <div class="accordion">
          {% for glitch in game.glitches_data %}
            <details class="accordion-item">
              <summary class="accordion-header">
                <span class="accordion-title">{{ glitch.label }}</span>
                <span class="accordion-icon">‚ñº</span>
              </summary>
              <div class="accordion-content">
                {% if glitch.description %}<p>{{ glitch.description | markdownify }}</p>{% else %}<p class="muted">See resources for detailed rules.</p>{% endif %}
                {% if glitch.allowed and glitch.allowed.size > 0 %}
                  <p class="mt-2"><strong>Allowed:</strong> {{ glitch.allowed | join: ", " }}</p>
                {% endif %}
                {% if glitch.banned and glitch.banned.size > 0 %}
                  <p class="mt-2"><strong>Banned:</strong> {{ glitch.banned | join: ", " }}</p>
                {% endif %}
                {% if glitch.notes %}
                  <p class="mt-2 muted"><em>{{ glitch.notes }}</em></p>
                {% endif %}
              </div>
            </details>
          {% endfor %}
        </div>
      </div>
    </details>
  </div>
  {% endif %}

</section>

{% if show_rule_builder %}
<!-- Rule Builder JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const gameId = '{{ game_id }}';
  
  // DOM elements
  const rbCard = document.getElementById('rule-builder-card');
  const rbToggle = document.getElementById('rb-toggle');
  const rbContent = document.getElementById('rule-builder-content');
  const categorySelect = document.getElementById('rb-category');
  const communitySelect = document.getElementById('rb-community-challenge');
  const characterSelect = document.getElementById('rb-character');
  const glitchSelect = document.getElementById('rb-glitch');
  const challengeSelect = document.getElementById('rb-challenge');
  const restrictionSelect = document.getElementById('rb-restriction');
  const resetBtn = document.getElementById('rb-reset');
  const activeFiltersDiv = document.getElementById('rb-active-filters');
  const summaryDiv = document.getElementById('rb-summary');
  const summaryContent = document.getElementById('rb-summary-content');
  const validationDiv = document.getElementById('rb-validation');
  const findRunnersBtn = document.getElementById('rb-find-runners');

  // State
  let selectedCategory = null;
  let selectedCommunityChallenge = null;
  let selectedCharacter = null;
  let selectedGlitch = null;
  let selectedChallenges = [];
  let selectedRestrictions = [];

  // Store original options for multi-selects
  const originalChallengeOptions = challengeSelect ? Array.from(challengeSelect.options).map(el => {
    if (el.tagName === 'OPTGROUP') return null;
    return {
      value: el.value,
      text: el.textContent.trim(),
      label: el.dataset.label,
      description: el.dataset.description || '',
      optgroup: el.parentElement.tagName === 'OPTGROUP' ? el.parentElement.label : null
    };
  }).filter(Boolean) : [];

  const originalRestrictionOptions = restrictionSelect ? Array.from(restrictionSelect.options).map(opt => ({
    value: opt.value,
    text: opt.textContent.trim(),
    label: opt.dataset.label,
    description: opt.dataset.description || ''
  })) : [];

  // Highlight animation on first visit
  const highlightKey = 'rb-highlighted-' + gameId;
  if (!sessionStorage.getItem(highlightKey)) {
    rbCard.classList.add('rule-builder-highlight--animate');
    sessionStorage.setItem(highlightKey, 'true');
    setTimeout(() => {
      rbCard.classList.remove('rule-builder-highlight--animate');
    }, 3000);
  }

  // Toggle Rule Builder visibility
  if (rbToggle && rbContent) {
    rbToggle.addEventListener('click', function() {
      const isHidden = rbContent.hidden;
      rbContent.hidden = !isHidden;
      rbToggle.setAttribute('aria-expanded', isHidden);
      rbToggle.classList.toggle('is-active', isHidden);
      rbCard.classList.toggle('rule-builder--expanded', isHidden);
      rbToggle.querySelector('.filter-toggle__text').textContent = isHidden ? 'Close' : 'Open';
    });
  }

  // Category select
  if (categorySelect) {
    categorySelect.addEventListener('change', function() {
      const option = this.options[this.selectedIndex];
      selectedCategory = option.value ? { 
        slug: option.value, 
        label: option.dataset.label || option.text.trim(),
        description: option.dataset.description || ''
      } : null;
      updateRuleBuilder();
    });
  }

  // Community Challenge select
  if (communitySelect) {
    communitySelect.addEventListener('change', function() {
      const option = this.options[this.selectedIndex];
      selectedCommunityChallenge = option.value ? { 
        slug: option.value, 
        label: option.dataset.label || option.text.trim(),
        description: option.dataset.description || ''
      } : null;
      updateRuleBuilder();
    });
  }

  // Character select
  if (characterSelect) {
    characterSelect.addEventListener('change', function() {
      const option = this.options[this.selectedIndex];
      selectedCharacter = option.value ? { 
        slug: option.value, 
        label: option.dataset.label || option.text.trim(),
        description: option.dataset.description || ''
      } : null;
      updateRuleBuilder();
    });
  }

  // Glitch select
  if (glitchSelect) {
    glitchSelect.addEventListener('change', function() {
      const option = this.options[this.selectedIndex];
      selectedGlitch = option.value ? { 
        slug: option.value, 
        label: option.dataset.label || option.text.trim(),
        description: option.dataset.description || '',
        allowed: option.dataset.allowed ? option.dataset.allowed.split('|') : [],
        banned: option.dataset.banned ? option.dataset.banned.split('|') : [],
        notes: option.dataset.notes || ''
      } : null;
      updateRuleBuilder();
    });
  }

  // Challenge multi-select
  if (challengeSelect) {
    challengeSelect.addEventListener('change', function() {
      const option = this.options[this.selectedIndex];
      if (option.value && !selectedChallenges.find(c => c.slug === option.value)) {
        selectedChallenges.push({ 
          slug: option.value, 
          label: option.dataset.label || option.text.trim(),
          description: option.dataset.description || ''
        });
        this.value = '';
        updateChallengeDropdown();
        updateRuleBuilder();
      }
    });
  }

  // Restriction multi-select
  if (restrictionSelect) {
    restrictionSelect.addEventListener('change', function() {
      const option = this.options[this.selectedIndex];
      if (option.value && !selectedRestrictions.find(r => r.slug === option.value)) {
        selectedRestrictions.push({ 
          slug: option.value, 
          label: option.dataset.label || option.text.trim(),
          description: option.dataset.description || ''
        });
        this.value = '';
        updateRestrictionDropdown();
        updateRuleBuilder();
      }
    });
  }

  // Reset all
  if (resetBtn) {
    resetBtn.addEventListener('click', function() {
      selectedCategory = null;
      selectedCommunityChallenge = null;
      selectedCharacter = null;
      selectedGlitch = null;
      selectedChallenges = [];
      selectedRestrictions = [];
      if (categorySelect) categorySelect.value = '';
      if (communitySelect) communitySelect.value = '';
      if (characterSelect) characterSelect.value = '';
      if (glitchSelect) glitchSelect.value = '';
      updateChallengeDropdown();
      updateRestrictionDropdown();
      updateRuleBuilder();
    });
  }

  function updateChallengeDropdown() {
    if (!challengeSelect) return;
    const selectedSlugs = selectedChallenges.map(c => c.slug);
    challengeSelect.innerHTML = '';
    const groups = {};
    originalChallengeOptions.forEach(opt => {
      if (!opt.value || !selectedSlugs.includes(opt.value)) {
        const groupName = opt.optgroup || '_default';
        if (!groups[groupName]) groups[groupName] = [];
        groups[groupName].push(opt);
      }
    });
    if (groups['_default']) {
      groups['_default'].forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        if (opt.label) option.dataset.label = opt.label;
        if (opt.description) option.dataset.description = opt.description;
        challengeSelect.appendChild(option);
      });
    }
    Object.keys(groups).filter(k => k !== '_default').forEach(groupName => {
      const optgroup = document.createElement('optgroup');
      optgroup.label = groupName;
      groups[groupName].forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        if (opt.label) option.dataset.label = opt.label;
        if (opt.description) option.dataset.description = opt.description;
        optgroup.appendChild(option);
      });
      if (optgroup.children.length > 0) challengeSelect.appendChild(optgroup);
    });
  }

  function updateRestrictionDropdown() {
    if (!restrictionSelect) return;
    const selectedSlugs = selectedRestrictions.map(r => r.slug);
    restrictionSelect.innerHTML = '';
    originalRestrictionOptions.forEach(opt => {
      if (!opt.value || !selectedSlugs.includes(opt.value)) {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        if (opt.label) option.dataset.label = opt.label;
        if (opt.description) option.dataset.description = opt.description;
        restrictionSelect.appendChild(option);
      }
    });
  }

  function removeChallenge(slug) {
    selectedChallenges = selectedChallenges.filter(c => c.slug !== slug);
    updateChallengeDropdown();
    updateRuleBuilder();
  }

  function removeRestriction(slug) {
    selectedRestrictions = selectedRestrictions.filter(r => r.slug !== slug);
    updateRestrictionDropdown();
    updateRuleBuilder();
  }

  function removeCategory() {
    selectedCategory = null;
    if (categorySelect) categorySelect.value = '';
    updateRuleBuilder();
  }

  function removeCommunityChallenge() {
    selectedCommunityChallenge = null;
    if (communitySelect) communitySelect.value = '';
    updateRuleBuilder();
  }

  function removeCharacter() {
    selectedCharacter = null;
    if (characterSelect) characterSelect.value = '';
    updateRuleBuilder();
  }

  function removeGlitch() {
    selectedGlitch = null;
    if (glitchSelect) glitchSelect.value = '';
    updateRuleBuilder();
  }

  function updateRuleBuilder() {
    const tags = [];
    let hasContent = false;

    // Build tags in order: Category -> Community -> Character -> Challenges -> Restrictions -> Glitch
    if (selectedCategory) { tags.push({ label: selectedCategory.label, clear: removeCategory }); hasContent = true; }
    if (selectedCommunityChallenge) { tags.push({ label: selectedCommunityChallenge.label, clear: removeCommunityChallenge }); hasContent = true; }
    if (selectedCharacter) { tags.push({ label: selectedCharacter.label, clear: removeCharacter }); hasContent = true; }
    selectedChallenges.forEach(c => { tags.push({ label: c.label, clear: () => removeChallenge(c.slug) }); hasContent = true; });
    selectedRestrictions.forEach(r => { tags.push({ label: r.label, clear: () => removeRestriction(r.slug) }); hasContent = true; });
    if (selectedGlitch) { tags.push({ label: selectedGlitch.label, clear: removeGlitch }); hasContent = true; }

    // Update active filters tags
    if (activeFiltersDiv) {
      activeFiltersDiv.innerHTML = tags.map(t => 
        `<span class="tag tag--removable" role="button" tabindex="0" title="Click to remove">${t.label}</span>`
      ).join('');
      activeFiltersDiv.querySelectorAll('.tag--removable').forEach((tag, i) => {
        tag.addEventListener('click', () => tags[i].clear());
        tag.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); tags[i].clear(); } });
      });
    }

    // Update rules summary panel
    if (summaryDiv && summaryContent) {
      if (hasContent) {
        let summaryHtml = '<ul class="rule-builder__rules-list">';
        
        if (selectedCategory) {
          summaryHtml += `<li><strong>Category:</strong> ${selectedCategory.label}`;
          if (selectedCategory.description) summaryHtml += `<br><span class="muted">${selectedCategory.description}</span>`;
          summaryHtml += '</li>';
        }
        
        if (selectedCommunityChallenge) {
          summaryHtml += `<li><strong>Community Challenge:</strong> ${selectedCommunityChallenge.label}`;
          if (selectedCommunityChallenge.description) summaryHtml += `<br><span class="muted">${selectedCommunityChallenge.description}</span>`;
          summaryHtml += '</li>';
        }
        
        if (selectedCharacter) {
          summaryHtml += `<li><strong>{{ character_label }}:</strong> ${selectedCharacter.label}`;
          if (selectedCharacter.description) summaryHtml += `<br><span class="muted">${selectedCharacter.description}</span>`;
          summaryHtml += '</li>';
        }
        
        selectedChallenges.forEach(ch => {
          summaryHtml += `<li><strong>Challenge:</strong> ${ch.label}`;
          if (ch.description) summaryHtml += `<br><span class="muted">${ch.description}</span>`;
          summaryHtml += '</li>';
        });
        
        selectedRestrictions.forEach(r => {
          summaryHtml += `<li><strong>Restriction:</strong> ${r.label}`;
          if (r.description) summaryHtml += `<br><span class="muted">${r.description}</span>`;
          summaryHtml += '</li>';
        });
        
        if (selectedGlitch) {
          summaryHtml += `<li><strong>Glitch Rules:</strong> ${selectedGlitch.label}`;
          if (selectedGlitch.description) summaryHtml += `<br><span class="muted">${selectedGlitch.description}</span>`;
          if (selectedGlitch.allowed && selectedGlitch.allowed.length > 0 && selectedGlitch.allowed[0]) {
            summaryHtml += `<br><span class="text-success">‚úì Allowed:</span> ${selectedGlitch.allowed.join(', ')}`;
          }
          if (selectedGlitch.banned && selectedGlitch.banned.length > 0 && selectedGlitch.banned[0]) {
            summaryHtml += `<br><span class="text-danger">‚úó Banned:</span> ${selectedGlitch.banned.join(', ')}`;
          }
          if (selectedGlitch.notes) {
            summaryHtml += `<br><em class="muted">${selectedGlitch.notes}</em>`;
          }
          summaryHtml += '</li>';
        }
        
        summaryHtml += '</ul>';
        summaryContent.innerHTML = summaryHtml;
        summaryDiv.style.display = 'block';
      } else {
        summaryDiv.style.display = 'none';
      }
    }

    if (validationDiv) validationDiv.style.display = 'none';

    if (findRunnersBtn) {
      if (hasContent) {
        const filterData = {
          challenges: selectedChallenges.map(c => c.label),
          restrictions: selectedRestrictions.map(r => r.label),
          glitch: selectedGlitch ? selectedGlitch.slug : '',
          character: selectedCharacter ? selectedCharacter.label : ''
        };
        const hashData = encodeURIComponent(JSON.stringify(filterData));
        findRunnersBtn.href = '/games/' + gameId + '/runs/#filters=' + hashData;
        findRunnersBtn.style.display = 'inline-block';
      } else {
        findRunnersBtn.style.display = 'none';
      }
    }
  }

  updateChallengeDropdown();
  updateRestrictionDropdown();
});
</script>
{% endif %}
