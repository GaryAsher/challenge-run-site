{% assign game_id = include.game.game_id %}
{% assign history = site.data.history[game_id] %}

<div class="history-tab">
  <div class="card">
    <h2>History</h2>
    <p class="muted">A log of all changes made to this game's content.</p>
    
    {% if history and history.size > 0 %}
      <div class="history-list">
        {% assign sorted_history = history | sort: "date" | reverse %}
        
        {% for entry in sorted_history limit: 50 %}
          <div class="history-entry history-entry--{{ entry.action }}">
            <div class="history-entry__icon">
              {% case entry.action %}
                {% when 'run_submitted' %}
                  <span title="Run Submitted">üì•</span>
                {% when 'run_approved' %}
                  <span title="Run Approved">‚úÖ</span>
                {% when 'run_rejected' %}
                  <span title="Run Rejected">‚ùå</span>
                {% when 'run_verified' %}
                  <span title="Run Verified">üèÜ</span>
                {% when 'run_unverified' %}
                  <span title="Verification Removed">üîÑ</span>
                {% when 'run_removed' %}
                  <span title="Run Removed">üóëÔ∏è</span>
                {% when 'rule_updated' %}
                  <span title="Rule Updated">üìù</span>
                {% when 'info_updated' %}
                  <span title="Info Updated">‚ÑπÔ∏è</span>
                {% when 'gm_added' %}
                  <span title="GM Added">üë§</span>
                {% when 'gm_removed' %}
                  <span title="GM Removed">üë§</span>
                {% else %}
                  <span>üìã</span>
              {% endcase %}
            </div>
            
            <div class="history-entry__content">
              <div class="history-entry__header">
                <span class="history-entry__action">
                  {% case entry.action %}
                    {% when 'run_submitted' %}Run submitted
                    {% when 'run_approved' %}Run approved
                    {% when 'run_rejected' %}Run rejected
                    {% when 'run_verified' %}Run verified
                    {% when 'run_unverified' %}Verification removed
                    {% when 'run_removed' %}Run removed
                    {% when 'rule_updated' %}Rules updated
                    {% when 'info_updated' %}Info updated
                    {% when 'gm_added' %}Moderator added
                    {% when 'gm_removed' %}Moderator removed
                    {% else %}{{ entry.action | replace: "_", " " | capitalize }}
                  {% endcase %}
                </span>
                <span class="history-entry__date">
                  {{ entry.date | date: "%b %d, %Y" }}
                </span>
              </div>
              
              {% if entry.target %}
                <div class="history-entry__target">
                  <code>{{ entry.target }}</code>
                </div>
              {% endif %}
              
              {% if entry.note and entry.note != "" %}
                <div class="history-entry__note">
                  {{ entry.note }}
                </div>
              {% endif %}
              
              {% if entry.by %}
                <div class="history-entry__by">
                  {% if entry.by.discord and entry.by.discord != "anonymous" %}
                    by <strong>{{ entry.by.discord }}</strong>
                  {% elsif entry.by.github %}
                    by <strong>@{{ entry.by.github }}</strong>
                  {% else %}
                    by anonymous
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
        
        {% if sorted_history.size > 50 %}
          <p class="muted history-more">
            Showing most recent 50 entries. 
            <a href="https://github.com/GaryAsher/challenge-run-site/blob/main/_data/history/{{ game_id }}.yml" target="_blank">
              View full history on GitHub
            </a>
          </p>
        {% endif %}
      </div>
    {% else %}
      <div class="history-empty">
        <p class="muted">No history recorded yet.</p>
        <p class="muted">Changes to runs, rules, and game info will appear here.</p>
      </div>
    {% endif %}
  </div>
</div>

<style>
  .history-list {
    margin-top: 1.5rem;
  }
  
  .history-entry {
    display: flex;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border, #333);
  }
  
  .history-entry:last-child {
    border-bottom: none;
  }
  
  .history-entry__icon {
    font-size: 1.25rem;
    flex-shrink: 0;
    width: 2rem;
    text-align: center;
  }
  
  .history-entry__content {
    flex: 1;
    min-width: 0;
  }
  
  .history-entry__header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .history-entry__action {
    font-weight: 500;
  }
  
  .history-entry__date {
    font-size: 0.85rem;
    color: var(--text-muted, #888);
  }
  
  .history-entry__target {
    margin-top: 0.25rem;
  }
  
  .history-entry__target code {
    font-size: 0.8rem;
    background: var(--bg, #0f0f1a);
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    word-break: break-all;
  }
  
  .history-entry__note {
    margin-top: 0.35rem;
    font-size: 0.9rem;
    color: var(--text-muted, #aaa);
  }
  
  .history-entry__by {
    margin-top: 0.35rem;
    font-size: 0.8rem;
    color: var(--text-muted, #888);
  }
  
  .history-empty {
    text-align: center;
    padding: 2rem;
  }
  
  .history-more {
    margin-top: 1rem;
    text-align: center;
    font-size: 0.85rem;
  }
  
  /* Action-specific styling */
  .history-entry--run_verified .history-entry__action {
    color: var(--success, #2ecc71);
  }
  
  .history-entry--run_rejected .history-entry__action,
  .history-entry--run_removed .history-entry__action {
    color: var(--danger, #e74c3c);
  }
  
  .history-entry--run_approved .history-entry__action {
    color: var(--primary, #3498db);
  }
</style>
