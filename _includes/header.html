<header class="site-header">
  <!-- Brand/Logo - Admin panel toggle (only for admins) -->
  <a class="brand" href="{{ '/' | relative_url }}" id="brand-link">CRC</a>
  <button type="button" class="brand brand--admin-toggle" id="brand-admin-toggle" hidden aria-label="Admin panel">
    <span class="brand__text">CRC</span>
    <span class="brand__admin-badge" id="brand-admin-badge" hidden>0</span>
  </button>

  <nav class="nav" aria-label="Primary navigation">
    <div class="nav-group">
      <a href="{{ '/games/' | relative_url }}">Games</a>
      <a href="{{ '/runners/' | relative_url }}">Runners</a>
      <a href="{{ '/teams/' | relative_url }}">Teams</a>
      <a href="{{ '/news/' | relative_url }}">News</a>
    </div>

    <div class="nav-group">
      <div class="nav-dropdown">
        <button type="button" class="nav-dropdown__toggle" aria-expanded="false" aria-haspopup="true">
          More <span class="nav-dropdown__caret">‚ñæ</span>
        </button>
        <div class="nav-dropdown__menu" hidden>
          <a href="{{ '/rules/' | relative_url }}" class="nav-dropdown__item">Rules</a>
          <a href="{{ '/glossary/' | relative_url }}" class="nav-dropdown__item">Glossary</a>
          <a href="{{ '/support/' | relative_url }}" class="nav-dropdown__item">Support</a>
          <hr class="nav-dropdown__divider">
          <a href="{{ '/feed.xml' | relative_url }}" class="nav-dropdown__item">üì° RSS Feed</a>
        </div>
      </div>
    </div>

    <div class="nav-search-wrap" id="header-search-wrap">
      <input type="text" id="header-search" class="nav-search-input" placeholder="Search..." autocomplete="off" aria-label="Search" />
      <div class="header-search-results" id="header-search-results" hidden></div>
    </div>

    <!-- User Account Section -->
    <div class="nav-group nav-user" id="nav-user">
      <!-- Signed out state -->
      <a href="{{ '/sign-in/' | relative_url }}" class="nav-user__signin" id="nav-signin">Sign In</a>
      
      <!-- Signed in state - Avatar button -->
      <button type="button" class="nav-user__avatar-btn" id="nav-user-avatar-btn" hidden aria-label="Account menu">
        <img class="nav-user__avatar" id="nav-user-avatar" src="/assets/img/site/default-runner.png" alt="" />
      </button>
      
      <!-- User dropdown menu -->
      <div class="nav-user__menu" id="nav-user-menu" hidden>
        <div class="nav-user__menu-header">
          <img class="nav-user__menu-avatar" id="nav-user-menu-avatar" src="/assets/img/site/default-runner.png" alt="" />
          <div class="nav-user__menu-info">
            <span class="nav-user__menu-name" id="nav-user-menu-name">User</span>
            <span class="nav-user__menu-status" id="nav-user-menu-status">Signed In</span>
          </div>
        </div>
        <div class="nav-user__menu-items">
          <a href="#" class="nav-user__menu-item" id="nav-profile-link">
            <span class="nav-user__menu-icon">üë§</span> My Profile
          </a>
          <a href="{{ '/profile/settings/' | relative_url }}" class="nav-user__menu-item">
            <span class="nav-user__menu-icon">‚öôÔ∏è</span> Account Settings
          </a>
          <a href="{{ '/profile/theme/' | relative_url }}" class="nav-user__menu-item">
            <span class="nav-user__menu-icon">üé®</span> Theme
          </a>
          <a href="#" class="nav-user__menu-item nav-user__menu-item--disabled" id="nav-messages-link">
            <span class="nav-user__menu-icon">üí¨</span> Messages
            <span class="nav-user__menu-soon">Soon</span>
          </a>
          <hr class="nav-user__menu-divider">
          <div class="nav-user__menu-section">
            <span class="nav-user__menu-section-title">Pending Submissions</span>
            <div id="nav-user-submissions" class="nav-user__submissions">
              <span class="nav-user__menu-muted">No pending submissions</span>
            </div>
          </div>
          <hr class="nav-user__menu-divider">
          <button type="button" class="nav-user__menu-item nav-user__menu-item--signout" id="nav-signout">
            <span class="nav-user__menu-icon">üö™</span> Sign Out
          </button>
        </div>
      </div>
    </div>
  </nav>
</header>

<!-- Admin Panel (slides from left, admins only) -->
<div class="admin-panel" id="admin-panel" hidden>
  <div class="admin-panel__backdrop" id="admin-panel-backdrop"></div>
  <aside class="admin-panel__content">
    <div class="admin-panel__header">
      <span class="admin-panel__title">
        <span class="admin-badge">Admin</span>
        Moderation
      </span>
      <button type="button" class="admin-panel__close" id="admin-panel-close">&times;</button>
    </div>
    <nav class="admin-panel__nav">
      <!-- Dashboard at TOP -->
      <a href="/admin/test/" class="admin-panel__item admin-panel__item--highlight">
        <span class="admin-panel__icon">üìä</span>
        <span class="admin-panel__text">Dashboard</span>
      </a>
      <hr class="admin-panel__divider">
      <a href="/admin/profiles/" class="admin-panel__item">
        <span class="admin-panel__icon">üë•</span>
        <span class="admin-panel__text">Pending Profiles</span>
        <span class="admin-panel__badge" id="admin-profiles-badge" hidden>0</span>
      </a>
      <a href="/admin/games/" class="admin-panel__item">
        <span class="admin-panel__icon">üéÆ</span>
        <span class="admin-panel__text">Pending Games</span>
        <span class="admin-panel__badge" id="admin-games-badge" hidden>0</span>
      </a>
      <a href="/admin/runs/" class="admin-panel__item">
        <span class="admin-panel__icon">üèÉ</span>
        <span class="admin-panel__text">Pending Runs</span>
        <span class="admin-panel__badge" id="admin-runs-badge" hidden>0</span>
      </a>
      <hr class="admin-panel__divider">
      <a href="/admin/support/" class="admin-panel__item">
        <span class="admin-panel__icon">üé´</span>
        <span class="admin-panel__text">Support Tickets</span>
        <span class="admin-panel__badge" id="admin-support-badge" hidden>0</span>
      </a>
      <a href="/admin/reports/" class="admin-panel__item">
        <span class="admin-panel__icon">‚ö†Ô∏è</span>
        <span class="admin-panel__text">User Reports</span>
        <span class="admin-panel__badge" id="admin-reports-badge" hidden>0</span>
      </a>
    </nav>
  </aside>
</div>

<!-- Header Search Index -->
<script id="header-search-data" type="application/json">
{
  "games": [{% for g in site.games %}{"id":{{ g.game_id | jsonify }},"name":{{ g.game_name | jsonify }},"aliases":{{ g.game_name_aliases | default: empty | jsonify }},"url":{{ g.url | relative_url | jsonify }}}{% unless forloop.last %},{% endunless %}{% endfor %}],
  "runners": [{% for r in site.runners %}{"id":{{ r.runner_id | default: r.title | jsonify }},"name":{{ r.name | default: r.title | jsonify }},"url":{{ r.url | relative_url | jsonify }}}{% unless forloop.last %},{% endunless %}{% endfor %}],
  "teams": [{% for t in site.teams %}{"id":{{ t.team_id | default: t.title | jsonify }},"name":{{ t.name | default: t.title | jsonify }},"url":{{ t.url | relative_url | jsonify }}}{% unless forloop.last %},{% endunless %}{% endfor %}]
}
</script>

<style>
/* Admin Panel Toggle */
.brand--admin-toggle { display: flex; align-items: center; gap: 6px; background: none; border: none; color: var(--accent); font-weight: 800; font-size: inherit; cursor: pointer; padding: 0.25rem 0.5rem; margin: -0.25rem -0.5rem; border-radius: 6px; position: relative; }
.brand--admin-toggle:hover { background: var(--surface); }
.brand--admin-toggle[hidden] { display: none; }
.brand__admin-badge { position: absolute; top: -4px; right: -8px; background: #dc3545; color: white; font-size: 0.65rem; font-weight: 700; padding: 2px 5px; border-radius: 10px; min-width: 16px; text-align: center; }
.brand__admin-badge[hidden] { display: none; }

/* Admin Panel */
.admin-panel { position: fixed; inset: 0; z-index: 1000; }
.admin-panel[hidden] { display: none; }
.admin-panel__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
.admin-panel__content { position: absolute; top: 0; left: 0; bottom: 0; width: 280px; max-width: 85vw; background: var(--surface); box-shadow: 2px 0 12px rgba(0,0,0,0.3); display: flex; flex-direction: column; animation: adminSlideIn 0.2s ease; }
@keyframes adminSlideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
.admin-panel__header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border); background: var(--bg); }
.admin-panel__title { display: flex; align-items: center; gap: 8px; font-weight: 600; }
.admin-panel__close { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; padding: 0.25rem; line-height: 1; }
.admin-panel__nav { padding: 0.75rem 0; overflow-y: auto; flex: 1; }
.admin-panel__item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--fg); text-decoration: none; transition: background 0.15s ease; }
.admin-panel__item:hover { background: var(--bg-hover); }
.admin-panel__item--highlight { background: rgba(var(--accent-rgb), 0.1); border-left: 3px solid var(--accent); }
.admin-panel__item--highlight:hover { background: rgba(var(--accent-rgb), 0.2); }
.admin-panel__icon { font-size: 1.1rem; width: 24px; text-align: center; }
.admin-panel__text { flex: 1; }
.admin-panel__badge { background: #dc3545; color: white; font-size: 0.7rem; font-weight: 700; padding: 2px 6px; border-radius: 10px; min-width: 18px; text-align: center; }
.admin-panel__badge[hidden] { display: none; }
.admin-panel__divider { margin: 0.5rem 1rem; border: none; border-top: 1px solid var(--border); }
.admin-badge { background: var(--accent); color: var(--bg); font-size: 0.65rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

/* Nav dropdown (copied from original for completeness) */
.nav-dropdown { position: relative; }
.nav-dropdown__toggle { background: none; border: none; color: var(--fg); cursor: pointer; padding: 0.5rem; font-size: inherit; display: flex; align-items: center; gap: 4px; }
.nav-dropdown__toggle:hover { color: var(--accent); }
.nav-dropdown__caret { font-size: 0.75em; }
.nav-dropdown__menu { position: absolute; top: 100%; right: 0; min-width: 180px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: 0 4px 12px rgba(0,0,0,0.3); padding: 0.5rem 0; z-index: 100; }
.nav-dropdown__menu[hidden] { display: none; }
.nav-dropdown__item { display: block; padding: 0.5rem 1rem; color: var(--fg); text-decoration: none; }
.nav-dropdown__item:hover { background: var(--bg-hover); }
.nav-dropdown__divider { margin: 0.5rem 0; border: none; border-top: 1px solid var(--border); }
</style>

<script>
// Header search
(function() {
  var data, input = document.getElementById('header-search'), results = document.getElementById('header-search-results');
  if (!input || !results) return;
  try { data = JSON.parse(document.getElementById('header-search-data')?.textContent || '{}'); } catch { return; }
  function search(q) {
    if (!q || q.length < 2) return { games: [], runners: [], teams: [] };
    q = q.toLowerCase();
    return {
      games: (data.games || []).filter(function(g) { return g.name.toLowerCase().includes(q) || (g.aliases || []).some(function(a){return a.toLowerCase().includes(q);}); }).slice(0,5),
      runners: (data.runners || []).filter(function(r) { return r.name.toLowerCase().includes(q) || r.id.toLowerCase().includes(q); }).slice(0,5),
      teams: (data.teams || []).filter(function(t) { return t.name.toLowerCase().includes(q) || t.id.toLowerCase().includes(q); }).slice(0,5)
    };
  }
  function render(r, q) {
    if (!q || q.length<2) { results.hidden=true; return; }
    var total = r.games.length + r.runners.length + r.teams.length;
    if (!total) { results.innerHTML='<div class="search-no-results">No results</div>'; results.hidden=false; return; }
    var h='';
    if (r.games.length) { h+='<div class="search-result-group"><div class="search-result-group__title">Games</div>'; r.games.forEach(function(g){h+='<a href="'+g.url+'" class="search-result-item">'+g.name+'</a>';}); h+='</div>'; }
    if (r.runners.length) { h+='<div class="search-result-group"><div class="search-result-group__title">Runners</div>'; r.runners.forEach(function(x){h+='<a href="'+x.url+'" class="search-result-item">'+x.name+'</a>';}); h+='</div>'; }
    if (r.teams.length) { h+='<div class="search-result-group"><div class="search-result-group__title">Teams</div>'; r.teams.forEach(function(x){h+='<a href="'+x.url+'" class="search-result-item">'+x.name+'</a>';}); h+='</div>'; }
    results.innerHTML=h; results.hidden=false;
  }
  var t; input.addEventListener('input',function(){clearTimeout(t);t=setTimeout(function(){render(search(input.value),input.value);},150);});
  input.addEventListener('blur',function(){setTimeout(function(){results.hidden=true;},200);});
  input.addEventListener('focus',function(){if(input.value.length>=2)render(search(input.value),input.value);});
})();

// User menu toggle
(function() {
  var btn = document.getElementById('nav-user-avatar-btn'), menu = document.getElementById('nav-user-menu');
  if (!btn || !menu) return;
  btn.addEventListener('click', function(e) { e.stopPropagation(); menu.hidden = !menu.hidden; });
  document.addEventListener('click', function(e) { if (!menu.hidden && !menu.contains(e.target)) menu.hidden = true; });
  document.addEventListener('keydown', function(e) { if (e.key === 'Escape') menu.hidden = true; });
})();

// Admin panel toggle
(function() {
  var btn = document.getElementById('brand-admin-toggle'), panel = document.getElementById('admin-panel');
  if (!btn || !panel) return;
  btn.addEventListener('click', function() { panel.hidden = false; });
  document.getElementById('admin-panel-backdrop')?.addEventListener('click', function() { panel.hidden = true; });
  document.getElementById('admin-panel-close')?.addEventListener('click', function() { panel.hidden = true; });
  document.addEventListener('keydown', function(e) { if (e.key === 'Escape' && !panel.hidden) panel.hidden = true; });
})();

// Apply saved theme on page load
(function() {
  var saved = localStorage.getItem('crc-theme');
  if (saved) {
    try {
      var theme = JSON.parse(saved);
      if (theme.accent) document.documentElement.style.setProperty('--accent', theme.accent);
      if (theme.accentRgb) document.documentElement.style.setProperty('--accent-rgb', theme.accentRgb);
      if (theme.bg) document.documentElement.style.setProperty('--bg', theme.bg);
      if (theme.surface) document.documentElement.style.setProperty('--surface', theme.surface);
      if (theme.bgImage) document.body.style.backgroundImage = 'url(' + theme.bgImage + ')';
      if (theme.bgOpacity) document.body.style.setProperty('--theme-bg-opacity', theme.bgOpacity);
    } catch (e) {}
  }
})();
</script>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

const ADMIN_IDS = ['gary-asher'];

async function initHeaderAuth() {
  try {
    await CRCAuth.init();
    
    const signinLink = document.getElementById('nav-signin');
    const avatarBtn = document.getElementById('nav-user-avatar-btn');
    const userAvatar = document.getElementById('nav-user-avatar');
    const menuAvatar = document.getElementById('nav-user-menu-avatar');
    const menuName = document.getElementById('nav-user-menu-name');
    const menuStatus = document.getElementById('nav-user-menu-status');
    const profileLink = document.getElementById('nav-profile-link');
    const signoutBtn = document.getElementById('nav-signout');
    const submissionsEl = document.getElementById('nav-user-submissions');
    const brandLink = document.getElementById('brand-link');
    const adminToggle = document.getElementById('brand-admin-toggle');
    
    if (!CRCAuth.isSignedIn()) return;
    
    // User is signed in - swap Sign In for avatar
    const metadata = CRCAuth.getProviderMetadata();
    const profile = CRCAuth.getProfile();
    
    signinLink.hidden = true;
    avatarBtn.hidden = false;
    
    const avatarUrl = metadata.providerAvatar || '/assets/img/site/default-runner.png';
    userAvatar.src = avatarUrl;
    menuAvatar.src = avatarUrl;
    menuName.textContent = profile?.display_name || metadata.providerUsername || 'User';
    
    if (profile && !profile._isPending) {
      menuStatus.textContent = 'Runner';
      profileLink.href = '/runners/' + profile.runner_id + '/';
      profileLink.innerHTML = '<span class="nav-user__menu-icon">üë§</span> My Profile';
    } else if (profile && profile._isPending) {
      menuStatus.textContent = '‚è≥ Profile Pending';
      profileLink.href = '/profile/status/';
      profileLink.innerHTML = '<span class="nav-user__menu-icon">‚è≥</span> Profile Status';
    } else {
      menuStatus.textContent = 'No Profile';
      profileLink.href = '/profile/create/';
      profileLink.innerHTML = '<span class="nav-user__menu-icon">‚ûï</span> Create Profile';
    }
    
    loadUserSubmissions(submissionsEl);
    
    // Check admin
    const isAdmin = await checkAdminStatus();
    if (isAdmin) {
      brandLink.hidden = true;
      adminToggle.hidden = false;
      loadAdminCounts();
    }
    
    signoutBtn?.addEventListener('click', async () => { await CRCAuth.signOut(); window.location.href = '/'; });
  } catch (err) { console.error('[Header] Auth error:', err); }
}

async function checkAdminStatus() {
  const profile = CRCAuth.getProfile();
  const metadata = CRCAuth.getProviderMetadata();
  if (profile?.runner_id && ADMIN_IDS.includes(profile.runner_id.toLowerCase())) return true;
  const username = metadata?.providerUsername?.toLowerCase() || '';
  if (ADMIN_IDS.some(id => username === id || username === id.replace(/-/g, '_'))) return true;
  
  const supabase = CRCAuth.getSupabaseClient?.();
  if (supabase) {
    const user = CRCAuth.getUser();
    if (user) {
      const { data } = await supabase.from('runner_profiles').select('is_admin').eq('user_id', user.id).single();
      if (data?.is_admin) return true;
    }
  }
  return false;
}

async function loadUserSubmissions(el) {
  if (!el) return;
  const supabase = CRCAuth.getSupabaseClient?.();
  const user = CRCAuth.getUser();
  if (!supabase || !user) { el.innerHTML = '<span class="nav-user__menu-muted">No pending submissions</span>'; return; }
  
  try {
    const { data } = await supabase.from('pending_profiles').select('requested_runner_id').eq('user_id', user.id).eq('status', 'pending');
    if (data?.length) {
      el.innerHTML = data.map(p => `<a href="/profile/status/" class="nav-user__submission-item"><span class="nav-user__submission-status">Pending</span>Profile: ${p.requested_runner_id}</a>`).join('');
    } else {
      el.innerHTML = '<span class="nav-user__menu-muted">No pending submissions</span>';
    }
  } catch { el.innerHTML = '<span class="nav-user__menu-muted">No pending submissions</span>'; }
}

async function loadAdminCounts() {
  const supabase = CRCAuth.getSupabaseClient?.();
  if (!supabase) return;
  let total = 0;
  
  try {
    const { count: profiles } = await supabase.from('pending_profiles').select('*', { count: 'exact', head: true }).eq('status', 'pending');
    if (profiles > 0) {
      document.getElementById('admin-profiles-badge')?.classList.remove('hidden');
      document.getElementById('admin-profiles-badge').hidden = false;
      document.getElementById('admin-profiles-badge').textContent = profiles;
      total += profiles;
    }
    // TODO: games, runs, support, reports counts
    
    if (total > 0) {
      const mainBadge = document.getElementById('brand-admin-badge');
      if (mainBadge) { mainBadge.textContent = total; mainBadge.hidden = false; }
    }
  } catch (e) { console.error('[Header] Admin counts:', e); }
}

initHeaderAuth();
</script>
