<header class="site-header">
  <!-- Brand/Logo - becomes panel toggle when signed in -->
  <a class="brand" href="{{ '/' | relative_url }}" id="brand-link">CRC</a>
  <button type="button" class="brand brand--panel-toggle" id="brand-panel-toggle" hidden aria-label="Open dashboard">
    <span class="brand__text">CRC</span>
    <svg class="brand__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>

  <nav class="nav" aria-label="Primary navigation">
    <div class="nav-group">
      <a href="{{ '/games/' | relative_url }}">Games</a>
      <a href="{{ '/runners/' | relative_url }}">Runners</a>
      <a href="{{ '/teams/' | relative_url }}">Teams</a>
      <a href="{{ '/news/' | relative_url }}">News</a>
    </div>

    <div class="nav-group">
      <div class="nav-dropdown">
        <button type="button" class="nav-dropdown__toggle" aria-expanded="false" aria-haspopup="true">
          More <span class="nav-dropdown__caret">‚ñæ</span>
        </button>
        <div class="nav-dropdown__menu" hidden>
          <a href="{{ '/rules/' | relative_url }}" class="nav-dropdown__item">Rules</a>
          <a href="{{ '/glossary/' | relative_url }}" class="nav-dropdown__item">Glossary</a>
          <a href="{{ '/support/' | relative_url }}" class="nav-dropdown__item">Support</a>
          <hr class="nav-dropdown__divider">
          <a href="{{ '/feed.xml' | relative_url }}" class="nav-dropdown__item">üì° RSS Feed</a>
        </div>
      </div>
    </div>

    <div class="nav-search-wrap" id="header-search-wrap">
      <input
        type="text"
        id="header-search"
        class="nav-search-input"
        placeholder="Search..."
        autocomplete="off"
        aria-label="Search"
      />
      <div class="header-search-results" id="header-search-results" hidden></div>
    </div>

    <!-- User Account Section -->
    <div class="nav-group nav-user" id="nav-user">
      <!-- Signed out state -->
      <a href="{{ '/sign-in/' | relative_url }}" class="nav-user__signin" id="nav-signin">Sign In</a>
      
      <!-- Signed in state - Avatar button (hidden by default, shown via JS) -->
      <button type="button" class="nav-user__avatar-btn" id="nav-user-avatar-btn" hidden aria-label="Account menu" aria-expanded="false" aria-haspopup="true">
        <img class="nav-user__avatar" id="nav-user-avatar" src="/assets/img/site/default-runner.png" alt="" />
      </button>
      
      <!-- User dropdown menu (appears when avatar is clicked) -->
      <div class="nav-user__menu" id="nav-user-menu" hidden>
        <div class="nav-user__menu-header">
          <img class="nav-user__menu-avatar" id="nav-user-menu-avatar" src="/assets/img/site/default-runner.png" alt="" />
          <div class="nav-user__menu-info">
            <span class="nav-user__menu-name" id="nav-user-menu-name">User</span>
            <span class="nav-user__menu-status" id="nav-user-menu-status">Signed In</span>
          </div>
        </div>
        <div class="nav-user__menu-items">
          <a href="#" class="nav-user__menu-item" id="nav-profile-link">
            <span class="nav-user__menu-icon">üë§</span> My Profile
          </a>
          <a href="{{ '/profile/settings/' | relative_url }}" class="nav-user__menu-item">
            <span class="nav-user__menu-icon">‚öôÔ∏è</span> Settings
          </a>
          <hr class="nav-user__menu-divider">
          <a href="{{ '/submit/' | relative_url }}" class="nav-user__menu-item">
            <span class="nav-user__menu-icon">üéÆ</span> Submit a Run
          </a>
          <hr class="nav-user__menu-divider">
          <button type="button" class="nav-user__menu-item nav-user__menu-item--btn" id="nav-signout">
            <span class="nav-user__menu-icon">üö™</span> Sign Out
          </button>
        </div>
      </div>
    </div>
  </nav>
</header>

<!-- Header Search Index -->
<script id="header-search-data" type="application/json">
{
  "games": [
    {% for g in site.games %}
    {
      "id": {{ g.game_id | jsonify }},
      "name": {{ g.game_name | jsonify }},
      "aliases": {{ g.game_name_aliases | default: empty | jsonify }},
      "url": {{ g.url | relative_url | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  "runners": [
    {% for r in site.runners %}
    {
      "id": {{ r.runner_id | default: r.title | jsonify }},
      "name": {{ r.name | default: r.title | jsonify }},
      "url": {{ r.url | relative_url | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  "teams": [
    {% for t in site.teams %}
    {
      "id": {{ t.team_id | default: t.title | jsonify }},
      "name": {{ t.name | default: t.title | jsonify }},
      "url": {{ t.url | relative_url | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
}
</script>

<script>
// More dropdown toggle
(function() {
  document.querySelectorAll('.nav-dropdown__toggle').forEach(function(btn) {
    var menu = btn.nextElementSibling;
    
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      var isOpen = !menu.hidden;
      menu.hidden = isOpen;
      btn.setAttribute('aria-expanded', !isOpen);
    });
  });
  
  document.addEventListener('click', function() {
    document.querySelectorAll('.nav-dropdown__menu').forEach(function(m) {
      m.hidden = true;
      m.previousElementSibling.setAttribute('aria-expanded', 'false');
    });
  });
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('.nav-dropdown__menu').forEach(function(m) {
        m.hidden = true;
        m.previousElementSibling.setAttribute('aria-expanded', 'false');
      });
    }
  });
})();

// Header live search
(function() {
  var input = document.getElementById('header-search');
  var results = document.getElementById('header-search-results');
  var dataEl = document.getElementById('header-search-data');
  
  if (!input || !results || !dataEl) return;
  
  var searchData;
  try {
    searchData = JSON.parse(dataEl.textContent);
  } catch(e) {
    return;
  }
  
  function norm(s) {
    return (s || '').toString().trim().toLowerCase();
  }
  
  // Convert roman numerals to arabic for matching
  function expandRomanNumerals(s) {
    var str = norm(s);
    var romans = [
      ['viii', '8'], ['vii', '7'], ['vi', '6'], ['iv', '4'], ['v', '5'],
      ['iii', '3'], ['ii', '2'], ['i', '1'],
      ['xiii', '13'], ['xii', '12'], ['xi', '11'], ['x', '10'],
      ['xiv', '14'], ['xv', '15'], ['xvi', '16']
    ];
    romans.forEach(function(pair) {
      var regex = new RegExp('\\b' + pair[0] + '\\b', 'g');
      str = str.replace(regex, pair[1]);
    });
    return str;
  }
  
  function search(query) {
    var q = norm(query);
    var qExpanded = expandRomanNumerals(query);
    if (!q || q.length < 2) return { games: [], runners: [], teams: [] };
    
    var out = { games: [], runners: [], teams: [] };
    
    (searchData.games || []).forEach(function(g) {
      var haystack = [norm(g.name), norm(g.id)].concat((g.aliases || []).map(norm)).join(' ');
      var haystackExpanded = expandRomanNumerals(haystack);
      if (haystack.indexOf(q) !== -1 || haystackExpanded.indexOf(qExpanded) !== -1) {
        out.games.push(g);
      }
    });
    
    (searchData.runners || []).forEach(function(r) {
      if (norm(r.name).indexOf(q) !== -1 || norm(r.id).indexOf(q) !== -1) {
        out.runners.push(r);
      }
    });
    
    (searchData.teams || []).forEach(function(t) {
      if (norm(t.name).indexOf(q) !== -1 || norm(t.id).indexOf(q) !== -1) {
        out.teams.push(t);
      }
    });
    
    out.games = out.games.slice(0, 5);
    out.runners = out.runners.slice(0, 5);
    out.teams = out.teams.slice(0, 3);
    
    return out;
  }
  
  function escapeHtml(s) {
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }
  
  function render(searchResults, query) {
    var total = searchResults.games.length + searchResults.runners.length + searchResults.teams.length;
    
    if (!query || query.length < 2) {
      results.hidden = true;
      return;
    }
    
    if (total === 0) {
      results.innerHTML = '<div class="search-no-results">No results found</div>';
      results.hidden = false;
      return;
    }
    
    var html = '';
    
    if (searchResults.games.length) {
      html += '<div class="search-result-group">';
      html += '<div class="search-result-group__title">Games</div>';
      searchResults.games.forEach(function(g) {
        html += '<a href="' + g.url + '" class="search-result-item">';
        html += '<span class="search-result-item__name">' + escapeHtml(g.name) + '</span>';
        html += '</a>';
      });
      html += '</div>';
    }
    
    if (searchResults.runners.length) {
      html += '<div class="search-result-group">';
      html += '<div class="search-result-group__title">Runners</div>';
      searchResults.runners.forEach(function(r) {
        html += '<a href="' + r.url + '" class="search-result-item">';
        html += '<span class="search-result-item__name">' + escapeHtml(r.name) + '</span>';
        html += '</a>';
      });
      html += '</div>';
    }
    
    if (searchResults.teams.length) {
      html += '<div class="search-result-group">';
      html += '<div class="search-result-group__title">Teams</div>';
      searchResults.teams.forEach(function(t) {
        html += '<a href="' + t.url + '" class="search-result-item">';
        html += '<span class="search-result-item__name">' + escapeHtml(t.name) + '</span>';
        html += '</a>';
      });
      html += '</div>';
    }
    
    results.innerHTML = html;
    results.hidden = false;
  }
  
  var debounceTimer;
  input.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(function() {
      var query = input.value;
      var searchResults = search(query);
      render(searchResults, query);
    }, 150);
  });
  
  input.addEventListener('blur', function() {
    setTimeout(function() {
      results.hidden = true;
    }, 200);
  });
  
  input.addEventListener('focus', function() {
    if (input.value.length >= 2) {
      var searchResults = search(input.value);
      render(searchResults, input.value);
    }
  });
  
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      results.hidden = true;
      input.blur();
    }
  });
})();

// Header User Auth State
(function() {
  var signinLink = document.getElementById('nav-signin');
  var avatarBtn = document.getElementById('nav-user-avatar-btn');
  var userAvatar = document.getElementById('nav-user-avatar');
  var userMenu = document.getElementById('nav-user-menu');
  var menuAvatar = document.getElementById('nav-user-menu-avatar');
  var menuName = document.getElementById('nav-user-menu-name');
  var menuStatus = document.getElementById('nav-user-menu-status');
  var profileLink = document.getElementById('nav-profile-link');
  var signoutBtn = document.getElementById('nav-signout');
  
  if (!signinLink || !avatarBtn) return;
  
  // Toggle user menu
  avatarBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    var isOpen = !userMenu.hidden;
    userMenu.hidden = isOpen;
    avatarBtn.setAttribute('aria-expanded', !isOpen);
  });
  
  // Close menu when clicking outside
  document.addEventListener('click', function(e) {
    if (!userMenu.hidden && !userMenu.contains(e.target) && e.target !== avatarBtn) {
      userMenu.hidden = true;
      avatarBtn.setAttribute('aria-expanded', 'false');
    }
  });
  
  // Close on Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !userMenu.hidden) {
      userMenu.hidden = true;
      avatarBtn.setAttribute('aria-expanded', 'false');
    }
  });
  
  // Check if CRCAuth is available (loaded via module in pages that need it)
  function initAuthUI() {
    if (typeof window.CRCAuth === 'undefined') {
      return;
    }
    
    var auth = window.CRCAuth;
    
    if (auth.isSignedIn()) {
      var metadata = auth.getProviderMetadata();
      var profile = auth.getProfile();
      
      // Hide sign in, show avatar
      signinLink.hidden = true;
      avatarBtn.hidden = false;
      
      // Set avatar images
      var avatarUrl = metadata.providerAvatar || '/assets/img/site/default-runner.png';
      userAvatar.src = avatarUrl;
      menuAvatar.src = avatarUrl;
      
      // Set name and status
      menuName.textContent = profile?.display_name || metadata.providerUsername || 'User';
      
      if (profile && !profile._isPending) {
        menuStatus.textContent = 'Runner';
        profileLink.href = '/runners/' + profile.runner_id + '/';
        profileLink.innerHTML = '<span class="nav-user__menu-icon">üë§</span> My Profile';
      } else if (profile && profile._isPending) {
        menuStatus.textContent = '‚è≥ Profile Pending';
        profileLink.href = '/profile/status/';
        profileLink.innerHTML = '<span class="nav-user__menu-icon">‚è≥</span> Profile Status';
      } else {
        menuStatus.textContent = 'No Profile';
        profileLink.href = '/profile/create/';
        profileLink.innerHTML = '<span class="nav-user__menu-icon">‚ûï</span> Create Profile';
      }
    }
    
    // Listen for auth changes
    auth.onAuthStateChange(function(event, user, profile) {
      if (event === 'SIGNED_IN') {
        signinLink.hidden = true;
        avatarBtn.hidden = false;
      } else if (event === 'SIGNED_OUT') {
        signinLink.hidden = false;
        avatarBtn.hidden = true;
        userMenu.hidden = true;
      }
    });
  }
  
  // Sign out handler
  if (signoutBtn) {
    signoutBtn.addEventListener('click', async function() {
      if (typeof window.CRCAuth !== 'undefined') {
        await window.CRCAuth.signOut();
        window.location.href = '/';
      }
    });
  }
  
  // Try to init after a short delay (in case auth.js loads async)
  setTimeout(initAuthUI, 100);
  
  // Also listen for custom event from auth module
  document.addEventListener('crc-auth-ready', initAuthUI);
})();
</script>
