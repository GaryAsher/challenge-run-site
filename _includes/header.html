<header class="site-header">
  <a class="brand" href="{{ '/' | relative_url }}">CRC</a>

  <nav class="nav" aria-label="Primary navigation">
    <div class="nav-group">
      <a href="{{ '/games/' | relative_url }}">Games</a>
      <a href="{{ '/runners/' | relative_url }}">Runners</a>
      <a href="{{ '/teams/' | relative_url }}">Teams</a>
      <a href="{{ '/news/' | relative_url }}">News</a>
    </div>

    <div class="nav-group">
      <div class="nav-dropdown">
        <button type="button" class="nav-dropdown__toggle" aria-expanded="false" aria-haspopup="true">
          More <span class="nav-dropdown__caret">â–¾</span>
        </button>
        <div class="nav-dropdown__menu" hidden>
          <a href="{{ '/rules/' | relative_url }}" class="nav-dropdown__item">Rules</a>
          <a href="{{ '/glossary/' | relative_url }}" class="nav-dropdown__item">Glossary</a>
          <a href="{{ '/support/' | relative_url }}" class="nav-dropdown__item">Support</a>
          <hr class="nav-dropdown__divider">
          <a href="{{ '/feed.xml' | relative_url }}" class="nav-dropdown__item">ðŸ“¡ RSS Feed</a>
        </div>
      </div>
    </div>

    <div class="nav-search-wrap" id="header-search-wrap">
      <input
        type="text"
        id="header-search"
        class="nav-search-input"
        placeholder="Search..."
        autocomplete="off"
        aria-label="Search"
      />
      <div class="header-search-results" id="header-search-results" hidden></div>
    </div>
  </nav>
</header>

<!-- Header Search Index -->
<script id="header-search-data" type="application/json">
{
  "games": [
    {% for g in site.games %}
    {
      "id": {{ g.game_id | jsonify }},
      "name": {{ g.game_name | jsonify }},
      "aliases": {{ g.game_name_aliases | default: empty | jsonify }},
      "url": {{ g.url | relative_url | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  "runners": [
    {% for r in site.runners %}
    {
      "id": {{ r.runner_id | default: r.title | jsonify }},
      "name": {{ r.name | default: r.title | jsonify }},
      "url": {{ r.url | relative_url | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  "teams": [
    {% for t in site.teams %}
    {
      "id": {{ t.team_id | default: t.title | jsonify }},
      "name": {{ t.name | default: t.title | jsonify }},
      "url": {{ t.url | relative_url | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
}
</script>

<script>
// More dropdown toggle
(function() {
  document.querySelectorAll('.nav-dropdown__toggle').forEach(function(btn) {
    var menu = btn.nextElementSibling;
    
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      var isOpen = !menu.hidden;
      menu.hidden = isOpen;
      btn.setAttribute('aria-expanded', !isOpen);
    });
  });
  
  document.addEventListener('click', function() {
    document.querySelectorAll('.nav-dropdown__menu').forEach(function(m) {
      m.hidden = true;
      m.previousElementSibling.setAttribute('aria-expanded', 'false');
    });
  });
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('.nav-dropdown__menu').forEach(function(m) {
        m.hidden = true;
        m.previousElementSibling.setAttribute('aria-expanded', 'false');
      });
    }
  });
})();

// Header live search
(function() {
  var input = document.getElementById('header-search');
  var results = document.getElementById('header-search-results');
  var dataEl = document.getElementById('header-search-data');
  
  if (!input || !results || !dataEl) return;
  
  var searchData;
  try {
    searchData = JSON.parse(dataEl.textContent);
  } catch(e) {
    return;
  }
  
  function norm(s) {
    return (s || '').toString().trim().toLowerCase();
  }
  
  // Convert roman numerals to arabic for matching
  function expandRomanNumerals(s) {
    var str = norm(s);
    var romans = [
      ['viii', '8'], ['vii', '7'], ['vi', '6'], ['iv', '4'], ['v', '5'],
      ['iii', '3'], ['ii', '2'], ['i', '1'],
      ['xiii', '13'], ['xii', '12'], ['xi', '11'], ['x', '10'],
      ['xiv', '14'], ['xv', '15'], ['xvi', '16']
    ];
    romans.forEach(function(pair) {
      var regex = new RegExp('\\b' + pair[0] + '\\b', 'g');
      str = str.replace(regex, pair[1]);
    });
    return str;
  }
  
  function search(query) {
    var q = norm(query);
    var qExpanded = expandRomanNumerals(query);
    if (!q || q.length < 2) return { games: [], runners: [], teams: [] };
    
    var out = { games: [], runners: [], teams: [] };
    
    (searchData.games || []).forEach(function(g) {
      var haystack = [norm(g.name), norm(g.id)].concat((g.aliases || []).map(norm)).join(' ');
      var haystackExpanded = expandRomanNumerals(haystack);
      if (haystack.indexOf(q) !== -1 || haystackExpanded.indexOf(qExpanded) !== -1) {
        out.games.push(g);
      }
    });
    
    (searchData.runners || []).forEach(function(r) {
      if (norm(r.name).indexOf(q) !== -1 || norm(r.id).indexOf(q) !== -1) {
        out.runners.push(r);
      }
    });
    
    (searchData.teams || []).forEach(function(t) {
      if (norm(t.name).indexOf(q) !== -1 || norm(t.id).indexOf(q) !== -1) {
        out.teams.push(t);
      }
    });
    
    out.games = out.games.slice(0, 5);
    out.runners = out.runners.slice(0, 5);
    out.teams = out.teams.slice(0, 3);
    
    return out;
  }
  
  function escapeHtml(s) {
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }
  
  function render(searchResults, query) {
    var total = searchResults.games.length + searchResults.runners.length + searchResults.teams.length;
    
    if (!query || query.length < 2) {
      results.hidden = true;
      return;
    }
    
    if (total === 0) {
      results.innerHTML = '<div class="search-no-results">No results found</div>';
      results.hidden = false;
      return;
    }
    
    var html = '';
    
    if (searchResults.games.length) {
      html += '<div class="search-result-group">';
      html += '<div class="search-result-group__title">Games</div>';
      searchResults.games.forEach(function(g) {
        html += '<a href="' + g.url + '" class="search-result-item">';
        html += '<span class="search-result-item__name">' + escapeHtml(g.name) + '</span>';
        html += '</a>';
      });
      html += '</div>';
    }
    
    if (searchResults.runners.length) {
      html += '<div class="search-result-group">';
      html += '<div class="search-result-group__title">Runners</div>';
      searchResults.runners.forEach(function(r) {
        html += '<a href="' + r.url + '" class="search-result-item">';
        html += '<span class="search-result-item__name">' + escapeHtml(r.name) + '</span>';
        html += '</a>';
      });
      html += '</div>';
    }
    
    if (searchResults.teams.length) {
      html += '<div class="search-result-group">';
      html += '<div class="search-result-group__title">Teams</div>';
      searchResults.teams.forEach(function(t) {
        html += '<a href="' + t.url + '" class="search-result-item">';
        html += '<span class="search-result-item__name">' + escapeHtml(t.name) + '</span>';
        html += '</a>';
      });
      html += '</div>';
    }
    
    results.innerHTML = html;
    results.hidden = false;
  }
  
  var debounceTimer;
  input.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(function() {
      var query = input.value;
      var searchResults = search(query);
      render(searchResults, query);
    }, 150);
  });
  
  input.addEventListener('blur', function() {
    setTimeout(function() {
      results.hidden = true;
    }, 200);
  });
  
  input.addEventListener('focus', function() {
    if (input.value.length >= 2) {
      var searchResults = search(input.value);
      render(searchResults, input.value);
    }
  });
  
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      results.hidden = true;
      input.blur();
    }
  });
})();
</script>
