<!-- Debug View Banner (Discord-style ‚Äî above entire header when simulating a role) -->
<div class="debug-view-header-banner" id="header-debug-banner" hidden>
  <span class="debug-view-header-banner__icon">üëÅÔ∏è</span>
  <span class="debug-view-header-banner__text">Now viewing as: <strong id="header-debug-role">User</strong></span>
  <span class="debug-view-header-banner__hint">This is how the site appears to this role. Forms and actions are disabled.</span>
  <button type="button" class="debug-view-header-banner__exit" id="header-exit-debug">‚Ü© Return to Super Admin</button>
</div>

<header class="site-header">
  
  <!-- Brand/Logo -->
  <a class="brand" href="{{ '/' | relative_url }}" id="brand-link" title="Go to Home">CRC</a>
  
  <!-- Admin Panel Button (next to logo, only for admins) -->
  <button type="button" class="header-admin-btn" id="header-admin-btn" hidden title="Admin Panel">
    <span class="header-admin-btn__icon">üõ°Ô∏è</span>
    <span class="header-admin-btn__badge" id="header-admin-badge" hidden>0</span>
  </button>

  <nav class="nav" aria-label="Primary navigation">
    <div class="nav-group">
      <a href="{{ '/games/' | relative_url }}">Games</a>
      <a href="{{ '/runners/' | relative_url }}">Runners</a>
      <a href="{{ '/teams/' | relative_url }}">Teams</a>
    </div>

    <div class="nav-group">
      <div class="nav-dropdown" id="more-dropdown">
        <button type="button" class="nav-dropdown__toggle" aria-expanded="false" aria-haspopup="true">
          More <span class="nav-dropdown__caret">‚ñæ</span>
        </button>
        <div class="nav-dropdown__menu" hidden>
          <a href="{{ '/news/' | relative_url }}" class="nav-dropdown__item">üì∞ News</a>
          <a href="{{ '/rules/' | relative_url }}" class="nav-dropdown__item">üìú Rules</a>
          <a href="{{ '/glossary/' | relative_url }}" class="nav-dropdown__item">üìñ Glossary</a>
          <a href="{{ '/support/' | relative_url }}" class="nav-dropdown__item">üí¨ Support</a>
          <hr class="nav-dropdown__divider">
          <a href="{{ '/feed.xml' | relative_url }}" class="nav-dropdown__item">üì° RSS Feed</a>
        </div>
      </div>
    </div>

    <div class="nav-search-wrap" id="header-search-wrap">
      <input type="text" id="header-search" class="nav-search-input" placeholder="Search..." autocomplete="off" aria-label="Search" />
      <div class="header-search-results" id="header-search-results" hidden></div>
    </div>

    <!-- User Account Section -->
    <div class="nav-group nav-user" id="nav-user">
      <a href="{{ '/sign-in/' | relative_url }}" class="nav-user__signin" id="nav-signin">Sign In</a>
      <button type="button" class="nav-user__avatar-btn" id="nav-user-avatar-btn" hidden aria-label="Account menu">
        <img class="nav-user__avatar" id="nav-user-avatar" src="/assets/img/site/default-runner.png" alt="" />
        <span class="nav-user__admin-indicator" id="nav-user-admin-indicator" hidden></span>
      </button>
      <div class="nav-user__menu" id="nav-user-menu" hidden>
        <div class="nav-user__menu-header">
          <img class="nav-user__menu-avatar" id="nav-user-menu-avatar" src="/assets/img/site/default-runner.png" alt="" />
          <div class="nav-user__menu-info">
            <span class="nav-user__menu-name" id="nav-user-menu-name">User</span>
            <span class="nav-user__menu-role" id="nav-user-menu-role">Runner</span>
          </div>
        </div>
        <div class="nav-user__menu-items">
          <a href="#" class="nav-user__menu-item" id="nav-profile-link">
            <span class="nav-user__menu-icon">üë§</span> My Profile
          </a>
          <a href="{{ '/profile/edit/' | relative_url }}" class="nav-user__menu-item">
            <span class="nav-user__menu-icon">‚úèÔ∏è</span> Edit Profile
          </a>
          <a href="{{ '/profile/theme/' | relative_url }}" class="nav-user__menu-item">
            <span class="nav-user__menu-icon">üé®</span> Theme
          </a>
          <a href="{{ '/profile/settings/' | relative_url }}" class="nav-user__menu-item">
            <span class="nav-user__menu-icon">‚öôÔ∏è</span> Account Settings
          </a>
          <hr class="nav-user__menu-divider">
          <!-- Messages -->
          <a href="{{ '/profile/messages/' | relative_url }}" class="nav-user__menu-item" id="nav-messages-link">
            <span class="nav-user__menu-icon">üí¨</span> 
            <span>Messages</span>
            <span class="nav-user__menu-badge" id="nav-messages-badge" hidden>0</span>
          </a>
          <!-- Pending Submissions -->
          <a href="{{ '/profile/submissions/' | relative_url }}" class="nav-user__menu-item" id="nav-submissions-link">
            <span class="nav-user__menu-icon">üìã</span> 
            <span>Pending Submissions</span>
            <span class="nav-user__menu-badge" id="nav-submissions-badge" hidden>0</span>
          </a>
          <hr class="nav-user__menu-divider">
          <button type="button" class="nav-user__menu-item nav-user__menu-item--signout" id="nav-signout">
            <span class="nav-user__menu-icon">üö™</span> Sign Out
          </button>
        </div>
      </div>
    </div>
  </nav>
</header>

<!-- ============================================================
     ADMIN / VERIFIER PANEL
     Role-based panel with different views for different roles
     ============================================================ -->
<div class="admin-panel" id="admin-panel" hidden>
  <div class="admin-panel__backdrop" id="admin-panel-backdrop"></div>
  <aside class="admin-panel__content">
    <div class="admin-panel__header">
      <span class="admin-panel__title">
        <span class="admin-badge" id="admin-role-badge">Admin</span>
        <span id="admin-panel-title">Moderation</span>
      </span>
      <button type="button" class="admin-panel__close" id="admin-panel-close">&times;</button>
    </div>
    <nav class="admin-panel__nav">
      
      <!-- Super Admin Only Section (at top) -->
      <div id="super-admin-section" hidden>
        <hr class="admin-panel__divider">
        <div class="admin-panel__section-title">Super Admin</div>
        <a href="/admin/health/" class="admin-panel__item">
          <span class="admin-panel__icon">üíö</span>
          <span class="admin-panel__text">Site Health</span>
        </a>
        <a href="/admin/financials/" class="admin-panel__item">
          <span class="admin-panel__icon">üí∞</span>
          <span class="admin-panel__text">Financials</span>
        </a>
      </div>
      
      <!-- Admin Section -->
      <div id="admin-section">
        <hr class="admin-panel__divider" id="admin-divider-1">
        <div class="admin-panel__section-title" id="admin-section-title">Admin</div>
        
        <!-- Dashboard (Admin/Super Admin only) -->
        <a href="/admin/" class="admin-panel__item" id="admin-dashboard-link">
          <span class="admin-panel__icon">üìä</span>
          <span class="admin-panel__text">Dashboard</span>
        </a>
        
        <!-- Moderation Queue (order: Profiles -> Games -> Runs) -->
        <a href="/admin/profiles/" class="admin-panel__item" id="admin-profiles-link">
          <span class="admin-panel__icon">üë•</span>
          <span class="admin-panel__text">Pending Profiles</span>
          <span class="admin-panel__badge" id="admin-profiles-badge" hidden>0</span>
        </a>
        <a href="/admin/games/" class="admin-panel__item" id="admin-games-link">
          <span class="admin-panel__icon">üéÆ</span>
          <span class="admin-panel__text">Pending Games</span>
          <span class="admin-panel__badge" id="admin-games-badge" hidden>0</span>
        </a>
        <a href="/admin/runs/" class="admin-panel__item" id="admin-runs-link">
          <span class="admin-panel__icon">üèÉ</span>
          <span class="admin-panel__text">Pending Runs</span>
          <span class="admin-panel__badge" id="admin-runs-badge" hidden>0</span>
        </a>
        
        <hr class="admin-panel__divider" id="admin-divider-2">
        
        <!-- Support & Reports (Admin only) -->
        <a href="/admin/users/" class="admin-panel__item" id="admin-reports-link">
          <span class="admin-panel__icon">‚ö†Ô∏è</span>
          <span class="admin-panel__text">User Reports</span>
          <span class="admin-panel__badge" id="admin-reports-badge" hidden>0</span>
        </a>
        <a href="/admin/support/" class="admin-panel__item" id="admin-support-link">
          <span class="admin-panel__icon">üé´</span>
          <span class="admin-panel__text">Support Tickets</span>
          <span class="admin-panel__badge" id="admin-support-badge" hidden>0</span>
        </a>
      </div>
      
      <!-- Verifier Only Section (shows assigned games) -->
      <div id="verifier-section" hidden>
        <hr class="admin-panel__divider">
        <div class="admin-panel__section-title">Verifier</div>
        <div id="verifier-games-list">
          <!-- Populated by JS based on assigned games -->
        </div>
      </div>
    </nav>
    
    <!-- Panel Footer -->
    <div class="admin-panel__footer">
      <a href="/legal/privacy/" class="admin-panel__footer-link">Privacy</a>
      <a href="/legal/terms/" class="admin-panel__footer-link">Terms</a>
    </div>
  </aside>
</div>

<!-- Header Search Index -->
<script id="header-search-data" type="application/json">
{
  "games": [{% for g in site.games %}{"id":{{ g.game_id | jsonify }},"name":{{ g.game_name | jsonify }},"aliases":{{ g.game_name_aliases | default: empty | jsonify }},"url":{{ g.url | relative_url | jsonify }}}{% unless forloop.last %},{% endunless %}{% endfor %}],
  "runners": [{% for r in site.runners %}{"id":{{ r.runner_id | default: r.title | jsonify }},"name":{{ r.name | default: r.title | jsonify }},"url":{{ r.url | relative_url | jsonify }}}{% unless forloop.last %},{% endunless %}{% endfor %}],
  "teams": [{% for t in site.teams %}{"id":{{ t.team_id | default: t.title | jsonify }},"name":{{ t.name | default: t.title | jsonify }},"url":{{ t.url | relative_url | jsonify }}}{% unless forloop.last %},{% endunless %}{% endfor %}]
}
</script>

<style>
/* Header Admin Button (next to logo) */
.header-admin-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 0.4rem;
  margin-left: 0.5rem;
  background: rgba(var(--accent-rgb), 0.15);
  border: 1px solid var(--accent);
  border-radius: var(--radius-sm);
  color: var(--accent);
  text-decoration: none;
  cursor: pointer;
  transition: all 0.15s ease;
}
.header-admin-btn:hover {
  background: var(--accent);
  color: var(--bg);
}
.header-admin-btn[hidden] { display: none; }
.header-admin-btn__icon { font-size: 1rem; }
.header-admin-btn__badge {
  position: absolute;
  top: -6px;
  right: -6px;
  background: #dc3545;
  color: white;
  font-size: 0.65rem;
  font-weight: 700;
  padding: 2px 5px;
  border-radius: 10px;
  min-width: 16px;
  text-align: center;
}
.header-admin-btn__badge[hidden] { display: none; }

/* User Menu Role Badge */
.nav-user__menu-role {
  font-size: 0.75rem;
  color: var(--accent);
  font-weight: 600;
  text-transform: capitalize;
}

/* User Menu Badge (for messages/submissions count) */
.nav-user__menu-badge {
  background: #dc3545;
  color: white;
  font-size: 0.65rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 16px;
  text-align: center;
  margin-left: auto;
}
.nav-user__menu-badge[hidden] { display: none; }

/* Admin Panel Toggle */
.brand--admin-toggle { display: flex; align-items: center; gap: 6px; background: none; border: none; color: var(--accent); font-weight: 800; font-size: inherit; cursor: pointer; padding: 0.25rem 0.5rem; margin: -0.25rem -0.5rem; border-radius: 6px; position: relative; }
.brand--admin-toggle:hover { background: var(--surface); }
.brand--admin-toggle[hidden] { display: none; }
.brand__admin-badge { position: absolute; top: -4px; right: -8px; background: #dc3545; color: white; font-size: 0.65rem; font-weight: 700; padding: 2px 5px; border-radius: 10px; min-width: 16px; text-align: center; }
.brand__admin-badge[hidden] { display: none; }

/* Admin Panel */
.admin-panel { position: fixed; inset: 0; z-index: 1000; }
.admin-panel[hidden] { display: none; }
.admin-panel__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
.admin-panel__content { position: absolute; top: 0; left: 0; bottom: 0; width: 280px; max-width: 85vw; background: var(--surface); box-shadow: 2px 0 12px rgba(0,0,0,0.3); display: flex; flex-direction: column; animation: adminSlideIn 0.2s ease; }
@keyframes adminSlideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
.admin-panel__header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border); background: var(--bg); }
.admin-panel__title { display: flex; align-items: center; gap: 8px; font-weight: 600; }
.admin-panel__close { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; padding: 0.25rem; line-height: 1; }
.admin-panel__nav { padding: 0.75rem 0; overflow-y: auto; flex: 1; }

/* Panel Items - with hover effect */
.admin-panel__item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--fg); text-decoration: none; transition: all 0.15s ease; border-left: 3px solid transparent; }
.admin-panel__item:hover { background: rgba(var(--accent-rgb), 0.15); border-left-color: var(--accent); }
.admin-panel__item--home { color: var(--text-muted); }
.admin-panel__item--home:hover { color: var(--fg); }

.admin-panel__icon { font-size: 1.1rem; width: 24px; text-align: center; }
.admin-panel__text { flex: 1; }
.admin-panel__badge { background: #dc3545; color: white; font-size: 0.7rem; font-weight: 700; padding: 2px 6px; border-radius: 10px; min-width: 18px; text-align: center; }
.admin-panel__badge[hidden] { display: none; }
.admin-panel__divider { margin: 0.5rem 1rem; border: none; border-top: 1px solid var(--border); }
.admin-panel__section-title { padding: 0.5rem 1rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600; }
.admin-badge { background: var(--accent); color: var(--bg); font-size: 0.65rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

/* Panel Footer */
.admin-panel__footer { padding: 0.75rem 1rem; border-top: 1px solid var(--border); display: flex; gap: 1rem; }
.admin-panel__footer-link { font-size: 0.8rem; color: var(--text-muted); text-decoration: none; }
.admin-panel__footer-link:hover { color: var(--accent); }

/* Nav dropdown */
.nav-dropdown { position: relative; }
.nav-dropdown__toggle { background: none; border: none; color: var(--fg); cursor: pointer; padding: 0.5rem; font-size: inherit; display: flex; align-items: center; gap: 4px; }
.nav-dropdown__toggle:hover { color: var(--accent); }
.nav-dropdown__caret { font-size: 0.75em; transition: transform 0.15s ease; }
.nav-dropdown.is-open .nav-dropdown__caret { transform: rotate(180deg); }
.nav-dropdown__menu { position: absolute; top: 100%; right: 0; min-width: 180px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: 0 4px 12px rgba(0,0,0,0.3); padding: 0.5rem 0; z-index: 100; }
.nav-dropdown__menu[hidden] { display: none; }
.nav-dropdown__item { display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1rem; color: var(--fg); text-decoration: none; transition: background 0.15s ease; }
.nav-dropdown__item:hover { background: var(--bg-hover); color: var(--accent); }
.nav-dropdown__divider { margin: 0.5rem 0; border: none; border-top: 1px solid var(--border); }
</style>

<script>
// Header search
(function() {
  var data, input = document.getElementById('header-search'), results = document.getElementById('header-search-results');
  if (!input || !results) return;
  try { data = JSON.parse(document.getElementById('header-search-data')?.textContent || '{}'); } catch { return; }
  function search(q) {
    if (!q || q.length < 2) return { games: [], runners: [], teams: [] };
    q = q.toLowerCase();
    return {
      games: (data.games || []).filter(function(g) { return g.name.toLowerCase().includes(q) || (g.aliases || []).some(function(a){return a.toLowerCase().includes(q);}); }).slice(0,5),
      runners: (data.runners || []).filter(function(r) { return r.name.toLowerCase().includes(q) || r.id.toLowerCase().includes(q); }).slice(0,5),
      teams: (data.teams || []).filter(function(t) { return t.name.toLowerCase().includes(q) || t.id.toLowerCase().includes(q); }).slice(0,5)
    };
  }
  function render(r, q) {
    if (!q || q.length<2) { results.hidden=true; return; }
    var total = r.games.length + r.runners.length + r.teams.length;
    if (!total) { results.innerHTML='<div class="search-no-results">No results</div>'; results.hidden=false; return; }
    var h='';
    if (r.games.length) { h+='<div class="search-result-group"><div class="search-result-group__title">Games</div>'; r.games.forEach(function(g){h+='<a href="'+g.url+'" class="search-result-item">'+g.name+'</a>';}); h+='</div>'; }
    if (r.runners.length) { h+='<div class="search-result-group"><div class="search-result-group__title">Runners</div>'; r.runners.forEach(function(x){h+='<a href="'+x.url+'" class="search-result-item">'+x.name+'</a>';}); h+='</div>'; }
    if (r.teams.length) { h+='<div class="search-result-group"><div class="search-result-group__title">Teams</div>'; r.teams.forEach(function(x){h+='<a href="'+x.url+'" class="search-result-item">'+x.name+'</a>';}); h+='</div>'; }
    results.innerHTML=h; results.hidden=false;
  }
  var t; input.addEventListener('input',function(){clearTimeout(t);t=setTimeout(function(){render(search(input.value),input.value);},150);});
  input.addEventListener('blur',function(){setTimeout(function(){results.hidden=true;},200);});
  input.addEventListener('focus',function(){if(input.value.length>=2)render(search(input.value),input.value);});
})();

// More dropdown toggle (FIXED)
(function() {
  var dropdown = document.getElementById('more-dropdown');
  if (!dropdown) return;
  var toggle = dropdown.querySelector('.nav-dropdown__toggle');
  var menu = dropdown.querySelector('.nav-dropdown__menu');
  if (!toggle || !menu) return;
  
  toggle.addEventListener('click', function(e) {
    e.stopPropagation();
    var isOpen = !menu.hidden;
    menu.hidden = isOpen;
    dropdown.classList.toggle('is-open', !isOpen);
    toggle.setAttribute('aria-expanded', !isOpen);
  });
  
  document.addEventListener('click', function(e) {
    if (!dropdown.contains(e.target)) {
      menu.hidden = true;
      dropdown.classList.remove('is-open');
      toggle.setAttribute('aria-expanded', 'false');
    }
  });
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !menu.hidden) {
      menu.hidden = true;
      dropdown.classList.remove('is-open');
      toggle.setAttribute('aria-expanded', 'false');
    }
  });
})();

// User menu toggle
(function() {
  var btn = document.getElementById('nav-user-avatar-btn'), menu = document.getElementById('nav-user-menu');
  if (!btn || !menu) return;
  btn.addEventListener('click', function(e) { e.stopPropagation(); menu.hidden = !menu.hidden; });
  document.addEventListener('click', function(e) { if (!menu.hidden && !menu.contains(e.target)) menu.hidden = true; });
  document.addEventListener('keydown', function(e) { if (e.key === 'Escape') menu.hidden = true; });
})();

// Admin panel toggle (now in user menu)
(function() {
  var btn = document.getElementById('header-admin-btn'), panel = document.getElementById('admin-panel');
  if (!panel) return;
  if (btn) {
    btn.addEventListener('click', function() { 
      panel.hidden = false; 
      document.getElementById('nav-user-menu').hidden = true; // Close user menu if open
    });
  }
  document.getElementById('admin-panel-backdrop')?.addEventListener('click', function() { panel.hidden = true; });
  document.getElementById('admin-panel-close')?.addEventListener('click', function() { panel.hidden = true; });
  document.addEventListener('keydown', function(e) { if (e.key === 'Escape' && !panel.hidden) panel.hidden = true; });
})();

// Debug view header banner
(function() {
  var debugRole = sessionStorage.getItem('crc-debug-view-role');
  var banner = document.getElementById('header-debug-banner');
  var roleText = document.getElementById('header-debug-role');
  var exitBtn = document.getElementById('header-exit-debug');
  
  if (debugRole && banner && roleText) {
    var labels = { admin: 'üõ°Ô∏è Admin', verifier: '‚úÖ Verifier', user: 'üë§ User' };
    banner.hidden = false;
    roleText.textContent = labels[debugRole] || debugRole.charAt(0).toUpperCase() + debugRole.slice(1);
  }
  
  exitBtn?.addEventListener('click', function() {
    sessionStorage.removeItem('crc-debug-view-role');
    window.location.href = '/admin/debug/';
  });
})();

// Apply saved theme on page load
(function() {
  var saved = localStorage.getItem('crc-theme');
  if (saved) {
    try {
      var theme = JSON.parse(saved);
      if (theme.accent) document.documentElement.style.setProperty('--accent', theme.accent);
      if (theme.accentRgb) document.documentElement.style.setProperty('--accent-rgb', theme.accentRgb);
      if (theme.bg) document.documentElement.style.setProperty('--bg', theme.bg);
      if (theme.surface) document.documentElement.style.setProperty('--surface', theme.surface);
      if (theme.bgImage) document.body.style.backgroundImage = 'url(' + theme.bgImage + ')';
    } catch (e) {}
  }
})();
</script>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

// SECURITY (Item 4): No hardcoded admin IDs. All role checks use the database.

async function initHeaderAuth() {
  try {
    await CRCAuth.init();
    
    const signinLink = document.getElementById('nav-signin');
    const avatarBtn = document.getElementById('nav-user-avatar-btn');
    const userAvatar = document.getElementById('nav-user-avatar');
    const menuAvatar = document.getElementById('nav-user-menu-avatar');
    const menuName = document.getElementById('nav-user-menu-name');
    const menuRole = document.getElementById('nav-user-menu-role');
    const profileLink = document.getElementById('nav-profile-link');
    const signoutBtn = document.getElementById('nav-signout');
    const brandLink = document.getElementById('brand-link');
    
    if (!CRCAuth.isSignedIn()) return;
    
    const metadata = CRCAuth.getProviderMetadata();
    const profile = CRCAuth.getProfile();
    
    if (signinLink) signinLink.hidden = true;
    if (avatarBtn) avatarBtn.hidden = false;
    
    const avatarUrl = metadata.providerAvatar || '/assets/img/site/default-runner.png';
    if (userAvatar) userAvatar.src = avatarUrl;
    if (menuAvatar) menuAvatar.src = avatarUrl;
    if (menuName) menuName.textContent = profile?.display_name || metadata.providerUsername || 'User';
    
    if (profile && !profile._isPending) {
      if (profileLink) {
        profileLink.href = '/runners/' + profile.runner_id + '/';
        profileLink.innerHTML = '<span class="nav-user__menu-icon">üë§</span> My Profile';
      }
    } else if (profile && profile._isPending) {
      if (profileLink) {
        profileLink.href = '/profile/status/';
        profileLink.innerHTML = '<span class="nav-user__menu-icon">‚è≥</span> Profile Status';
      }
      if (menuRole) menuRole.textContent = '‚è≥ Pending';
    } else {
      if (profileLink) {
        profileLink.href = '/profile/create/';
        profileLink.innerHTML = '<span class="nav-user__menu-icon">‚ûï</span> Create Profile';
      }
      if (menuRole) menuRole.textContent = 'No Profile';
    }
    
    // Check roles and setup panel
    const role = await getUserRole();
    
    // Update user menu role display (only if not already set to pending/no profile)
    if (menuRole && profile && !profile._isPending) {
      const roleLabels = {
        'super_admin': 'Super Admin',
        'admin': 'Admin',
        'verifier': 'Verifier',
        'none': 'Runner'
      };
      menuRole.textContent = roleLabels[role] || 'Runner';
    }
    
    if (role !== 'none') {
      // Check if debug view is active (super admin simulating another role)
      const debugRole = sessionStorage.getItem('crc-debug-view-role');
      const effectiveRole = debugRole || role;
      
      // Show admin button in header (next to logo) ‚Äî hide if simulating 'user'
      const headerAdminBtn = document.getElementById('header-admin-btn');
      const adminIndicator = document.getElementById('nav-user-admin-indicator');
      
      if (effectiveRole === 'user') {
        // User role = no admin access at all
        if (headerAdminBtn) headerAdminBtn.hidden = true;
        if (adminIndicator) adminIndicator.hidden = true;
      } else {
        if (headerAdminBtn) headerAdminBtn.hidden = false;
        if (adminIndicator) adminIndicator.hidden = false;
        setupAdminPanel(effectiveRole, profile);
        loadAdminCounts();
      }
    }
    
    if (signoutBtn) {
      signoutBtn.addEventListener('click', async () => { 
        await CRCAuth.signOut(); 
        window.location.href = '/'; 
      });
    }
  } catch (err) { console.error('[Header] Auth error:', err); }
}

async function getUserRole() {
  const supabase = CRCAuth.getSupabaseClient?.();
  const user = CRCAuth.getUser();
  
  // SECURITY (Item 4): All role checks come from the database
  if (supabase && user) {
    try {
      const { data } = await supabase.from('runner_profiles').select('is_admin, role, verified_games').eq('user_id', user.id).single();
      if (data?.is_admin) return 'super_admin';
      if (data?.role === 'admin') return 'admin';
      if (data?.role === 'verifier' && data?.verified_games?.length > 0) return 'verifier';

      // Also check moderators table
      const { data: mod } = await supabase.from('moderators').select('can_manage_moderators, assigned_games').eq('user_id', user.id).maybeSingle();
      if (mod?.can_manage_moderators) return 'admin';
      if (mod && mod.assigned_games?.length > 0) return 'verifier';
    } catch (err) {
      console.error('[Header] Role check error:', err);
    }
  }
  
  return 'none';
}

function setupAdminPanel(role, profile) {
  const roleBadge = document.getElementById('admin-role-badge');
  const panelTitle = document.getElementById('admin-panel-title');
  const superAdminSection = document.getElementById('super-admin-section');
  const adminSection = document.getElementById('admin-section');
  const verifierSection = document.getElementById('verifier-section');
  
  // Hide elements based on role
  if (role === 'super_admin') {
    roleBadge.textContent = 'Super Admin';
    roleBadge.style.background = '#9b59b6';
    panelTitle.textContent = 'Administration';
    superAdminSection.hidden = false;
    adminSection.hidden = false;
  } else if (role === 'admin') {
    roleBadge.textContent = 'Admin';
    panelTitle.textContent = 'Moderation';
    superAdminSection.hidden = true;
    adminSection.hidden = false;
  } else if (role === 'verifier') {
    roleBadge.textContent = 'Verifier';
    roleBadge.style.background = '#3498db';
    panelTitle.textContent = 'Verification';
    
    // Hide super admin and admin sections
    superAdminSection.hidden = true;
    adminSection.hidden = true;
    
    // Show verifier section with their games
    verifierSection.hidden = false;
    loadVerifierGames(profile?.verified_games || []);
  }
}

async function loadVerifierGames(gameIds) {
  const list = document.getElementById('verifier-games-list');
  if (!gameIds || gameIds.length === 0) {
    list.innerHTML = '<p class="muted" style="padding: 0 1rem; font-size: 0.85rem;">No games assigned yet.</p>';
    return;
  }
  
  // Generate links for each assigned game (Item 1: escape gameId)
  list.innerHTML = gameIds.map(gameId => {
    const safe = gameId.replace(/[^a-z0-9-]/gi, '');
    return `
    <a href="/admin/runs/?game=${encodeURIComponent(safe)}" class="admin-panel__item">
      <span class="admin-panel__icon">üéÆ</span>
      <span class="admin-panel__text">${safe}</span>
    </a>`;
  }).join('');
}

async function loadUserSubmissions(el) {
  if (!el) return;
  const supabase = CRCAuth.getSupabaseClient?.();
  const user = CRCAuth.getUser();
  if (!supabase || !user) { el.innerHTML = '<span class="nav-user__menu-muted">No pending submissions</span>'; return; }
  
  try {
    const { data } = await supabase.from('pending_profiles').select('requested_runner_id').eq('user_id', user.id).eq('status', 'pending');
    if (data?.length) {
      el.innerHTML = data.map(p => `<a href="/profile/status/" class="nav-user__submission-item"><span class="nav-user__submission-status">Pending</span>Profile: ${p.requested_runner_id}</a>`).join('');
    } else {
      el.innerHTML = '<span class="nav-user__menu-muted">No pending submissions</span>';
    }
  } catch { el.innerHTML = '<span class="nav-user__menu-muted">No pending submissions</span>'; }
}

async function loadAdminCounts() {
  const supabase = CRCAuth.getSupabaseClient?.();
  if (!supabase) return;
  let total = 0;
  
  try {
    const { count: profiles } = await supabase.from('pending_profiles').select('*', { count: 'exact', head: true }).eq('status', 'pending');
    if (profiles > 0) {
      const badge = document.getElementById('admin-profiles-badge');
      if (badge) { badge.hidden = false; badge.textContent = profiles; }
      total += profiles;
    }
    
    if (total > 0) {
      // Update header admin button badge
      const headerBadge = document.getElementById('header-admin-badge');
      if (headerBadge) { headerBadge.textContent = total; headerBadge.hidden = false; }
    }
  } catch (e) { console.error('[Header] Admin counts:', e); }
}

initHeaderAuth();
</script>
