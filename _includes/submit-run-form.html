{% assign preset_game = include.game %}
{% assign hide_game_select = false %}
<!-- =========================
     Submit Run Form Include

     If game is provided, the form will be pre-configured for that game
     and the game selector will be hidden.
     
     FORM ORDER (matches payload):
     1. Game + Category
     2. Standard Challenges
     3. Community Challenge
     4. Character
     5. Glitch Category
     6. Restrictions
     7. Run Details (runner_id, video_url, date_completed, run_time)
     8. Captcha
     9. Submit
     ========================= -->

{% if preset_game and preset_game.game_id %}
  {% assign hide_game_select = true %}
{% endif %}

<div class="submit-run-page">
  <div class="card">
    {% unless hide_game_select %}
      <h1>Submit a Run</h1>
      <p class="muted submit-lead">
        Select a game to see its specific options, then fill in your run details.
        <span class="required-hint"><span class="required-marker">*</span> indicates required fields</span>
      </p>
    {% else %}
      <h1>Submit a {{ preset_game.game_name }} Run</h1>
      <p class="muted submit-lead">
        Fill in your run details below. All options are specific to {{ preset_game.game_name }}.
        <span class="required-hint"><span class="required-marker">*</span> indicates required fields</span>
      </p>
    {% endunless %}

    <form class="submit-form" id="submitRunForm" novalidate>
      <div class="submit-grid">

        <!-- =========================
             1. GAME + CATEGORY
             ========================= -->
        {% unless hide_game_select %}
        <div class="submit-section" aria-labelledby="game-section-title">
          <p id="game-section-title" class="submit-section__title">Game <span class="required-marker">*</span></p>
          <p class="submit-section__sub">Pick the game first so the options below match that game.</p>

          <div class="submit-field">
            <label for="gameSearch" class="submit-label muted">Search</label>
            <input 
              id="gameSearch" 
              type="text" 
              placeholder="Type to filter games..." 
              autocomplete="off"
              aria-label="Search for a game"
            />
          </div>

          <div class="submit-field">
            <label for="gameSelect" class="submit-label muted">Select Game <span class="required-marker">*</span></label>
            <select 
              id="gameSelect" 
              class="select" 
              required
              aria-label="Select a game"
              aria-required="true"
            >
              <option value="">Choose a game...</option>
            </select>
            <span class="field-error" id="gameSelect-error" role="alert" hidden></span>
          </div>
        </div>
        {% else %}
        <!-- Hidden game selector - pre-filled -->
        <input type="hidden" id="gameSelect" value="{{ preset_game.game_id }}" />
        <div style="display:none;">
          <input id="gameSearch" type="hidden" value="" />
        </div>
        {% endunless %}

        <div class="submit-section" aria-labelledby="category-section-title">
          <p id="category-section-title" class="submit-section__title">Category <span class="required-marker">*</span></p>
          <p class="submit-section__sub">Select the tier and category for your run.</p>

          <div class="submit-row-2">
            <div class="submit-field">
              <label for="tierSelect" class="submit-label muted">Category Tier <span class="required-marker">*</span></label>
              <select 
                id="tierSelect" 
                class="select" 
                required
                aria-label="Select category tier"
                aria-required="true"
              >
                <option value="">Select tier...</option>
              </select>
              <span class="field-error" id="tierSelect-error" role="alert" hidden></span>
            </div>

            <div class="submit-field">
              <label for="categorySelect" class="submit-label muted">Category <span class="required-marker">*</span></label>
              <select 
                id="categorySelect" 
                class="select" 
                required
                aria-label="Select run category"
                aria-required="true"
              >
                <option value="">Select category...</option>
              </select>
              <span class="field-error" id="categorySelect-error" role="alert" hidden></span>
            </div>
          </div>
        </div>

        <!-- =========================
             2. STANDARD CHALLENGES
             ========================= -->
        <div class="submit-section" aria-labelledby="standard-challenges-title">
          <p id="standard-challenges-title" class="submit-section__title">Standard Challenges</p>
          <p class="submit-section__sub">
            Multi-select. Click a suggestion to add it, click a chip to remove it.
            <br><em>At least one Standard or Community Challenge is required.</em>
          </p>

          <div class="multi-pick" id="standardChallengePicker" data-kind="standard-challenges" role="group" aria-labelledby="standard-challenges-title">
            <div class="multi-pick__picked filter-input__picked" id="standardChallengePicked" role="list" aria-label="Selected standard challenges"></div>

            <div class="filter-input">
              <div class="filter-input__wrap">
                <input
                  id="standardChallengeSearch"
                  class="filter-input__field"
                  type="text"
                  placeholder="Type to search challenges..."
                  autocomplete="off"
                  aria-label="Search standard challenges"
                  aria-autocomplete="list"
                  aria-controls="standardChallengeSuggestions"
                  aria-expanded="false"
                />
                <div
                  id="standardChallengeSuggestions"
                  class="filter-input__suggestions"
                  role="listbox"
                  aria-label="Standard challenge suggestions"
                  hidden
                ></div>
              </div>
            </div>

            <div class="multi-pick__help">
              Examples: Damageless, Hitless, No-Hit / No-Damage
            </div>
          </div>

          <select id="standardChallengeSelect" multiple hidden aria-hidden="true"></select>
        </div>

        <!-- =========================
             3. COMMUNITY CHALLENGE
             ========================= -->
        <div class="submit-section" aria-labelledby="community-challenges-title">
          <p id="community-challenges-title" class="submit-section__title">Community Challenge</p>
          <p class="submit-section__sub">Optional. Pick one game-specific community challenge.</p>

          <div class="submit-field">
            <label for="communityChallengeSelect" class="submit-label muted">Community Challenge</label>
            <select 
              id="communityChallengeSelect" 
              class="select"
              aria-label="Select community challenge (optional)"
            >
              <option value="">None selected</option>
            </select>
          </div>
        </div>

        <!-- =========================
             4. CHARACTER / WEAPON / CLASS
             ========================= -->
        <div class="submit-section" aria-labelledby="character-title" id="characterSection">
          <p id="character-title" class="submit-section__title">Character</p>
          <p class="submit-section__sub">
            This label changes per game (e.g., "Weapon / Aspect", "Class").
          </p>

          <div class="submit-field">
            <label for="characterSelect" class="submit-label muted" id="characterLabel">Character</label>
            <select 
              id="characterSelect" 
              class="select"
              aria-labelledby="characterLabel"
            >
              <option value="">Any / Not applicable</option>
            </select>
            <span class="field-error" id="characterSelect-error" role="alert" hidden></span>
          </div>
        </div>

        <!-- =========================
             5. GLITCH CATEGORY
             ========================= -->
        <div class="submit-section" aria-labelledby="glitch-title" id="glitchSection">
          <p id="glitch-title" class="submit-section__title">Glitch Category</p>
          <p class="submit-section__sub">Optional. Select the glitch ruleset used.</p>

          <div class="submit-field">
            <label for="glitchSelect" class="submit-label muted">Glitch Category</label>
            <select 
              id="glitchSelect" 
              class="select"
              aria-label="Select glitch category (optional)"
            >
              <option value="">N/A</option>
            </select>
          </div>
        </div>

        <!-- =========================
             6. RESTRICTIONS
             ========================= -->
        <div class="submit-section" aria-labelledby="restrictions-title">
          <p id="restrictions-title" class="submit-section__title">Restrictions</p>
          <p class="submit-section__sub">
            Multi-select. Additional restrictions applied to the run.
          </p>

          <div class="multi-pick" id="restrictionsPicker" data-kind="restrictions" role="group" aria-labelledby="restrictions-title">
            <div class="multi-pick__picked filter-input__picked" id="restrictionsPicked" role="list" aria-label="Selected restrictions"></div>

            <div class="filter-input">
              <div class="filter-input__wrap">
                <input
                  id="restrictionsSearch"
                  class="filter-input__field"
                  type="text"
                  placeholder="Type to search restrictions..."
                  autocomplete="off"
                  aria-label="Search restrictions"
                  aria-autocomplete="list"
                  aria-controls="restrictionsSuggestions"
                  aria-expanded="false"
                />
                <div
                  id="restrictionsSuggestions"
                  class="filter-input__suggestions"
                  role="listbox"
                  aria-label="Restriction suggestions"
                  hidden
                ></div>
              </div>
            </div>

            <div class="multi-pick__help">
              Game-specific restrictions like "Arcanaless", "No Hexes", etc.
            </div>
          </div>

          <select id="restrictionsSelect" multiple size="10" hidden aria-hidden="true"></select>
        </div>

        <!-- =========================
             7. RUN DETAILS
             ========================= -->
        <div class="submit-section" aria-labelledby="run-details-title">
          <p id="run-details-title" class="submit-section__title">Run Details <span class="required-marker">*</span></p>
          <p class="submit-section__sub">Runner information, video proof, and timing.</p>

          <!-- Auth-aware Runner ID Section -->
          <div class="submit-field">
            <label for="runnerId" class="submit-label">Runner ID <span class="required-marker">*</span></label>
            
            <!-- Signed-in state (shown when user has a profile) -->
            <div id="runner-auth-signed-in" class="runner-auth-info" hidden>
              <div class="runner-auth-badge">
                <img id="runner-auth-avatar" class="runner-auth-avatar" src="/assets/img/site/default-runner.png" alt="" />
                <div class="runner-auth-details">
                  <span id="runner-auth-name" class="runner-auth-name">Runner Name</span>
                  <span id="runner-auth-id" class="runner-auth-id muted">runner-id</span>
                </div>
                <span class="runner-auth-verified" title="Verified account">âœ“</span>
              </div>
              <input 
                id="runnerId" 
                type="text" 
                required
                aria-required="true"
                readonly
                class="runner-id-readonly"
              />
            </div>
            
            <!-- Not signed in state -->
            <div id="runner-auth-guest" class="runner-auth-guest">
              <div class="submit-hint">
                <a href="/sign-in/" class="runner-auth-link">Sign in</a> to link this run to your profile, or enter a Runner ID manually.
              </div>
              <input 
                id="runnerIdGuest" 
                type="text" 
                placeholder="your-runner-id" 
                required
                aria-required="true"
                aria-describedby="runnerId-hint"
                pattern="[a-z0-9\-]+"
              />
            </div>
            
            <span class="field-error" id="runnerId-error" role="alert" hidden></span>
          </div>

          <div class="submit-field">
            <label for="videoUrl" class="submit-label">Video URL <span class="required-marker">*</span></label>
            <div class="submit-hint" id="videoUrl-hint">YouTube, Twitch Highlight, or Bilibili are accepted.</div>
            <input
              id="videoUrl"
              type="url"
              placeholder="https://youtube.com/watch?v=... or https://twitch.tv/videos/..."
              required
              aria-required="true"
              aria-describedby="videoUrl-hint"
            />
            <span class="field-error" id="videoUrl-error" role="alert" hidden></span>
            <div id="videoTitle" class="video-title-preview" hidden></div>
          </div>

          <div class="submit-row-2">
            <div class="submit-field">
              <label for="dateCompleted" class="submit-label">Date Completed</label>
              <div class="submit-hint" id="dateCompleted-hint">Format: YYYY/MM/DD (optional).</div>
              <input 
                id="dateCompleted" 
                type="text" 
                class="date-input"
                placeholder="YYYY/MM/DD"
                maxlength="10"
                aria-describedby="dateCompleted-hint"
              />
              <span class="field-error" id="dateCompleted-error" role="alert" hidden></span>
            </div>

            <div class="submit-field">
              <label for="runTime" class="submit-label">Run Time <span id="runTimeMethod" class="muted"></span></label>
              <div class="submit-hint" id="runTime-hint">Format: HH:MM:SS or MM:SS (optional)</div>
              <div class="input-with-secondary">
                <input 
                  id="runTime" 
                  type="text" 
                  placeholder="12:34:56"
                  aria-describedby="runTime-hint"
                  pattern="^(\d{1,2}:)?\d{1,2}:\d{2}$"
                />
                <span id="runTimeSecondary" class="input-secondary-label muted"></span>
              </div>
              <span class="field-error" id="runTime-error" role="alert" hidden></span>
            </div>
          </div>
        </div>
           
        <!-- =========================
             8. CAPTCHA VERIFICATION
             ========================= -->
        {% include turnstile.html %}
           
        <!-- =========================
             9. ACTIONS + OUTPUT
             ========================= -->
        <div class="submit-section" aria-labelledby="submit-section-title">
          <p id="submit-section-title" class="submit-section__title">Submit</p>
          <p class="submit-section__sub">Review your information and submit.</p>

          <div class="submit-actions">
            <button id="btnSubmit" class="btn btn--primary" type="submit">
              <span class="btn__text">Submit Run</span>
              <span class="btn__loading" hidden>
                <span class="spinner" aria-hidden="true"></span>
                Submitting...
              </span>
            </button>
            <button id="btnCopy" class="btn" type="button">Copy Payload</button>
          </div>

          <div id="msg" class="submit-message muted" aria-live="polite" role="status"></div>

          <details class="submit-details">
            <summary>Preview payload</summary>
            <pre id="preview" style="white-space:pre-wrap;"></pre>
          </details>
        </div>

      </div>
    </form>
  </div>
</div>

{% if hide_game_select %}
<!-- Pre-set the game for the JS -->
<script>
  window.CRC_PRESET_GAME_ID = {{ preset_game.game_id | jsonify }};
</script>
{% endif %}

<!-- Auth integration for runner ID -->
<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

(async function() {
  const signedInEl = document.getElementById('runner-auth-signed-in');
  const guestEl = document.getElementById('runner-auth-guest');
  const runnerIdInput = document.getElementById('runnerId');
  const runnerIdGuestInput = document.getElementById('runnerIdGuest');
  const avatarEl = document.getElementById('runner-auth-avatar');
  const nameEl = document.getElementById('runner-auth-name');
  const idEl = document.getElementById('runner-auth-id');
  
  try {
    await CRCAuth.init();
    
    if (CRCAuth.isSignedIn() && CRCAuth.hasProfile()) {
      // User is signed in with an approved profile
      const profile = CRCAuth.getProfile();
      const metadata = CRCAuth.getProviderMetadata();
      
      // Show signed-in state
      signedInEl.hidden = false;
      guestEl.hidden = true;
      
      // Fill in profile info
      avatarEl.src = profile.avatar_url || metadata.providerAvatar || '/assets/img/site/default-runner.png';
      nameEl.textContent = profile.display_name || metadata.providerUsername || 'Runner';
      idEl.textContent = profile.runner_id;
      runnerIdInput.value = profile.runner_id;
      
      // Remove the guest input from the DOM to avoid confusion
      if (runnerIdGuestInput) {
        runnerIdGuestInput.removeAttribute('required');
        runnerIdGuestInput.name = '';
      }
    } else {
      // Not signed in or no profile - show guest mode
      signedInEl.hidden = true;
      guestEl.hidden = false;
      
      // Make sure the guest input is used for validation
      if (runnerIdInput) {
        runnerIdInput.removeAttribute('required');
      }
      if (runnerIdGuestInput) {
        runnerIdGuestInput.id = 'runnerId';
      }
    }
  } catch (error) {
    console.error('Auth init error on submit form:', error);
    // Fall back to guest mode
    signedInEl.hidden = true;
    guestEl.hidden = false;
  }
})();
</script>

<script src="{{ '/assets/js/submit-run.js' | relative_url }}"></script>
