<!-- Cookie Consent Banner -->
<div class="cookie-banner" id="cookie-banner" hidden>
  <div class="cookie-banner__content">
    <p class="cookie-banner__text">
      We use essential cookies to keep you signed in and remember your preferences. 
      We also use analytics cookies to understand how you use the site.
      <a href="/legal/cookies/">Learn more</a>
    </p>
    <div class="cookie-banner__actions">
      <button type="button" class="btn cookie-banner__btn cookie-banner__btn--settings" id="cookie-manage">Manage</button>
      <button type="button" class="btn cookie-banner__btn cookie-banner__btn--reject" id="cookie-reject">Reject Non-Essential</button>
      <button type="button" class="btn cookie-banner__btn cookie-banner__btn--accept" id="cookie-accept">Accept All</button>
    </div>
  </div>
</div>

<!-- Cookie Settings Modal -->
<div class="cookie-modal" id="cookie-modal" hidden>
  <div class="cookie-modal__backdrop" id="cookie-modal-backdrop"></div>
  <div class="cookie-modal__dialog">
    <div class="cookie-modal__header">
      <h2>Cookie Settings</h2>
      <button type="button" class="cookie-modal__close" id="cookie-modal-close">&times;</button>
    </div>
    <div class="cookie-modal__body">
      <p class="muted">Choose which cookies you allow. Essential cookies cannot be disabled as they are required for the site to function.</p>
      
      <div class="cookie-category">
        <div class="cookie-category__header">
          <div>
            <h3>Essential Cookies</h3>
            <p class="muted">Authentication, security, and your theme/display preferences. Required for the site to work.</p>
          </div>
          <span class="cookie-toggle cookie-toggle--always">Always On</span>
        </div>
        <div class="cookie-category__details">
          <table class="cookie-detail-table">
            <tr><td><code>sb-*-auth-token</code></td><td>Supabase authentication session</td><td>7 days</td></tr>
            <tr><td><code>crc_theme</code></td><td>Your selected theme/accent color</td><td>1 year</td></tr>
            <tr><td><code>crc_cookie_consent</code></td><td>Your cookie preferences</td><td>1 year</td></tr>
          </table>
        </div>
      </div>
      
      <div class="cookie-category">
        <div class="cookie-category__header">
          <div>
            <h3>Analytics Cookies</h3>
            <p class="muted">Help us understand how visitors use the site so we can improve it. All data is anonymized â€” no personal data is tracked.</p>
          </div>
          <label class="cookie-toggle-switch">
            <input type="checkbox" id="cookie-analytics-toggle" />
            <span class="cookie-toggle-slider"></span>
          </label>
        </div>
        <div class="cookie-category__details">
          <table class="cookie-detail-table">
            <tr><td>Cloudflare Web Analytics</td><td>Privacy-focused, cookieless page view analytics</td><td>Session</td></tr>
          </table>
        </div>
      </div>
    </div>
    <div class="cookie-modal__footer">
      <button type="button" class="btn cookie-modal__save" id="cookie-save-settings">Save Settings</button>
    </div>
  </div>
</div>

<style>
/* Cookie Banner */
.cookie-banner {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 2000;
  background: var(--surface);
  border-top: 1px solid var(--border);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
  padding: 1rem;
}
.cookie-banner[hidden] { display: none; }
.cookie-banner__content {
  max-width: 1100px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  gap: 1.5rem;
  flex-wrap: wrap;
}
.cookie-banner__text {
  flex: 1;
  min-width: 280px;
  margin: 0;
  font-size: 0.9rem;
  line-height: 1.5;
  color: var(--fg);
}
.cookie-banner__text a { color: var(--accent); }
.cookie-banner__actions {
  display: flex;
  gap: 0.5rem;
  flex-shrink: 0;
  flex-wrap: wrap;
}
.cookie-banner__btn {
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
}
.cookie-banner__btn--accept {
  background: var(--accent);
  color: var(--bg);
  border: none;
}
.cookie-banner__btn--reject {
  background: transparent;
  color: var(--fg);
  border: 1px solid var(--border);
}
.cookie-banner__btn--settings {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border);
}
.cookie-banner__btn:hover { opacity: 0.85; }

/* Cookie Modal */
.cookie-modal { position: fixed; inset: 0; z-index: 2100; display: flex; align-items: center; justify-content: center; }
.cookie-modal[hidden] { display: none; }
.cookie-modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.6); }
.cookie-modal__dialog {
  position: relative;
  width: 90%;
  max-width: 560px;
  max-height: 85vh;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.cookie-modal__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border);
}
.cookie-modal__header h2 { margin: 0; font-size: 1.15rem; }
.cookie-modal__close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0.25rem;
  line-height: 1;
}
.cookie-modal__body { padding: 1.25rem; overflow-y: auto; flex: 1; }
.cookie-modal__body > p { margin: 0 0 1.25rem 0; font-size: 0.9rem; }
.cookie-modal__footer {
  padding: 1rem 1.25rem;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
}
.cookie-modal__save {
  background: var(--accent);
  color: var(--bg);
  border: none;
  padding: 0.6rem 1.5rem;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
}
.cookie-modal__save:hover { opacity: 0.85; }

/* Cookie Categories */
.cookie-category {
  padding: 1rem;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 0.75rem;
}
.cookie-category__header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
}
.cookie-category__header h3 { margin: 0 0 0.25rem 0; font-size: 1rem; }
.cookie-category__header p { margin: 0; font-size: 0.8rem; }
.cookie-category__details { margin-top: 0.75rem; }
.cookie-detail-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
.cookie-detail-table td { padding: 0.4rem 0.5rem; border-top: 1px solid var(--border); color: var(--text-muted); }
.cookie-detail-table code { font-size: 0.75rem; background: var(--surface); padding: 0.1rem 0.3rem; border-radius: 3px; }
.cookie-toggle--always {
  font-size: 0.75rem;
  color: var(--text-muted);
  font-weight: 600;
  white-space: nowrap;
  padding: 0.3rem 0.6rem;
  background: var(--surface);
  border-radius: 4px;
}

/* Toggle Switch */
.cookie-toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
.cookie-toggle-switch input { opacity: 0; width: 0; height: 0; }
.cookie-toggle-slider {
  position: absolute; inset: 0; cursor: pointer;
  background: var(--border); border-radius: 24px;
  transition: background 0.2s;
}
.cookie-toggle-slider::before {
  content: '';
  position: absolute;
  height: 18px; width: 18px;
  left: 3px; bottom: 3px;
  background: white;
  border-radius: 50%;
  transition: transform 0.2s;
}
.cookie-toggle-switch input:checked + .cookie-toggle-slider { background: var(--accent); }
.cookie-toggle-switch input:checked + .cookie-toggle-slider::before { transform: translateX(20px); }

@media(max-width:600px) {
  .cookie-banner__content { flex-direction: column; align-items: stretch; }
  .cookie-banner__actions { justify-content: stretch; }
  .cookie-banner__btn { flex: 1; text-align: center; }
}
</style>

<script>
// Cookie Consent Manager
window.CRCCookieConsent = (function() {
  var STORAGE_KEY = 'crc_cookie_consent';
  var banner = document.getElementById('cookie-banner');
  var modal = document.getElementById('cookie-modal');
  var analyticsToggle = document.getElementById('cookie-analytics-toggle');
  
  function getConsent() {
    try {
      var raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch(e) { return null; }
  }
  
  function setConsent(prefs) {
    prefs.timestamp = new Date().toISOString();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
    applyConsent(prefs);
    hideBanner();
    hideModal();
  }
  
  function applyConsent(prefs) {
    if (prefs && prefs.analytics) {
      loadAnalytics();
    }
  }
  
  function loadAnalytics() {
    // Only load if not already loaded
    if (document.getElementById('cf-analytics-script')) return;
    var token = document.querySelector('meta[name="cf-analytics-token"]');
    if (!token) return;
    var s = document.createElement('script');
    s.id = 'cf-analytics-script';
    s.defer = true;
    s.src = 'https://static.cloudflareinsights.com/beacon.min.js';
    s.setAttribute('data-cf-beacon', '{"token": "' + token.getAttribute('content') + '"}');
    document.head.appendChild(s);
  }
  
  function showBanner() { if (banner) banner.hidden = false; }
  function hideBanner() { if (banner) banner.hidden = true; }
  function showModal() { if (modal) modal.hidden = false; }
  function hideModal() { if (modal) modal.hidden = true; }
  
  // Init: check existing consent
  var existing = getConsent();
  if (existing) {
    applyConsent(existing);
  } else {
    showBanner();
  }
  
  // Banner buttons
  document.getElementById('cookie-accept')?.addEventListener('click', function() {
    setConsent({ essential: true, analytics: true });
  });
  
  document.getElementById('cookie-reject')?.addEventListener('click', function() {
    setConsent({ essential: true, analytics: false });
  });
  
  document.getElementById('cookie-manage')?.addEventListener('click', function() {
    var prefs = getConsent();
    if (analyticsToggle) analyticsToggle.checked = prefs ? prefs.analytics : false;
    hideBanner();
    showModal();
  });
  
  // Modal buttons
  document.getElementById('cookie-modal-close')?.addEventListener('click', function() {
    hideModal();
    if (!getConsent()) showBanner(); // Re-show banner if no choice made
  });
  
  document.getElementById('cookie-modal-backdrop')?.addEventListener('click', function() {
    hideModal();
    if (!getConsent()) showBanner();
  });
  
  document.getElementById('cookie-save-settings')?.addEventListener('click', function() {
    setConsent({
      essential: true,
      analytics: analyticsToggle ? analyticsToggle.checked : false
    });
  });
  
  // Public API (for footer link)
  return {
    showSettings: function() {
      var prefs = getConsent();
      if (analyticsToggle) analyticsToggle.checked = prefs ? prefs.analytics : false;
      showModal();
    },
    getConsent: getConsent
  };
})();
</script>
