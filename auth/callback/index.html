---
layout: default
title: "Signing In..."
---

<div class="page-width">
  <div class="auth-callback">
    <div class="auth-callback__content">
      <div class="auth-callback__spinner" id="spinner">
        <div class="spinner spinner--large"></div>
      </div>
      <h1 class="auth-callback__title" id="title">Signing you in...</h1>
      <p class="auth-callback__message muted" id="message">Please wait while we complete the sign-in process.</p>
      <div class="auth-callback__actions" id="actions" hidden></div>
    </div>
  </div>
</div>

<style>
.auth-callback {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 60vh;
  text-align: center;
}

.auth-callback__content {
  max-width: 400px;
  padding: 2rem;
}

.auth-callback__spinner {
  margin-bottom: 1.5rem;
}

.spinner--large {
  width: 48px;
  height: 48px;
  border-width: 4px;
}

.auth-callback__title {
  margin-bottom: 0.5rem;
}

.auth-callback__message {
  margin-bottom: 1rem;
}

.auth-callback__error {
  color: var(--danger);
  background: var(--danger-bg, rgba(220, 53, 69, 0.1));
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.auth-callback__actions {
  margin-top: 1.5rem;
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
}
</style>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

const spinner = document.getElementById('spinner');
const title = document.getElementById('title');
const message = document.getElementById('message');
const actions = document.getElementById('actions');

function showSuccess(text, redirectUrl) {
  spinner.innerHTML = '<span style="font-size: 3rem;">âœ“</span>';
  title.textContent = 'Success!';
  message.textContent = text;
  
  setTimeout(() => {
    window.location.href = redirectUrl;
  }, 1500);
}

function showError(text) {
  spinner.style.display = 'none';
  title.textContent = 'Sign-in Failed';
  message.innerHTML = `<div class="auth-callback__error">${text}</div>`;
  actions.hidden = false;
  actions.innerHTML = `
    <a href="/sign-in/" class="btn btn--primary">Try Again</a>
    <a href="/" class="btn">Go Home</a>
  `;
}

(async function() {
  try {
    // Initialize auth - this will process the OAuth callback in the URL
    await CRCAuth.init();
    
    // Small delay to ensure session is fully processed
    await new Promise(r => setTimeout(r, 300));
    
    // Check if signed in
    if (CRCAuth.isSignedIn()) {
      const metadata = CRCAuth.getProviderMetadata();
      const profile = CRCAuth.getProfile();
      
      // Determine redirect
      let redirectUrl = '/';
      
      // Check for stored redirect
      try {
        const stored = sessionStorage.getItem('crc_auth_redirect');
        if (stored && stored !== '/sign-in/' && stored !== '/auth/callback/') {
          redirectUrl = stored;
          sessionStorage.removeItem('crc_auth_redirect');
        }
      } catch (e) { /* ignore */ }
      
      // If no stored redirect, go based on profile status
      if (redirectUrl === '/') {
        if (!profile) {
          redirectUrl = '/profile/create/';
        } else if (profile._isPending) {
          redirectUrl = '/profile/status/';
        } else {
          redirectUrl = `/runners/${profile.runner_id}/`;
        }
      }
      
      showSuccess(`Welcome, ${metadata.providerUsername || 'Runner'}! Redirecting...`, redirectUrl);
    } else {
      showError('Sign-in was not completed. Please try again.');
    }
  } catch (error) {
    console.error('Auth callback error:', error);
    showError(error.message || 'An unexpected error occurred.');
  }
})();
</script>
