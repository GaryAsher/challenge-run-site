---
layout: default
title: "Admin Dashboard"
---

<div class="page-width">
  <div id="auth-check">
    <div class="card">
      <div class="sign-in-loading">
        <div class="spinner"></div>
        <p class="muted">Checking access...</p>
      </div>
    </div>
  </div>
  
  <div id="not-authorized" class="card" hidden>
    <h2>Access Denied</h2>
    <p class="muted">You don't have permission to view this page.</p>
    <a href="/" class="btn btn--primary">Go Home</a>
  </div>
  
  <div id="admin-content" hidden>
    <div class="dashboard-header">
      <h1>üìä Dashboard</h1>
      <p class="muted">Admin tools, testing, and site monitoring</p>
    </div>
    
    <!-- Quick Stats -->
    <div class="dashboard-stats">
      <div class="stat-card">
        <span class="stat-card__value" id="stat-profiles">-</span>
        <span class="stat-card__label">Pending Profiles</span>
      </div>
      <div class="stat-card">
        <span class="stat-card__value" id="stat-games">-</span>
        <span class="stat-card__label">Pending Games</span>
      </div>
      <div class="stat-card">
        <span class="stat-card__value" id="stat-runs">-</span>
        <span class="stat-card__label">Pending Runs</span>
      </div>
      <div class="stat-card">
        <span class="stat-card__value" id="stat-total-runners">-</span>
        <span class="stat-card__label">Total Runners</span>
      </div>
    </div>
    
    <!-- Dashboard Tabs -->
    <nav class="dashboard-tabs">
      <button class="tab active" data-tab="overview" type="button">Overview</button>
      <button class="tab" data-tab="test-profile" type="button">Test Profile</button>
      <button class="tab" data-tab="test-game" type="button">Test Game</button>
      <button class="tab" data-tab="test-run" type="button">Test Run</button>
      <button class="tab" data-tab="debug-view" type="button">Debug View</button>
    </nav>
    
    <!-- ==========================================================
         OVERVIEW TAB - Reordered: Data Usage -> System Status -> Site Statistics -> Recent Activity
         ========================================================== -->
    <section class="tab-panel active" data-panel="overview">
      <div class="overview-grid">
        
        <!-- Data Usage (FIRST) -->
        <div class="card">
          <h2>üíæ Data Usage</h2>
          <p class="muted mb-2">Supabase resource estimates:</p>
          <div class="data-usage">
            <div class="usage-item">
              <span class="usage-label">Database Rows</span>
              <div class="usage-bar-wrap">
                <div class="usage-bar" id="usage-bar-rows" style="width: 5%"></div>
              </div>
              <span class="usage-value" id="usage-rows">~50 / 100k</span>
            </div>
            <div class="usage-item">
              <span class="usage-label">Storage</span>
              <div class="usage-bar-wrap">
                <div class="usage-bar" id="usage-bar-storage" style="width: 1%"></div>
              </div>
              <span class="usage-value" id="usage-storage">~5MB / 500MB</span>
            </div>
            <div class="usage-item">
              <span class="usage-label">Auth Users</span>
              <div class="usage-bar-wrap">
                <div class="usage-bar" id="usage-bar-auth" style="width: 0%"></div>
              </div>
              <span class="usage-value" id="usage-auth">~5 / 50k</span>
            </div>
          </div>
        </div>
        
        <!-- System Status (SECOND) -->
        <div class="card">
          <h2>üíö System Status</h2>
          <div class="status-list">
            <div class="status-item">
              <span class="status-dot" id="status-dot-supabase"></span>
              <span>Supabase Database</span>
              <span class="status-value" id="status-supabase">Checking...</span>
            </div>
            <div class="status-item">
              <span class="status-dot" id="status-dot-auth"></span>
              <span>Authentication</span>
              <span class="status-value" id="status-auth">Checking...</span>
            </div>
            <div class="status-item">
              <span class="status-dot" id="status-dot-github"></span>
              <span>GitHub Actions</span>
              <span class="status-value" id="status-github">Checking...</span>
            </div>
            <div class="status-item">
              <span class="status-dot" id="status-dot-cloudflare"></span>
              <span>Cloudflare CDN</span>
              <span class="status-value" id="status-cloudflare">Checking...</span>
            </div>
            <div class="status-item">
              <span class="status-dot ok" id="status-dot-jekyll"></span>
              <span>Jekyll Build</span>
              <span class="status-value" id="status-jekyll">OK</span>
            </div>
          </div>
          <p class="muted mt-3" style="font-size: 0.8rem;">
            Last checked: <span id="status-timestamp">-</span>
            <button type="button" class="btn btn--small ml-2" id="refresh-status">üîÑ</button>
          </p>
        </div>
        
        <!-- Site Statistics (THIRD) -->
        <div class="card">
          <h2>üìà Site Statistics</h2>
          <div class="site-stats">
            <div class="site-stat">
              <span class="site-stat__label">Total Games</span>
              <span class="site-stat__value" id="stat-total-games">-</span>
            </div>
            <div class="site-stat">
              <span class="site-stat__label">Total Runners</span>
              <span class="site-stat__value" id="stat-total-runners-2">-</span>
            </div>
            <div class="site-stat">
              <span class="site-stat__label">Total Runs</span>
              <span class="site-stat__value" id="stat-total-runs">-</span>
            </div>
            <div class="site-stat">
              <span class="site-stat__label">Verified Runs</span>
              <span class="site-stat__value" id="stat-verified-runs">-</span>
            </div>
          </div>
        </div>
        
        <!-- Recent Activity (FOURTH) -->
        <div class="card">
          <h2>üïê Recent Activity</h2>
          <div class="activity-list" id="recent-activity">
            <p class="muted">Loading...</p>
          </div>
        </div>
        
        <!-- Test Games -->
        <div class="card">
          <h2>üß™ Test Games</h2>
          <p class="muted mb-2">Hidden games for testing:</p>
          <ul class="test-games-list">
            {% for g in site.games %}
              {% if g.test_only == true or g.published == false %}
                <li>
                  <a href="{{ g.url | relative_url }}">{{ g.game_name }}</a>
                  {% if g.test_only %}<span class="tag tag--small">test-only</span>{% endif %}
                  {% if g.published == false %}<span class="tag tag--small">unpublished</span>{% endif %}
                </li>
              {% endif %}
            {% endfor %}
          </ul>
        </div>
        
      </div>
    </section>
    
    <!-- ==========================================================
         TEST PROFILE SIMULATOR
         ========================================================== -->
    <section class="tab-panel" data-panel="test-profile">
      <div class="card">
        <h2>üßë Profile Submission Simulator</h2>
        <p class="muted mb-3">Test the profile creation workflow without submitting.</p>
        <div class="sim-form">
          <div class="sim-row">
            <label class="sim-label">Display Name</label>
            <input type="text" id="sim-profile-name" class="sim-input" value="TestRunner123" />
          </div>
          <div class="sim-row">
            <label class="sim-label">Runner ID (slug)</label>
            <input type="text" id="sim-profile-id" class="sim-input" value="test-runner-123" />
          </div>
          <div class="sim-row">
            <label class="sim-label">Bio</label>
            <textarea id="sim-profile-bio" class="sim-input" rows="2">I like speedrunning!</textarea>
          </div>
          <button type="button" class="btn btn--primary mt-3" id="sim-profile-run">‚ñ∂ Run Simulation</button>
        </div>
        <div class="sim-log" id="sim-profile-log"></div>
      </div>
    </section>
    
    <!-- ==========================================================
         TEST GAME SIMULATOR
         ========================================================== -->
    <section class="tab-panel" data-panel="test-game">
      <div class="card">
        <h2>üéÆ Game Submission Simulator</h2>
        <p class="muted mb-3">Test the game submission workflow.</p>
        <div class="sim-form">
          <div class="sim-row">
            <label class="sim-label">Game Name</label>
            <input type="text" id="sim-game-name" class="sim-input" value="Super Test Game" />
          </div>
          <div class="sim-row">
            <label class="sim-label">Game ID (slug)</label>
            <input type="text" id="sim-game-id" class="sim-input" value="super-test-game" />
          </div>
          <div class="sim-row">
            <label class="sim-label">Release Year</label>
            <input type="text" id="sim-game-year" class="sim-input" value="2024" />
          </div>
          <div class="sim-row">
            <label class="sim-label">Developer</label>
            <input type="text" id="sim-game-dev" class="sim-input" value="Indie Studio" />
          </div>
          <div class="sim-row">
            <label class="sim-label">Genres (comma-separated)</label>
            <input type="text" id="sim-game-genres" class="sim-input" value="roguelike, action" />
          </div>
          <div class="sim-row">
            <label class="sim-label">Categories (comma-separated)</label>
            <input type="text" id="sim-game-categories" class="sim-input" value="Any%, 100%" />
          </div>
          <button type="button" class="btn btn--primary mt-3" id="sim-game-run">‚ñ∂ Run Simulation</button>
        </div>
        <div class="sim-log" id="sim-game-log"></div>
      </div>
    </section>
    
    <!-- ==========================================================
         TEST RUN SIMULATOR
         ========================================================== -->
    <section class="tab-panel" data-panel="test-run">
      <div class="card">
        <h2>üèÉ Run Submission Simulator</h2>
        <p class="muted mb-3">Test the run submission workflow.</p>
        <div class="sim-form">
          <div class="sim-row">
            <label class="sim-label">Game</label>
            <select id="sim-run-game" class="sim-input">
              <option value="">Select a game...</option>
              {% for g in site.games %}
                <option value="{{ g.game_id }}">{{ g.game_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="sim-row">
            <label class="sim-label">Category</label>
            <input type="text" id="sim-run-category" class="sim-input" value="Any%" />
          </div>
          <div class="sim-row">
            <label class="sim-label">Runner ID</label>
            <input type="text" id="sim-run-runner" class="sim-input" value="test-runner" />
          </div>
          <div class="sim-row">
            <label class="sim-label">Time</label>
            <input type="text" id="sim-run-time" class="sim-input" value="12:34.56" />
          </div>
          <div class="sim-row">
            <label class="sim-label">Video URL</label>
            <input type="url" id="sim-run-video" class="sim-input" value="https://youtube.com/watch?v=test123" />
          </div>
          <button type="button" class="btn btn--primary mt-3" id="sim-run-run">‚ñ∂ Run Simulation</button>
        </div>
        <div class="sim-log" id="sim-run-log"></div>
      </div>
    </section>
    
    <!-- ==========================================================
         DEBUG VIEW TAB - View site as different roles
         ========================================================== -->
    <section class="tab-panel" data-panel="debug-view">
      <div class="card">
        <h2>üëÅÔ∏è Debug View Mode</h2>
        <p class="muted mb-3">Preview the site as a different role. Submissions are disabled while in debug mode.</p>
        
        <div class="debug-view-warning" id="debug-active-warning" hidden>
          <div class="debug-view-banner">
            <span class="debug-view-icon">‚ö†Ô∏è</span>
            <span>Currently viewing as: <strong id="current-debug-role">-</strong></span>
            <button type="button" class="btn btn--small" id="exit-debug-view">Return to Admin View</button>
          </div>
        </div>
        
        <div class="debug-role-cards" id="debug-role-options">
          <!-- Populated by JS based on current role -->
        </div>
        
        <div class="debug-info mt-4">
          <h3>What Debug View Does:</h3>
          <ul class="debug-info-list">
            <li>üîí <strong>Disables submissions</strong> - No profile, game, or run submissions while active</li>
            <li>üëÅÔ∏è <strong>Shows restricted views</strong> - See what users/verifiers see</li>
            <li>üß™ <strong>Session-based</strong> - Resets when you close the browser</li>
            <li>‚Ü©Ô∏è <strong>Easy exit</strong> - Return to your normal role anytime</li>
          </ul>
        </div>
      </div>
      
      <div class="card mt-4">
        <h2>üîê Your Current Permissions</h2>
        <div id="debug-permissions">
          <div class="debug-row"><span class="debug-key">Role</span><span class="debug-value" id="perm-role">-</span></div>
          <div class="debug-row"><span class="debug-key">Runner ID</span><span class="debug-value" id="perm-runner-id">-</span></div>
          <div class="debug-row"><span class="debug-key">Can Approve Profiles</span><span class="debug-value" id="perm-profiles">-</span></div>
          <div class="debug-row"><span class="debug-key">Can Approve Games</span><span class="debug-value" id="perm-games">-</span></div>
          <div class="debug-row"><span class="debug-key">Can Verify Runs</span><span class="debug-value" id="perm-runs">-</span></div>
          <div class="debug-row"><span class="debug-key">Access Financials</span><span class="debug-value" id="perm-financials">-</span></div>
        </div>
      </div>
    </section>
    
  </div>
</div>

<style>
/* Dashboard Header */
.dashboard-header { margin-bottom: 1.5rem; }
.dashboard-header h1 { margin-bottom: 0.25rem; }

/* Stats */
.dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 1rem; text-align: center; }
.stat-card__value { display: block; font-size: 2rem; font-weight: 700; color: var(--accent); }
.stat-card__label { font-size: 0.8rem; color: var(--text-muted); }

/* Tabs */
.dashboard-tabs { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
.dashboard-tabs .tab { padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; font-size: 0.9rem; transition: all 0.15s; }
.dashboard-tabs .tab:hover { border-color: var(--accent); }
.dashboard-tabs .tab.active { background: var(--accent); border-color: var(--accent); color: var(--bg); }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* Overview Grid */
.overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }

/* Status */
.status-list { display: flex; flex-direction: column; gap: 0.75rem; }
.status-item { display: flex; align-items: center; gap: 0.75rem; }
.status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--text-muted); flex-shrink: 0; }
.status-dot.ok { background: #10b981; }
.status-dot.warn { background: #f59e0b; }
.status-dot.error { background: #ef4444; }
.status-value { margin-left: auto; font-size: 0.85rem; color: var(--text-muted); }

/* Site Stats */
.site-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
.site-stat { text-align: center; padding: 0.75rem; background: var(--bg); border-radius: var(--radius-sm); }
.site-stat__label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
.site-stat__value { display: block; font-size: 1.25rem; font-weight: 600; }

/* Activity */
.activity-list { max-height: 200px; overflow-y: auto; }
.activity-item { padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
.activity-item:last-child { border-bottom: none; }
.activity-time { float: right; font-size: 0.8rem; color: var(--text-muted); }

/* Data Usage */
.data-usage { display: flex; flex-direction: column; gap: 1rem; }
.usage-item { display: flex; align-items: center; gap: 0.75rem; }
.usage-label { width: 100px; font-size: 0.85rem; flex-shrink: 0; }
.usage-bar-wrap { flex: 1; height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; }
.usage-bar { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.3s; }
.usage-value { font-size: 0.8rem; color: var(--text-muted); min-width: 90px; text-align: right; }

/* Test Games */
.test-games-list { list-style: none; padding: 0; margin: 0; }
.test-games-list li { padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.test-games-list li:last-child { border-bottom: none; }

/* Simulators */
.sim-form { max-width: 500px; }
.sim-row { margin-bottom: 1rem; }
.sim-label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.25rem; }
.sim-input { width: 100%; padding: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--fg); font-size: 0.9rem; }
.sim-input:focus { border-color: var(--accent); outline: none; }
.sim-log { margin-top: 1.5rem; padding: 1rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: monospace; font-size: 0.8rem; max-height: 300px; overflow-y: auto; }
.sim-log:empty { display: none; }

/* Debug View */
.debug-view-warning { margin-bottom: 1.5rem; }
.debug-view-banner { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: linear-gradient(135deg, #f59e0b, #d97706); color: #000; border-radius: var(--radius-sm); flex-wrap: wrap; }
.debug-view-icon { font-size: 1.25rem; }
.debug-view-banner .btn--small { background: rgba(0,0,0,0.2); border: 1px solid rgba(0,0,0,0.3); color: #000; margin-left: auto; }

.debug-role-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
.debug-role-card { padding: 1.25rem; background: var(--bg); border: 2px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s; }
.debug-role-card:hover { border-color: var(--accent); }
.debug-role-card.active { border-color: var(--accent); background: rgba(var(--accent-rgb), 0.1); }
.debug-role-card__icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
.debug-role-card__name { font-weight: 600; margin-bottom: 0.25rem; }
.debug-role-card__desc { font-size: 0.8rem; color: var(--text-muted); }

.debug-info-list { list-style: none; padding: 0; margin: 0; }
.debug-info-list li { padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.debug-info-list li:last-child { border-bottom: none; }

.debug-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.debug-row:last-child { border-bottom: none; }
.debug-key { font-size: 0.9rem; color: var(--text-muted); }
.debug-value { font-weight: 500; }

.ml-2 { margin-left: 0.5rem; }
</style>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

const ADMIN_IDS = ['gary-asher', 'garyasher'];
const SUPER_ADMIN_IDS = ['gary-asher'];
const DEBUG_VIEW_KEY = 'crc-debug-view-role';

const authCheck = document.getElementById('auth-check');
const notAuthorized = document.getElementById('not-authorized');
const adminContent = document.getElementById('admin-content');

let supabase = null;
let actualRole = 'user';

// Helpers
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
function log(el, msg, type = 'info') {
  const colors = { info: '#888', success: '#10b981', error: '#ef4444', warning: '#f59e0b' };
  el.innerHTML += `<div style="color:${colors[type]}">${msg}</div>`;
  el.scrollTop = el.scrollHeight;
}
function clearLog(el) { el.innerHTML = ''; }

// Tab switching
document.querySelectorAll('.dashboard-tabs .tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.dashboard-tabs .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.querySelector(`[data-panel="${tab.dataset.tab}"]`)?.classList.add('active');
  });
});

// Profile Simulator
document.getElementById('sim-profile-run')?.addEventListener('click', async () => {
  const logEl = document.getElementById('sim-profile-log');
  clearLog(logEl);
  const name = document.getElementById('sim-profile-name').value;
  const id = document.getElementById('sim-profile-id').value;
  const bio = document.getElementById('sim-profile-bio').value;
  
  log(logEl, 'üöÄ Starting profile submission simulation...', 'info');
  await sleep(300);
  
  log(logEl, 'Step 1: Validating inputs...', 'info');
  if (!name || !id || !/^[a-z0-9-]+$/.test(id)) { log(logEl, '‚ùå Invalid inputs', 'error'); return; }
  log(logEl, '‚úÖ Validation passed', 'success');
  
  await sleep(400);
  log(logEl, 'Step 2: Checking ID availability...', 'info');
  log(logEl, `‚úÖ "${id}" is available`, 'success');
  
  await sleep(300);
  log(logEl, 'Step 4: Generating profile data...', 'info');
  log(logEl, `<pre style="margin-left:1rem;color:var(--text-muted)">${JSON.stringify({ runner_id: id, display_name: name, bio, status: 'pending' }, null, 2)}</pre>`, 'info');
  
  log(logEl, '‚îÄ'.repeat(35), 'info');
  log(logEl, 'üéâ SIMULATION COMPLETE', 'success');
});

// Game Simulator
document.getElementById('sim-game-run')?.addEventListener('click', async () => {
  const logEl = document.getElementById('sim-game-log');
  clearLog(logEl);
  const name = document.getElementById('sim-game-name').value;
  const id = document.getElementById('sim-game-id').value;
  const categories = document.getElementById('sim-game-categories').value;
  
  log(logEl, 'üöÄ Starting game submission simulation...', 'info');
  await sleep(300);
  
  log(logEl, 'Step 1: Validating inputs...', 'info');
  if (!name || !id || !/^[a-z0-9-]+$/.test(id)) { log(logEl, '‚ùå Invalid inputs', 'error'); return; }
  log(logEl, '‚úÖ Validation passed', 'success');
  
  await sleep(400);
  log(logEl, 'Step 2: Checking ID availability...', 'info');
  const existing = ['hades-2', 'hollow-knight', 'celeste'];
  if (existing.includes(id)) { log(logEl, `‚ùå "${id}" already exists`, 'error'); return; }
  log(logEl, `‚úÖ "${id}" is available`, 'success');
  
  await sleep(400);
  log(logEl, 'Step 3: Parsing categories...', 'info');
  const cats = categories.split(',').map(c => c.trim()).filter(Boolean);
  log(logEl, `‚úÖ Categories: ${cats.join(', ')}`, 'success');
  
  await sleep(300);
  log(logEl, 'Step 4: Generating file structure...', 'info');
  log(logEl, `üìÑ _games/${id}.md`, 'info');
  cats.forEach(c => log(logEl, `üìÅ /games/${id}/runs/full-runs/${c.toLowerCase()}/`, 'info'));
  
  log(logEl, '‚îÄ'.repeat(35), 'info');
  log(logEl, 'üéâ SIMULATION COMPLETE', 'success');
});

// Run Simulator
document.getElementById('sim-run-run')?.addEventListener('click', async () => {
  const logEl = document.getElementById('sim-run-log');
  clearLog(logEl);
  const game = document.getElementById('sim-run-game').value;
  const category = document.getElementById('sim-run-category').value;
  const runner = document.getElementById('sim-run-runner').value;
  const time = document.getElementById('sim-run-time').value;
  const video = document.getElementById('sim-run-video').value;
  
  log(logEl, 'üöÄ Starting run submission simulation...', 'info');
  await sleep(300);
  
  log(logEl, 'Step 1: Validating required fields...', 'info');
  if (!game || !category || !runner || !video) { log(logEl, '‚ùå Missing required fields', 'error'); return; }
  log(logEl, '‚úÖ All fields present', 'success');
  
  await sleep(400);
  log(logEl, 'Step 2: Validating video URL...', 'info');
  const hosts = ['youtube.com', 'youtu.be', 'twitch.tv'];
  try { const u = new URL(video); if (!hosts.some(h => u.hostname.includes(h))) log(logEl, '‚ö†Ô∏è Unknown video host', 'warning'); else log(logEl, '‚úÖ Video URL valid', 'success'); } catch { log(logEl, '‚ùå Invalid URL', 'error'); return; }
  
  await sleep(400);
  log(logEl, 'Step 3: Validating time format...', 'info');
  if (!/^(\d{1,2}:)?(\d{1,2}:)?\d{1,2}(\.\d+)?$/.test(time)) log(logEl, '‚ö†Ô∏è Time format may be invalid', 'warning');
  else log(logEl, `‚úÖ Time: ${time}`, 'success');
  
  await sleep(300);
  log(logEl, 'Step 4: Generating run file...', 'info');
  const date = new Date().toISOString().split('T')[0];
  log(logEl, `üìÑ ${date}__${game}__${runner}__${category.toLowerCase()}__01.md`, 'info');
  
  log(logEl, '‚îÄ'.repeat(35), 'info');
  log(logEl, 'üéâ SIMULATION COMPLETE', 'success');
});

// Debug View Functions
function getDebugViewRole() {
  return sessionStorage.getItem(DEBUG_VIEW_KEY);
}

function setDebugViewRole(role) {
  if (role) {
    sessionStorage.setItem(DEBUG_VIEW_KEY, role);
  } else {
    sessionStorage.removeItem(DEBUG_VIEW_KEY);
  }
  renderDebugView();
}

function renderDebugView() {
  const debugRole = getDebugViewRole();
  const warning = document.getElementById('debug-active-warning');
  const roleLabel = document.getElementById('current-debug-role');
  const optionsEl = document.getElementById('debug-role-options');
  
  // Show/hide warning
  if (debugRole) {
    warning.hidden = false;
    roleLabel.textContent = debugRole.charAt(0).toUpperCase() + debugRole.slice(1);
  } else {
    warning.hidden = true;
  }
  
  // Role options
  const roles = [
    { id: 'admin', name: 'Admin', icon: 'üõ°Ô∏è', desc: 'Moderation tools, no financials' },
    { id: 'verifier', name: 'Verifier', icon: '‚úì', desc: 'Only assigned game queues' },
    { id: 'user', name: 'User', icon: 'üë§', desc: 'Standard user experience' }
  ];
  
  // Filter based on actual role
  const availableRoles = actualRole === 'super_admin' ? roles : 
                         actualRole === 'admin' ? roles.filter(r => r.id !== 'admin') : 
                         roles.filter(r => r.id === 'user');
  
  optionsEl.innerHTML = availableRoles.map(r => `
    <div class="debug-role-card ${debugRole === r.id ? 'active' : ''}" data-role="${r.id}">
      <div class="debug-role-card__icon">${r.icon}</div>
      <div class="debug-role-card__name">${r.name}</div>
      <div class="debug-role-card__desc">${r.desc}</div>
    </div>
  `).join('');
  
  // Add click handlers
  optionsEl.querySelectorAll('.debug-role-card').forEach(card => {
    card.addEventListener('click', () => {
      setDebugViewRole(card.dataset.role);
    });
  });
  
  // Exit button
  document.getElementById('exit-debug-view')?.addEventListener('click', () => {
    setDebugViewRole(null);
  });
  
  // Update permissions display
  const effectiveRole = debugRole || actualRole;
  document.getElementById('perm-role').textContent = effectiveRole;
  document.getElementById('perm-runner-id').textContent = CRCAuth.getProfile()?.runner_id || '-';
  document.getElementById('perm-profiles').textContent = ['super_admin', 'admin'].includes(effectiveRole) ? '‚úÖ Yes' : '‚ùå No';
  document.getElementById('perm-games').textContent = ['super_admin', 'admin'].includes(effectiveRole) ? '‚úÖ Yes' : '‚ùå No';
  document.getElementById('perm-runs').textContent = ['super_admin', 'admin', 'verifier'].includes(effectiveRole) ? '‚úÖ Yes' : '‚ùå No';
  document.getElementById('perm-financials').textContent = effectiveRole === 'super_admin' ? '‚úÖ Yes' : '‚ùå No';
}

// Check System Status
async function checkSystemStatus() {
  document.getElementById('status-timestamp').textContent = new Date().toLocaleTimeString();
  
  // Supabase
  if (supabase) {
    try {
      const start = Date.now();
      await supabase.from('runner_profiles').select('id', { count: 'exact', head: true });
      const latency = Date.now() - start;
      document.getElementById('status-supabase').textContent = `Connected (${latency}ms)`;
      document.getElementById('status-dot-supabase').className = 'status-dot ok';
    } catch { 
      document.getElementById('status-supabase').textContent = 'Error';
      document.getElementById('status-dot-supabase').className = 'status-dot error';
    }
  }
  
  // Auth
  document.getElementById('status-auth').textContent = CRCAuth.isSignedIn() ? 'Active' : 'Not signed in';
  document.getElementById('status-dot-auth').className = 'status-dot ' + (CRCAuth.isSignedIn() ? 'ok' : 'warn');
  
  // GitHub (check status API)
  try {
    const res = await fetch('https://www.githubstatus.com/api/v2/status.json');
    const data = await res.json();
    const isOk = data.status?.indicator === 'none';
    document.getElementById('status-github').textContent = isOk ? 'Operational' : 'Degraded';
    document.getElementById('status-dot-github').className = 'status-dot ' + (isOk ? 'ok' : 'warn');
  } catch {
    document.getElementById('status-github').textContent = 'Unknown';
    document.getElementById('status-dot-github').className = 'status-dot warn';
  }
  
  // Cloudflare (check if page loaded via CF by checking headers)
  try {
    const res = await fetch(window.location.origin + '/', { method: 'HEAD' });
    const cfRay = res.headers.get('cf-ray');
    if (cfRay) {
      document.getElementById('status-cloudflare').textContent = 'Active';
      document.getElementById('status-dot-cloudflare').className = 'status-dot ok';
    } else {
      document.getElementById('status-cloudflare').textContent = 'Active (no ray)';
      document.getElementById('status-dot-cloudflare').className = 'status-dot ok';
    }
  } catch {
    document.getElementById('status-cloudflare').textContent = 'Unknown';
    document.getElementById('status-dot-cloudflare').className = 'status-dot warn';
  }
}

// Load Dashboard Data
async function loadDashboard() {
  await checkSystemStatus();
  
  // Stats
  if (supabase) {
    try {
      const { count: profiles } = await supabase.from('pending_profiles').select('*', { count: 'exact', head: true }).eq('status', 'pending');
      document.getElementById('stat-profiles').textContent = profiles || 0;
      
      const { count: runners } = await supabase.from('runner_profiles').select('*', { count: 'exact', head: true });
      document.getElementById('stat-total-runners').textContent = runners || 0;
      document.getElementById('stat-total-runners-2').textContent = runners || 0;
      
      // Update usage bars
      if (runners) {
        const rowPercent = Math.min((runners / 100000) * 100, 100);
        document.getElementById('usage-bar-rows').style.width = rowPercent + '%';
        document.getElementById('usage-rows').textContent = `~${runners} / 100k`;
        
        document.getElementById('usage-bar-auth').style.width = (runners / 50000) * 100 + '%';
        document.getElementById('usage-auth').textContent = `~${runners} / 50k`;
      }
    } catch (e) { console.error(e); }
  }
  
  document.getElementById('stat-games').textContent = '0';
  document.getElementById('stat-runs').textContent = '0';
  document.getElementById('stat-total-games').textContent = '{{ site.games.size }}';
  document.getElementById('stat-total-runs').textContent = '{{ site.runs.size }}';
  document.getElementById('stat-verified-runs').textContent = '-';
  
  // Activity placeholder
  document.getElementById('recent-activity').innerHTML = `
    <div class="activity-item">Profile created: gary-asher <span class="activity-time">2 days ago</span></div>
    <div class="activity-item">Run submitted: Hades 2 Any% <span class="activity-time">3 days ago</span></div>
  `;
}

// Refresh button
document.getElementById('refresh-status')?.addEventListener('click', checkSystemStatus);

// Initialize
(async function() {
  await CRCAuth.init();
  const isSignedIn = CRCAuth.isSignedIn();
  const profile = CRCAuth.getProfile();
  const metadata = CRCAuth.getProviderMetadata();
  const runnerId = profile?.runner_id?.toLowerCase() || '';
  const username = metadata?.providerUsername?.toLowerCase() || '';
  
  const isSuperAdmin = SUPER_ADMIN_IDS.includes(runnerId) || SUPER_ADMIN_IDS.some(id => username === id || username === id.replace(/-/g, '_'));
  const isAdmin = isSuperAdmin || ADMIN_IDS.includes(runnerId) || ADMIN_IDS.some(id => username === id || username === id.replace(/-/g, '_'));
  
  actualRole = isSuperAdmin ? 'super_admin' : isAdmin ? 'admin' : 'user';
  
  authCheck.hidden = true;
  if (isSignedIn && isAdmin) {
    adminContent.hidden = false;
    supabase = CRCAuth.getSupabaseClient?.();
    renderDebugView();
    loadDashboard();
  } else {
    notAuthorized.hidden = false;
  }
})();
</script>
