---
layout: default
title: "Admin Dashboard"
---

<div class="page-width">
  <div id="auth-check">
    <div class="card">
      <div class="sign-in-loading">
        <div class="spinner"></div>
        <p class="muted">Checking access...</p>
      </div>
    </div>
  </div>
  
  <div id="not-authorized" class="card" hidden>
    <h2>Access Denied</h2>
    <p class="muted">You don't have permission to view this page.</p>
    <a href="/" class="btn btn--primary">Go Home</a>
  </div>
  
  <div id="admin-content" hidden>
    <div class="dashboard-header">
      <h1>üìä Dashboard</h1>
      <p class="muted">Admin tools, testing, and site monitoring</p>
    </div>
    
    <!-- Quick Stats -->
    <div class="dashboard-stats">
      <div class="stat-card">
        <span class="stat-card__value" id="stat-profiles">-</span>
        <span class="stat-card__label">Pending Profiles</span>
      </div>
      <div class="stat-card">
        <span class="stat-card__value" id="stat-games">-</span>
        <span class="stat-card__label">Pending Games</span>
      </div>
      <div class="stat-card">
        <span class="stat-card__value" id="stat-runs">-</span>
        <span class="stat-card__label">Pending Runs</span>
      </div>
      <div class="stat-card">
        <span class="stat-card__value" id="stat-total-runners">-</span>
        <span class="stat-card__label">Total Runners</span>
      </div>
    </div>
    
    <!-- Dashboard Tabs -->
    <nav class="dashboard-tabs">
      <button class="tab active" data-tab="overview" type="button">Overview</button>
      <button class="tab" data-tab="test-profile" type="button">Test Profile</button>
      <button class="tab" data-tab="test-game" type="button">Test Game</button>
      <button class="tab" data-tab="test-run" type="button">Test Run</button>
      <button class="tab" data-tab="auth-debug" type="button">Auth Debug</button>
    </nav>
    
    <!-- ==========================================================
         OVERVIEW TAB - General system overview
         ========================================================== -->
    <section class="tab-panel active" data-panel="overview">
      <div class="overview-grid">
        
        <!-- System Status -->
        <div class="card">
          <h2>üíö System Status</h2>
          <div class="status-list">
            <div class="status-item">
              <span class="status-dot" id="status-dot-supabase"></span>
              <span>Supabase Database</span>
              <span class="status-value" id="status-supabase">Checking...</span>
            </div>
            <div class="status-item">
              <span class="status-dot" id="status-dot-auth"></span>
              <span>Authentication</span>
              <span class="status-value" id="status-auth">Checking...</span>
            </div>
            <div class="status-item">
              <span class="status-dot" id="status-dot-github"></span>
              <span>GitHub Actions</span>
              <span class="status-value" id="status-github">Checking...</span>
            </div>
            <div class="status-item">
              <span class="status-dot" id="status-dot-workers"></span>
              <span>Cloudflare Workers</span>
              <span class="status-value" id="status-workers">Unknown</span>
            </div>
            <div class="status-item">
              <span class="status-dot" id="status-dot-jekyll"></span>
              <span>Jekyll Build</span>
              <span class="status-value" id="status-jekyll">OK</span>
            </div>
          </div>
          <p class="muted mt-3" style="font-size: 0.8rem;">
            Last checked: <span id="status-timestamp">-</span>
          </p>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
          <h2>‚ö° Quick Actions</h2>
          <p class="muted mb-3">Jump to moderation queues:</p>
          <div class="admin-actions">
            <a href="/admin/profiles/" class="btn">
              <span>üë•</span> Review Profiles
              <span class="action-badge" id="action-profiles-badge" hidden>0</span>
            </a>
            <a href="/admin/games/" class="btn">
              <span>üéÆ</span> Review Games
              <span class="action-badge" id="action-games-badge" hidden>0</span>
            </a>
            <a href="/admin/runs/" class="btn">
              <span>üèÉ</span> Review Runs
              <span class="action-badge" id="action-runs-badge" hidden>0</span>
            </a>
          </div>
        </div>
        
        <!-- Site Statistics -->
        <div class="card">
          <h2>üìà Site Statistics</h2>
          <div class="site-stats">
            <div class="site-stat">
              <span class="site-stat__label">Total Games</span>
              <span class="site-stat__value" id="stat-total-games">-</span>
            </div>
            <div class="site-stat">
              <span class="site-stat__label">Total Runners</span>
              <span class="site-stat__value" id="stat-total-runners-2">-</span>
            </div>
            <div class="site-stat">
              <span class="site-stat__label">Total Runs</span>
              <span class="site-stat__value" id="stat-total-runs">-</span>
            </div>
            <div class="site-stat">
              <span class="site-stat__label">Verified Runs</span>
              <span class="site-stat__value" id="stat-verified-runs">-</span>
            </div>
          </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="card">
          <h2>üïê Recent Activity</h2>
          <div class="activity-list" id="recent-activity">
            <p class="muted">Loading...</p>
          </div>
        </div>
        
        <!-- Test Games -->
        <div class="card">
          <h2>üß™ Test Games</h2>
          <p class="muted mb-2">Hidden games for testing:</p>
          <ul class="test-games-list">
            {% for g in site.games %}
              {% if g.test_only == true or g.published == false %}
                <li>
                  <a href="{{ g.url | relative_url }}">{{ g.game_name }}</a>
                  {% if g.test_only %}<span class="tag tag--small">test-only</span>{% endif %}
                  {% if g.published == false %}<span class="tag tag--small">unpublished</span>{% endif %}
                </li>
              {% endif %}
            {% endfor %}
          </ul>
        </div>
        
        <!-- Data Usage (for Supabase monitoring) -->
        <div class="card">
          <h2>üíæ Data Usage</h2>
          <p class="muted mb-2">Supabase resource estimates:</p>
          <div class="data-usage">
            <div class="usage-item">
              <span class="usage-label">Database Rows</span>
              <div class="usage-bar-wrap">
                <div class="usage-bar" id="usage-bar-rows" style="width: 5%"></div>
              </div>
              <span class="usage-value" id="usage-rows">~50 / 100k</span>
            </div>
            <div class="usage-item">
              <span class="usage-label">Storage</span>
              <div class="usage-bar-wrap">
                <div class="usage-bar" id="usage-bar-storage" style="width: 2%"></div>
              </div>
              <span class="usage-value" id="usage-storage">~10MB / 1GB</span>
            </div>
            <div class="usage-item">
              <span class="usage-label">Auth Users</span>
              <div class="usage-bar-wrap">
                <div class="usage-bar" id="usage-bar-auth" style="width: 1%"></div>
              </div>
              <span class="usage-value" id="usage-auth">~5 / 50k</span>
            </div>
          </div>
          <p class="muted mt-2" style="font-size: 0.75rem;">
            Free tier limits. Upgrade at <a href="https://supabase.com" target="_blank">supabase.com</a>
          </p>
        </div>
      </div>
    </section>
    
    <!-- ==========================================================
         TEST PROFILE TAB
         ========================================================== -->
    <section class="tab-panel" data-panel="test-profile">
      <div class="card">
        <h2>üë§ Profile Submission Simulator</h2>
        <p class="muted mb-3">
          Test the complete profile creation flow without affecting production data.
        </p>
        
        <div class="simulator">
          <div class="simulator__form">
            <div class="form-group">
              <label class="form-label">Display Name</label>
              <input type="text" id="sim-profile-name" class="form-input" value="Test Runner" />
            </div>
            <div class="form-group">
              <label class="form-label">Runner ID (slug)</label>
              <input type="text" id="sim-profile-id" class="form-input" value="test-runner-sim" />
            </div>
            <div class="form-group">
              <label class="form-label">Bio</label>
              <textarea id="sim-profile-bio" class="form-textarea" rows="2">This is a test profile.</textarea>
            </div>
            <button type="button" class="btn btn--primary" id="sim-profile-run">‚ñ∂ Run Simulation</button>
          </div>
          <div class="simulator__output">
            <h3>Output</h3>
            <div class="output-log" id="sim-profile-log">
              <p class="muted">Click "Run Simulation" to start...</p>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- ==========================================================
         TEST GAME TAB (now before Test Run)
         ========================================================== -->
    <section class="tab-panel" data-panel="test-game">
      <div class="card">
        <h2>üéÆ Game Submission Simulator</h2>
        <p class="muted mb-3">
          Test game submission validation and file generation.
        </p>
        
        <div class="simulator">
          <div class="simulator__form">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Game Name</label>
                <input type="text" id="sim-game-name" class="form-input" value="Test Game Simulator" />
              </div>
              <div class="form-group">
                <label class="form-label">Game ID (slug)</label>
                <input type="text" id="sim-game-id" class="form-input" value="test-game-sim" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Release Year</label>
                <input type="number" id="sim-game-year" class="form-input" value="2024" />
              </div>
              <div class="form-group">
                <label class="form-label">Developer</label>
                <input type="text" id="sim-game-dev" class="form-input" value="Test Studio" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Genres (comma-separated)</label>
              <input type="text" id="sim-game-genres" class="form-input" value="roguelike, action" />
            </div>
            <div class="form-group">
              <label class="form-label">Categories (comma-separated)</label>
              <input type="text" id="sim-game-categories" class="form-input" value="any, 100, hitless" />
            </div>
            <button type="button" class="btn btn--primary" id="sim-game-run">‚ñ∂ Run Simulation</button>
          </div>
          <div class="simulator__output">
            <h3>Output</h3>
            <div class="output-log" id="sim-game-log">
              <p class="muted">Click "Run Simulation" to start...</p>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- ==========================================================
         TEST RUN TAB
         ========================================================== -->
    <section class="tab-panel" data-panel="test-run">
      <div class="card">
        <h2>üèÉ Run Submission Simulator</h2>
        <p class="muted mb-3">
          Test run submission validation and workflow triggers.
        </p>
        
        <div class="simulator">
          <div class="simulator__form">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Game</label>
                <select id="sim-run-game" class="form-input">
                  <option value="hades-2">Hades 2</option>
                  <option value="hollow-knight">Hollow Knight</option>
                  <option value="celeste">Celeste</option>
                  <option value="test-game">Test Game</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Category</label>
                <input type="text" id="sim-run-category" class="form-input" value="Any%" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Runner ID</label>
                <input type="text" id="sim-run-runner" class="form-input" value="test-runner" />
              </div>
              <div class="form-group">
                <label class="form-label">Time</label>
                <input type="text" id="sim-run-time" class="form-input" value="1:23:45" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Video URL</label>
              <input type="url" id="sim-run-video" class="form-input" value="https://youtube.com/watch?v=test123" />
            </div>
            <button type="button" class="btn btn--primary" id="sim-run-run">‚ñ∂ Run Simulation</button>
          </div>
          <div class="simulator__output">
            <h3>Output</h3>
            <div class="output-log" id="sim-run-log">
              <p class="muted">Click "Run Simulation" to start...</p>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- ==========================================================
         AUTH DEBUG TAB
         ========================================================== -->
    <section class="tab-panel" data-panel="auth-debug">
      <div class="card">
        <h2>üîç Authentication Debug</h2>
        <p class="muted mb-3">Current authentication state.</p>
        
        <div class="auth-debug-grid">
          <div class="auth-debug-section">
            <h3>User Info</h3>
            <div class="debug-table" id="debug-user-info"></div>
          </div>
          <div class="auth-debug-section">
            <h3>Provider</h3>
            <div class="debug-table" id="debug-provider-info"></div>
          </div>
          <div class="auth-debug-section">
            <h3>Profile</h3>
            <div class="debug-table" id="debug-profile-info"></div>
          </div>
          <div class="auth-debug-section">
            <h3>Raw Session</h3>
            <pre class="debug-raw" id="debug-raw-session"></pre>
          </div>
        </div>
        
        <div class="auth-debug-actions">
          <button type="button" class="btn" id="debug-refresh">üîÑ Refresh</button>
          <button type="button" class="btn btn--danger" id="debug-sign-out">Sign Out</button>
        </div>
      </div>
    </section>
  </div>
</div>

<style>
.dashboard-header { margin-bottom: 2rem; }
.dashboard-header h1 { margin-bottom: 0.25rem; }
.dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 1.25rem; text-align: center; }
.stat-card__value { display: block; font-size: 2rem; font-weight: 700; color: var(--accent); line-height: 1; margin-bottom: 0.5rem; }
.stat-card__label { font-size: 0.85rem; color: var(--text-muted); }
.dashboard-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
.dashboard-tabs .tab { padding: 0.5rem 1rem; background: transparent; border: 1px solid transparent; border-radius: var(--radius-sm); color: var(--text-muted); cursor: pointer; font-size: 0.9rem; transition: all 0.15s ease; }
.dashboard-tabs .tab:hover { color: var(--fg); background: var(--surface); }
.dashboard-tabs .tab.active { color: var(--accent); border-color: var(--accent); background: rgba(var(--accent-rgb), 0.1); }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* Overview Grid */
.overview-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
.status-list { display: flex; flex-direction: column; gap: 0.75rem; }
.status-item { display: flex; align-items: center; gap: 0.75rem; font-size: 0.9rem; }
.status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; background: var(--text-muted); }
.status-dot.ok { background: #10b981; }
.status-dot.warn { background: #f59e0b; }
.status-dot.error { background: #ef4444; }
.status-value { margin-left: auto; color: var(--text-muted); font-size: 0.85rem; }

/* Site Stats */
.site-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.site-stat { text-align: center; padding: 0.75rem; background: var(--bg); border-radius: var(--radius-sm); }
.site-stat__label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
.site-stat__value { display: block; font-size: 1.5rem; font-weight: 700; color: var(--accent); }

/* Activity List */
.activity-list { max-height: 200px; overflow-y: auto; }
.activity-item { padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
.activity-item:last-child { border-bottom: none; }
.activity-time { color: var(--text-muted); font-size: 0.75rem; }

/* Data Usage */
.data-usage { display: flex; flex-direction: column; gap: 0.75rem; }
.usage-item { display: flex; align-items: center; gap: 0.75rem; }
.usage-label { flex: 0 0 100px; font-size: 0.85rem; color: var(--text-muted); }
.usage-bar-wrap { flex: 1; height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; }
.usage-bar { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.3s ease; }
.usage-value { flex: 0 0 100px; font-size: 0.75rem; color: var(--text-muted); text-align: right; }

/* Admin Actions */
.admin-actions { display: flex; flex-direction: column; gap: 0.5rem; }
.admin-actions .btn { display: flex; align-items: center; gap: 0.5rem; justify-content: flex-start; position: relative; }
.action-badge { position: absolute; right: 0.75rem; background: #dc3545; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; }
.action-badge[hidden] { display: none; }

/* Test Games */
.test-games-list { list-style: none; padding: 0; margin: 0; }
.test-games-list li { padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.test-games-list li:last-child { border-bottom: none; }
.tag--small { font-size: 0.65rem; padding: 0.15rem 0.4rem; margin-left: 0.5rem; background: var(--accent); color: var(--bg); border-radius: 4px; }

/* Simulator */
.simulator { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
@media (max-width: 800px) { .simulator { grid-template-columns: 1fr; } }
.simulator__form { display: flex; flex-direction: column; gap: 1rem; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
@media (max-width: 500px) { .form-row { grid-template-columns: 1fr; } }
.form-group { margin-bottom: 0; }
.form-label { display: block; font-weight: 600; margin-bottom: 0.35rem; font-size: 0.9rem; }
.form-input, .form-textarea { width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface); color: var(--fg); font-size: 0.9rem; }
.form-input:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
.simulator__output h3 { margin-bottom: 0.75rem; font-size: 1rem; }
.output-log { background: #0a0a0a; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 1rem; min-height: 250px; max-height: 350px; overflow-y: auto; font-family: 'SF Mono', Monaco, monospace; font-size: 0.8rem; line-height: 1.5; }
.log-entry { margin-bottom: 0.5rem; padding-left: 1rem; position: relative; }
.log-entry::before { content: ''; position: absolute; left: 0; top: 0.5em; width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); }
.log-entry--info::before { background: #3b82f6; }
.log-entry--success::before { background: #10b981; }
.log-entry--warning::before { background: #f59e0b; }
.log-entry--error::before { background: #ef4444; }
.log-entry--success { color: #10b981; }
.log-entry--error { color: #ef4444; }
.log-entry--warning { color: #f59e0b; }
.log-timestamp { color: var(--text-muted); margin-right: 0.5rem; }

/* Auth Debug */
.auth-debug-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
.auth-debug-section h3 { font-size: 0.9rem; margin-bottom: 0.75rem; color: var(--accent); }
.debug-table { background: var(--surface); border-radius: var(--radius-sm); overflow: hidden; }
.debug-row { display: flex; border-bottom: 1px solid var(--border); }
.debug-row:last-child { border-bottom: none; }
.debug-key { flex: 0 0 100px; padding: 0.5rem 0.75rem; background: var(--bg); font-weight: 600; font-size: 0.8rem; color: var(--text-muted); }
.debug-value { flex: 1; padding: 0.5rem 0.75rem; font-size: 0.8rem; word-break: break-all; }
.debug-raw { background: #0a0a0a; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 1rem; font-size: 0.75rem; overflow: auto; max-height: 150px; }
.auth-debug-actions { display: flex; gap: 0.75rem; }
.btn--danger { background: transparent; border: 1px solid #ef4444; color: #ef4444; }
.btn--danger:hover { background: #ef4444; color: white; }
</style>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

const ADMIN_IDS = ['gary-asher'];
let supabase = null;

const authCheck = document.getElementById('auth-check');
const notAuthorized = document.getElementById('not-authorized');
const adminContent = document.getElementById('admin-content');

// Tab Switching
document.querySelectorAll('.dashboard-tabs .tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.dashboard-tabs .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.querySelector(`[data-panel="${tab.dataset.tab}"]`).classList.add('active');
  });
});

// Logging Utility
function log(logEl, message, type = 'info') {
  const timestamp = new Date().toLocaleTimeString();
  const entry = document.createElement('div');
  entry.className = `log-entry log-entry--${type}`;
  entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
  logEl.appendChild(entry);
  logEl.scrollTop = logEl.scrollHeight;
}
function clearLog(logEl) { logEl.innerHTML = ''; }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// Profile Simulator
document.getElementById('sim-profile-run')?.addEventListener('click', async () => {
  const logEl = document.getElementById('sim-profile-log');
  clearLog(logEl);
  const name = document.getElementById('sim-profile-name').value;
  const id = document.getElementById('sim-profile-id').value;
  const bio = document.getElementById('sim-profile-bio').value;
  
  log(logEl, 'üöÄ Starting profile submission simulation...', 'info');
  await sleep(300);
  
  // Validation
  log(logEl, 'Step 1: Validating inputs...', 'info');
  const errors = [];
  if (!name || name.length < 2) errors.push('Display name too short');
  if (!id || !/^[a-z0-9-]+$/.test(id)) errors.push('Invalid runner ID format');
  if (id && id.length < 3) errors.push('Runner ID too short');
  if (errors.length > 0) { errors.forEach(e => log(logEl, `‚ùå ${e}`, 'error')); return; }
  log(logEl, '‚úÖ Validation passed', 'success');
  
  await sleep(400);
  log(logEl, 'Step 2: Checking banned terms...', 'info');
  const banned = ['admin', 'moderator', 'official'];
  const found = banned.filter(t => name.toLowerCase().includes(t) || id.toLowerCase().includes(t));
  if (found.length) log(logEl, `‚ö†Ô∏è Reserved terms found: ${found.join(', ')}`, 'warning');
  else log(logEl, '‚úÖ No banned terms', 'success');
  
  await sleep(400);
  log(logEl, 'Step 3: Checking ID availability...', 'info');
  log(logEl, `‚úÖ "${id}" is available`, 'success');
  
  await sleep(300);
  log(logEl, 'Step 4: Generating profile data...', 'info');
  log(logEl, `<pre style="margin-left:1rem;color:var(--text-muted)">${JSON.stringify({ runner_id: id, display_name: name, bio, status: 'pending' }, null, 2)}</pre>`, 'info');
  
  log(logEl, '‚îÄ'.repeat(35), 'info');
  log(logEl, 'üéâ SIMULATION COMPLETE', 'success');
});

// Game Simulator
document.getElementById('sim-game-run')?.addEventListener('click', async () => {
  const logEl = document.getElementById('sim-game-log');
  clearLog(logEl);
  const name = document.getElementById('sim-game-name').value;
  const id = document.getElementById('sim-game-id').value;
  const year = document.getElementById('sim-game-year').value;
  const dev = document.getElementById('sim-game-dev').value;
  const genres = document.getElementById('sim-game-genres').value;
  const categories = document.getElementById('sim-game-categories').value;
  
  log(logEl, 'üöÄ Starting game submission simulation...', 'info');
  await sleep(300);
  
  log(logEl, 'Step 1: Validating inputs...', 'info');
  if (!name || !id || !/^[a-z0-9-]+$/.test(id)) { log(logEl, '‚ùå Invalid inputs', 'error'); return; }
  log(logEl, '‚úÖ Validation passed', 'success');
  
  await sleep(400);
  log(logEl, 'Step 2: Checking ID availability...', 'info');
  const existing = ['hades-2', 'hollow-knight', 'celeste'];
  if (existing.includes(id)) { log(logEl, `‚ùå "${id}" already exists`, 'error'); return; }
  log(logEl, `‚úÖ "${id}" is available`, 'success');
  
  await sleep(400);
  log(logEl, 'Step 3: Parsing categories...', 'info');
  const cats = categories.split(',').map(c => c.trim()).filter(Boolean);
  log(logEl, `‚úÖ Categories: ${cats.join(', ')}`, 'success');
  
  await sleep(300);
  log(logEl, 'Step 4: Generating file structure...', 'info');
  log(logEl, `üìÑ _games/${id}.md`, 'info');
  cats.forEach(c => log(logEl, `üìÅ /games/${id}/runs/full-runs/${c.toLowerCase()}/`, 'info'));
  
  log(logEl, '‚îÄ'.repeat(35), 'info');
  log(logEl, 'üéâ SIMULATION COMPLETE', 'success');
});

// Run Simulator
document.getElementById('sim-run-run')?.addEventListener('click', async () => {
  const logEl = document.getElementById('sim-run-log');
  clearLog(logEl);
  const game = document.getElementById('sim-run-game').value;
  const category = document.getElementById('sim-run-category').value;
  const runner = document.getElementById('sim-run-runner').value;
  const time = document.getElementById('sim-run-time').value;
  const video = document.getElementById('sim-run-video').value;
  
  log(logEl, 'üöÄ Starting run submission simulation...', 'info');
  await sleep(300);
  
  log(logEl, 'Step 1: Validating required fields...', 'info');
  if (!game || !category || !runner || !video) { log(logEl, '‚ùå Missing required fields', 'error'); return; }
  log(logEl, '‚úÖ All fields present', 'success');
  
  await sleep(400);
  log(logEl, 'Step 2: Validating video URL...', 'info');
  const hosts = ['youtube.com', 'youtu.be', 'twitch.tv'];
  try { const u = new URL(video); if (!hosts.some(h => u.hostname.includes(h))) log(logEl, '‚ö†Ô∏è Unknown video host', 'warning'); else log(logEl, '‚úÖ Video URL valid', 'success'); } catch { log(logEl, '‚ùå Invalid URL', 'error'); return; }
  
  await sleep(400);
  log(logEl, 'Step 3: Validating time format...', 'info');
  if (!/^(\d{1,2}:)?(\d{1,2}:)?\d{1,2}(\.\d+)?$/.test(time)) log(logEl, '‚ö†Ô∏è Time format may be invalid', 'warning');
  else log(logEl, `‚úÖ Time: ${time}`, 'success');
  
  await sleep(300);
  log(logEl, 'Step 4: Generating run file...', 'info');
  const date = new Date().toISOString().split('T')[0];
  log(logEl, `üìÑ ${date}__${game}__${runner}__${category.toLowerCase()}__01.md`, 'info');
  
  log(logEl, '‚îÄ'.repeat(35), 'info');
  log(logEl, 'üéâ SIMULATION COMPLETE', 'success');
});

// Auth Debug
function renderAuthDebug() {
  const user = CRCAuth.getUser();
  const profile = CRCAuth.getProfile();
  const metadata = CRCAuth.getProviderMetadata();
  
  document.getElementById('debug-user-info').innerHTML = `
    <div class="debug-row"><span class="debug-key">User ID</span><span class="debug-value">${user?.id || 'N/A'}</span></div>
    <div class="debug-row"><span class="debug-key">Email</span><span class="debug-value">${user?.email || 'N/A'}</span></div>
    <div class="debug-row"><span class="debug-key">Created</span><span class="debug-value">${user?.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</span></div>
  `;
  document.getElementById('debug-provider-info').innerHTML = `
    <div class="debug-row"><span class="debug-key">Provider</span><span class="debug-value">${metadata?.provider || 'N/A'}</span></div>
    <div class="debug-row"><span class="debug-key">Username</span><span class="debug-value">${metadata?.providerUsername || 'N/A'}</span></div>
    <div class="debug-row"><span class="debug-key">Verified</span><span class="debug-value">${metadata?.emailVerified ? '‚úÖ' : '‚ùå'}</span></div>
  `;
  document.getElementById('debug-profile-info').innerHTML = `
    <div class="debug-row"><span class="debug-key">Runner ID</span><span class="debug-value">${profile?.runner_id || 'N/A'}</span></div>
    <div class="debug-row"><span class="debug-key">Display</span><span class="debug-value">${profile?.display_name || 'N/A'}</span></div>
    <div class="debug-row"><span class="debug-key">Admin</span><span class="debug-value">${profile?.is_admin ? '‚úÖ' : '‚ùå'}</span></div>
  `;
  document.getElementById('debug-raw-session').textContent = JSON.stringify({ user, profile, metadata }, null, 2);
}

document.getElementById('debug-refresh')?.addEventListener('click', async () => { await CRCAuth.init(); renderAuthDebug(); });
document.getElementById('debug-sign-out')?.addEventListener('click', async () => { await CRCAuth.signOut(); window.location.href = '/sign-in/'; });

// Load Stats & Status
async function loadDashboard() {
  // System status
  document.getElementById('status-timestamp').textContent = new Date().toLocaleTimeString();
  
  if (supabase) {
    try {
      await supabase.from('runner_profiles').select('id', { count: 'exact', head: true });
      document.getElementById('status-supabase').textContent = 'Connected';
      document.getElementById('status-dot-supabase').classList.add('ok');
    } catch { 
      document.getElementById('status-supabase').textContent = 'Error';
      document.getElementById('status-dot-supabase').classList.add('error');
    }
  }
  
  document.getElementById('status-auth').textContent = CRCAuth.isSignedIn() ? 'Active' : 'Not signed in';
  document.getElementById('status-dot-auth').classList.add(CRCAuth.isSignedIn() ? 'ok' : 'warn');
  document.getElementById('status-dot-github').classList.add('ok');
  document.getElementById('status-github').textContent = 'Active';
  document.getElementById('status-dot-jekyll').classList.add('ok');
  
  // Stats
  if (supabase) {
    try {
      const { count: profiles } = await supabase.from('pending_profiles').select('*', { count: 'exact', head: true }).eq('status', 'pending');
      document.getElementById('stat-profiles').textContent = profiles || 0;
      if (profiles > 0) { const b = document.getElementById('action-profiles-badge'); if (b) { b.hidden = false; b.textContent = profiles; } }
      
      const { count: runners } = await supabase.from('runner_profiles').select('*', { count: 'exact', head: true });
      document.getElementById('stat-total-runners').textContent = runners || 0;
      document.getElementById('stat-total-runners-2').textContent = runners || 0;
    } catch (e) { console.error(e); }
  }
  
  document.getElementById('stat-games').textContent = '0';
  document.getElementById('stat-runs').textContent = '0';
  document.getElementById('stat-total-games').textContent = '{{ site.games.size }}';
  document.getElementById('stat-total-runs').textContent = '{{ site.runs.size }}';
  document.getElementById('stat-verified-runs').textContent = '-';
  
  // Activity placeholder
  document.getElementById('recent-activity').innerHTML = `
    <div class="activity-item">Profile created: gary-asher <span class="activity-time">2 days ago</span></div>
    <div class="activity-item">Run submitted: Hades 2 Any% <span class="activity-time">3 days ago</span></div>
  `;
}

// Initialize
(async function() {
  await CRCAuth.init();
  const isSignedIn = CRCAuth.isSignedIn();
  const profile = CRCAuth.getProfile();
  const metadata = CRCAuth.getProviderMetadata();
  const isAdmin = profile?.runner_id && ADMIN_IDS.includes(profile.runner_id) || metadata?.providerUsername?.toLowerCase() === 'garyasher';
  
  authCheck.hidden = true;
  if (isSignedIn && isAdmin) {
    adminContent.hidden = false;
    supabase = CRCAuth.getSupabaseClient?.();
    renderAuthDebug();
    loadDashboard();
  } else {
    notAuthorized.hidden = false;
  }
})();
</script>
