---
layout: default
title: "Site Health"
---

<div class="page-width">
  <div id="auth-check">
    <div class="card">
      <div class="sign-in-loading">
        <div class="spinner"></div>
        <p class="muted">Verifying super admin access...</p>
      </div>
    </div>
  </div>
  
  <div id="not-authorized" class="card" hidden>
    <h2>Access Denied</h2>
    <p class="muted">Super Admin privileges required.</p>
    <a href="/" class="btn btn--primary">Go Home</a>
  </div>
  
  <div id="admin-content" hidden>
    <div class="page-header">
      <span class="super-admin-badge">üîí Super Admin Only</span>
      <h1>üíö Site Health</h1>
      <p class="muted">System monitoring and diagnostics</p>
    </div>
    
    <!-- Health Overview -->
    <div class="health-status-bar" id="health-status-bar">
      <span class="health-indicator" id="health-indicator"></span>
      <span class="health-text" id="health-text">Checking systems...</span>
      <span class="health-time" id="health-time"></span>
    </div>
    
    <!-- Quick Stats Row -->
    <div class="health-stats-row">
      <div class="health-stat">
        <span class="health-stat__value" id="stat-users-24h">-</span>
        <span class="health-stat__label">Active Users (24h)</span>
      </div>
      <div class="health-stat">
        <span class="health-stat__value" id="stat-error-rate">-</span>
        <span class="health-stat__label">Error Rate</span>
      </div>
      <div class="health-stat">
        <span class="health-stat__value" id="stat-avg-response">-</span>
        <span class="health-stat__label">Avg API Response</span>
      </div>
      <div class="health-stat">
        <span class="health-stat__value" id="stat-uptime">-</span>
        <span class="health-stat__label">Uptime (30d)</span>
      </div>
    </div>
    
    <!-- Service Status Grid -->
    <div class="health-grid">
      <!-- Supabase -->
      <div class="health-card" id="health-supabase">
        <div class="health-card__header">
          <span class="health-card__icon">üóÑÔ∏è</span>
          <h3>Supabase Database</h3>
          <span class="health-card__status" id="supabase-status">Checking...</span>
        </div>
        <div class="health-card__body">
          <div class="health-metric">
            <span class="health-metric__label">Response Time</span>
            <span class="health-metric__value" id="supabase-latency">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Connection</span>
            <span class="health-metric__value" id="supabase-connection">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Active Sessions</span>
            <span class="health-metric__value" id="supabase-sessions">-</span>
          </div>
        </div>
      </div>
      
      <!-- Authentication -->
      <div class="health-card" id="health-auth">
        <div class="health-card__header">
          <span class="health-card__icon">üîê</span>
          <h3>Authentication</h3>
          <span class="health-card__status" id="auth-status">Checking...</span>
        </div>
        <div class="health-card__body">
          <div class="health-metric">
            <span class="health-metric__label">Provider</span>
            <span class="health-metric__value" id="auth-provider">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Session Valid</span>
            <span class="health-metric__value" id="auth-session">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Token Expires</span>
            <span class="health-metric__value" id="auth-expires">-</span>
          </div>
        </div>
      </div>
      
      <!-- GitHub -->
      <div class="health-card" id="health-github">
        <div class="health-card__header">
          <span class="health-card__icon">üêô</span>
          <h3>GitHub Actions</h3>
          <span class="health-card__status" id="github-status">Unknown</span>
        </div>
        <div class="health-card__body">
          <div class="health-metric">
            <span class="health-metric__label">Last Deploy</span>
            <span class="health-metric__value" id="github-last-deploy">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Last Workflow</span>
            <span class="health-metric__value" id="github-last-run">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Status</span>
            <span class="health-metric__value" id="github-workflow-status">-</span>
          </div>
        </div>
      </div>
      
      <!-- Uptime Monitor -->
      <div class="health-card" id="health-uptime">
        <div class="health-card__header">
          <span class="health-card__icon">üìà</span>
          <h3>Uptime Monitor</h3>
          <span class="health-card__status" id="uptime-status">Unknown</span>
        </div>
        <div class="health-card__body">
          <div class="health-metric">
            <span class="health-metric__label">Last 24h</span>
            <span class="health-metric__value" id="uptime-24h">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Last 7 Days</span>
            <span class="health-metric__value" id="uptime-7d">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Last Incident</span>
            <span class="health-metric__value" id="uptime-last-incident">-</span>
          </div>
          <div class="health-metric uptime-config-note">
            <a href="https://uptimerobot.com/" target="_blank" rel="noopener" class="uptime-config-link">Configure UptimeRobot ‚Üí</a>
          </div>
        </div>
      </div>
      
      <!-- Cloudflare -->
      <div class="health-card" id="health-cloudflare">
        <div class="health-card__header">
          <span class="health-card__icon">‚òÅÔ∏è</span>
          <h3>Cloudflare</h3>
          <span class="health-card__status" id="cloudflare-status">Unknown</span>
        </div>
        <div class="health-card__body">
          <div class="health-metric">
            <span class="health-metric__label">CDN</span>
            <span class="health-metric__value">Active</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">SSL</span>
            <span class="health-metric__value">Enabled</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Cache</span>
            <span class="health-metric__value">Enabled</span>
          </div>
        </div>
      </div>
      
      <!-- JS Error Tracking -->
      <div class="health-card" id="health-errors">
        <div class="health-card__header">
          <span class="health-card__icon">üêõ</span>
          <h3>Error Tracking</h3>
          <span class="health-card__status" id="errors-status">Unknown</span>
        </div>
        <div class="health-card__body">
          <div class="health-metric">
            <span class="health-metric__label">JS Errors (24h)</span>
            <span class="health-metric__value" id="errors-js-24h">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">API Errors (24h)</span>
            <span class="health-metric__value" id="errors-api-24h">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Last Error</span>
            <span class="health-metric__value" id="errors-last">-</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Resource Usage - Visual Bars like Dashboard -->
    <div class="card mt-4">
      <h2>üìä Resource Usage</h2>
      <p class="muted mb-3">Estimated usage against Supabase free tier limits.</p>
      
      <div class="resource-usage-grid">
        <div class="resource-usage-card">
          <div class="resource-usage-card__header">
            <span class="resource-usage-card__icon">üìù</span>
            <div class="resource-usage-card__info">
              <span class="resource-usage-card__title">Database Rows</span>
              <span class="resource-usage-card__value" id="resource-rows-value">0</span>
            </div>
            <span class="resource-usage-card__limit">/ 100,000</span>
          </div>
          <div class="resource-usage-card__bar">
            <div class="resource-usage-card__fill" id="resource-rows-bar" style="width: 0%"></div>
          </div>
          <span class="resource-usage-card__percent" id="resource-rows-percent">0%</span>
        </div>
        
        <div class="resource-usage-card">
          <div class="resource-usage-card__header">
            <span class="resource-usage-card__icon">üíæ</span>
            <div class="resource-usage-card__info">
              <span class="resource-usage-card__title">Database Size</span>
              <span class="resource-usage-card__value" id="resource-size-value">0 MB</span>
            </div>
            <span class="resource-usage-card__limit">/ 500 MB</span>
          </div>
          <div class="resource-usage-card__bar">
            <div class="resource-usage-card__fill" id="resource-size-bar" style="width: 0%"></div>
          </div>
          <span class="resource-usage-card__percent" id="resource-size-percent">0%</span>
        </div>
        
        <div class="resource-usage-card">
          <div class="resource-usage-card__header">
            <span class="resource-usage-card__icon">üë•</span>
            <div class="resource-usage-card__info">
              <span class="resource-usage-card__title">Auth Users</span>
              <span class="resource-usage-card__value" id="resource-users-value">0</span>
            </div>
            <span class="resource-usage-card__limit">/ 50,000</span>
          </div>
          <div class="resource-usage-card__bar">
            <div class="resource-usage-card__fill" id="resource-users-bar" style="width: 0%"></div>
          </div>
          <span class="resource-usage-card__percent" id="resource-users-percent">0%</span>
        </div>
        
        <div class="resource-usage-card">
          <div class="resource-usage-card__header">
            <span class="resource-usage-card__icon">üóÇÔ∏è</span>
            <div class="resource-usage-card__info">
              <span class="resource-usage-card__title">File Storage</span>
              <span class="resource-usage-card__value" id="resource-storage-value">0 MB</span>
            </div>
            <span class="resource-usage-card__limit">/ 1 GB</span>
          </div>
          <div class="resource-usage-card__bar">
            <div class="resource-usage-card__fill" id="resource-storage-bar" style="width: 0%"></div>
          </div>
          <span class="resource-usage-card__percent" id="resource-storage-percent">0%</span>
        </div>
      </div>
    </div>
    
    <!-- API Performance -->
    <div class="card mt-4">
      <h2>‚ö° API Performance</h2>
      <p class="muted mb-3">Recent Supabase query response times (last 10 queries).</p>
      
      <div class="api-perf-container">
        <div class="api-perf-chart" id="api-perf-chart">
          <div class="api-perf-chart__empty">Collecting data...</div>
        </div>
        <div class="api-perf-stats">
          <div class="api-perf-stat">
            <span class="api-perf-stat__label">Min</span>
            <span class="api-perf-stat__value" id="api-perf-min">-</span>
          </div>
          <div class="api-perf-stat">
            <span class="api-perf-stat__label">Avg</span>
            <span class="api-perf-stat__value" id="api-perf-avg">-</span>
          </div>
          <div class="api-perf-stat">
            <span class="api-perf-stat__label">Max</span>
            <span class="api-perf-stat__value" id="api-perf-max">-</span>
          </div>
          <div class="api-perf-stat">
            <span class="api-perf-stat__label">P95</span>
            <span class="api-perf-stat__value" id="api-perf-p95">-</span>
          </div>
        </div>
      </div>
      
      <!-- API Performance Report -->
      <div class="api-perf-report mt-3">
        <h3>üìÑ Performance Report</h3>
        <div class="api-perf-report__content" id="api-perf-report">
          <p class="muted">Waiting for performance data...</p>
        </div>
      </div>
      
      <!-- Slow Query Details -->
      <div class="api-slow-queries mt-3" id="slow-queries-section" hidden>
        <h3>üê¢ Slow Query Details</h3>
        <div class="slow-queries-list" id="slow-queries-list">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
    
    <!-- Recent Events Log -->
    <div class="card mt-4">
      <h2>üìã System Log</h2>
      <p class="muted mb-3">Recent system events and errors.</p>
      
      <div class="log-filters mb-2">
        <button type="button" class="log-filter active" data-filter="all">All</button>
        <button type="button" class="log-filter" data-filter="info">Info</button>
        <button type="button" class="log-filter" data-filter="success">Success</button>
        <button type="button" class="log-filter" data-filter="warn">Warning</button>
        <button type="button" class="log-filter" data-filter="error">Error</button>
      </div>
      
      <div class="system-log" id="system-log">
        <div class="log-entry log-entry--info">
          <span class="log-time">Now</span>
          <span class="log-message">Health check initiated</span>
        </div>
      </div>
      
      <div class="log-actions mt-3">
        <button type="button" class="btn" id="refresh-health">üîÑ Refresh All</button>
        <button type="button" class="btn" id="clear-log">üóëÔ∏è Clear Log</button>
        <button type="button" class="btn" id="export-log">üì§ Export Log</button>
      </div>
    </div>
  </div>
</div>

<style>
.super-admin-badge {
  display: inline-block;
  background: #9b59b6;
  color: white;
  font-size: 0.75rem;
  font-weight: 600;
  padding: 0.25rem 0.75rem;
  border-radius: 4px;
  margin-bottom: 0.5rem;
}

.page-header { margin-bottom: 2rem; }
.page-header h1 { margin-bottom: 0.25rem; }

/* Health Status Bar */
.health-status-bar {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem 1.25rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 1rem;
}

.health-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--text-muted);
  animation: pulse 2s infinite;
}

.health-indicator.ok { background: #10b981; }
.health-indicator.warn { background: #f59e0b; }
.health-indicator.error { background: #ef4444; }

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.health-text { flex: 1; font-weight: 500; }
.health-time { font-size: 0.85rem; color: var(--text-muted); }

/* Quick Stats Row */
.health-stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.health-stat {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 1rem;
  text-align: center;
}

.health-stat__value {
  display: block;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
  line-height: 1.2;
}

.health-stat__label {
  display: block;
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Health Grid */
.health-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.25rem;
}

.health-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
}

.health-card__header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
}

.health-card__icon { font-size: 1.25rem; }
.health-card__header h3 { flex: 1; font-size: 1rem; margin: 0; }

.health-card__status {
  font-size: 0.8rem;
  font-weight: 600;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  background: var(--text-muted);
  color: var(--bg);
}

.health-card__status.ok { background: #10b981; }
.health-card__status.warn { background: #f59e0b; }
.health-card__status.error { background: #ef4444; }

.health-card__body { padding: 1rem; }

.health-metric {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--border);
}

.health-metric:last-child { border-bottom: none; }

.health-metric__label { font-size: 0.85rem; color: var(--text-muted); }
.health-metric__value { font-size: 0.85rem; font-weight: 500; }

.uptime-config-note { justify-content: center; }
.uptime-config-link { font-size: 0.8rem; color: var(--accent); }

/* Queue Grid */
.queue-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.queue-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  transition: border-color 0.15s ease;
}

.queue-card:hover { border-color: var(--accent); }

.queue-card__icon { font-size: 1.5rem; }

.queue-card__info { flex: 1; }

.queue-card__count {
  display: block;
  font-size: 1.5rem;
  font-weight: 700;
  line-height: 1;
}

.queue-card__count.has-items { color: #f59e0b; }

.queue-card__label {
  display: block;
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
}

.queue-card__link {
  font-size: 0.85rem;
  color: var(--accent);
  white-space: nowrap;
}

/* API Performance */
.api-perf-container {
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
}

.api-perf-chart {
  flex: 1;
  min-width: 300px;
  height: 120px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: flex-end;
  padding: 0.5rem;
  gap: 4px;
}

.api-perf-chart__empty {
  width: 100%;
  text-align: center;
  color: var(--text-muted);
  font-size: 0.85rem;
  align-self: center;
}

.api-perf-bar {
  flex: 1;
  background: var(--accent);
  border-radius: 2px 2px 0 0;
  min-height: 4px;
  transition: height 0.3s ease;
  position: relative;
}

.api-perf-bar:hover::after {
  content: attr(data-value);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.7rem;
  white-space: nowrap;
}

.api-perf-bar.slow { background: #f59e0b; }
.api-perf-bar.very-slow { background: #ef4444; }

.api-perf-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
  min-width: 160px;
}

.api-perf-stat {
  text-align: center;
  padding: 0.75rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
}

.api-perf-stat__label {
  display: block;
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 0.25rem;
}

.api-perf-stat__value {
  font-size: 1rem;
  font-weight: 600;
}

/* API Performance Report */
.api-perf-report {
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.api-perf-report h3 {
  font-size: 0.95rem;
  margin-bottom: 0.75rem;
}

.api-perf-report__content {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 1rem;
  font-size: 0.85rem;
  line-height: 1.6;
}

.api-perf-report__content p {
  margin: 0 0 0.5rem 0;
}

.api-perf-report__content p:last-child {
  margin-bottom: 0;
}

.report-good { color: #10b981; }
.report-warn { color: #f59e0b; }
.report-bad { color: #ef4444; }

/* Resource Usage Cards - Dashboard Style */
.resource-usage-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 1rem;
}

.resource-usage-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 1rem;
}

.resource-usage-card__header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.resource-usage-card__icon {
  font-size: 1.25rem;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  border-radius: var(--radius-sm);
}

.resource-usage-card__info {
  flex: 1;
}

.resource-usage-card__title {
  display: block;
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-bottom: 0.15rem;
}

.resource-usage-card__value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--fg);
}

.resource-usage-card__limit {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.resource-usage-card__bar {
  height: 8px;
  background: var(--bg);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.resource-usage-card__fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), #8b5cf6);
  border-radius: 4px;
  transition: width 0.5s ease;
}

.resource-usage-card__fill.warn {
  background: linear-gradient(90deg, #f59e0b, #f97316);
}

.resource-usage-card__fill.danger {
  background: linear-gradient(90deg, #ef4444, #dc2626);
}

.resource-usage-card__percent {
  font-size: 0.75rem;
  color: var(--text-muted);
}

/* Slow Queries */
.api-slow-queries {
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.api-slow-queries h3 {
  font-size: 0.95rem;
  margin-bottom: 0.75rem;
}

.slow-queries-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.slow-query-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
}

.slow-query-item--yellow {
  border-left: 3px solid #f59e0b;
}

.slow-query-item--red {
  border-left: 3px solid #ef4444;
}

.slow-query-item__status {
  font-size: 1.25rem;
}

.slow-query-item__info {
  flex: 1;
}

.slow-query-item__name {
  font-weight: 600;
}

.slow-query-item__time {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.slow-query-item__latency {
  font-weight: 700;
  font-family: monospace;
}

.slow-query-item--yellow .slow-query-item__latency {
  color: #f59e0b;
}

.slow-query-item--red .slow-query-item__latency {
  color: #ef4444;
}

/* Log Filters */
.log-filters {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.log-filter {
  padding: 0.35rem 0.75rem;
  font-size: 0.8rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s ease;
  color: var(--fg);
}

.log-filter:hover { border-color: var(--accent); }
.log-filter.active {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

/* System Log */
.system-log {
  max-height: 300px;
  overflow-y: auto;
  background: #0a0a0a;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0.75rem;
}

.log-entry {
  display: flex;
  gap: 1rem;
  padding: 0.35rem 0;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 0.8rem;
  border-bottom: 1px solid var(--border);
}

.log-entry:last-child { border-bottom: none; }
.log-entry.hidden { display: none; }

.log-time { color: var(--text-muted); flex-shrink: 0; width: 80px; }
.log-message { flex: 1; }

.log-entry--info .log-message { color: #3b82f6; }
.log-entry--success .log-message { color: #10b981; }
.log-entry--warn .log-message { color: #f59e0b; }
.log-entry--error .log-message { color: #ef4444; }

.log-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

/* Button fixes for admin pages */
.btn {
  color: var(--fg);
  background: var(--surface);
  border: 1px solid var(--border);
}

.btn:hover {
  border-color: var(--accent);
}

.btn--primary {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

.btn--primary:hover {
  opacity: 0.9;
}
</style>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

const SUPER_ADMIN_IDS = ['gary-asher'];
let supabase = null;
let apiResponseTimes = [];
let jsErrors = [];
let apiErrors = [];

const authCheck = document.getElementById('auth-check');
const notAuthorized = document.getElementById('not-authorized');
const adminContent = document.getElementById('admin-content');

// Error tracking - capture JS errors
window.CRC_HealthErrors = { js: [], api: [] };

window.onerror = function(msg, url, lineNo, columnNo, error) {
  const errorInfo = {
    message: msg,
    url: url,
    line: lineNo,
    column: columnNo,
    timestamp: new Date().toISOString()
  };
  window.CRC_HealthErrors.js.push(errorInfo);
  // Keep only last 100 errors
  if (window.CRC_HealthErrors.js.length > 100) {
    window.CRC_HealthErrors.js.shift();
  }
  return false;
};

// Track API errors via fetch interception (for demo purposes, uses localStorage)
function getStoredErrors() {
  try {
    const stored = localStorage.getItem('crc_health_errors');
    return stored ? JSON.parse(stored) : { js: [], api: [], lastReset: Date.now() };
  } catch {
    return { js: [], api: [], lastReset: Date.now() };
  }
}

function saveStoredErrors(errors) {
  try {
    localStorage.setItem('crc_health_errors', JSON.stringify(errors));
  } catch {}
}

function log(message, type = 'info') {
  const logEl = document.getElementById('system-log');
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement('div');
  entry.className = `log-entry log-entry--${type}`;
  entry.dataset.type = type;
  entry.innerHTML = `<span class="log-time">${time}</span><span class="log-message">${message}</span>`;
  logEl.appendChild(entry);
  logEl.scrollTop = logEl.scrollHeight;
}

// Measure API response time
async function timedQuery(queryFn, label) {
  const start = Date.now();
  try {
    const result = await queryFn();
    const latency = Date.now() - start;
    apiResponseTimes.push({ label, latency, timestamp: Date.now() });
    if (apiResponseTimes.length > 10) apiResponseTimes.shift();
    return { result, latency };
  } catch (error) {
    const latency = Date.now() - start;
    apiResponseTimes.push({ label, latency, timestamp: Date.now(), error: true });
    if (apiResponseTimes.length > 10) apiResponseTimes.shift();
    throw error;
  }
}

function updateApiPerfChart() {
  const chart = document.getElementById('api-perf-chart');
  if (apiResponseTimes.length === 0) return;
  
  const times = apiResponseTimes.map(r => r.latency);
  const maxTime = Math.max(...times, 100);
  
  chart.innerHTML = apiResponseTimes.map(r => {
    const height = Math.max((r.latency / maxTime) * 100, 5);
    let cls = 'api-perf-bar';
    if (r.latency > 500) cls += ' very-slow';
    else if (r.latency > 200) cls += ' slow';
    return `<div class="${cls}" style="height: ${height}%" data-value="${r.latency}ms"></div>`;
  }).join('');
  
  // Update stats
  const sorted = [...times].sort((a, b) => a - b);
  document.getElementById('api-perf-min').textContent = Math.min(...times) + 'ms';
  document.getElementById('api-perf-avg').textContent = Math.round(times.reduce((a, b) => a + b, 0) / times.length) + 'ms';
  document.getElementById('api-perf-max').textContent = Math.max(...times) + 'ms';
  document.getElementById('api-perf-p95').textContent = sorted[Math.floor(sorted.length * 0.95)] + 'ms';
}

async function checkHealth() {
  const indicator = document.getElementById('health-indicator');
  const text = document.getElementById('health-text');
  const time = document.getElementById('health-time');
  
  let allOk = true;
  let warnings = 0;
  
  // Check Supabase
  log('Checking Supabase connection...');
  const supabaseStatus = document.getElementById('supabase-status');
  try {
    const { result, latency } = await timedQuery(
      () => supabase.from('runner_profiles').select('id', { count: 'exact', head: true }),
      'profiles_count'
    );
    
    supabaseStatus.textContent = 'Healthy';
    supabaseStatus.className = 'health-card__status ok';
    document.getElementById('supabase-latency').textContent = latency + 'ms';
    document.getElementById('supabase-connection').textContent = 'Connected';
    document.getElementById('supabase-sessions').textContent = '1';
    document.getElementById('stat-avg-response').textContent = latency + 'ms';
    log('Supabase: Connected (' + latency + 'ms)', 'success');
  } catch (e) {
    supabaseStatus.textContent = 'Error';
    supabaseStatus.className = 'health-card__status error';
    document.getElementById('supabase-latency').textContent = 'N/A';
    document.getElementById('supabase-connection').textContent = 'Failed';
    log('Supabase: Connection failed - ' + e.message, 'error');
    allOk = false;
  }
  
  // Check Auth
  const authStatus = document.getElementById('auth-status');
  const user = CRCAuth.getUser();
  const metadata = CRCAuth.getProviderMetadata();
  
  if (user) {
    authStatus.textContent = 'Active';
    authStatus.className = 'health-card__status ok';
    document.getElementById('auth-provider').textContent = metadata?.provider || 'Unknown';
    document.getElementById('auth-session').textContent = 'Valid';
    document.getElementById('auth-expires').textContent = 'Active';
    log('Auth: Session active', 'success');
  } else {
    authStatus.textContent = 'No Session';
    authStatus.className = 'health-card__status warn';
    warnings++;
  }
  
  // GitHub status (placeholder - would need GitHub API)
  document.getElementById('github-status').textContent = 'Unknown';
  document.getElementById('github-last-deploy').textContent = 'Check GitHub';
  document.getElementById('github-last-run').textContent = 'Check GitHub';
  document.getElementById('github-workflow-status').textContent = 'N/A';
  log('GitHub: API integration not configured', 'warn');
  
  // Uptime status (placeholder - would need UptimeRobot API)
  document.getElementById('uptime-status').textContent = 'Unknown';
  document.getElementById('uptime-24h').textContent = 'Configure UptimeRobot';
  document.getElementById('uptime-7d').textContent = '-';
  document.getElementById('uptime-last-incident').textContent = '-';
  document.getElementById('stat-uptime').textContent = 'N/A';
  log('Uptime: UptimeRobot integration not configured', 'warn');
  
  // Cloudflare (assume ok if page loaded)
  document.getElementById('cloudflare-status').textContent = 'Active';
  document.getElementById('cloudflare-status').className = 'health-card__status ok';
  log('Cloudflare: Active (page served)', 'success');
  
  // Error tracking status
  const storedErrors = getStoredErrors();
  const now = Date.now();
  const dayAgo = now - 24 * 60 * 60 * 1000;
  
  // Reset if older than 24h
  if (storedErrors.lastReset < dayAgo) {
    storedErrors.js = [];
    storedErrors.api = [];
    storedErrors.lastReset = now;
    saveStoredErrors(storedErrors);
  }
  
  const jsErrors24h = (storedErrors.js || []).filter(e => new Date(e.timestamp).getTime() > dayAgo).length;
  const apiErrors24h = (storedErrors.api || []).filter(e => new Date(e.timestamp).getTime() > dayAgo).length;
  
  document.getElementById('errors-js-24h').textContent = jsErrors24h;
  document.getElementById('errors-api-24h').textContent = apiErrors24h;
  document.getElementById('errors-last').textContent = jsErrors24h + apiErrors24h > 0 ? 'See log' : 'None';
  
  const totalErrors = jsErrors24h + apiErrors24h;
  const errorsStatus = document.getElementById('errors-status');
  if (totalErrors === 0) {
    errorsStatus.textContent = 'Clean';
    errorsStatus.className = 'health-card__status ok';
  } else if (totalErrors < 10) {
    errorsStatus.textContent = 'Minor';
    errorsStatus.className = 'health-card__status warn';
    warnings++;
  } else {
    errorsStatus.textContent = 'Issues';
    errorsStatus.className = 'health-card__status error';
    allOk = false;
  }
  
  const errorRate = totalErrors > 0 ? `${totalErrors}/24h` : '0%';
  document.getElementById('stat-error-rate').textContent = errorRate;
  
  log(`Error tracking: ${jsErrors24h} JS, ${apiErrors24h} API errors in 24h`, totalErrors > 0 ? 'warn' : 'success');
  
  // Update overall status
  if (allOk && warnings === 0) {
    indicator.className = 'health-indicator ok';
    text.textContent = 'All systems operational';
  } else if (allOk) {
    indicator.className = 'health-indicator warn';
    text.textContent = `Operational with ${warnings} warning(s)`;
  } else {
    indicator.className = 'health-indicator error';
    text.textContent = 'Some issues detected';
  }
  time.textContent = 'Last checked: ' + new Date().toLocaleTimeString();
  
  // Load resource usage
  await loadResources();
  updateApiPerfChart();
  updatePerformanceReport();
}

async function loadResources() {
  if (!supabase) return;
  
  try {
    // Count rows in tables
    const { result: profilesResult } = await timedQuery(
      () => supabase.from('runner_profiles').select('*', { count: 'exact', head: true }),
      'runner_profiles_count'
    );
    const profiles = profilesResult?.count || 0;
    
    const { result: pendingResult } = await timedQuery(
      () => supabase.from('pending_profiles').select('*', { count: 'exact', head: true }),
      'pending_count'
    );
    const pending = pendingResult?.count || 0;
    
    const totalRows = profiles + pending;
    const rowPercent = (totalRows / 100000) * 100;
    
    // Update Resource Usage Cards
    document.getElementById('resource-rows-value').textContent = totalRows.toLocaleString();
    document.getElementById('resource-rows-percent').textContent = rowPercent.toFixed(1) + '%';
    const rowsBar = document.getElementById('resource-rows-bar');
    rowsBar.style.width = Math.min(rowPercent, 100) + '%';
    rowsBar.classList.remove('warn', 'danger');
    if (rowPercent > 80) rowsBar.classList.add('danger');
    else if (rowPercent > 50) rowsBar.classList.add('warn');
    
    // Database Size Estimate
    const sizeEst = Math.round(totalRows * 0.002);
    const sizePercent = (sizeEst / 500) * 100;
    document.getElementById('resource-size-value').textContent = `~${sizeEst} MB`;
    document.getElementById('resource-size-percent').textContent = sizePercent.toFixed(1) + '%';
    const sizeBar = document.getElementById('resource-size-bar');
    sizeBar.style.width = Math.min(sizePercent, 100) + '%';
    sizeBar.classList.remove('warn', 'danger');
    if (sizePercent > 80) sizeBar.classList.add('danger');
    else if (sizePercent > 50) sizeBar.classList.add('warn');
    
    // Auth Users
    const usersPercent = (profiles / 50000) * 100;
    document.getElementById('resource-users-value').textContent = profiles.toLocaleString();
    document.getElementById('resource-users-percent').textContent = usersPercent.toFixed(2) + '%';
    const usersBar = document.getElementById('resource-users-bar');
    usersBar.style.width = Math.min(usersPercent, 100) + '%';
    usersBar.classList.remove('warn', 'danger');
    if (usersPercent > 80) usersBar.classList.add('danger');
    else if (usersPercent > 50) usersBar.classList.add('warn');
    
    // Active users (24h) - estimate from profiles with recent activity
    document.getElementById('stat-users-24h').textContent = profiles > 0 ? Math.ceil(profiles * 0.1) : '0';
    
    // Storage
    document.getElementById('resource-storage-value').textContent = '~0 MB';
    document.getElementById('resource-storage-percent').textContent = '0%';
    document.getElementById('resource-storage-bar').style.width = '0%';
    
    log('Resource usage loaded', 'success');
    updateApiPerfChart();
  } catch (e) {
    log('Failed to load resources: ' + e.message, 'error');
  }
}

function updatePerformanceReport() {
  const reportEl = document.getElementById('api-perf-report');
  const slowQueriesSection = document.getElementById('slow-queries-section');
  const slowQueriesList = document.getElementById('slow-queries-list');
  
  if (!reportEl) return;
  
  if (apiResponseTimes.length < 3) {
    reportEl.innerHTML = '<p class="muted">Collecting performance data... (need at least 3 queries)</p>';
    if (slowQueriesSection) slowQueriesSection.hidden = true;
    return;
  }
  
  const times = apiResponseTimes.map(r => r.latency);
  const avg = Math.round(times.reduce((a, b) => a + b, 0) / times.length);
  const max = Math.max(...times);
  const min = Math.min(...times);
  
  // Get slow queries (>200ms = yellow, >500ms = red)
  const yellowQueries = apiResponseTimes.filter(r => r.latency > 200 && r.latency <= 500);
  const redQueries = apiResponseTimes.filter(r => r.latency > 500);
  const slowQueries = yellowQueries.length;
  const verySlowQueries = redQueries.length;
  
  let healthStatus = 'good';
  let healthClass = 'report-good';
  let healthText = '‚úÖ Excellent';
  
  if (avg > 300 || verySlowQueries > 0) {
    healthStatus = 'bad';
    healthClass = 'report-bad';
    healthText = '‚ùå Poor';
  } else if (avg > 150 || slowQueries > 2) {
    healthStatus = 'warn';
    healthClass = 'report-warn';
    healthText = '‚ö†Ô∏è Fair';
  }
  
  let report = `
    <p><strong>Performance Rating:</strong> <span class="${healthClass}">${healthText}</span></p>
    <p><strong>Summary:</strong> Average response time is ${avg}ms across ${times.length} queries.</p>
  `;
  
  if (slowQueries > 0) {
    report += `<p><span class="report-warn">‚ö†Ô∏è</span> ${slowQueries} queries took longer than 200ms.</p>`;
  }
  
  if (verySlowQueries > 0) {
    report += `<p><span class="report-bad">‚ùå</span> ${verySlowQueries} queries took longer than 500ms. Consider checking database indexes or network latency.</p>`;
  }
  
  if (healthStatus === 'good') {
    report += `<p><span class="report-good">‚úÖ</span> All queries are performing within acceptable limits.</p>`;
  }
  
  report += `<p class="muted" style="margin-top: 0.5rem; font-size: 0.8rem;">Range: ${min}ms - ${max}ms | Queries analyzed: ${times.length}</p>`;
  
  reportEl.innerHTML = report;
  
  // Show slow query details
  if (slowQueriesSection && slowQueriesList) {
    const allSlowQueries = [...redQueries, ...yellowQueries];
    
    if (allSlowQueries.length > 0) {
      slowQueriesSection.hidden = false;
      slowQueriesList.innerHTML = allSlowQueries.map(q => {
        const isRed = q.latency > 500;
        const statusIcon = isRed ? 'üî¥' : 'üü°';
        const itemClass = isRed ? 'slow-query-item--red' : 'slow-query-item--yellow';
        const timeStr = new Date(q.timestamp).toLocaleTimeString();
        
        return `
          <div class="slow-query-item ${itemClass}">
            <span class="slow-query-item__status">${statusIcon}</span>
            <div class="slow-query-item__info">
              <span class="slow-query-item__name">${q.name || 'Unknown Query'}</span>
              <span class="slow-query-item__time">${timeStr}</span>
            </div>
            <span class="slow-query-item__latency">${q.latency}ms</span>
          </div>
        `;
      }).join('');
    } else {
      slowQueriesSection.hidden = true;
    }
  }
}

// Log filtering
document.querySelectorAll('.log-filter').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.log-filter').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    const filter = btn.dataset.filter;
    document.querySelectorAll('.log-entry').forEach(entry => {
      if (filter === 'all' || entry.dataset.type === filter) {
        entry.classList.remove('hidden');
      } else {
        entry.classList.add('hidden');
      }
    });
  });
});

// Clear log
document.getElementById('clear-log')?.addEventListener('click', () => {
  const logEl = document.getElementById('system-log');
  logEl.innerHTML = '';
  log('Log cleared', 'info');
});

// Export log
document.getElementById('export-log')?.addEventListener('click', () => {
  const logEl = document.getElementById('system-log');
  const entries = Array.from(logEl.querySelectorAll('.log-entry')).map(entry => {
    const time = entry.querySelector('.log-time').textContent;
    const message = entry.querySelector('.log-message').textContent;
    const type = entry.dataset.type || 'info';
    return `[${time}] [${type.toUpperCase()}] ${message}`;
  });
  
  const blob = new Blob([entries.join('\n')], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `health-log-${new Date().toISOString().split('T')[0]}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  
  log('Log exported', 'success');
});

document.getElementById('refresh-health')?.addEventListener('click', checkHealth);

// Initialize
(async function() {
  await CRCAuth.init();
  
  const profile = CRCAuth.getProfile();
  const metadata = CRCAuth.getProviderMetadata();
  const runnerId = profile?.runner_id?.toLowerCase() || '';
  const username = metadata?.providerUsername?.toLowerCase() || '';
  
  const isSuperAdmin = SUPER_ADMIN_IDS.includes(runnerId) || 
                       SUPER_ADMIN_IDS.some(id => username === id || username === id.replace(/-/g, '_'));
  
  authCheck.hidden = true;
  
  if (CRCAuth.isSignedIn() && isSuperAdmin) {
    adminContent.hidden = false;
    supabase = CRCAuth.getSupabaseClient?.();
    checkHealth();
    
    // Auto-refresh every 60 seconds
    setInterval(checkHealth, 60000);
  } else {
    notAuthorized.hidden = false;
  }
})();
</script>
