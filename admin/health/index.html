---
layout: default
title: "Site Health"
---

<div class="page-width">
  <div id="auth-check">
    <div class="card">
      <div class="sign-in-loading">
        <div class="spinner"></div>
        <p class="muted">Verifying super admin access...</p>
      </div>
    </div>
  </div>
  
  <div id="not-authorized" class="card" hidden>
    <h2>Access Denied</h2>
    <p class="muted">Super Admin privileges required.</p>
    <a href="/" class="btn btn--primary">Go Home</a>
  </div>
  
  <div id="admin-content" hidden>
    <div class="page-header">
      <span class="super-admin-badge">üîí Super Admin Only</span>
      <h1>üíö Site Health</h1>
      <p class="muted">System monitoring and diagnostics</p>
    </div>
    
    <!-- Health Overview -->
    <div class="health-status-bar" id="health-status-bar">
      <span class="health-indicator" id="health-indicator"></span>
      <span class="health-text" id="health-text">Checking systems...</span>
      <span class="health-time" id="health-time"></span>
    </div>
    
    <!-- Service Status Grid -->
    <div class="health-grid">
      <!-- Supabase -->
      <div class="health-card" id="health-supabase">
        <div class="health-card__header">
          <span class="health-card__icon">üóÑÔ∏è</span>
          <h3>Supabase Database</h3>
          <span class="health-card__status" id="supabase-status">Checking...</span>
        </div>
        <div class="health-card__body">
          <div class="health-metric">
            <span class="health-metric__label">Response Time</span>
            <span class="health-metric__value" id="supabase-latency">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Connection</span>
            <span class="health-metric__value" id="supabase-connection">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Active Sessions</span>
            <span class="health-metric__value" id="supabase-sessions">-</span>
          </div>
        </div>
      </div>
      
      <!-- Authentication -->
      <div class="health-card" id="health-auth">
        <div class="health-card__header">
          <span class="health-card__icon">üîê</span>
          <h3>Authentication</h3>
          <span class="health-card__status" id="auth-status">Checking...</span>
        </div>
        <div class="health-card__body">
          <div class="health-metric">
            <span class="health-metric__label">Provider</span>
            <span class="health-metric__value" id="auth-provider">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Session Valid</span>
            <span class="health-metric__value" id="auth-session">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Token Expires</span>
            <span class="health-metric__value" id="auth-expires">-</span>
          </div>
        </div>
      </div>
      
      <!-- GitHub -->
      <div class="health-card" id="health-github">
        <div class="health-card__header">
          <span class="health-card__icon">üêô</span>
          <h3>GitHub Actions</h3>
          <span class="health-card__status" id="github-status">Unknown</span>
        </div>
        <div class="health-card__body">
          <div class="health-metric">
            <span class="health-metric__label">Last Workflow</span>
            <span class="health-metric__value" id="github-last-run">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Status</span>
            <span class="health-metric__value" id="github-workflow-status">-</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Repository</span>
            <span class="health-metric__value">challenge-run-site</span>
          </div>
        </div>
      </div>
      
      <!-- Cloudflare -->
      <div class="health-card" id="health-cloudflare">
        <div class="health-card__header">
          <span class="health-card__icon">‚òÅÔ∏è</span>
          <h3>Cloudflare</h3>
          <span class="health-card__status" id="cloudflare-status">Unknown</span>
        </div>
        <div class="health-card__body">
          <div class="health-metric">
            <span class="health-metric__label">CDN</span>
            <span class="health-metric__value">Active</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">SSL</span>
            <span class="health-metric__value">Enabled</span>
          </div>
          <div class="health-metric">
            <span class="health-metric__label">Cache</span>
            <span class="health-metric__value">Enabled</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Resource Usage -->
    <div class="card mt-4">
      <h2>üìä Resource Usage</h2>
      <p class="muted mb-3">Estimated usage against Supabase free tier limits.</p>
      
      <div class="resource-bars">
        <div class="resource-bar">
          <div class="resource-bar__header">
            <span class="resource-bar__label">Database Rows</span>
            <span class="resource-bar__value" id="resource-rows">0 / 100,000</span>
          </div>
          <div class="resource-bar__track">
            <div class="resource-bar__fill" id="resource-rows-bar" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="resource-bar">
          <div class="resource-bar__header">
            <span class="resource-bar__label">Database Size</span>
            <span class="resource-bar__value" id="resource-size">0 MB / 500 MB</span>
          </div>
          <div class="resource-bar__track">
            <div class="resource-bar__fill" id="resource-size-bar" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="resource-bar">
          <div class="resource-bar__header">
            <span class="resource-bar__label">Auth Users</span>
            <span class="resource-bar__value" id="resource-users">0 / 50,000</span>
          </div>
          <div class="resource-bar__track">
            <div class="resource-bar__fill" id="resource-users-bar" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="resource-bar">
          <div class="resource-bar__header">
            <span class="resource-bar__label">Storage</span>
            <span class="resource-bar__value" id="resource-storage">0 MB / 1 GB</span>
          </div>
          <div class="resource-bar__track">
            <div class="resource-bar__fill" id="resource-storage-bar" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Recent Events Log -->
    <div class="card mt-4">
      <h2>üìã System Log</h2>
      <p class="muted mb-3">Recent system events and errors.</p>
      
      <div class="system-log" id="system-log">
        <div class="log-entry log-entry--info">
          <span class="log-time">Now</span>
          <span class="log-message">Health check initiated</span>
        </div>
      </div>
      
      <button type="button" class="btn mt-3" id="refresh-health">üîÑ Refresh All</button>
    </div>
  </div>
</div>

<style>
.super-admin-badge {
  display: inline-block;
  background: #9b59b6;
  color: white;
  font-size: 0.75rem;
  font-weight: 600;
  padding: 0.25rem 0.75rem;
  border-radius: 4px;
  margin-bottom: 0.5rem;
}

.page-header { margin-bottom: 2rem; }
.page-header h1 { margin-bottom: 0.25rem; }

/* Health Status Bar */
.health-status-bar {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem 1.25rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 1.5rem;
}

.health-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--text-muted);
  animation: pulse 2s infinite;
}

.health-indicator.ok { background: #10b981; }
.health-indicator.warn { background: #f59e0b; }
.health-indicator.error { background: #ef4444; }

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.health-text { flex: 1; font-weight: 500; }
.health-time { font-size: 0.85rem; color: var(--text-muted); }

/* Health Grid */
.health-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.25rem;
}

.health-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
}

.health-card__header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
}

.health-card__icon { font-size: 1.25rem; }
.health-card__header h3 { flex: 1; font-size: 1rem; margin: 0; }

.health-card__status {
  font-size: 0.8rem;
  font-weight: 600;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  background: var(--text-muted);
  color: var(--bg);
}

.health-card__status.ok { background: #10b981; }
.health-card__status.warn { background: #f59e0b; }
.health-card__status.error { background: #ef4444; }

.health-card__body { padding: 1rem; }

.health-metric {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--border);
}

.health-metric:last-child { border-bottom: none; }

.health-metric__label { font-size: 0.85rem; color: var(--text-muted); }
.health-metric__value { font-size: 0.85rem; font-weight: 500; }

/* Resource Bars */
.resource-bars { display: flex; flex-direction: column; gap: 1.25rem; }

.resource-bar__header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
}

.resource-bar__label { font-size: 0.9rem; }
.resource-bar__value { font-size: 0.85rem; color: var(--text-muted); }

.resource-bar__track {
  height: 8px;
  background: var(--bg);
  border-radius: 4px;
  overflow: hidden;
}

.resource-bar__fill {
  height: 100%;
  background: var(--accent);
  border-radius: 4px;
  transition: width 0.5s ease;
}

.resource-bar__fill.warn { background: #f59e0b; }
.resource-bar__fill.danger { background: #ef4444; }

/* System Log */
.system-log {
  max-height: 300px;
  overflow-y: auto;
  background: #0a0a0a;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0.75rem;
}

.log-entry {
  display: flex;
  gap: 1rem;
  padding: 0.35rem 0;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 0.8rem;
  border-bottom: 1px solid var(--border);
}

.log-entry:last-child { border-bottom: none; }

.log-time { color: var(--text-muted); flex-shrink: 0; width: 80px; }
.log-message { flex: 1; }

.log-entry--info .log-message { color: #3b82f6; }
.log-entry--success .log-message { color: #10b981; }
.log-entry--warn .log-message { color: #f59e0b; }
.log-entry--error .log-message { color: #ef4444; }
</style>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

const SUPER_ADMIN_IDS = ['gary-asher'];
let supabase = null;

const authCheck = document.getElementById('auth-check');
const notAuthorized = document.getElementById('not-authorized');
const adminContent = document.getElementById('admin-content');

function log(message, type = 'info') {
  const logEl = document.getElementById('system-log');
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement('div');
  entry.className = `log-entry log-entry--${type}`;
  entry.innerHTML = `<span class="log-time">${time}</span><span class="log-message">${message}</span>`;
  logEl.appendChild(entry);
  logEl.scrollTop = logEl.scrollHeight;
}

async function checkHealth() {
  const indicator = document.getElementById('health-indicator');
  const text = document.getElementById('health-text');
  const time = document.getElementById('health-time');
  
  let allOk = true;
  
  // Check Supabase
  log('Checking Supabase connection...');
  const supabaseStatus = document.getElementById('supabase-status');
  try {
    const start = Date.now();
    await supabase.from('runner_profiles').select('id', { count: 'exact', head: true });
    const latency = Date.now() - start;
    
    supabaseStatus.textContent = 'Healthy';
    supabaseStatus.className = 'health-card__status ok';
    document.getElementById('supabase-latency').textContent = latency + 'ms';
    document.getElementById('supabase-connection').textContent = 'Connected';
    document.getElementById('supabase-sessions').textContent = '1';
    log('Supabase: Connected (' + latency + 'ms)', 'success');
  } catch (e) {
    supabaseStatus.textContent = 'Error';
    supabaseStatus.className = 'health-card__status error';
    document.getElementById('supabase-latency').textContent = 'N/A';
    document.getElementById('supabase-connection').textContent = 'Failed';
    log('Supabase: Connection failed - ' + e.message, 'error');
    allOk = false;
  }
  
  // Check Auth
  const authStatus = document.getElementById('auth-status');
  const user = CRCAuth.getUser();
  const metadata = CRCAuth.getProviderMetadata();
  
  if (user) {
    authStatus.textContent = 'Active';
    authStatus.className = 'health-card__status ok';
    document.getElementById('auth-provider').textContent = metadata?.provider || 'Unknown';
    document.getElementById('auth-session').textContent = 'Valid';
    document.getElementById('auth-expires').textContent = 'Active';
    log('Auth: Session active', 'success');
  } else {
    authStatus.textContent = 'No Session';
    authStatus.className = 'health-card__status warn';
    allOk = false;
  }
  
  // GitHub status (placeholder)
  document.getElementById('github-status').textContent = 'Unknown';
  document.getElementById('github-last-run').textContent = 'Check GitHub';
  document.getElementById('github-workflow-status').textContent = 'N/A';
  
  // Cloudflare (assume ok if page loaded)
  document.getElementById('cloudflare-status').textContent = 'Active';
  document.getElementById('cloudflare-status').className = 'health-card__status ok';
  log('Cloudflare: Active (page served)', 'success');
  
  // Update overall status
  indicator.className = 'health-indicator ' + (allOk ? 'ok' : 'warn');
  text.textContent = allOk ? 'All systems operational' : 'Some issues detected';
  time.textContent = 'Last checked: ' + new Date().toLocaleTimeString();
  
  // Load resource usage
  await loadResources();
}

async function loadResources() {
  if (!supabase) return;
  
  try {
    // Count rows in tables
    const { count: profiles } = await supabase.from('runner_profiles').select('*', { count: 'exact', head: true });
    const { count: pending } = await supabase.from('pending_profiles').select('*', { count: 'exact', head: true });
    
    const totalRows = (profiles || 0) + (pending || 0);
    const rowPercent = (totalRows / 100000) * 100;
    
    document.getElementById('resource-rows').textContent = `${totalRows.toLocaleString()} / 100,000`;
    document.getElementById('resource-rows-bar').style.width = Math.min(rowPercent, 100) + '%';
    
    // Estimates
    document.getElementById('resource-size').textContent = `~${Math.round(totalRows * 0.002)} MB / 500 MB`;
    document.getElementById('resource-size-bar').style.width = (totalRows * 0.002 / 500) * 100 + '%';
    
    document.getElementById('resource-users').textContent = `${profiles || 0} / 50,000`;
    document.getElementById('resource-users-bar').style.width = ((profiles || 0) / 50000) * 100 + '%';
    
    document.getElementById('resource-storage').textContent = `~0 MB / 1 GB`;
    document.getElementById('resource-storage-bar').style.width = '0%';
    
    log('Resource usage loaded', 'success');
  } catch (e) {
    log('Failed to load resources: ' + e.message, 'error');
  }
}

document.getElementById('refresh-health')?.addEventListener('click', checkHealth);

// Initialize
(async function() {
  await CRCAuth.init();
  
  const profile = CRCAuth.getProfile();
  const metadata = CRCAuth.getProviderMetadata();
  const runnerId = profile?.runner_id?.toLowerCase() || '';
  const username = metadata?.providerUsername?.toLowerCase() || '';
  
  const isSuperAdmin = SUPER_ADMIN_IDS.includes(runnerId) || 
                       SUPER_ADMIN_IDS.some(id => username === id || username === id.replace(/-/g, '_'));
  
  authCheck.hidden = true;
  
  if (CRCAuth.isSignedIn() && isSuperAdmin) {
    adminContent.hidden = false;
    supabase = CRCAuth.getSupabaseClient?.();
    checkHealth();
  } else {
    notAuthorized.hidden = false;
  }
})();
</script>
