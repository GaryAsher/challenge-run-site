---
layout: default
title: "Debug & Diagnostics"
---

<div class="page-width">
  <div id="auth-check">
    <div class="card">
      <div class="sign-in-loading">
        <div class="spinner"></div>
        <p class="muted">Checking access...</p>
      </div>
    </div>
  </div>
  
  <div id="not-authorized" class="card" hidden>
    <h2>Access Denied</h2>
    <p class="muted">Super admin access required for debug tools.</p>
    <a href="/" class="btn btn--primary">Go Home</a>
  </div>
  
  <div id="admin-content" hidden>
    <!-- Debug Mode Banner (shows when a role is being simulated) -->
    <div class="debug-banner" id="debug-banner" hidden>
      <div class="debug-banner__inner">
        <span class="debug-banner__icon">üîç</span>
        <span>Viewing site as: <strong id="debug-banner-role">‚Äî</strong></span>
        <span class="debug-banner__hint">Navigate to other admin pages to see their view. Submissions are disabled.</span>
        <button type="button" class="btn btn--small debug-banner__exit" id="exit-debug-global">‚úï Exit Debug</button>
      </div>
    </div>

    <p class="muted mb-2"><a href="/admin/">‚Üê Dashboard</a></p>
    <div class="debug-header">
      <h1>üîß Debug & Diagnostics</h1>
      <p class="muted">Role simulation, system health, and submission testing.</p>
    </div>
    
    <!-- Tabs -->
    <nav class="debug-tabs">
      <button class="tab active" data-tab="role-sim" type="button">üëÅÔ∏è Role Simulation</button>
      <button class="tab" data-tab="system" type="button">üíö System Health</button>
      <button class="tab" data-tab="simulators" type="button">üß™ Submission Testers</button>
    </nav>
    
    <!-- ============================================================
         ROLE SIMULATION TAB
         ============================================================ -->
    <section class="tab-panel active" data-panel="role-sim">
      <div class="card">
        <h2>üëÅÔ∏è Role Simulation</h2>
        <p class="muted mb-3">Preview the site as a different role. When active, the entire admin panel adjusts to show what that role would see. Submissions are disabled during debug mode.</p>
        
        <div class="role-cards" id="role-cards">
          <div class="role-card" data-role="super_admin">
            <div class="role-card__icon">‚≠ê</div>
            <div class="role-card__info">
              <div class="role-card__name">Super Admin</div>
              <div class="role-card__desc">Full access: runs, games, profiles, users, financials, health, debug tools.</div>
            </div>
            <div class="role-card__badge" id="badge-super_admin"></div>
          </div>
          <div class="role-card" data-role="admin">
            <div class="role-card__icon">üõ°Ô∏è</div>
            <div class="role-card__info">
              <div class="role-card__name">Admin</div>
              <div class="role-card__desc">Moderation: runs, games, profiles. No financials, health, or debug.</div>
            </div>
            <div class="role-card__badge" id="badge-admin"></div>
          </div>
          <div class="role-card" data-role="verifier">
            <div class="role-card__icon">‚úÖ</div>
            <div class="role-card__info">
              <div class="role-card__name">Verifier</div>
              <div class="role-card__desc">Runs only, limited to their assigned games. Cannot see profiles or games queues.</div>
            </div>
            <div class="role-card__badge" id="badge-verifier"></div>
          </div>
          <div class="role-card" data-role="user">
            <div class="role-card__icon">üë§</div>
            <div class="role-card__info">
              <div class="role-card__name">User</div>
              <div class="role-card__desc">No dashboard access. Sees the public site only.</div>
            </div>
            <div class="role-card__badge" id="badge-user"></div>
          </div>
        </div>
      </div>
      
      <!-- Permissions Matrix -->
      <div class="card mt-4">
        <h2>üîê Permissions Matrix</h2>
        <p class="muted mb-3">What each role can access:</p>
        <div class="permissions-table-wrap">
          <table class="permissions-table">
            <thead>
              <tr>
                <th>Capability</th>
                <th>Super Admin</th>
                <th>Admin</th>
                <th>Verifier</th>
                <th>User</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Review runs (all games)</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td><td class="perm-no">‚ùå</td><td class="perm-no">‚ùå</td></tr>
              <tr><td>Review runs (assigned games)</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td><td class="perm-no">‚ùå</td></tr>
              <tr><td>Review profiles</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td><td class="perm-no">‚ùå</td><td class="perm-no">‚ùå</td></tr>
              <tr><td>Review games</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td><td class="perm-no">‚ùå</td><td class="perm-no">‚ùå</td></tr>
              <tr><td>User management</td><td class="perm-yes">‚úÖ</td><td class="perm-no">‚ùå</td><td class="perm-no">‚ùå</td><td class="perm-no">‚ùå</td></tr>
              <tr><td>Financials</td><td class="perm-yes">‚úÖ</td><td class="perm-no">‚ùå</td><td class="perm-no">‚ùå</td><td class="perm-no">‚ùå</td></tr>
              <tr><td>Site health</td><td class="perm-yes">‚úÖ</td><td class="perm-no">‚ùå</td><td class="perm-no">‚ùå</td><td class="perm-no">‚ùå</td></tr>
              <tr><td>Debug tools</td><td class="perm-yes">‚úÖ</td><td class="perm-no">‚ùå</td><td class="perm-no">‚ùå</td><td class="perm-no">‚ùå</td></tr>
              <tr><td>Submit runs</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td></tr>
              <tr><td>Submit games</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td></tr>
              <tr><td>Edit own profile</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td><td class="perm-yes">‚úÖ</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Current Session Info -->
      <div class="card mt-4">
        <h2>üìã Current Session</h2>
        <div class="session-grid">
          <div class="session-row"><span class="session-key">Actual Role</span><span class="session-val" id="session-actual-role">‚Äî</span></div>
          <div class="session-row"><span class="session-key">Effective Role</span><span class="session-val" id="session-effective-role">‚Äî</span></div>
          <div class="session-row"><span class="session-key">Debug Mode</span><span class="session-val" id="session-debug-mode">Off</span></div>
          <div class="session-row"><span class="session-key">Runner ID</span><span class="session-val" id="session-runner-id">‚Äî</span></div>
          <div class="session-row"><span class="session-key">User ID</span><span class="session-val" id="session-user-id">‚Äî</span></div>
        </div>
      </div>
    </section>
    
    <!-- ============================================================
         SYSTEM HEALTH TAB
         ============================================================ -->
    <section class="tab-panel" data-panel="system">
      <div class="system-grid">
        <!-- Service Status -->
        <div class="card">
          <h2>üíö Service Status</h2>
          <div class="status-list">
            <div class="status-item">
              <span class="status-dot" id="status-dot-supabase"></span>
              <span>Supabase Database</span>
              <span class="status-value" id="status-supabase">Checking...</span>
            </div>
            <div class="status-item">
              <span class="status-dot" id="status-dot-auth"></span>
              <span>Authentication</span>
              <span class="status-value" id="status-auth">Checking...</span>
            </div>
            <div class="status-item">
              <span class="status-dot" id="status-dot-worker"></span>
              <span>Cloudflare Worker</span>
              <span class="status-value" id="status-worker">Checking...</span>
            </div>
            <div class="status-item">
              <span class="status-dot ok" id="status-dot-jekyll"></span>
              <span>Jekyll Build</span>
              <span class="status-value" id="status-jekyll">OK</span>
            </div>
          </div>
          <p class="muted mt-3" style="font-size: 0.8rem;">
            Last checked: <span id="status-timestamp">‚Äî</span>
            <button type="button" class="btn btn--small ml-2" id="refresh-status">üîÑ Recheck</button>
          </p>
        </div>
        
        <!-- Data Usage -->
        <div class="card">
          <h2>üíæ Data Usage</h2>
          <p class="muted mb-2">Supabase free tier estimates:</p>
          <div class="data-usage">
            <div class="usage-item">
              <span class="usage-label">Database Rows</span>
              <div class="usage-bar-wrap"><div class="usage-bar" id="usage-bar-rows" style="width: 1%"></div></div>
              <span class="usage-value" id="usage-rows">‚Äî / 100k</span>
            </div>
            <div class="usage-item">
              <span class="usage-label">Storage</span>
              <div class="usage-bar-wrap"><div class="usage-bar" id="usage-bar-storage" style="width: 1%"></div></div>
              <span class="usage-value" id="usage-storage">‚Äî / 500MB</span>
            </div>
            <div class="usage-item">
              <span class="usage-label">Auth Users</span>
              <div class="usage-bar-wrap"><div class="usage-bar" id="usage-bar-auth" style="width: 0%"></div></div>
              <span class="usage-value" id="usage-auth">‚Äî / 50k</span>
            </div>
          </div>
        </div>
        
        <!-- Site Stats -->
        <div class="card">
          <h2>üìà Site Statistics</h2>
          <div class="site-stats">
            <div class="site-stat">
              <span class="site-stat__label">Games</span>
              <span class="site-stat__value" id="stat-games">{{ site.games | where_exp: "g", "g.test_only != true" | size }}</span>
            </div>
            <div class="site-stat">
              <span class="site-stat__label">Runners</span>
              <span class="site-stat__value" id="stat-runners">‚Äî</span>
            </div>
            <div class="site-stat">
              <span class="site-stat__label">Runs</span>
              <span class="site-stat__value" id="stat-runs">{{ site.runs.size }}</span>
            </div>
            <div class="site-stat">
              <span class="site-stat__label">Achievements</span>
              <span class="site-stat__value" id="stat-achievements">{{ site.achievements.size }}</span>
            </div>
          </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="card">
          <h2>üïê Recent Activity</h2>
          <div class="activity-list" id="recent-activity">
            <p class="muted">Loading...</p>
          </div>
        </div>
      </div>
    </section>
    
    <!-- ============================================================
         SUBMISSION TESTERS TAB
         ============================================================ -->
    <section class="tab-panel" data-panel="simulators">
      <div class="sim-grid">
        <!-- Profile Simulator -->
        <div class="card">
          <h2>üßë Profile Submission Tester</h2>
          <p class="muted mb-3">Dry-run the profile creation workflow. No data is written.</p>
          <div class="sim-form">
            <div class="sim-row">
              <label class="sim-label">Display Name</label>
              <input type="text" id="sim-profile-name" class="sim-input" value="TestRunner123" />
            </div>
            <div class="sim-row">
              <label class="sim-label">Runner ID (slug)</label>
              <input type="text" id="sim-profile-id" class="sim-input" value="test-runner-123" />
            </div>
            <div class="sim-row">
              <label class="sim-label">Bio</label>
              <textarea id="sim-profile-bio" class="sim-input" rows="2">I like speedrunning!</textarea>
            </div>
            <button type="button" class="btn btn--primary mt-3" id="sim-profile-run">‚ñ∂ Run Simulation</button>
          </div>
          <div class="sim-log" id="sim-profile-log"></div>
        </div>
        
        <!-- Game Simulator -->
        <div class="card">
          <h2>üéÆ Game Submission Tester</h2>
          <p class="muted mb-3">Dry-run the game submission workflow.</p>
          <div class="sim-form">
            <div class="sim-row">
              <label class="sim-label">Game Name</label>
              <input type="text" id="sim-game-name" class="sim-input" value="Super Test Game" />
            </div>
            <div class="sim-row">
              <label class="sim-label">Game ID (slug)</label>
              <input type="text" id="sim-game-id" class="sim-input" value="super-test-game" />
            </div>
            <div class="sim-row">
              <label class="sim-label">Categories (comma-separated)</label>
              <input type="text" id="sim-game-categories" class="sim-input" value="Any%, 100%" />
            </div>
            <button type="button" class="btn btn--primary mt-3" id="sim-game-run">‚ñ∂ Run Simulation</button>
          </div>
          <div class="sim-log" id="sim-game-log"></div>
        </div>
        
        <!-- Run Simulator -->
        <div class="card">
          <h2>üèÉ Run Submission Tester</h2>
          <p class="muted mb-3">Dry-run the run submission workflow.</p>
          <div class="sim-form">
            <div class="sim-row">
              <label class="sim-label">Game</label>
              <select id="sim-run-game" class="sim-input">
                <option value="">Select a game...</option>
                {% for g in site.games %}
                  <option value="{{ g.game_id }}">{{ g.game_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="sim-row">
              <label class="sim-label">Runner ID</label>
              <input type="text" id="sim-run-runner" class="sim-input" value="test-runner" />
            </div>
            <div class="sim-row">
              <label class="sim-label">Video URL</label>
              <input type="url" id="sim-run-video" class="sim-input" value="https://youtube.com/watch?v=test123" />
            </div>
            <button type="button" class="btn btn--primary mt-3" id="sim-run-run">‚ñ∂ Run Simulation</button>
          </div>
          <div class="sim-log" id="sim-run-log"></div>
        </div>
      </div>
    </section>
    
  </div>
</div>

<style>
/* Header */
.debug-header { margin-bottom: 1.5rem; }
.debug-header h1 { margin-bottom: 0.25rem; }

/* Debug Banner */
.debug-banner {
  position: sticky;
  top: 0;
  z-index: 100;
  margin: -1rem -1rem 1.5rem -1rem;
  padding: 0 1rem;
}
.debug-banner__inner {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem 1.25rem;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: #000;
  border-radius: 0 0 12px 12px;
  flex-wrap: wrap;
  font-size: 0.9rem;
}
.debug-banner__icon { font-size: 1.2rem; }
.debug-banner__hint { font-size: 0.8rem; opacity: 0.8; }
.debug-banner__exit {
  margin-left: auto;
  background: rgba(0,0,0,0.15);
  border: 1px solid rgba(0,0,0,0.25);
  color: #000;
  font-weight: 600;
}

/* Tabs */
.debug-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  border-bottom: 1px solid var(--border);
  padding-bottom: 1rem;
}
.debug-tabs .tab {
  padding: 0.5rem 1rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.15s;
  color: var(--fg);
}
.debug-tabs .tab:hover { border-color: var(--accent); }
.debug-tabs .tab.active { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 500; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* Role Cards */
.role-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
.role-card {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1.25rem;
  background: var(--bg);
  border: 2px solid var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
}
.role-card:hover { border-color: var(--accent); transform: translateY(-1px); }
.role-card.active { border-color: var(--accent); background: rgba(var(--accent-rgb, 99, 102, 241), 0.08); }
.role-card.active::after {
  content: '‚óè ACTIVE';
  position: absolute;
  top: 8px;
  right: 12px;
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  color: var(--accent);
}
.role-card__icon { font-size: 1.75rem; flex-shrink: 0; margin-top: 2px; }
.role-card__name { font-weight: 700; font-size: 1.05rem; margin-bottom: 0.25rem; }
.role-card__desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.4; }
.role-card__badge { display: none; }

/* Permissions Table */
.permissions-table-wrap { overflow-x: auto; }
.permissions-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}
.permissions-table th, .permissions-table td {
  padding: 0.6rem 0.75rem;
  border-bottom: 1px solid var(--border);
  text-align: center;
}
.permissions-table th { font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.03em; color: var(--text-muted); }
.permissions-table th:first-child, .permissions-table td:first-child { text-align: left; }
.perm-yes { color: #10b981; }
.perm-no { color: var(--text-muted); opacity: 0.5; }

/* Session Info */
.session-grid { display: flex; flex-direction: column; }
.session-row { display: flex; justify-content: space-between; padding: 0.6rem 0; border-bottom: 1px solid var(--border); }
.session-row:last-child { border-bottom: none; }
.session-key { font-size: 0.9rem; color: var(--text-muted); }
.session-val { font-weight: 600; font-family: monospace; font-size: 0.85rem; }

/* System Health */
.system-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }

.status-list { display: flex; flex-direction: column; gap: 0.75rem; }
.status-item { display: flex; align-items: center; gap: 0.75rem; }
.status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--text-muted); flex-shrink: 0; }
.status-dot.ok { background: #10b981; }
.status-dot.warn { background: #f59e0b; }
.status-dot.error { background: #ef4444; }
.status-value { margin-left: auto; font-size: 0.85rem; color: var(--text-muted); }

.data-usage { display: flex; flex-direction: column; gap: 1rem; }
.usage-item { display: flex; align-items: center; gap: 0.75rem; }
.usage-label { width: 110px; font-size: 0.85rem; flex-shrink: 0; }
.usage-bar-wrap { flex: 1; height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; }
.usage-bar { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.3s; }
.usage-value { font-size: 0.8rem; color: var(--text-muted); min-width: 90px; text-align: right; }

.site-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
.site-stat { text-align: center; padding: 0.75rem; background: var(--bg); border-radius: 8px; }
.site-stat__label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
.site-stat__value { display: block; font-size: 1.25rem; font-weight: 600; }

.activity-list { max-height: 250px; overflow-y: auto; }
.activity-item { padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
.activity-item:last-child { border-bottom: none; }
.activity-time { float: right; font-size: 0.8rem; color: var(--text-muted); }

/* Simulators */
.sim-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
.sim-form { max-width: 500px; }
.sim-row { margin-bottom: 1rem; }
.sim-label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.25rem; }
.sim-input { width: 100%; padding: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--fg); font-size: 0.9rem; }
.sim-input:focus { border-color: var(--accent); outline: none; }
.sim-log { margin-top: 1.5rem; padding: 1rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 0.8rem; max-height: 250px; overflow-y: auto; }
.sim-log:empty { display: none; }

.mt-4 { margin-top: 1.5rem; }
.ml-2 { margin-left: 0.5rem; }
.btn--small { padding: 0.35rem 0.75rem; font-size: 0.85rem; }

@media (max-width: 640px) {
  .role-cards { grid-template-columns: 1fr; }
  .system-grid { grid-template-columns: 1fr; }
  .sim-grid { grid-template-columns: 1fr; }
  .debug-banner__inner { font-size: 0.85rem; }
}
</style>

<script type="module">
import { CRCAdmin } from '{{ "/assets/js/admin.js" | relative_url }}';
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

const authCheck = document.getElementById('auth-check');
const notAuthorized = document.getElementById('not-authorized');
const adminContent = document.getElementById('admin-content');

let supabase = null;

// Helpers
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
function log(el, msg, type = 'info') {
  const colors = { info: '#888', success: '#10b981', error: '#ef4444', warning: '#f59e0b' };
  el.innerHTML += `<div style="color:${colors[type]}">${msg}</div>`;
  el.scrollTop = el.scrollHeight;
}
function clearLog(el) { el.innerHTML = ''; }

// =========================================================================
// Init
// =========================================================================

(async function() {
  const role = await CRCAdmin.init();

  authCheck.hidden = true;

  // Only super admins can access debug tools
  if (!role || !CRCAdmin.isSuperAdmin()) {
    notAuthorized.hidden = false;
    return;
  }

  adminContent.hidden = false;
  supabase = CRCAuth.getSupabaseClient?.();

  setupTabs();
  setupRoleSimulation();
  setupSimulators();
  checkSystemStatus();
  loadRecentActivity();
})();

// =========================================================================
// Tabs
// =========================================================================

function setupTabs() {
  document.querySelectorAll('.debug-tabs .tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.debug-tabs .tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.querySelector(`[data-panel="${tab.dataset.tab}"]`)?.classList.add('active');
    });
  });
}

// =========================================================================
// Role Simulation
// =========================================================================

function setupRoleSimulation() {
  renderRoleState();

  // Role card clicks
  document.getElementById('role-cards').addEventListener('click', (e) => {
    const card = e.target.closest('.role-card');
    if (!card) return;
    const role = card.dataset.role;
    const currentDebug = CRCAdmin.getDebugRole();

    if (currentDebug === role) {
      // Clicking active role exits debug
      CRCAdmin.setDebugRole(null);
    } else if (role === 'super_admin') {
      // Clicking super_admin = exit debug (back to actual role)
      CRCAdmin.setDebugRole(null);
    } else {
      CRCAdmin.setDebugRole(role);
    }
    renderRoleState();
  });

  // Exit debug button
  document.getElementById('exit-debug-global')?.addEventListener('click', () => {
    CRCAdmin.setDebugRole(null);
    renderRoleState();
  });
}

function renderRoleState() {
  const actualRole = CRCAdmin.getRole();
  const debugRole = CRCAdmin.getDebugRole();
  const effectiveRole = CRCAdmin.getEffectiveRole();
  const isDebug = CRCAdmin.isDebugMode();

  // Banner
  const banner = document.getElementById('debug-banner');
  const bannerRole = document.getElementById('debug-banner-role');
  banner.hidden = !isDebug;
  if (isDebug) {
    const labels = { admin: 'üõ°Ô∏è Admin', verifier: '‚úÖ Verifier', user: 'üë§ User' };
    bannerRole.textContent = labels[debugRole] || debugRole;
  }

  // Role cards
  document.querySelectorAll('.role-card').forEach(card => {
    const role = card.dataset.role;
    const isActive = isDebug ? (role === debugRole) : (role === 'super_admin');
    card.classList.toggle('active', isActive);
  });

  // Session info
  document.getElementById('session-actual-role').textContent = CRCAdmin.roleLabel(actualRole);
  document.getElementById('session-effective-role').textContent = CRCAdmin.roleLabel(effectiveRole);
  document.getElementById('session-debug-mode').textContent = isDebug ? `On ‚Üí ${debugRole}` : 'Off';
  document.getElementById('session-runner-id').textContent = CRCAdmin.getProfile()?.runner_id || '‚Äî';
  document.getElementById('session-user-id').textContent = CRCAuth.getUser()?.id?.slice(0, 8) + '...' || '‚Äî';
}

// =========================================================================
// System Health
// =========================================================================

async function checkSystemStatus() {
  document.getElementById('status-timestamp').textContent = new Date().toLocaleTimeString();

  // Supabase
  if (supabase) {
    try {
      const start = Date.now();
      const { count } = await supabase.from('runner_profiles').select('id', { count: 'exact', head: true });
      const latency = Date.now() - start;
      document.getElementById('status-supabase').textContent = `Connected (${latency}ms)`;
      document.getElementById('status-dot-supabase').className = 'status-dot ok';

      // Update runner count
      document.getElementById('stat-runners').textContent = count || 0;

      // Usage bars
      if (count) {
        document.getElementById('usage-bar-rows').style.width = Math.max((count / 100000) * 100, 1) + '%';
        document.getElementById('usage-rows').textContent = `~${count} / 100k`;
        document.getElementById('usage-bar-auth').style.width = Math.max((count / 50000) * 100, 1) + '%';
        document.getElementById('usage-auth').textContent = `~${count} / 50k`;
      }
    } catch {
      document.getElementById('status-supabase').textContent = 'Error';
      document.getElementById('status-dot-supabase').className = 'status-dot error';
    }
  }

  // Auth
  document.getElementById('status-auth').textContent = CRCAuth.isSignedIn() ? 'Active' : 'Not signed in';
  document.getElementById('status-dot-auth').className = 'status-dot ' + (CRCAuth.isSignedIn() ? 'ok' : 'warn');

  // Worker
  const workerUrl = window.CRC_WORKER_URL || window.CRC_RUN_SUBMIT_ENDPOINT;
  if (workerUrl) {
    try {
      const start = Date.now();
      const res = await fetch(workerUrl, { method: 'OPTIONS' });
      const latency = Date.now() - start;
      document.getElementById('status-worker').textContent = `Reachable (${latency}ms)`;
      document.getElementById('status-dot-worker').className = 'status-dot ok';
    } catch {
      document.getElementById('status-worker').textContent = 'Unreachable';
      document.getElementById('status-dot-worker').className = 'status-dot error';
    }
  } else {
    document.getElementById('status-worker').textContent = 'Not configured';
    document.getElementById('status-dot-worker').className = 'status-dot warn';
  }
}

document.getElementById('refresh-status')?.addEventListener('click', checkSystemStatus);

// =========================================================================
// Recent Activity
// =========================================================================

async function loadRecentActivity() {
  const el = document.getElementById('recent-activity');
  if (!supabase) { el.innerHTML = '<p class="muted">Not connected</p>'; return; }

  try {
    const activities = [];

    const { data: profiles } = await supabase
      .from('runner_profiles')
      .select('runner_id, display_name, created_at')
      .order('created_at', { ascending: false })
      .limit(5);

    if (profiles) {
      profiles.forEach(p => activities.push({
        text: `üë§ Profile: ${p.display_name || p.runner_id}`,
        time: new Date(p.created_at)
      }));
    }

    const { data: pending } = await supabase
      .from('pending_profiles')
      .select('display_name, submitted_at, status')
      .order('submitted_at', { ascending: false })
      .limit(5);

    if (pending) {
      pending.forEach(p => {
        const icon = p.status === 'pending' ? '‚è≥' : p.status === 'approved' ? '‚úÖ' : '‚ùå';
        activities.push({
          text: `${icon} Submission: ${p.display_name}`,
          time: new Date(p.submitted_at)
        });
      });
    }

    activities.sort((a, b) => b.time - a.time);
    const recent = activities.slice(0, 8);

    if (recent.length === 0) {
      el.innerHTML = '<p class="muted">No recent activity</p>';
      return;
    }

    el.innerHTML = recent.map(a => {
      const ago = getTimeAgo(a.time);
      return `<div class="activity-item">${a.text} <span class="activity-time">${ago}</span></div>`;
    }).join('');
  } catch {
    el.innerHTML = '<p class="muted">Unable to load activity</p>';
  }
}

function getTimeAgo(date) {
  const s = Math.floor((new Date() - date) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s / 60) + ' min ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  if (s < 604800) return Math.floor(s / 86400) + 'd ago';
  return date.toLocaleDateString();
}

// =========================================================================
// Simulators
// =========================================================================

function setupSimulators() {
  // Profile sim
  document.getElementById('sim-profile-run')?.addEventListener('click', async () => {
    const logEl = document.getElementById('sim-profile-log');
    clearLog(logEl);
    const name = document.getElementById('sim-profile-name').value;
    const id = document.getElementById('sim-profile-id').value;

    log(logEl, 'üöÄ Starting profile simulation...', 'info');
    await sleep(300);

    if (!name || !id || !/^[a-z0-9-]+$/.test(id)) { log(logEl, '‚ùå Invalid inputs (name required, ID must be lowercase slug)', 'error'); return; }
    log(logEl, '‚úÖ Validation passed', 'success');
    await sleep(300);
    log(logEl, `‚úÖ "${id}" would be checked for availability`, 'success');
    await sleep(200);
    log(logEl, `üìÑ Would create: pending_profiles row + _runners/${id}.md on approve`, 'info');
    log(logEl, '‚îÄ'.repeat(35), 'info');
    log(logEl, 'üéâ SIMULATION COMPLETE (no data written)', 'success');
  });

  // Game sim
  document.getElementById('sim-game-run')?.addEventListener('click', async () => {
    const logEl = document.getElementById('sim-game-log');
    clearLog(logEl);
    const name = document.getElementById('sim-game-name').value;
    const id = document.getElementById('sim-game-id').value;
    const cats = document.getElementById('sim-game-categories').value.split(',').map(c => c.trim()).filter(Boolean);

    log(logEl, 'üöÄ Starting game simulation...', 'info');
    await sleep(300);

    if (!name || !id || !/^[a-z0-9-]+$/.test(id)) { log(logEl, '‚ùå Invalid inputs', 'error'); return; }
    log(logEl, '‚úÖ Validation passed', 'success');
    await sleep(300);
    log(logEl, `‚úÖ Categories: ${cats.join(', ')}`, 'success');
    log(logEl, `üìÑ Would create: pending_games row + _games/${id}.md on approve`, 'info');
    cats.forEach(c => log(logEl, `üìÅ Would generate: /games/${id}/runs/full-runs/${c.toLowerCase().replace(/\s+/g, '-')}/`, 'info'));
    log(logEl, '‚îÄ'.repeat(35), 'info');
    log(logEl, 'üéâ SIMULATION COMPLETE (no data written)', 'success');
  });

  // Run sim
  document.getElementById('sim-run-run')?.addEventListener('click', async () => {
    const logEl = document.getElementById('sim-run-log');
    clearLog(logEl);
    const game = document.getElementById('sim-run-game').value;
    const runner = document.getElementById('sim-run-runner').value;
    const video = document.getElementById('sim-run-video').value;

    log(logEl, 'üöÄ Starting run simulation...', 'info');
    await sleep(300);

    if (!game || !runner || !video) { log(logEl, '‚ùå Missing required fields', 'error'); return; }
    log(logEl, '‚úÖ All fields present', 'success');
    await sleep(300);

    try {
      const u = new URL(video);
      const hosts = ['youtube.com', 'youtu.be', 'twitch.tv'];
      if (!hosts.some(h => u.hostname.includes(h))) log(logEl, '‚ö†Ô∏è Unknown video host', 'warning');
      else log(logEl, '‚úÖ Video URL valid', 'success');
    } catch { log(logEl, '‚ùå Invalid URL', 'error'); return; }

    const date = new Date().toISOString().split('T')[0];
    log(logEl, `üìÑ Would create: pending_runs row + _runs/${game}/${date}__${game}__${runner}__category__01.md on approve`, 'info');
    log(logEl, '‚îÄ'.repeat(35), 'info');
    log(logEl, 'üéâ SIMULATION COMPLETE (no data written)', 'success');
  });
}
</script>

{% if site.run_submit_endpoint %}
<script>
  window.CRC_WORKER_URL = {{ site.run_submit_endpoint | jsonify }};
</script>
{% endif %}
