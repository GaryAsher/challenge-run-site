---
layout: default
title: "Dashboard - Pending Profiles"
---

<div class="page-width">
  <div class="admin-page">
    <!-- Loading -->
    <div id="loading-state" class="card">
      <div class="admin-loading">
        <div class="spinner"></div>
        <p class="muted">Verifying access...</p>
      </div>
    </div>

    <!-- Not authorized -->
    <div id="not-authorized" class="card" hidden>
      <h2>ğŸ”’ Access Denied</h2>
      <p class="muted">This page requires administrator privileges.</p>
      <a href="/" class="btn">Go Home</a>
    </div>

    <!-- Admin content -->
    <div id="admin-content" hidden>
      <p class="muted mb-3"><a href="/admin/">â† Back to Dashboard</a></p>

      <div class="admin-header">
        <div>
          <h1>ğŸ‘¥ Pending Profiles</h1>
          <p class="muted">Review and approve runner profile submissions.</p>
        </div>
        <div class="admin-header__role" id="role-badge"></div>
      </div>

      <!-- Stats -->
      <div class="mod-stats card">
        <div class="mod-stats__item">
          <span class="mod-stats__value" id="pending-count">â€”</span>
          <span class="mod-stats__label">Pending</span>
        </div>
        <div class="mod-stats__item">
          <span class="mod-stats__value" id="approved-count">â€”</span>
          <span class="mod-stats__label">Total Runners</span>
        </div>
      </div>

      <!-- Filter tabs -->
      <div class="filter-bar">
        <div class="filter-tabs">
          <button class="filter-tab active" data-status="pending">Pending</button>
          <button class="filter-tab" data-status="approved">Approved</button>
          <button class="filter-tab" data-status="rejected">Rejected</button>
          <button class="filter-tab" data-status="all">All</button>
        </div>
        <button type="button" class="btn btn--small" id="refresh-btn">ğŸ”„ Refresh</button>
      </div>

      <!-- Queue -->
      <div id="queue-list"></div>
      <div id="queue-empty" class="card" hidden>
        <p style="text-align:center;padding:2rem">ğŸ‰ No pending profiles!</p>
      </div>

      <!-- Review Modal -->
      <div id="review-modal" class="modal" hidden>
        <div class="modal__backdrop"></div>
        <div class="modal__content">
          <div class="modal__header">
            <h2 id="modal-title">Review Profile</h2>
            <button type="button" class="modal__close">&times;</button>
          </div>
          <div class="modal__body" id="review-body"></div>
          <div class="modal__footer">
            <div class="modal__reject-section" id="reject-section" hidden>
              <label class="modal__label">Rejection Reason:</label>
              <textarea id="reject-reason" class="modal__textarea" placeholder="Why is this profile being rejected?"></textarea>
            </div>
            <div class="modal__actions">
              <button class="btn btn--success" id="modal-approve-btn">âœ“ Approve</button>
              <button class="btn btn--danger" id="modal-reject-btn">âœ— Reject</button>
              <button class="btn" id="modal-cancel-btn">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.admin-page { max-width: 900px; margin: 0 auto; }
.admin-loading { text-align: center; padding: 3rem; }
.admin-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
.admin-header__role { font-size: 0.85rem; padding: 4px 10px; border-radius: 6px; background: var(--surface); border: 1px solid var(--border); white-space: nowrap; }

/* Stats */
.mod-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; text-align: center; margin-bottom: 1.5rem; }
.mod-stats__value { display: block; font-size: 2rem; font-weight: bold; color: var(--accent); }
.mod-stats__label { font-size: 0.875rem; color: var(--text-muted); }

/* Filter bar */
.filter-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 0.75rem; }
.filter-tabs { display: flex; gap: 0.25rem; }
.filter-tab { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 0.4rem 0.85rem; font-size: 0.85rem; cursor: pointer; color: var(--fg); transition: all 0.2s; }
.filter-tab:hover { border-color: var(--accent); }
.filter-tab.active { background: var(--accent); color: white; border-color: var(--accent); }

/* Profile cards */
.mod-card { border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; background: var(--surface); transition: opacity 0.3s, transform 0.3s; }
.mod-card.fade-out { opacity: 0; transform: translateX(40px); }
.mod-card__header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.75rem; }
.mod-card__user { display: flex; align-items: center; gap: 0.75rem; }
.mod-card__avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background: var(--bg); }
.mod-card__name { font-weight: 600; margin: 0; }
.mod-card__id { font-size: 0.875rem; color: var(--text-muted); margin: 0; }
.mod-card__date { font-size: 0.8rem; color: var(--text-muted); }
.mod-card__bio { margin: 0.75rem 0; padding: 0.75rem; background: var(--bg); border-radius: 8px; font-size: 0.9rem; }
.mod-card__socials { display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 0.75rem 0; }
.mod-card__social-tag { font-size: 0.8rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 2px 8px; }
.mod-card__details { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem; padding: 0.75rem; background: var(--bg); border-radius: 8px; margin: 0.75rem 0; font-size: 0.85rem; }
.mod-card__detail-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }
.mod-card__actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
.mod-card__status { margin-left: auto; }

/* Buttons */
.btn--small { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
.btn--success { background: #28a745; color: white; border-color: #28a745; }
.btn--success:hover { background: #218838; }
.btn--danger { background: #dc3545; color: white; border-color: #dc3545; }
.btn--danger:hover { background: #c82333; }
.btn--outline-danger { background: transparent; border: 1px solid #dc3545; color: #dc3545; }
.btn--outline-danger:hover { background: #dc3545; color: white; }

/* Modal */
.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal[hidden] { display: none; }
.modal__backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.6); }
.modal__content { position: relative; background: var(--surface); border-radius: 12px; width: 90%; max-width: 520px; max-height: 90vh; overflow: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
.modal__header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); }
.modal__header h2 { margin: 0; font-size: 1.1rem; }
.modal__close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.25rem; line-height: 1; }
.modal__body { padding: 1.25rem; }
.modal__footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border); }
.modal__reject-section { margin-bottom: 1rem; }
.modal__label { display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem; }
.modal__textarea { width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--fg); min-height: 80px; resize: vertical; box-sizing: border-box; }
.modal__actions { display: flex; gap: 0.5rem; justify-content: flex-end; flex-wrap: wrap; }

@media (max-width: 600px) {
  .mod-stats { grid-template-columns: 1fr; }
  .mod-card__header { flex-direction: column; }
  .filter-tabs { overflow-x: auto; }
}
</style>

<script type="module">
import { CRCAdmin } from '{{ "/assets/js/admin.js" | relative_url }}';

const loadingState = document.getElementById('loading-state');
const notAuthorized = document.getElementById('not-authorized');
const adminContent = document.getElementById('admin-content');

let currentFilter = 'pending';
let profiles = [];
let currentReviewId = null;

function showState(state) {
  loadingState.hidden = state !== 'loading';
  notAuthorized.hidden = state !== 'denied';
  adminContent.hidden = state !== 'admin';
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// â”€â”€â”€ Load Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadQueue() {
  const queueList = document.getElementById('queue-list');
  const queueEmpty = document.getElementById('queue-empty');
  queueList.innerHTML = '<p class="muted" style="text-align:center;padding:2rem">Loading...</p>';

  const { data, count, error } = await CRCAdmin.getPendingProfiles({ status: currentFilter });

  if (error) {
    queueList.innerHTML = `<p class="muted" style="text-align:center;padding:2rem">Error: ${esc(error)}</p>`;
    return;
  }

  profiles = data || [];

  // Update pending count
  if (currentFilter === 'pending') {
    document.getElementById('pending-count').textContent = count || 0;
  }

  if (profiles.length === 0) {
    queueList.innerHTML = '';
    queueList.hidden = true;
    queueEmpty.hidden = false;
  } else {
    queueList.hidden = false;
    queueEmpty.hidden = true;
    queueList.innerHTML = profiles.map(renderCard).join('');
  }
}

function renderCard(p) {
  const socials = p.socials && typeof p.socials === 'object' ? Object.entries(p.socials) : [];
  const socialTags = socials
    .filter(([, v]) => v)
    .map(([k]) => `<span class="mod-card__social-tag">${esc(k)}</span>`)
    .join('');

  const statusHtml = p.status !== 'pending' ? `<div class="mod-card__status">${CRCAdmin.statusBadge(p.status)}</div>` : '';

  return `
    <div class="mod-card" data-id="${p.id}">
      <div class="mod-card__header">
        <div class="mod-card__user">
          <img class="mod-card__avatar" src="${esc(p.avatar_url || '/assets/img/site/default-runner.png')}" alt="" onerror="this.src='/assets/img/site/default-runner.png'" />
          <div>
            <p class="mod-card__name">${esc(p.display_name)}</p>
            <p class="mod-card__id">@${esc(p.requested_runner_id)}</p>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem">
          ${statusHtml}
          <span class="mod-card__date">${CRCAdmin.formatTimestamp(p.submitted_at || p.created_at)}</span>
        </div>
      </div>
      ${p.bio ? `<div class="mod-card__bio">${esc(p.bio)}</div>` : ''}
      ${socialTags ? `<div class="mod-card__socials">${socialTags}</div>` : ''}
      <div class="mod-card__details">
        ${p.pronouns ? `<div><span class="mod-card__detail-label">Pronouns</span><div>${esc(p.pronouns)}</div></div>` : ''}
        ${p.location ? `<div><span class="mod-card__detail-label">Location</span><div>${esc(p.location)}</div></div>` : ''}
        ${p.games?.length ? `<div><span class="mod-card__detail-label">Games</span><div>${esc(p.games.join(', '))}</div></div>` : ''}
      </div>
      ${p.status === 'rejected' && p.rejection_reason ? `<div class="mod-card__bio" style="border-left:3px solid #dc3545"><strong>Rejection reason:</strong> ${esc(p.rejection_reason)}</div>` : ''}
      ${p.status === 'pending' ? `
        <div class="mod-card__actions">
          <button class="btn btn--small btn--success" data-action="approve" data-id="${p.id}">âœ“ Approve</button>
          <button class="btn btn--small" data-action="review" data-id="${p.id}">ğŸ‘ Review</button>
          <button class="btn btn--small btn--outline-danger" data-action="reject-quick" data-id="${p.id}">âœ— Reject</button>
        </div>
      ` : ''}
    </div>
  `;
}

// â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function handleApprove(id) {
  if (!confirm('Approve this profile? It will be published to the site.')) return;
  const card = document.querySelector(`.mod-card[data-id="${id}"]`);

  const { error } = await CRCAdmin.approveProfile(id);
  if (error) {
    alert('Error: ' + error);
    return;
  }

  if (card) {
    card.classList.add('fade-out');
    setTimeout(() => { card.remove(); updatePendingCount(-1); }, 300);
  } else {
    await loadQueue();
  }
}

function openReviewModal(id) {
  const p = profiles.find(x => x.id === id);
  if (!p) return;
  currentReviewId = id;

  const socials = p.socials && typeof p.socials === 'object' ? Object.entries(p.socials) : [];
  const socialHtml = socials
    .filter(([, v]) => v)
    .map(([k, v]) => `<div><span class="mod-card__detail-label">${esc(k)}</span><div><a href="${esc(v)}" target="_blank" rel="noopener">${esc(v)}</a></div></div>`)
    .join('');

  document.getElementById('review-body').innerHTML = `
    <div class="mod-card__user" style="margin-bottom:1rem">
      <img class="mod-card__avatar" src="${esc(p.avatar_url || '/assets/img/site/default-runner.png')}" alt="" onerror="this.src='/assets/img/site/default-runner.png'" />
      <div>
        <p class="mod-card__name">${esc(p.display_name)}</p>
        <p class="mod-card__id">@${esc(p.requested_runner_id)}</p>
      </div>
    </div>
    ${p.bio ? `<div class="mod-card__bio">${esc(p.bio)}</div>` : ''}
    <div class="mod-card__details">
      ${p.pronouns ? `<div><span class="mod-card__detail-label">Pronouns</span><div>${esc(p.pronouns)}</div></div>` : ''}
      ${p.location ? `<div><span class="mod-card__detail-label">Location</span><div>${esc(p.location)}</div></div>` : ''}
      ${p.games?.length ? `<div><span class="mod-card__detail-label">Games</span><div>${esc(p.games.join(', '))}</div></div>` : ''}
      ${socialHtml}
    </div>
  `;

  document.getElementById('reject-section').hidden = true;
  document.getElementById('reject-reason').value = '';
  document.getElementById('review-modal').hidden = false;
}

function closeModal() {
  document.getElementById('review-modal').hidden = true;
  currentReviewId = null;
}

async function handleModalApprove() {
  if (!currentReviewId) return;
  await handleApprove(currentReviewId);
  closeModal();
}

async function handleModalReject() {
  const sec = document.getElementById('reject-section');
  const reason = document.getElementById('reject-reason');

  // First click: show reason input
  if (sec.hidden) {
    sec.hidden = false;
    reason.focus();
    return;
  }

  // Second click: submit
  if (!currentReviewId) return;
  const { error } = await CRCAdmin.rejectProfile(currentReviewId, reason.value || '');
  if (error) {
    alert('Error: ' + error);
    return;
  }

  const card = document.querySelector(`.mod-card[data-id="${currentReviewId}"]`);
  closeModal();
  if (card) {
    card.classList.add('fade-out');
    setTimeout(() => { card.remove(); updatePendingCount(-1); }, 300);
  } else {
    await loadQueue();
  }
}

async function handleQuickReject(id) {
  currentReviewId = id;
  openReviewModal(id);
  // Jump straight to reject mode
  document.getElementById('reject-section').hidden = false;
  document.getElementById('reject-reason').focus();
}

function updatePendingCount(delta) {
  const el = document.getElementById('pending-count');
  const current = parseInt(el.textContent) || 0;
  el.textContent = Math.max(0, current + delta);
}

// â”€â”€â”€ Event Delegation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;

  const action = btn.dataset.action;
  const id = btn.dataset.id;

  switch (action) {
    case 'approve': handleApprove(id); break;
    case 'review': openReviewModal(id); break;
    case 'reject-quick': handleQuickReject(id); break;
  }
});

// Filter tabs
document.querySelectorAll('.filter-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentFilter = tab.dataset.status;
    loadQueue();
  });
});

// Modal controls
document.querySelector('.modal__backdrop')?.addEventListener('click', closeModal);
document.querySelector('.modal__close')?.addEventListener('click', closeModal);
document.getElementById('modal-cancel-btn')?.addEventListener('click', closeModal);
document.getElementById('modal-approve-btn')?.addEventListener('click', handleModalApprove);
document.getElementById('modal-reject-btn')?.addEventListener('click', handleModalReject);
document.getElementById('refresh-btn')?.addEventListener('click', loadQueue);

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

(async function() {
  showState('loading');

  const role = await CRCAdmin.init();

  if (!role || !CRCAdmin.isAdmin()) {
    showState('denied');
    return;
  }

  document.getElementById('role-badge').textContent = CRCAdmin.roleLabel(role);
  showState('admin');

  // Load counts
  const counts = await CRCAdmin.getCounts();
  document.getElementById('pending-count').textContent = counts.pendingProfiles ?? 'â€”';
  document.getElementById('approved-count').textContent = counts.totalRunners ?? 'â€”';

  await loadQueue();
})();
</script>
