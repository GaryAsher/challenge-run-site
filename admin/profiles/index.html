---
layout: default
title: "Dashboard - Pending Profiles"
---

<div class="page-width">
  <div class="profiles-admin">
    <!-- Loading -->
    <div id="loading-state" class="card">
      <div class="profiles-loading">
        <div class="spinner"></div>
        <p class="muted">Checking access...</p>
      </div>
    </div>

    <!-- Not authorized -->
    <div id="not-authorized" class="card" hidden>
      <h2>üîí Access Denied</h2>
      <p class="muted">You need admin privileges to review profiles.</p>
      <a href="/" class="btn btn--primary">Go Home</a>
    </div>

    <!-- Main content -->
    <div id="profiles-content" hidden>
      <p class="muted mb-2"><a href="/admin/">‚Üê Dashboard</a></p>

      <div class="profiles-header">
        <h1>üë• Pending Profiles</h1>
        <p class="muted" id="profiles-role-info"></p>
      </div>

      <!-- Filters -->
      <div class="profiles-filters card">
        <div class="profiles-filters__row">
          <div class="profiles-filters__tabs" id="status-tabs">
            <button class="filter-tab active" data-status="pending" type="button">
              Pending <span class="filter-tab__count" id="count-pending">0</span>
            </button>
            <button class="filter-tab" data-status="approved" type="button">Approved</button>
            <button class="filter-tab" data-status="rejected" type="button">Rejected</button>
            <button class="filter-tab" data-status="needs_changes" type="button">Needs Changes</button>
            <button class="filter-tab" data-status="all" type="button">All</button>
          </div>
          <div class="profiles-filters__controls">
            <button class="btn btn--sm" id="refresh-btn" type="button" title="Refresh">‚Üª Refresh</button>
          </div>
        </div>
      </div>

      <!-- Profiles list -->
      <div id="profiles-list"></div>

      <!-- Empty state -->
      <div id="profiles-empty" class="profiles-empty card" hidden>
        <p>No profiles found matching your filters.</p>
        <p class="muted">New profile registrations will appear here for review.</p>
      </div>
    </div>

    <!-- Rejection modal -->
    <div id="reject-modal" class="modal" hidden>
      <div class="modal__backdrop" data-close></div>
      <div class="modal__content card">
        <h3>Reject Profile</h3>
        <p class="muted mb-2" id="reject-modal-info"></p>
        <div class="form-field">
          <label for="reject-reason">Reason <span class="required">*</span></label>
          <select id="reject-reason" class="filter-select">
            <option value="">Select a reason...</option>
            <option value="inappropriate_name">Inappropriate display name or runner ID</option>
            <option value="duplicate_account">Duplicate account</option>
            <option value="inappropriate_content">Inappropriate bio or content</option>
            <option value="suspicious_account">Suspicious account activity</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-field">
          <label for="reject-notes">Notes (optional)</label>
          <textarea id="reject-notes" rows="3" placeholder="Additional details for the user..."></textarea>
        </div>
        <div class="modal__actions">
          <button class="btn btn--reject" id="reject-confirm-btn" type="button" disabled>Reject Profile</button>
          <button class="btn btn--secondary" data-close type="button">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Request changes modal -->
    <div id="changes-modal" class="modal" hidden>
      <div class="modal__backdrop" data-close></div>
      <div class="modal__content card">
        <h3>Request Changes</h3>
        <p class="muted mb-2" id="changes-modal-info"></p>
        <div class="form-field">
          <label for="changes-notes">What needs to be changed? <span class="required">*</span></label>
          <textarea id="changes-notes" rows="4" placeholder="Describe what the user needs to fix..."></textarea>
        </div>
        <div class="modal__actions">
          <button class="btn btn--changes" id="changes-confirm-btn" type="button" disabled>Send Request</button>
          <button class="btn btn--secondary" data-close type="button">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.profiles-admin { max-width: 960px; margin: 0 auto; }
.profiles-loading { text-align: center; padding: 3rem; }

.profiles-header { margin-bottom: 1.5rem; }
.profiles-header h1 { margin: 0; }

/* Filters */
.profiles-filters { padding: 1rem; margin-bottom: 1.5rem; }
.profiles-filters__row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.75rem;
}
.profiles-filters__tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 0.25rem;
}
.filter-tab {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 0.4rem 0.75rem;
  font-size: 0.85rem;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
}
.filter-tab:hover { border-color: var(--fg); color: var(--fg); }
.filter-tab.active {
  background: var(--accent, #6366f1);
  color: white;
  border-color: var(--accent, #6366f1);
}
.filter-tab__count {
  display: inline-block;
  background: rgba(255,255,255,0.25);
  padding: 0 6px;
  border-radius: 10px;
  font-size: 0.75rem;
  margin-left: 4px;
  font-weight: 700;
}
.profiles-filters__controls {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

/* Profile cards */
.profile-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 1rem;
  overflow: hidden;
}
.profile-card__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.25rem;
  cursor: pointer;
  transition: background 0.1s;
  flex-wrap: wrap;
  gap: 0.75rem;
}
.profile-card__header:hover { background: rgba(255,255,255,0.02); }
.profile-card__user {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.profile-card__avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  object-fit: cover;
  background: var(--bg);
}
.profile-card__name { font-weight: 700; font-size: 1.05rem; }
.profile-card__id { font-size: 0.85rem; color: var(--text-muted); }
.profile-card__meta {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 0.85rem;
  color: var(--text-muted);
}

/* Expandable details */
.profile-card__body {
  display: none;
  border-top: 1px solid var(--border);
  padding: 1.25rem;
}
.profile-card.expanded .profile-card__body { display: block; }

.profile-details {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1rem;
  margin-bottom: 1.25rem;
}
.profile-detail {
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
}
.profile-detail__label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
}
.profile-detail__value {
  font-weight: 500;
  word-break: break-word;
}

.profile-bio {
  padding: 0.75rem;
  background: var(--bg);
  border-radius: 8px;
  font-size: 0.9rem;
  margin-bottom: 1.25rem;
  white-space: pre-line;
}

.profile-socials {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-bottom: 1.25rem;
}
.profile-social-tag {
  font-size: 0.8rem;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 3px 10px;
}
.profile-social-tag a { color: var(--accent, #6366f1); text-decoration: none; }
.profile-social-tag a:hover { text-decoration: underline; }

/* Action buttons */
.profile-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}
.btn--approve {
  background: #28a745; color: white; border: none;
  padding: 0.5rem 1.25rem; border-radius: 6px; font-weight: 600; cursor: pointer;
}
.btn--approve:hover { background: #218838; }
.btn--approve:disabled { opacity: 0.5; cursor: not-allowed; }

.btn--reject {
  background: transparent; border: 1px solid #dc3545; color: #dc3545;
  padding: 0.5rem 1.25rem; border-radius: 6px; font-weight: 600; cursor: pointer;
}
.btn--reject:hover { background: #dc3545; color: white; }
.btn--reject:disabled { opacity: 0.5; }

.btn--changes {
  background: transparent; border: 1px solid #17a2b8; color: #17a2b8;
  padding: 0.5rem 1.25rem; border-radius: 6px; font-weight: 600; cursor: pointer;
}
.btn--changes:hover { background: #17a2b8; color: white; }
.btn--changes:disabled { opacity: 0.5; }

.btn--secondary {
  background: var(--surface); border: 1px solid var(--border); color: var(--fg);
  padding: 0.5rem 1.25rem; border-radius: 6px; cursor: pointer;
}
.btn--sm { padding: 0.35rem 0.75rem; font-size: 0.85rem; }

/* Status bar */
.profile-status-bar {
  padding: 0.75rem 1rem;
  border-top: 1px solid var(--border);
  font-size: 0.85rem;
  color: var(--text-muted);
  background: rgba(255,255,255,0.02);
}

/* Empty state */
.profiles-empty {
  text-align: center;
  padding: 3rem 2rem;
  color: var(--text-muted);
}

/* Modal */
.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal[hidden] { display: none; }
.modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.6); }
.modal__content { position: relative; width: 90%; max-width: 500px; max-height: 90vh; overflow: auto; padding: 1.5rem; }
.modal__content h3 { margin: 0 0 0.75rem 0; }
.modal__actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
.form-field { margin-bottom: 1rem; }
.form-field label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 0.35rem; }
.form-field textarea, .form-field select {
  width: 100%; padding: 0.5rem 0.6rem;
  background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
  color: var(--fg); font-size: 0.9rem;
}
.filter-select {
  background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
  padding: 0.4rem 0.6rem; font-size: 0.85rem; color: var(--fg);
}
.required { color: #dc3545; }

@media (max-width: 640px) {
  .profiles-filters__row { flex-direction: column; align-items: stretch; }
  .profiles-filters__tabs { overflow-x: auto; flex-wrap: nowrap; }
  .profile-details { grid-template-columns: 1fr 1fr; }
}
</style>

{% if site.run_submit_endpoint %}
<script>
  window.CRC_WORKER_URL = {{ site.run_submit_endpoint | jsonify }};
</script>
{% endif %}

<script type="module">
import { CRCAdmin } from '{{ "/assets/js/admin.js" | relative_url }}';

// =============================================================================
// State
// =============================================================================

let currentStatus = 'pending';
let allProfiles = [];
let currentRejectId = null;
let currentChangesId = null;

// =============================================================================
// DOM refs
// =============================================================================

const loadingEl = document.getElementById('loading-state');
const deniedEl = document.getElementById('not-authorized');
const contentEl = document.getElementById('profiles-content');
const profilesListEl = document.getElementById('profiles-list');
const profilesEmptyEl = document.getElementById('profiles-empty');
const statusTabsEl = document.getElementById('status-tabs');
const refreshBtn = document.getElementById('refresh-btn');
const pendingCountEl = document.getElementById('count-pending');

// Reject modal
const rejectModal = document.getElementById('reject-modal');
const rejectReasonEl = document.getElementById('reject-reason');
const rejectNotesEl = document.getElementById('reject-notes');
const rejectConfirmBtn = document.getElementById('reject-confirm-btn');
const rejectInfoEl = document.getElementById('reject-modal-info');

// Changes modal
const changesModal = document.getElementById('changes-modal');
const changesNotesEl = document.getElementById('changes-notes');
const changesConfirmBtn = document.getElementById('changes-confirm-btn');
const changesInfoEl = document.getElementById('changes-modal-info');

// =============================================================================
// Init
// =============================================================================

(async function() {
  const role = await CRCAdmin.init();

  if (!role || !CRCAdmin.isAdmin()) {
    showState('denied');
    return;
  }

  showState('ready');

  document.getElementById('profiles-role-info').textContent =
    `${CRCAdmin.roleLabel(role)} ‚Äî reviewing all profiles`;

  await loadProfiles();
  setupEventListeners();
})();

// =============================================================================
// State management
// =============================================================================

function showState(s) {
  loadingEl.hidden = s !== 'loading';
  deniedEl.hidden = s !== 'denied';
  contentEl.hidden = s !== 'ready';
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// =============================================================================
// Load profiles
// =============================================================================

async function loadProfiles() {
  profilesListEl.innerHTML = '<div class="profiles-loading"><div class="spinner"></div><p class="muted">Loading profiles...</p></div>';
  profilesEmptyEl.hidden = true;

  const result = await CRCAdmin.getPendingProfiles({ status: currentStatus });

  if (result.error) {
    profilesListEl.innerHTML = `<div class="card"><p class="muted">Error loading profiles: ${esc(result.error)}</p></div>`;
    return;
  }

  allProfiles = result.data;

  if (currentStatus === 'pending') {
    pendingCountEl.textContent = result.count;
  } else {
    const pending = await CRCAdmin.getPendingProfiles({ status: 'pending' });
    pendingCountEl.textContent = pending.count;
  }

  renderProfiles();
}

function renderProfiles() {
  if (allProfiles.length === 0) {
    profilesListEl.innerHTML = '';
    profilesEmptyEl.hidden = false;
    return;
  }

  profilesEmptyEl.hidden = true;
  profilesListEl.innerHTML = allProfiles.map(renderProfileCard).join('');
}

// =============================================================================
// Render a profile card
// =============================================================================

function renderProfileCard(p) {
  const isPending = p.status === 'pending';
  const isNeedsChanges = p.status === 'needs_changes';
  const canAct = isPending || isNeedsChanges;

  // Details grid
  const details = [];
  details.push({ label: 'Runner ID', value: `@${esc(p.requested_runner_id)}` });
  if (p.pronouns) details.push({ label: 'Pronouns', value: esc(p.pronouns) });
  if (p.location) details.push({ label: 'Location', value: esc(p.location) });
  if (p.games?.length) details.push({ label: 'Games', value: esc(p.games.join(', ')) });
  details.push({ label: 'Submitted', value: CRCAdmin.formatTimestamp(p.submitted_at || p.created_at) });

  const detailsHTML = details.map(d =>
    `<div class="profile-detail">
      <span class="profile-detail__label">${d.label}</span>
      <span class="profile-detail__value">${d.value}</span>
    </div>`
  ).join('');

  // Bio
  const bioHTML = p.bio ? `<div class="profile-bio">${esc(p.bio)}</div>` : '';

  // Socials
  const socials = p.socials && typeof p.socials === 'object' ? Object.entries(p.socials) : [];
  const socialsHTML = socials.filter(([, v]) => v).length > 0
    ? `<div class="profile-socials">
        ${socials.filter(([, v]) => v).map(([k, v]) =>
          `<span class="profile-social-tag"><a href="${esc(v)}" target="_blank" rel="noopener">${esc(k)}</a></span>`
        ).join('')}
      </div>`
    : '';

  // Actions
  let actionsHTML = '';
  if (canAct) {
    actionsHTML = `
      <div class="profile-actions">
        <button class="btn--approve" data-action="approve" data-id="${p.id}" type="button">‚úÖ Approve</button>
        <button class="btn--changes" data-action="changes" data-id="${p.id}" type="button">‚úèÔ∏è Request Changes</button>
        <button class="btn--reject" data-action="reject" data-id="${p.id}" type="button">‚ùå Reject</button>
      </div>`;
  }

  // Status bar for non-pending
  let statusBarHTML = '';
  if (!isPending) {
    let statusInfo = `Status: ${p.status}`;
    if (p.reviewed_at) statusInfo += ` on ${CRCAdmin.formatDate(p.reviewed_at)}`;
    if (p.rejection_reason) statusInfo += ` ‚Äî Reason: ${p.rejection_reason}`;
    if (p.reviewer_notes) statusInfo += ` ‚Äî Notes: ${p.reviewer_notes}`;
    statusBarHTML = `<div class="profile-status-bar">${statusInfo}</div>`;
  }

  return `
    <div class="profile-card" data-profile-id="${p.id}">
      <div class="profile-card__header" data-toggle="${p.id}">
        <div class="profile-card__user">
          <img class="profile-card__avatar" src="${esc(p.avatar_url || '/assets/img/site/default-runner.png')}" alt="" onerror="this.src='/assets/img/site/default-runner.png'" />
          <div>
            <div class="profile-card__name">${esc(p.display_name)}</div>
            <div class="profile-card__id">@${esc(p.requested_runner_id)}</div>
          </div>
        </div>
        <div class="profile-card__meta">
          ${CRCAdmin.statusBadge(p.status)}
          <span>${CRCAdmin.formatDate(p.submitted_at || p.created_at)}</span>
        </div>
      </div>
      <div class="profile-card__body">
        <div class="profile-details">${detailsHTML}</div>
        ${bioHTML}
        ${socialsHTML}
        ${actionsHTML}
        ${statusBarHTML}
      </div>
    </div>`;
}

// =============================================================================
// Event listeners
// =============================================================================

function setupEventListeners() {
  // Status tabs
  statusTabsEl.addEventListener('click', (e) => {
    const tab = e.target.closest('.filter-tab');
    if (!tab) return;
    statusTabsEl.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentStatus = tab.dataset.status;
    loadProfiles();
  });

  // Refresh
  refreshBtn.addEventListener('click', () => loadProfiles());

  // Card toggle + action buttons
  profilesListEl.addEventListener('click', (e) => {
    const toggle = e.target.closest('[data-toggle]');
    if (toggle) {
      toggle.closest('.profile-card').classList.toggle('expanded');
      return;
    }

    const actionBtn = e.target.closest('[data-action]');
    if (!actionBtn) return;

    const action = actionBtn.dataset.action;
    const profileId = actionBtn.dataset.id;
    const profile = allProfiles.find(p => p.id === profileId);
    if (!profile) return;

    if (action === 'approve') handleApprove(profile, actionBtn);
    if (action === 'reject') openRejectModal(profile);
    if (action === 'changes') openChangesModal(profile);
  });

  // Modal close buttons
  document.querySelectorAll('[data-close]').forEach(el => {
    el.addEventListener('click', () => {
      rejectModal.hidden = true;
      changesModal.hidden = true;
    });
  });

  rejectReasonEl.addEventListener('change', () => {
    rejectConfirmBtn.disabled = !rejectReasonEl.value;
  });
  rejectConfirmBtn.addEventListener('click', handleRejectConfirm);

  changesNotesEl.addEventListener('input', () => {
    changesConfirmBtn.disabled = !changesNotesEl.value.trim();
  });
  changesConfirmBtn.addEventListener('click', handleChangesConfirm);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      rejectModal.hidden = true;
      changesModal.hidden = true;
    }
  });
}

// =============================================================================
// Actions
// =============================================================================

async function handleApprove(profile, btn) {
  if (!confirm(`Approve this profile?\n\n${profile.display_name} (@${profile.requested_runner_id})`)) return;

  btn.disabled = true;
  btn.textContent = 'Approving...';

  const result = await CRCAdmin.approveProfile(profile.id);

  if (result.error) {
    alert('Error approving profile: ' + result.error);
    btn.disabled = false;
    btn.textContent = '‚úÖ Approve';
    return;
  }

  if (result.filename) {
    console.log(`[Profiles] Created file: _runners/${result.filename}`);
  }

  const card = document.querySelector(`.profile-card[data-profile-id="${profile.id}"]`);
  if (card) {
    const idx = allProfiles.findIndex(p => p.id === profile.id);
    if (idx >= 0) allProfiles[idx] = result.data;
    card.outerHTML = renderProfileCard(result.data);
  }

  if (currentStatus === 'pending') {
    setTimeout(() => {
      const updatedCard = document.querySelector(`.profile-card[data-profile-id="${profile.id}"]`);
      if (updatedCard) {
        updatedCard.style.transition = 'opacity 0.3s';
        updatedCard.style.opacity = '0';
        setTimeout(() => {
          updatedCard.remove();
          allProfiles = allProfiles.filter(p => p.id !== profile.id);
          if (allProfiles.length === 0) profilesEmptyEl.hidden = false;
          const count = parseInt(pendingCountEl.textContent) || 0;
          if (count > 0) pendingCountEl.textContent = count - 1;
        }, 300);
      }
    }, 800);
  }
}

function openRejectModal(profile) {
  currentRejectId = profile.id;
  rejectInfoEl.textContent = `${profile.display_name} (@${profile.requested_runner_id})`;
  rejectReasonEl.value = '';
  rejectNotesEl.value = '';
  rejectConfirmBtn.disabled = true;
  rejectModal.hidden = false;
}

async function handleRejectConfirm() {
  if (!currentRejectId || !rejectReasonEl.value) return;

  rejectConfirmBtn.disabled = true;
  rejectConfirmBtn.textContent = 'Rejecting...';

  const result = await CRCAdmin.rejectProfile(currentRejectId, rejectReasonEl.value, rejectNotesEl.value.trim());

  if (result.error) {
    alert('Error: ' + result.error);
    rejectConfirmBtn.disabled = false;
    rejectConfirmBtn.textContent = 'Reject Profile';
    return;
  }

  rejectModal.hidden = true;
  const idx = allProfiles.findIndex(p => p.id === currentRejectId);
  if (idx >= 0) allProfiles[idx] = result.data;

  if (currentStatus === 'pending') {
    fadeOutAndRemove(`.profile-card[data-profile-id="${currentRejectId}"]`, currentRejectId);
  } else {
    const card = document.querySelector(`.profile-card[data-profile-id="${currentRejectId}"]`);
    if (card) card.outerHTML = renderProfileCard(result.data);
  }

  rejectConfirmBtn.textContent = 'Reject Profile';
  currentRejectId = null;
}

function openChangesModal(profile) {
  currentChangesId = profile.id;
  changesInfoEl.textContent = `${profile.display_name} (@${profile.requested_runner_id})`;
  changesNotesEl.value = '';
  changesConfirmBtn.disabled = true;
  changesModal.hidden = false;
}

async function handleChangesConfirm() {
  if (!currentChangesId || !changesNotesEl.value.trim()) return;

  changesConfirmBtn.disabled = true;
  changesConfirmBtn.textContent = 'Sending...';

  const result = await CRCAdmin.requestProfileChanges(currentChangesId, changesNotesEl.value.trim());

  if (result.error) {
    alert('Error: ' + result.error);
    changesConfirmBtn.disabled = false;
    changesConfirmBtn.textContent = 'Send Request';
    return;
  }

  changesModal.hidden = true;
  const idx = allProfiles.findIndex(p => p.id === currentChangesId);
  if (idx >= 0) allProfiles[idx] = result.data;

  if (currentStatus === 'pending') {
    fadeOutAndRemove(`.profile-card[data-profile-id="${currentChangesId}"]`, currentChangesId);
  } else {
    const card = document.querySelector(`.profile-card[data-profile-id="${currentChangesId}"]`);
    if (card) card.outerHTML = renderProfileCard(result.data);
  }

  changesConfirmBtn.textContent = 'Send Request';
  currentChangesId = null;
}

// =============================================================================
// Helpers
// =============================================================================

function fadeOutAndRemove(selector, id) {
  const card = document.querySelector(selector);
  if (card) {
    card.style.transition = 'opacity 0.3s';
    card.style.opacity = '0';
    setTimeout(() => {
      card.remove();
      allProfiles = allProfiles.filter(p => p.id !== id);
      if (allProfiles.length === 0) profilesEmptyEl.hidden = false;
      const count = parseInt(pendingCountEl.textContent) || 0;
      if (count > 0) pendingCountEl.textContent = count - 1;
    }, 300);
  }
}
</script>
