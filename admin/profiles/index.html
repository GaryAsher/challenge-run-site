---
layout: default
title: "Admin - Pending Profiles"
---

<div class="page-width">
  <div class="admin-page">
    <!-- Loading -->
    <div id="loading-state" class="card">
      <div class="admin-loading">
        <div class="spinner"></div>
        <p class="muted">Verifying admin access...</p>
      </div>
    </div>

    <!-- Not authorized - this is all non-admins will ever see -->
    <div id="not-authorized" class="card" hidden>
      <h2>üîí Access Denied</h2>
      <p class="muted">This page requires administrator privileges.</p>
      <a href="/" class="btn">Go Home</a>
    </div>

    <!-- Admin content - only rendered after server verification -->
    <div id="admin-content" hidden>
      <!-- Content will be injected here ONLY after admin verification -->
    </div>
  </div>
</div>

<style>
.admin-page { max-width: 900px; margin: 0 auto; }
.admin-loading { text-align: center; padding: 3rem; }
.mod-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; text-align: center; margin-bottom: 2rem; }
.mod-stats__value { display: block; font-size: 2rem; font-weight: bold; color: var(--accent); }
.mod-stats__label { font-size: 0.875rem; color: var(--text-muted); }
.mod-queue__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.mod-queue__header h2 { margin: 0; }
.mod-card { border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; background: var(--surface); }
.mod-card__header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
.mod-card__user { display: flex; align-items: center; gap: 0.75rem; }
.mod-card__avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background: var(--bg); }
.mod-card__name { font-weight: 600; margin: 0; }
.mod-card__id { font-size: 0.875rem; color: var(--text-muted); margin: 0; }
.mod-card__date { font-size: 0.875rem; color: var(--text-muted); }
.mod-card__bio { margin: 1rem 0; padding: 0.75rem; background: var(--bg); border-radius: 8px; font-size: 0.9rem; }
.mod-card__actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal[hidden] { display: none; }
.modal__backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.6); }
.modal__content { position: relative; background: var(--surface); border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
.modal__header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); }
.modal__header h2 { margin: 0; font-size: 1.1rem; }
.modal__close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.25rem; line-height: 1; }
.modal__body { padding: 1.25rem; }
.modal__footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border); }
.modal__reject-section { margin-bottom: 1rem; }
.modal__label { display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem; }
.modal__textarea { width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--fg); min-height: 80px; resize: vertical; }
.modal__actions { display: flex; gap: 0.5rem; justify-content: flex-end; flex-wrap: wrap; }
.btn--success { background: #28a745; color: white; border-color: #28a745; }
.btn--success:hover { background: #218838; }
.btn--danger { background: #dc3545; color: white; border-color: #dc3545; }
.btn--danger:hover { background: #c82333; }
.btn--small { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
@media (max-width: 600px) {
  .mod-stats { grid-template-columns: 1fr; }
  .mod-card__header { flex-direction: column; }
}
</style>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

/**
 * SECURITY MODEL:
 * 1. Client-side: Admin UI is only rendered AFTER database verification
 * 2. Server-side (Supabase RLS): Database policies enforce that only admins can:
 *    - Read pending_profiles (via policy checking is_admin)
 *    - Call approve_profile / reject_profile functions
 * 
 * Even if someone bypasses client-side checks, RLS blocks all data access.
 */

(async function() {
  const loadingState = document.getElementById('loading-state');
  const notAuthorized = document.getElementById('not-authorized');
  const adminContent = document.getElementById('admin-content');
  
  let supabase = null;
  let pendingProfiles = [];
  let currentReviewId = null;
  
  function showState(state) {
    loadingState.hidden = state !== 'loading';
    notAuthorized.hidden = state !== 'denied';
    adminContent.hidden = state !== 'admin';
  }
  
  // Verify admin via DATABASE query
  async function verifyAdminAccess() {
    if (!supabase) return false;
    const user = CRCAuth.getUser();
    if (!user) return false;
    
    try {
      const { data, error } = await supabase
        .from('runner_profiles')
        .select('is_admin')
        .eq('user_id', user.id)
        .single();
      
      if (error || !data) {
        // Fallback: check provider username
        const metadata = CRCAuth.getProviderMetadata();
        const username = metadata?.providerUsername?.toLowerCase() || '';
        return ['gary_asher', 'gary-asher'].includes(username);
      }
      
      return data.is_admin === true;
    } catch (err) {
      return false;
    }
  }
  
  function renderAdminInterface() {
    adminContent.innerHTML = `
      <p class="muted mb-3"><a href="/">‚Üê Home</a></p>
      <h1>üë• Pending Profiles</h1>
      <p class="muted mb-4">Review and approve runner profile submissions.</p>
      <div class="mod-stats card">
        <div class="mod-stats__item">
          <span class="mod-stats__value" id="pending-count">0</span>
          <span class="mod-stats__label">Pending</span>
        </div>
        <div class="mod-stats__item">
          <span class="mod-stats__value" id="approved-count">0</span>
          <span class="mod-stats__label">Total Approved</span>
        </div>
      </div>
      <div class="mod-queue__header">
        <h2>Queue</h2>
        <button type="button" class="btn btn--small" id="refresh-btn">üîÑ Refresh</button>
      </div>
      <div id="queue-list"><p class="muted">Loading...</p></div>
      <div id="queue-empty" class="card" hidden>
        <p>üéâ No pending profiles!</p>
      </div>
      <div id="review-modal" class="modal" hidden>
        <div class="modal__backdrop"></div>
        <div class="modal__content">
          <div class="modal__header">
            <h2>Review Profile</h2>
            <button type="button" class="modal__close">&times;</button>
          </div>
          <div class="modal__body" id="review-content"></div>
          <div class="modal__footer">
            <div class="modal__reject-section" id="reject-section" hidden>
              <label class="modal__label">Rejection Reason:</label>
              <textarea id="reject-reason" class="modal__textarea"></textarea>
            </div>
            <div class="modal__actions">
              <button class="btn btn--success" id="approve-btn">‚úì Approve</button>
              <button class="btn btn--danger" id="reject-btn">‚úó Reject</button>
              <button class="btn" id="cancel-btn">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('refresh-btn').addEventListener('click', loadQueue);
    const modal = document.getElementById('review-modal');
    modal.querySelector('.modal__backdrop').addEventListener('click', closeModal);
    modal.querySelector('.modal__close').addEventListener('click', closeModal);
    document.getElementById('cancel-btn').addEventListener('click', closeModal);
    document.getElementById('approve-btn').addEventListener('click', () => approveProfile(currentReviewId));
    document.getElementById('reject-btn').addEventListener('click', rejectProfile);
  }
  
  async function loadQueue() {
    const queueList = document.getElementById('queue-list');
    const queueEmpty = document.getElementById('queue-empty');
    queueList.innerHTML = '<p class="muted">Loading...</p>';
    
    try {
      // Try without ordering first (safest), then sort client-side
      const { data, error } = await supabase
        .from('pending_profiles')
        .select('*')
        .eq('status', 'pending');
      
      if (error) throw error;
      
      // Sort by whatever date field exists
      pendingProfiles = (data || []).sort((a, b) => {
        const dateA = new Date(a.submitted_at || a.created_at || 0);
        const dateB = new Date(b.submitted_at || b.created_at || 0);
        return dateA - dateB;
      });
      
      document.getElementById('pending-count').textContent = pendingProfiles.length;
      
      const { count } = await supabase.from('runner_profiles').select('*', { count: 'exact', head: true });
      document.getElementById('approved-count').textContent = count || 0;
      
      if (pendingProfiles.length === 0) {
        queueList.hidden = true;
        queueEmpty.hidden = false;
      } else {
        queueList.hidden = false;
        queueEmpty.hidden = true;
        queueList.innerHTML = pendingProfiles.map(p => `
          <div class="mod-card">
            <div class="mod-card__header">
              <div class="mod-card__user">
                <img class="mod-card__avatar" src="/assets/img/site/default-runner.png" alt="" />
                <div>
                  <p class="mod-card__name">${esc(p.display_name)}</p>
                  <p class="mod-card__id">@${esc(p.requested_runner_id)}</p>
                </div>
              </div>
              <span class="mod-card__date">${fmtDate(p.submitted_at || p.created_at)}</span>
            </div>
            ${p.bio ? `<div class="mod-card__bio">${esc(p.bio)}</div>` : ''}
            <div class="mod-card__actions">
              <button class="btn btn--small btn--success" onclick="CRCAdmin.approve('${p.id}')">‚úì Approve</button>
              <button class="btn btn--small" onclick="CRCAdmin.review('${p.id}')">Review</button>
            </div>
          </div>
        `).join('');
      }
    } catch (err) {
      queueList.innerHTML = `<p class="muted">Error: ${err.message}</p>`;
    }
  }
  
  function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
  function fmtDate(d) { return d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : ''; }
  function closeModal() { document.getElementById('review-modal').hidden = true; currentReviewId = null; }
  
  async function approveProfile(id) {
    if (!id || !confirm('Approve this profile?')) return;
    try {
      const { error } = await supabase.rpc('approve_profile', { pending_id: id });
      if (error) throw error;
      closeModal();
      await loadQueue();
    } catch (err) { alert('Error: ' + err.message); }
  }
  
  async function rejectProfile() {
    const sec = document.getElementById('reject-section');
    const reason = document.getElementById('reject-reason');
    if (sec.hidden) { sec.hidden = false; reason.focus(); return; }
    try {
      const { error } = await supabase.rpc('reject_profile', { pending_id: currentReviewId, reason: reason.value || null });
      if (error) throw error;
      closeModal();
      await loadQueue();
    } catch (err) { alert('Error: ' + err.message); }
  }
  
  window.CRCAdmin = {
    approve: approveProfile,
    review: (id) => {
      const p = pendingProfiles.find(x => x.id === id);
      if (!p) return;
      currentReviewId = id;
      document.getElementById('review-content').innerHTML = `
        <div class="mod-card__user" style="margin-bottom:1rem">
          <img class="mod-card__avatar" src="/assets/img/site/default-runner.png" />
          <div><p class="mod-card__name">${esc(p.display_name)}</p><p class="mod-card__id">@${esc(p.requested_runner_id)}</p></div>
        </div>
        ${p.bio ? `<div class="mod-card__bio">${esc(p.bio)}</div>` : ''}
      `;
      document.getElementById('reject-section').hidden = true;
      document.getElementById('review-modal').hidden = false;
    }
  };
  
  // Init
  try {
    showState('loading');
    await CRCAuth.init();
    if (!CRCAuth.isSignedIn()) { showState('denied'); return; }
    supabase = CRCAuth.getSupabaseClient();
    if (!supabase) { showState('denied'); return; }
    
    const isAdmin = await verifyAdminAccess();
    console.log('[Admin] Verified:', isAdmin);
    if (!isAdmin) { showState('denied'); return; }
    
    renderAdminInterface();
    showState('admin');
    await loadQueue();
  } catch (e) { console.error(e); showState('denied'); }
})();
</script>
