---
layout: default
title: "Profile Moderation"
---

<div class="page-width">
  <h1>Profile Moderation</h1>
  <p class="muted mb-4">Review and approve pending runner profiles.</p>

  <!-- Not authorized -->
  <div id="not-authorized" class="card" hidden>
    <h2>Access Denied</h2>
    <p class="muted">You don't have permission to access this page.</p>
    <a href="{{ '/' | relative_url }}" class="btn">Go Home</a>
  </div>

  <!-- Moderation queue -->
  <div id="mod-queue" hidden>
    <div class="mod-stats card">
      <div class="mod-stats__item">
        <span class="mod-stats__value" id="pending-count">0</span>
        <span class="mod-stats__label">Pending</span>
      </div>
      <div class="mod-stats__item">
        <span class="mod-stats__value" id="approved-today">0</span>
        <span class="mod-stats__label">Approved Today</span>
      </div>
      <div class="mod-stats__item">
        <span class="mod-stats__value" id="rejected-today">0</span>
        <span class="mod-stats__label">Rejected Today</span>
      </div>
    </div>

    <div class="mod-queue__header">
      <h2>Pending Profiles</h2>
      <button type="button" class="btn btn--small" id="refresh-btn">Refresh</button>
    </div>

    <div id="queue-list">
      <p class="muted">Loading...</p>
    </div>

    <div id="queue-empty" class="card" hidden>
      <p class="muted">üéâ No pending profiles to review!</p>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading-state" class="card">
    <div class="mod-loading">
      <div class="spinner"></div>
      <p class="muted">Loading moderation queue...</p>
    </div>
  </div>
</div>

<!-- Review Modal -->
<div id="review-modal" class="modal" hidden>
  <div class="modal__backdrop"></div>
  <div class="modal__content">
    <div class="modal__header">
      <h2>Review Profile</h2>
      <button type="button" class="modal__close" aria-label="Close">&times;</button>
    </div>
    <div class="modal__body" id="review-content">
      <!-- Populated by JavaScript -->
    </div>
    <div class="modal__footer">
      <div class="modal__reject-section" id="reject-section" hidden>
        <label for="reject-reason" class="modal__label">Rejection Reason:</label>
        <textarea id="reject-reason" class="modal__textarea" placeholder="Explain why the profile was rejected..."></textarea>
      </div>
      <div class="modal__actions">
        <button type="button" class="btn btn--success" id="approve-btn">Approve</button>
        <button type="button" class="btn btn--danger" id="reject-btn">Reject</button>
        <button type="button" class="btn" id="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>
</div>

<style>
.mod-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  text-align: center;
  margin-bottom: 2rem;
}

.mod-stats__value {
  display: block;
  font-size: 2rem;
  font-weight: bold;
  color: var(--accent);
}

.mod-stats__label {
  font-size: 0.875rem;
  color: var(--muted);
}

.mod-queue__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.mod-queue__header h2 {
  margin: 0;
}

.mod-loading {
  text-align: center;
  padding: 3rem;
}

.mod-card {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
  background: var(--bg);
}

.mod-card__header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
}

.mod-card__user {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.mod-card__avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--bg-secondary);
}

.mod-card__name {
  font-weight: 600;
  margin: 0;
}

.mod-card__id {
  font-size: 0.875rem;
  color: var(--muted);
  margin: 0;
}

.mod-card__meta {
  text-align: right;
}

.mod-card__date {
  font-size: 0.875rem;
  color: var(--muted);
}

.mod-card__provider {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  background: var(--bg-secondary);
}

.mod-card__provider--discord {
  background: rgba(88, 101, 242, 0.2);
  color: #5865F2;
}

.mod-card__provider--twitch {
  background: rgba(145, 70, 255, 0.2);
  color: #9146FF;
}

.mod-card__bio {
  margin: 1rem 0;
  padding: 0.75rem;
  background: var(--bg-secondary);
  border-radius: 6px;
  font-size: 0.9rem;
}

.mod-card__warning {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  background: rgba(255, 193, 7, 0.1);
  border: 1px solid rgba(255, 193, 7, 0.3);
  border-radius: 6px;
  color: var(--warning, #ffc107);
  font-size: 0.875rem;
  margin-bottom: 1rem;
}

.mod-card__actions {
  display: flex;
  gap: 0.5rem;
}

/* Modal styles */
.modal {
  position: fixed;
  inset: 0;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
}

.modal__content {
  position: relative;
  background: var(--bg);
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border);
}

.modal__header h2 {
  margin: 0;
}

.modal__close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--muted);
  padding: 0.25rem;
}

.modal__body {
  padding: 1.5rem;
}

.modal__footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid var(--border);
}

.modal__reject-section {
  margin-bottom: 1rem;
}

.modal__label {
  display: block;
  font-weight: 500;
  margin-bottom: 0.5rem;
}

.modal__textarea {
  width: 100%;
  padding: 0.625rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--fg);
  min-height: 80px;
}

.modal__actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
}

.btn--success {
  background: var(--success, #28a745);
  color: white;
}

.btn--danger {
  background: var(--danger, #dc3545);
  color: white;
}

.btn--small {
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
}

@media (max-width: 600px) {
  .mod-stats {
    grid-template-columns: 1fr;
  }
  
  .mod-card__header {
    flex-direction: column;
    gap: 1rem;
  }
  
  .mod-card__meta {
    text-align: left;
  }
}
</style>

<script type="module">
import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';

(async function() {
  const notAuthorized = document.getElementById('not-authorized');
  const modQueue = document.getElementById('mod-queue');
  const loadingState = document.getElementById('loading-state');
  const queueList = document.getElementById('queue-list');
  const queueEmpty = document.getElementById('queue-empty');
  const refreshBtn = document.getElementById('refresh-btn');
  
  const reviewModal = document.getElementById('review-modal');
  const reviewContent = document.getElementById('review-content');
  const rejectSection = document.getElementById('reject-section');
  const rejectReason = document.getElementById('reject-reason');
  const approveBtn = document.getElementById('approve-btn');
  const rejectBtn = document.getElementById('reject-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  
  let pendingProfiles = [];
  let currentReviewId = null;
  let supabase = null;
  
  function showState(state) {
    notAuthorized.hidden = state !== 'not-authorized';
    modQueue.hidden = state !== 'queue';
    loadingState.hidden = state !== 'loading';
  }
  
  async function checkModeratorAccess() {
    if (!supabase) return false;
    
    const { data, error } = await supabase
      .from('moderators')
      .select('id')
      .eq('user_id', CRCAuth.getUser().id)
      .single();
    
    return !!data && !error;
  }
  
  async function loadQueue() {
    queueList.innerHTML = '<p class="muted">Loading...</p>';
    
    const { data, error } = await supabase
      .from('moderation_queue')
      .select('*');
    
    if (error) {
      console.error('Error loading queue:', error);
      queueList.innerHTML = '<p class="muted">Error loading queue.</p>';
      return;
    }
    
    pendingProfiles = data || [];
    document.getElementById('pending-count').textContent = pendingProfiles.length;
    
    renderQueue();
  }
  
  function renderQueue() {
    if (pendingProfiles.length === 0) {
      queueList.hidden = true;
      queueEmpty.hidden = false;
      return;
    }
    
    queueList.hidden = false;
    queueEmpty.hidden = true;
    
    queueList.innerHTML = pendingProfiles.map(profile => `
      <div class="mod-card" data-id="${profile.id}">
        <div class="mod-card__header">
          <div class="mod-card__user">
            <img class="mod-card__avatar" src="${profile.provider_avatar_url || '/assets/img/site/default-runner.png'}" alt="" />
            <div>
              <p class="mod-card__name">${escapeHtml(profile.display_name)}</p>
              <p class="mod-card__id">@${escapeHtml(profile.requested_runner_id)}</p>
            </div>
          </div>
          <div class="mod-card__meta">
            <span class="mod-card__provider mod-card__provider--${profile.provider || 'discord'}">${profile.provider || 'Unknown'}</span>
            <p class="mod-card__date">${formatDate(profile.created_at)}</p>
          </div>
        </div>
        
        ${!profile.account_age_ok ? `
          <div class="mod-card__warning">
            ‚ö†Ô∏è Account is less than 30 days old
          </div>
        ` : ''}
        
        ${profile.bio ? `
          <div class="mod-card__bio">${escapeHtml(profile.bio)}</div>
        ` : ''}
        
        <div class="mod-card__actions">
          <button type="button" class="btn btn--small btn--success" onclick="window.openReview('${profile.id}')">Review</button>
        </div>
      </div>
    `).join('');
  }
  
  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
  }
  
  function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }
  
  window.openReview = function(id) {
    const profile = pendingProfiles.find(p => p.id === id);
    if (!profile) return;
    
    currentReviewId = id;
    
    reviewContent.innerHTML = `
      <div class="mod-card__user" style="margin-bottom: 1rem;">
        <img class="mod-card__avatar" src="${profile.provider_avatar_url || '/assets/img/site/default-runner.png'}" alt="" />
        <div>
          <p class="mod-card__name">${escapeHtml(profile.display_name)}</p>
          <p class="mod-card__id">@${escapeHtml(profile.requested_runner_id)}</p>
        </div>
      </div>
      
      ${!profile.account_age_ok ? `
        <div class="mod-card__warning">
          ‚ö†Ô∏è Account is less than 30 days old (${profile.provider_username} on ${profile.provider})
        </div>
      ` : ''}
      
      <table style="width: 100%; font-size: 0.9rem;">
        <tr><td style="color: var(--muted);">Provider:</td><td>${profile.provider || 'Unknown'} (${profile.provider_username || 'N/A'})</td></tr>
        <tr><td style="color: var(--muted);">Submitted:</td><td>${formatDate(profile.created_at)}</td></tr>
        ${profile.bio ? `<tr><td style="color: var(--muted);">Bio:</td><td>${escapeHtml(profile.bio)}</td></tr>` : ''}
      </table>
    `;
    
    rejectSection.hidden = true;
    rejectReason.value = '';
    reviewModal.hidden = false;
  };
  
  function closeModal() {
    reviewModal.hidden = true;
    currentReviewId = null;
  }
  
  async function approveProfile() {
    if (!currentReviewId) return;
    
    approveBtn.disabled = true;
    approveBtn.textContent = 'Approving...';
    
    try {
      const { data, error } = await supabase.rpc('approve_pending_profile', {
        pending_id: currentReviewId,
        moderator_id: CRCAuth.getUser().id
      });
      
      if (error) throw error;
      
      closeModal();
      await loadQueue();
    } catch (err) {
      console.error('Approve error:', err);
      alert('Error approving profile: ' + err.message);
    } finally {
      approveBtn.disabled = false;
      approveBtn.textContent = 'Approve';
    }
  }
  
  async function rejectProfile() {
    if (!currentReviewId) return;
    
    if (rejectSection.hidden) {
      rejectSection.hidden = false;
      rejectReason.focus();
      return;
    }
    
    const reason = rejectReason.value.trim();
    
    rejectBtn.disabled = true;
    rejectBtn.textContent = 'Rejecting...';
    
    try {
      const { data, error } = await supabase.rpc('reject_pending_profile', {
        pending_id: currentReviewId,
        moderator_id: CRCAuth.getUser().id,
        reason: reason || null
      });
      
      if (error) throw error;
      
      closeModal();
      await loadQueue();
    } catch (err) {
      console.error('Reject error:', err);
      alert('Error rejecting profile: ' + err.message);
    } finally {
      rejectBtn.disabled = false;
      rejectBtn.textContent = 'Reject';
    }
  }
  
  // Event listeners
  reviewModal.querySelector('.modal__backdrop').addEventListener('click', closeModal);
  reviewModal.querySelector('.modal__close').addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);
  approveBtn.addEventListener('click', approveProfile);
  rejectBtn.addEventListener('click', rejectProfile);
  refreshBtn.addEventListener('click', loadQueue);
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !reviewModal.hidden) {
      closeModal();
    }
  });
  
  // Initialize
  try {
    await CRCAuth.init();
    
    if (!CRCAuth.isSignedIn()) {
      showState('not-authorized');
      return;
    }
    
    supabase = CRCAuth.getSupabaseClient();
    
    const isMod = await checkModeratorAccess();
    if (!isMod) {
      showState('not-authorized');
      return;
    }
    
    showState('queue');
    await loadQueue();
  } catch (error) {
    console.error('Init error:', error);
    showState('not-authorized');
  }
})();
</script>
