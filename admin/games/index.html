---
layout: default
title: "Dashboard - Pending Games"
---

<div class="page-width">
  <div class="admin-page">
    <!-- Loading -->
    <div id="loading-state" class="card">
      <div class="admin-loading">
        <div class="spinner"></div>
        <p class="muted">Verifying access...</p>
      </div>
    </div>

    <!-- Not authorized -->
    <div id="not-authorized" class="card" hidden>
      <h2>ğŸ”’ Access Denied</h2>
      <p class="muted">This page requires administrator privileges.</p>
      <a href="/" class="btn">Go Home</a>
    </div>

    <!-- Admin content -->
    <div id="admin-content" hidden>
      <p class="muted mb-3"><a href="/admin/">â† Back to Dashboard</a></p>

      <div class="admin-header">
        <div>
          <h1>ğŸ¯ Pending Games</h1>
          <p class="muted">Review and approve game submissions.</p>
        </div>
        <div class="admin-header__role" id="role-badge"></div>
      </div>

      <!-- Stats -->
      <div class="game-stats card">
        <div class="game-stats__item">
          <span class="game-stats__value" id="pending-count">â€”</span>
          <span class="game-stats__label">Pending</span>
        </div>
        <div class="game-stats__item">
          <span class="game-stats__value" id="total-games-count">â€”</span>
          <span class="game-stats__label">Active Games</span>
        </div>
      </div>

      <!-- Info box about dual sources -->
      <div class="admin-info-box" id="github-info">
        <p><strong>ğŸ“ Note:</strong> Games can also arrive via GitHub PRs in <code>_queue_games/</code>. This page shows games submitted through the Supabase pipeline.</p>
      </div>

      <!-- Filter tabs -->
      <div class="filter-bar">
        <div class="filter-tabs">
          <button class="filter-tab active" data-status="pending">Pending</button>
          <button class="filter-tab" data-status="approved">Approved</button>
          <button class="filter-tab" data-status="rejected">Rejected</button>
          <button class="filter-tab" data-status="all">All</button>
        </div>
        <button type="button" class="btn btn--small" id="refresh-btn">ğŸ”„ Refresh</button>
      </div>

      <!-- Queue -->
      <div id="queue-list"></div>
      <div id="queue-empty" class="card" hidden>
        <p style="text-align:center;padding:2rem">ğŸ‰ No pending games!</p>
      </div>

      <!-- Review Modal -->
      <div id="review-modal" class="modal" hidden>
        <div class="modal__backdrop"></div>
        <div class="modal__content modal__content--wide">
          <div class="modal__header">
            <h2 id="modal-title">Review Game</h2>
            <button type="button" class="modal__close">&times;</button>
          </div>
          <div class="modal__body" id="review-body"></div>
          <div class="modal__footer">
            <div class="modal__reject-section" id="reject-section" hidden>
              <label class="modal__label">Rejection Reason:</label>
              <textarea id="reject-reason" class="modal__textarea" placeholder="Why is this game being rejected?"></textarea>
            </div>
            <div class="modal__notes-section" id="notes-section" hidden>
              <label class="modal__label">Reviewer Notes (optional):</label>
              <textarea id="reviewer-notes" class="modal__textarea" placeholder="Notes about configuration, genres to add, etc."></textarea>
            </div>
            <div class="modal__actions">
              <button class="btn btn--success" id="modal-approve-btn">âœ“ Approve</button>
              <button class="btn btn--danger" id="modal-reject-btn">âœ— Reject</button>
              <button class="btn" id="modal-cancel-btn">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.admin-page { max-width: 960px; margin: 0 auto; }
.admin-loading { text-align: center; padding: 3rem; }
.admin-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
.admin-header__role { font-size: 0.85rem; padding: 4px 10px; border-radius: 6px; background: var(--surface); border: 1px solid var(--border); white-space: nowrap; }

.admin-info-box { background: var(--surface); border: 1px solid var(--accent); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; font-size: 0.9rem; }
.admin-info-box code { background: var(--bg); padding: 2px 5px; border-radius: 3px; font-size: 0.85em; }

/* Stats */
.game-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; text-align: center; margin-bottom: 1.5rem; }
.game-stats__value { display: block; font-size: 2rem; font-weight: bold; color: var(--accent); }
.game-stats__label { font-size: 0.875rem; color: var(--text-muted); }

/* Filter bar */
.filter-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 0.75rem; }
.filter-tabs { display: flex; gap: 0.25rem; }
.filter-tab { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 0.4rem 0.85rem; font-size: 0.85rem; cursor: pointer; color: var(--fg); transition: all 0.2s; }
.filter-tab:hover { border-color: var(--accent); }
.filter-tab.active { background: var(--accent); color: white; border-color: var(--accent); }

/* Game cards */
.game-card { border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; background: var(--surface); transition: opacity 0.3s, transform 0.3s; }
.game-card.fade-out { opacity: 0; transform: translateX(40px); }
.game-card__header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.75rem; }
.game-card__title { font-weight: 600; font-size: 1.1rem; }
.game-card__id { font-size: 0.85rem; color: var(--text-muted); font-family: monospace; }
.game-card__meta { font-size: 0.8rem; color: var(--text-muted); }

.game-card__tags { display: flex; gap: 0.4rem; flex-wrap: wrap; margin: 0.75rem 0; }
.game-tag { font-size: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 2px 8px; }
.game-tag--modded { background: #5865f2; color: white; border-color: #5865f2; }
.game-tag--category { background: var(--accent); color: white; border-color: var(--accent); opacity: 0.9; }

.game-card__details { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.5rem; padding: 0.75rem; background: var(--bg); border-radius: 8px; margin: 0.75rem 0; font-size: 0.85rem; }
.game-card__detail-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }
.game-card__actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
.game-card__pr-link { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.85rem; color: var(--accent); text-decoration: none; }
.game-card__pr-link:hover { text-decoration: underline; }

/* Buttons */
.btn--small { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
.btn--success { background: #28a745; color: white; border-color: #28a745; }
.btn--success:hover { background: #218838; }
.btn--danger { background: #dc3545; color: white; border-color: #dc3545; }
.btn--danger:hover { background: #c82333; }
.btn--outline-danger { background: transparent; border: 1px solid #dc3545; color: #dc3545; }
.btn--outline-danger:hover { background: #dc3545; color: white; }

/* Modal */
.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal[hidden] { display: none; }
.modal__backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.6); }
.modal__content { position: relative; background: var(--surface); border-radius: 12px; width: 90%; max-width: 520px; max-height: 90vh; overflow: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
.modal__content--wide { max-width: 680px; }
.modal__header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); }
.modal__header h2 { margin: 0; font-size: 1.1rem; }
.modal__close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.25rem; line-height: 1; }
.modal__body { padding: 1.25rem; }
.modal__footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border); }
.modal__reject-section, .modal__notes-section { margin-bottom: 1rem; }
.modal__label { display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem; }
.modal__textarea { width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--fg); min-height: 80px; resize: vertical; box-sizing: border-box; }
.modal__actions { display: flex; gap: 0.5rem; justify-content: flex-end; flex-wrap: wrap; }

/* Review detail sections */
.review-section { margin-bottom: 1rem; }
.review-section__title { font-weight: 600; font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem; }
.review-section__list { display: flex; flex-wrap: wrap; gap: 0.35rem; }
.review-section__item { font-size: 0.85rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 3px 10px; }

@media (max-width: 600px) {
  .game-stats { grid-template-columns: 1fr; }
  .game-card__header { flex-direction: column; }
  .filter-tabs { overflow-x: auto; }
}
</style>

<script type="module">
import { CRCAdmin } from '{{ "/assets/js/admin.js" | relative_url }}';

const loadingState = document.getElementById('loading-state');
const notAuthorized = document.getElementById('not-authorized');
const adminContent = document.getElementById('admin-content');

let currentFilter = 'pending';
let games = [];
let currentReviewId = null;

function showState(state) {
  loadingState.hidden = state !== 'loading';
  notAuthorized.hidden = state !== 'denied';
  adminContent.hidden = state !== 'admin';
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// â”€â”€â”€ Load Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadQueue() {
  const queueList = document.getElementById('queue-list');
  const queueEmpty = document.getElementById('queue-empty');
  queueList.innerHTML = '<p class="muted" style="text-align:center;padding:2rem">Loading...</p>';

  const { data, count, error } = await CRCAdmin.getPendingGames({ status: currentFilter });

  if (error) {
    queueList.innerHTML = `<p class="muted" style="text-align:center;padding:2rem">Error: ${esc(error)}</p>`;
    return;
  }

  games = data || [];

  if (currentFilter === 'pending') {
    document.getElementById('pending-count').textContent = count || 0;
  }

  if (games.length === 0) {
    queueList.innerHTML = '';
    queueList.hidden = true;
    queueEmpty.hidden = false;
  } else {
    queueList.hidden = false;
    queueEmpty.hidden = true;
    queueList.innerHTML = games.map(renderCard).join('');
  }
}

function renderCard(g) {
  const gd = g.game_data || {};

  // Extract categories from game_data
  const fullRuns = gd.full_runs || gd.full_run_categories || [];
  const miniChallenges = gd.mini_challenges || [];
  const challenges = gd.challenges_data || gd.challenges || [];
  const isModded = gd.is_modded === true || gd.is_modded === 'true';
  const charEnabled = gd.character_column?.enabled === true;

  const categoryTags = (Array.isArray(fullRuns) ? fullRuns : [])
    .slice(0, 5)
    .map(c => `<span class="game-tag game-tag--category">${esc(typeof c === 'string' ? c : c.label || c.slug || '')}</span>`)
    .join('');

  const challengeTags = (Array.isArray(challenges) ? challenges : [])
    .slice(0, 4)
    .map(c => `<span class="game-tag">${esc(typeof c === 'string' ? c : c.label || c.slug || '')}</span>`)
    .join('');

  const moddedTag = isModded
    ? `<span class="game-tag game-tag--modded">ğŸ”§ Modded${gd.base_game ? ` (${esc(gd.base_game)})` : ''}</span>`
    : '';

  const statusHtml = g.status !== 'pending' ? CRCAdmin.statusBadge(g.status) : '';
  const prLink = g.github_pr_url
    ? `<a class="game-card__pr-link" href="${esc(g.github_pr_url)}" target="_blank" rel="noopener">ğŸ”— PR #${g.github_pr_number || ''}</a>`
    : '';

  return `
    <div class="game-card" data-id="${g.id}">
      <div class="game-card__header">
        <div>
          <div class="game-card__title">${esc(g.game_name)}</div>
          <div class="game-card__id">${esc(g.game_id)}</div>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem">
          ${statusHtml}
          <span class="game-card__meta">${CRCAdmin.formatTimestamp(g.submitted_at)}</span>
        </div>
      </div>

      <div class="game-card__tags">
        ${moddedTag}
        ${categoryTags}
        ${fullRuns.length > 5 ? `<span class="game-tag">+${fullRuns.length - 5} more</span>` : ''}
      </div>

      <div class="game-card__details">
        <div>
          <span class="game-card__detail-label">Categories</span>
          <div>${fullRuns.length || 0} full runs${miniChallenges.length ? `, ${miniChallenges.length} mini` : ''}</div>
        </div>
        <div>
          <span class="game-card__detail-label">Challenges</span>
          <div>${challenges.length || 0} types</div>
        </div>
        <div>
          <span class="game-card__detail-label">Characters</span>
          <div>${charEnabled ? 'Enabled' : 'Disabled'}</div>
        </div>
        <div>
          <span class="game-card__detail-label">Submitted by</span>
          <div>${esc(g.submitter_handle || 'Unknown')}</div>
        </div>
      </div>

      ${prLink}

      ${g.status === 'rejected' && g.rejection_reason ? `<div style="margin:0.75rem 0;padding:0.75rem;background:var(--bg);border-radius:8px;border-left:3px solid #dc3545;font-size:0.9rem"><strong>Rejection reason:</strong> ${esc(g.rejection_reason)}</div>` : ''}

      ${g.status === 'pending' ? `
        <div class="game-card__actions">
          <button class="btn btn--small btn--success" data-action="approve" data-id="${g.id}">âœ“ Approve</button>
          <button class="btn btn--small" data-action="review" data-id="${g.id}">ğŸ‘ Review Details</button>
          <button class="btn btn--small btn--outline-danger" data-action="reject" data-id="${g.id}">âœ— Reject</button>
        </div>
      ` : ''}
    </div>
  `;
}

// â”€â”€â”€ Review Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openReviewModal(id) {
  const g = games.find(x => x.id === id);
  if (!g) return;
  currentReviewId = id;

  const gd = g.game_data || {};
  const fullRuns = gd.full_runs || gd.full_run_categories || [];
  const miniChallenges = gd.mini_challenges || [];
  const challenges = gd.challenges_data || [];
  const restrictions = gd.restrictions_data || [];
  const glitches = gd.glitches_data || [];
  const characters = gd.characters_data || [];

  function renderList(items) {
    if (!Array.isArray(items) || items.length === 0) return '<span class="muted">None</span>';
    return '<div class="review-section__list">' +
      items.map(i => `<span class="review-section__item">${esc(typeof i === 'string' ? i : i.label || i.slug || JSON.stringify(i))}</span>`).join('') +
    '</div>';
  }

  document.getElementById('modal-title').textContent = `Review: ${g.game_name}`;
  document.getElementById('review-body').innerHTML = `
    <div class="game-card__details" style="margin-bottom:1rem">
      <div><span class="game-card__detail-label">Game ID</span><div style="font-family:monospace">${esc(g.game_id)}</div></div>
      <div><span class="game-card__detail-label">Submitter</span><div>${esc(g.submitter_handle || 'Unknown')}</div></div>
      <div><span class="game-card__detail-label">Timing</span><div>${esc(gd.timing_method || 'RTA')}</div></div>
      <div><span class="game-card__detail-label">Modded</span><div>${gd.is_modded ? `Yes (base: ${esc(gd.base_game || '?')})` : 'No'}</div></div>
    </div>

    <div class="review-section">
      <div class="review-section__title">Full Run Categories (${fullRuns.length})</div>
      ${renderList(fullRuns)}
    </div>

    ${miniChallenges.length ? `
      <div class="review-section">
        <div class="review-section__title">Mini-Challenges (${miniChallenges.length})</div>
        ${renderList(miniChallenges)}
      </div>
    ` : ''}

    <div class="review-section">
      <div class="review-section__title">Challenge Types (${challenges.length})</div>
      ${renderList(challenges)}
    </div>

    ${restrictions.length ? `
      <div class="review-section">
        <div class="review-section__title">Restrictions (${restrictions.length})</div>
        ${renderList(restrictions)}
      </div>
    ` : ''}

    ${glitches.length ? `
      <div class="review-section">
        <div class="review-section__title">Glitch Categories (${glitches.length})</div>
        ${renderList(glitches)}
      </div>
    ` : ''}

    ${characters.length ? `
      <div class="review-section">
        <div class="review-section__title">Characters (${characters.length})</div>
        ${renderList(characters.slice(0, 20))}
        ${characters.length > 20 ? `<p class="muted" style="margin-top:0.5rem">... and ${characters.length - 20} more</p>` : ''}
      </div>
    ` : ''}

    ${gd.general_rules ? `
      <div class="review-section">
        <div class="review-section__title">General Rules</div>
        <div style="font-size:0.85rem;background:var(--bg);padding:0.75rem;border-radius:8px;white-space:pre-line">${esc(gd.general_rules)}</div>
      </div>
    ` : ''}

    ${g.github_pr_url ? `
      <div style="margin-top:1rem">
        <a href="${esc(g.github_pr_url)}" target="_blank" rel="noopener" class="btn btn--small">View GitHub PR â†’</a>
      </div>
    ` : ''}
  `;

  document.getElementById('reject-section').hidden = true;
  document.getElementById('notes-section').hidden = false;
  document.getElementById('reject-reason').value = '';
  document.getElementById('reviewer-notes').value = '';
  document.getElementById('review-modal').hidden = false;
}

function closeModal() {
  document.getElementById('review-modal').hidden = true;
  currentReviewId = null;
}

// â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function handleApprove(id) {
  const notes = document.getElementById('reviewer-notes')?.value || '';
  if (!confirm('Approve this game? You\'ll still need to add it to the _games/ directory and run generate.')) return;

  const card = document.querySelector(`.game-card[data-id="${id}"]`);
  const { error } = await CRCAdmin.approveGame(id, notes);
  if (error) {
    alert('Error: ' + error);
    return;
  }

  closeModal();
  if (card) {
    card.classList.add('fade-out');
    setTimeout(() => { card.remove(); updatePendingCount(-1); }, 300);
  } else {
    await loadQueue();
  }
}

async function handleReject(id) {
  const sec = document.getElementById('reject-section');
  const reason = document.getElementById('reject-reason');

  // If modal isn't open, open it first
  if (document.getElementById('review-modal').hidden) {
    openReviewModal(id);
    sec.hidden = false;
    reason.focus();
    return;
  }

  // If reject section hidden, show it
  if (sec.hidden) {
    sec.hidden = false;
    reason.focus();
    return;
  }

  // Submit rejection
  if (!currentReviewId) return;
  const notes = document.getElementById('reviewer-notes')?.value || '';
  const { error } = await CRCAdmin.rejectGame(currentReviewId, reason.value || 'Rejected', notes);
  if (error) {
    alert('Error: ' + error);
    return;
  }

  const card = document.querySelector(`.game-card[data-id="${currentReviewId}"]`);
  closeModal();
  if (card) {
    card.classList.add('fade-out');
    setTimeout(() => { card.remove(); updatePendingCount(-1); }, 300);
  } else {
    await loadQueue();
  }
}

function updatePendingCount(delta) {
  const el = document.getElementById('pending-count');
  const current = parseInt(el.textContent) || 0;
  el.textContent = Math.max(0, current + delta);
}

// â”€â”€â”€ Event Delegation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;

  const action = btn.dataset.action;
  const id = btn.dataset.id;

  switch (action) {
    case 'approve': handleApprove(id); break;
    case 'review': openReviewModal(id); break;
    case 'reject': handleReject(id); break;
  }
});

// Filter tabs
document.querySelectorAll('.filter-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentFilter = tab.dataset.status;
    loadQueue();
  });
});

// Modal controls
document.querySelector('.modal__backdrop')?.addEventListener('click', closeModal);
document.querySelector('.modal__close')?.addEventListener('click', closeModal);
document.getElementById('modal-cancel-btn')?.addEventListener('click', closeModal);
document.getElementById('modal-approve-btn')?.addEventListener('click', () => {
  if (currentReviewId) handleApprove(currentReviewId);
});
document.getElementById('modal-reject-btn')?.addEventListener('click', () => {
  if (currentReviewId) handleReject(currentReviewId);
});
document.getElementById('refresh-btn')?.addEventListener('click', loadQueue);

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

(async function() {
  showState('loading');

  const role = await CRCAdmin.init();

  if (!role || !CRCAdmin.isAdmin()) {
    showState('denied');
    return;
  }

  document.getElementById('role-badge').textContent = CRCAdmin.roleLabel(role);
  showState('admin');

  // Load counts
  const counts = await CRCAdmin.getCounts();
  document.getElementById('pending-count').textContent = counts.pendingGames ?? 'â€”';

  // Count active games from Jekyll data (not Supabase)
  // This is a rough count â€” could be enhanced later
  document.getElementById('total-games-count').textContent = 'â€”';

  await loadQueue();
})();
</script>
