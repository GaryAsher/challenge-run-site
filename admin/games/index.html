---
layout: default
title: "Dashboard - Pending Games"
---

<div class="page-width">
  <div class="games-admin">
    <!-- Loading -->
    <div id="loading-state" class="card">
      <div class="games-loading">
        <div class="spinner"></div>
        <p class="muted">Checking access...</p>
      </div>
    </div>

    <!-- Not authorized -->
    <div id="not-authorized" class="card" hidden>
      <h2>üîí Access Denied</h2>
      <p class="muted">You need admin privileges to review games.</p>
      <a href="/" class="btn btn--primary">Go Home</a>
    </div>

    <!-- Main content -->
    <div id="games-content" hidden>
      <p class="muted mb-2"><a href="/admin/">‚Üê Dashboard</a></p>

      <div class="games-header">
        <h1>üéØ Pending Games</h1>
        <p class="muted" id="games-role-info"></p>
      </div>

      <!-- Filters -->
      <div class="games-filters card">
        <div class="games-filters__row">
          <div class="games-filters__tabs" id="status-tabs">
            <button class="filter-tab active" data-status="pending" type="button">
              Pending <span class="filter-tab__count" id="count-pending">0</span>
            </button>
            <button class="filter-tab" data-status="approved" type="button">Approved</button>
            <button class="filter-tab" data-status="rejected" type="button">Rejected</button>
            <button class="filter-tab" data-status="needs_changes" type="button">Needs Changes</button>
            <button class="filter-tab" data-status="all" type="button">All</button>
          </div>
          <div class="games-filters__controls">
            <button class="btn btn--sm" id="refresh-btn" type="button" title="Refresh">‚Üª Refresh</button>
          </div>
        </div>
      </div>

      <!-- Games list -->
      <div id="games-list"></div>

      <!-- Empty state -->
      <div id="games-empty" class="games-empty card" hidden>
        <p>No games found matching your filters.</p>
        <p class="muted">New game submissions will appear here for review.</p>
      </div>
    </div>

    <!-- Rejection modal -->
    <div id="reject-modal" class="modal" hidden>
      <div class="modal__backdrop" data-close></div>
      <div class="modal__content card">
        <h3>Reject Game</h3>
        <p class="muted mb-2" id="reject-modal-info"></p>
        <div class="form-field">
          <label for="reject-reason">Reason <span class="required">*</span></label>
          <select id="reject-reason" class="filter-select">
            <option value="">Select a reason...</option>
            <option value="not_applicable">Game not suitable for challenge runs</option>
            <option value="duplicate">Game already exists on CRC</option>
            <option value="incomplete_data">Submission data is incomplete or incorrect</option>
            <option value="no_community">No community interest or support</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-field">
          <label for="reject-notes">Notes (optional)</label>
          <textarea id="reject-notes" rows="3" placeholder="Additional details for the submitter..."></textarea>
        </div>
        <div class="modal__actions">
          <button class="btn btn--reject" id="reject-confirm-btn" type="button" disabled>Reject Game</button>
          <button class="btn btn--secondary" data-close type="button">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Request changes modal -->
    <div id="changes-modal" class="modal" hidden>
      <div class="modal__backdrop" data-close></div>
      <div class="modal__content card">
        <h3>Request Changes</h3>
        <p class="muted mb-2" id="changes-modal-info"></p>
        <div class="form-field">
          <label for="changes-notes">What needs to be changed? <span class="required">*</span></label>
          <textarea id="changes-notes" rows="4" placeholder="Describe what needs to be fixed (categories, challenges, etc.)..."></textarea>
        </div>
        <div class="modal__actions">
          <button class="btn btn--changes" id="changes-confirm-btn" type="button" disabled>Send Request</button>
          <button class="btn btn--secondary" data-close type="button">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.games-admin { max-width: 960px; margin: 0 auto; }
.games-loading { text-align: center; padding: 3rem; }

.games-header { margin-bottom: 1.5rem; }
.games-header h1 { margin: 0; }

/* Filters */
.games-filters { padding: 1rem; margin-bottom: 1.5rem; }
.games-filters__row {
  display: flex; justify-content: space-between; align-items: center;
  flex-wrap: wrap; gap: 0.75rem;
}
.games-filters__tabs { display: flex; flex-wrap: wrap; gap: 0.25rem; }
.filter-tab {
  background: transparent; border: 1px solid var(--border); border-radius: 6px;
  padding: 0.4rem 0.75rem; font-size: 0.85rem; color: var(--text-muted);
  cursor: pointer; transition: all 0.15s;
}
.filter-tab:hover { border-color: var(--fg); color: var(--fg); }
.filter-tab.active {
  background: var(--accent, #6366f1); color: white; border-color: var(--accent, #6366f1);
}
.filter-tab__count {
  display: inline-block; background: rgba(255,255,255,0.25);
  padding: 0 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 4px; font-weight: 700;
}
.games-filters__controls { display: flex; gap: 0.5rem; align-items: center; }

/* Game cards */
.game-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; margin-bottom: 1rem; overflow: hidden;
}
.game-card__header {
  display: flex; justify-content: space-between; align-items: flex-start;
  padding: 1.25rem; cursor: pointer; transition: background 0.1s;
  flex-wrap: wrap; gap: 0.75rem;
}
.game-card__header:hover { background: rgba(255,255,255,0.02); }
.game-card__title { font-weight: 700; font-size: 1.05rem; }
.game-card__id { font-size: 0.85rem; color: var(--text-muted); font-family: monospace; }
.game-card__meta {
  display: flex; align-items: center; gap: 0.75rem;
  font-size: 0.85rem; color: var(--text-muted);
}

/* Expandable details */
.game-card__body {
  display: none; border-top: 1px solid var(--border); padding: 1.25rem;
}
.game-card.expanded .game-card__body { display: block; }

.game-tags { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 1rem; }
.game-tag {
  font-size: 0.75rem; background: var(--bg); border: 1px solid var(--border);
  border-radius: 4px; padding: 2px 8px;
}
.game-tag--modded { background: #5865f2; color: white; border-color: #5865f2; }
.game-tag--category { background: var(--accent); color: white; border-color: var(--accent); opacity: 0.9; }

.game-details {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 1rem; margin-bottom: 1.25rem;
}
.game-detail { display: flex; flex-direction: column; gap: 0.2rem; }
.game-detail__label {
  font-size: 0.7rem; text-transform: uppercase;
  letter-spacing: 0.05em; color: var(--text-muted);
}
.game-detail__value { font-weight: 500; word-break: break-word; }

/* Review sections inside expanded cards */
.review-section { margin-bottom: 1rem; }
.review-section__title {
  font-weight: 600; font-size: 0.8rem; text-transform: uppercase;
  color: var(--text-muted); margin-bottom: 0.5rem;
}
.review-section__list { display: flex; flex-wrap: wrap; gap: 0.35rem; }
.review-section__item {
  font-size: 0.85rem; background: var(--bg); border: 1px solid var(--border);
  border-radius: 4px; padding: 3px 10px;
}
.review-rules {
  font-size: 0.85rem; background: var(--bg); padding: 0.75rem;
  border-radius: 8px; white-space: pre-line; margin-top: 0.5rem;
}

/* Action buttons */
.game-actions {
  display: flex; gap: 0.5rem; flex-wrap: wrap;
  padding-top: 1rem; border-top: 1px solid var(--border);
}
.btn--approve {
  background: #28a745; color: white; border: none;
  padding: 0.5rem 1.25rem; border-radius: 6px; font-weight: 600; cursor: pointer;
}
.btn--approve:hover { background: #218838; }
.btn--approve:disabled { opacity: 0.5; cursor: not-allowed; }

.btn--reject {
  background: transparent; border: 1px solid #dc3545; color: #dc3545;
  padding: 0.5rem 1.25rem; border-radius: 6px; font-weight: 600; cursor: pointer;
}
.btn--reject:hover { background: #dc3545; color: white; }
.btn--reject:disabled { opacity: 0.5; }

.btn--changes {
  background: transparent; border: 1px solid #17a2b8; color: #17a2b8;
  padding: 0.5rem 1.25rem; border-radius: 6px; font-weight: 600; cursor: pointer;
}
.btn--changes:hover { background: #17a2b8; color: white; }
.btn--changes:disabled { opacity: 0.5; }

.btn--secondary {
  background: var(--surface); border: 1px solid var(--border); color: var(--fg);
  padding: 0.5rem 1.25rem; border-radius: 6px; cursor: pointer;
}
.btn--sm { padding: 0.35rem 0.75rem; font-size: 0.85rem; }

/* Status bar */
.game-status-bar {
  padding: 0.75rem 1rem; border-top: 1px solid var(--border);
  font-size: 0.85rem; color: var(--text-muted); background: rgba(255,255,255,0.02);
}

/* Empty state */
.games-empty {
  text-align: center; padding: 3rem 2rem; color: var(--text-muted);
}

/* Modal */
.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal[hidden] { display: none; }
.modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.6); }
.modal__content { position: relative; width: 90%; max-width: 500px; max-height: 90vh; overflow: auto; padding: 1.5rem; }
.modal__content h3 { margin: 0 0 0.75rem 0; }
.modal__actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
.form-field { margin-bottom: 1rem; }
.form-field label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 0.35rem; }
.form-field textarea, .form-field select {
  width: 100%; padding: 0.5rem 0.6rem;
  background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
  color: var(--fg); font-size: 0.9rem;
}
.filter-select {
  background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
  padding: 0.4rem 0.6rem; font-size: 0.85rem; color: var(--fg);
}
.required { color: #dc3545; }

@media (max-width: 640px) {
  .games-filters__row { flex-direction: column; align-items: stretch; }
  .games-filters__tabs { overflow-x: auto; flex-wrap: nowrap; }
  .game-details { grid-template-columns: 1fr 1fr; }
}
</style>

{% if site.run_submit_endpoint %}
<script>
  window.CRC_WORKER_URL = {{ site.run_submit_endpoint | jsonify }};
</script>
{% endif %}

<script type="module">
import { CRCAdmin } from '{{ "/assets/js/admin.js" | relative_url }}';

// =============================================================================
// State
// =============================================================================

let currentStatus = 'pending';
let allGames = [];
let currentRejectId = null;
let currentChangesId = null;

// =============================================================================
// DOM refs
// =============================================================================

const loadingEl = document.getElementById('loading-state');
const deniedEl = document.getElementById('not-authorized');
const contentEl = document.getElementById('games-content');
const gamesListEl = document.getElementById('games-list');
const gamesEmptyEl = document.getElementById('games-empty');
const statusTabsEl = document.getElementById('status-tabs');
const refreshBtn = document.getElementById('refresh-btn');
const pendingCountEl = document.getElementById('count-pending');

// Reject modal
const rejectModal = document.getElementById('reject-modal');
const rejectReasonEl = document.getElementById('reject-reason');
const rejectNotesEl = document.getElementById('reject-notes');
const rejectConfirmBtn = document.getElementById('reject-confirm-btn');
const rejectInfoEl = document.getElementById('reject-modal-info');

// Changes modal
const changesModal = document.getElementById('changes-modal');
const changesNotesEl = document.getElementById('changes-notes');
const changesConfirmBtn = document.getElementById('changes-confirm-btn');
const changesInfoEl = document.getElementById('changes-modal-info');

// =============================================================================
// Init
// =============================================================================

(async function() {
  const role = await CRCAdmin.init();

  if (!role || !CRCAdmin.isAdmin()) {
    showState('denied');
    return;
  }

  showState('ready');

  document.getElementById('games-role-info').textContent =
    `${CRCAdmin.roleLabel(role)} ‚Äî reviewing all games`;

  await loadGames();
  setupEventListeners();
})();

// =============================================================================
// State management
// =============================================================================

function showState(s) {
  loadingEl.hidden = s !== 'loading';
  deniedEl.hidden = s !== 'denied';
  contentEl.hidden = s !== 'ready';
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// =============================================================================
// Load games
// =============================================================================

async function loadGames() {
  gamesListEl.innerHTML = '<div class="games-loading"><div class="spinner"></div><p class="muted">Loading games...</p></div>';
  gamesEmptyEl.hidden = true;

  const result = await CRCAdmin.getPendingGames({ status: currentStatus });

  if (result.error) {
    gamesListEl.innerHTML = `<div class="card"><p class="muted">Error loading games: ${esc(result.error)}</p></div>`;
    return;
  }

  allGames = result.data;

  if (currentStatus === 'pending') {
    pendingCountEl.textContent = result.count;
  } else {
    const pending = await CRCAdmin.getPendingGames({ status: 'pending' });
    pendingCountEl.textContent = pending.count;
  }

  renderGames();
}

function renderGames() {
  if (allGames.length === 0) {
    gamesListEl.innerHTML = '';
    gamesEmptyEl.hidden = false;
    return;
  }

  gamesEmptyEl.hidden = true;
  gamesListEl.innerHTML = allGames.map(renderGameCard).join('');
}

// =============================================================================
// Render a game card
// =============================================================================

function renderGameCard(g) {
  const isPending = g.status === 'pending';
  const isNeedsChanges = g.status === 'needs_changes';
  const canAct = isPending || isNeedsChanges;

  const gd = g.game_data || {};
  const fullRuns = gd.full_runs || gd.full_run_categories || [];
  const miniChallenges = gd.mini_challenges || [];
  const challenges = gd.challenges_data || gd.challenges || [];
  const restrictions = gd.restrictions_data || [];
  const glitches = gd.glitches_data || [];
  const characters = gd.characters_data || [];
  const isModded = gd.is_modded === true || gd.is_modded === 'true';
  const charEnabled = gd.character_column?.enabled === true;

  // Tags
  const moddedTag = isModded
    ? `<span class="game-tag game-tag--modded">üîß Modded${gd.base_game ? ` (${esc(gd.base_game)})` : ''}</span>`
    : '';

  const categoryTags = (Array.isArray(fullRuns) ? fullRuns : [])
    .slice(0, 5)
    .map(c => `<span class="game-tag game-tag--category">${esc(typeof c === 'string' ? c : c.label || c.slug || '')}</span>`)
    .join('');

  const tagsHTML = (moddedTag || categoryTags)
    ? `<div class="game-tags">${moddedTag}${categoryTags}${fullRuns.length > 5 ? `<span class="game-tag">+${fullRuns.length - 5} more</span>` : ''}</div>`
    : '';

  // Details grid
  const details = [];
  details.push({ label: 'Game ID', value: `<code>${esc(g.game_id)}</code>` });
  details.push({ label: 'Categories', value: `${fullRuns.length || 0} full runs${miniChallenges.length ? `, ${miniChallenges.length} mini` : ''}` });
  details.push({ label: 'Challenges', value: `${challenges.length || 0} types` });
  details.push({ label: 'Characters', value: charEnabled ? 'Enabled' : 'Disabled' });
  details.push({ label: 'Timing', value: esc(gd.timing_method || 'RTA') });
  details.push({ label: 'Submitted by', value: esc(g.submitter_handle || 'Unknown') });
  details.push({ label: 'Submitted', value: CRCAdmin.formatTimestamp(g.submitted_at) });
  if (isModded && gd.base_game) details.push({ label: 'Base Game', value: `<code>${esc(gd.base_game)}</code>` });

  const detailsHTML = details.map(d =>
    `<div class="game-detail">
      <span class="game-detail__label">${d.label}</span>
      <span class="game-detail__value">${d.value}</span>
    </div>`
  ).join('');

  // Review sections
  function renderList(items) {
    if (!Array.isArray(items) || items.length === 0) return '<span class="muted">None</span>';
    return '<div class="review-section__list">' +
      items.map(i => `<span class="review-section__item">${esc(typeof i === 'string' ? i : i.label || i.slug || JSON.stringify(i))}</span>`).join('') +
    '</div>';
  }

  let sectionsHTML = '';

  sectionsHTML += `<div class="review-section">
    <div class="review-section__title">Full Run Categories (${fullRuns.length})</div>
    ${renderList(fullRuns)}
  </div>`;

  if (miniChallenges.length) {
    sectionsHTML += `<div class="review-section">
      <div class="review-section__title">Mini-Challenges (${miniChallenges.length})</div>
      ${renderList(miniChallenges)}
    </div>`;
  }

  sectionsHTML += `<div class="review-section">
    <div class="review-section__title">Challenge Types (${challenges.length})</div>
    ${renderList(challenges)}
  </div>`;

  if (restrictions.length) {
    sectionsHTML += `<div class="review-section">
      <div class="review-section__title">Restrictions (${restrictions.length})</div>
      ${renderList(restrictions)}
    </div>`;
  }

  if (glitches.length) {
    sectionsHTML += `<div class="review-section">
      <div class="review-section__title">Glitch Categories (${glitches.length})</div>
      ${renderList(glitches)}
    </div>`;
  }

  if (characters.length) {
    sectionsHTML += `<div class="review-section">
      <div class="review-section__title">Characters (${characters.length})</div>
      ${renderList(characters.slice(0, 20))}
      ${characters.length > 20 ? `<p class="muted" style="margin-top:0.5rem">... and ${characters.length - 20} more</p>` : ''}
    </div>`;
  }

  if (gd.general_rules) {
    sectionsHTML += `<div class="review-section">
      <div class="review-section__title">General Rules</div>
      <div class="review-rules">${esc(gd.general_rules)}</div>
    </div>`;
  }

  // Actions
  let actionsHTML = '';
  if (canAct) {
    actionsHTML = `
      <div class="game-actions">
        <button class="btn--approve" data-action="approve" data-id="${g.id}" type="button">‚úÖ Approve</button>
        <button class="btn--changes" data-action="changes" data-id="${g.id}" type="button">‚úèÔ∏è Request Changes</button>
        <button class="btn--reject" data-action="reject" data-id="${g.id}" type="button">‚ùå Reject</button>
      </div>`;
  }

  // Status bar
  let statusBarHTML = '';
  if (!isPending) {
    let statusInfo = `Status: ${g.status}`;
    if (g.reviewed_at) statusInfo += ` on ${CRCAdmin.formatDate(g.reviewed_at)}`;
    if (g.rejection_reason) statusInfo += ` ‚Äî Reason: ${g.rejection_reason}`;
    if (g.reviewer_notes) statusInfo += ` ‚Äî Notes: ${g.reviewer_notes}`;
    statusBarHTML = `<div class="game-status-bar">${statusInfo}</div>`;
  }

  return `
    <div class="game-card" data-game-id="${g.id}">
      <div class="game-card__header" data-toggle="${g.id}">
        <div>
          <div class="game-card__title">${esc(g.game_name)}</div>
          <div class="game-card__id">${esc(g.game_id)}</div>
        </div>
        <div class="game-card__meta">
          ${CRCAdmin.statusBadge(g.status)}
          <span>${CRCAdmin.formatDate(g.submitted_at)}</span>
        </div>
      </div>
      <div class="game-card__body">
        ${tagsHTML}
        <div class="game-details">${detailsHTML}</div>
        ${sectionsHTML}
        ${actionsHTML}
        ${statusBarHTML}
      </div>
    </div>`;
}

// =============================================================================
// Event listeners
// =============================================================================

function setupEventListeners() {
  // Status tabs
  statusTabsEl.addEventListener('click', (e) => {
    const tab = e.target.closest('.filter-tab');
    if (!tab) return;
    statusTabsEl.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentStatus = tab.dataset.status;
    loadGames();
  });

  // Refresh
  refreshBtn.addEventListener('click', () => loadGames());

  // Card toggle + action buttons
  gamesListEl.addEventListener('click', (e) => {
    const toggle = e.target.closest('[data-toggle]');
    if (toggle) {
      toggle.closest('.game-card').classList.toggle('expanded');
      return;
    }

    const actionBtn = e.target.closest('[data-action]');
    if (!actionBtn) return;

    const action = actionBtn.dataset.action;
    const gameId = actionBtn.dataset.id;
    const game = allGames.find(g => g.id === gameId);
    if (!game) return;

    if (action === 'approve') handleApprove(game, actionBtn);
    if (action === 'reject') openRejectModal(game);
    if (action === 'changes') openChangesModal(game);
  });

  // Modal close
  document.querySelectorAll('[data-close]').forEach(el => {
    el.addEventListener('click', () => {
      rejectModal.hidden = true;
      changesModal.hidden = true;
    });
  });

  rejectReasonEl.addEventListener('change', () => {
    rejectConfirmBtn.disabled = !rejectReasonEl.value;
  });
  rejectConfirmBtn.addEventListener('click', handleRejectConfirm);

  changesNotesEl.addEventListener('input', () => {
    changesConfirmBtn.disabled = !changesNotesEl.value.trim();
  });
  changesConfirmBtn.addEventListener('click', handleChangesConfirm);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      rejectModal.hidden = true;
      changesModal.hidden = true;
    }
  });
}

// =============================================================================
// Actions
// =============================================================================

async function handleApprove(game, btn) {
  if (!confirm(`Approve this game?\n\n${game.game_name} (${game.game_id})`)) return;

  btn.disabled = true;
  btn.textContent = 'Approving...';

  const result = await CRCAdmin.approveGame(game.id);

  if (result.error) {
    alert('Error approving game: ' + result.error);
    btn.disabled = false;
    btn.textContent = '‚úÖ Approve';
    return;
  }

  if (result.filename) {
    console.log(`[Games] Created file: _games/${result.filename}`);
  }

  const card = document.querySelector(`.game-card[data-game-id="${game.id}"]`);
  if (card) {
    const idx = allGames.findIndex(g => g.id === game.id);
    if (idx >= 0) allGames[idx] = result.data;
    card.outerHTML = renderGameCard(result.data);
  }

  if (currentStatus === 'pending') {
    setTimeout(() => {
      const updatedCard = document.querySelector(`.game-card[data-game-id="${game.id}"]`);
      if (updatedCard) {
        updatedCard.style.transition = 'opacity 0.3s';
        updatedCard.style.opacity = '0';
        setTimeout(() => {
          updatedCard.remove();
          allGames = allGames.filter(g => g.id !== game.id);
          if (allGames.length === 0) gamesEmptyEl.hidden = false;
          const count = parseInt(pendingCountEl.textContent) || 0;
          if (count > 0) pendingCountEl.textContent = count - 1;
        }, 300);
      }
    }, 800);
  }
}

function openRejectModal(game) {
  currentRejectId = game.id;
  rejectInfoEl.textContent = `${game.game_name} (${game.game_id})`;
  rejectReasonEl.value = '';
  rejectNotesEl.value = '';
  rejectConfirmBtn.disabled = true;
  rejectModal.hidden = false;
}

async function handleRejectConfirm() {
  if (!currentRejectId || !rejectReasonEl.value) return;

  rejectConfirmBtn.disabled = true;
  rejectConfirmBtn.textContent = 'Rejecting...';

  const result = await CRCAdmin.rejectGame(currentRejectId, rejectReasonEl.value, rejectNotesEl.value.trim());

  if (result.error) {
    alert('Error: ' + result.error);
    rejectConfirmBtn.disabled = false;
    rejectConfirmBtn.textContent = 'Reject Game';
    return;
  }

  rejectModal.hidden = true;
  const idx = allGames.findIndex(g => g.id === currentRejectId);
  if (idx >= 0) allGames[idx] = result.data;

  if (currentStatus === 'pending') {
    fadeOutAndRemove(`.game-card[data-game-id="${currentRejectId}"]`, currentRejectId);
  } else {
    const card = document.querySelector(`.game-card[data-game-id="${currentRejectId}"]`);
    if (card) card.outerHTML = renderGameCard(result.data);
  }

  rejectConfirmBtn.textContent = 'Reject Game';
  currentRejectId = null;
}

function openChangesModal(game) {
  currentChangesId = game.id;
  changesInfoEl.textContent = `${game.game_name} (${game.game_id})`;
  changesNotesEl.value = '';
  changesConfirmBtn.disabled = true;
  changesModal.hidden = false;
}

async function handleChangesConfirm() {
  if (!currentChangesId || !changesNotesEl.value.trim()) return;

  changesConfirmBtn.disabled = true;
  changesConfirmBtn.textContent = 'Sending...';

  const result = await CRCAdmin.requestGameChanges(currentChangesId, changesNotesEl.value.trim());

  if (result.error) {
    alert('Error: ' + result.error);
    changesConfirmBtn.disabled = false;
    changesConfirmBtn.textContent = 'Send Request';
    return;
  }

  changesModal.hidden = true;
  const idx = allGames.findIndex(g => g.id === currentChangesId);
  if (idx >= 0) allGames[idx] = result.data;

  if (currentStatus === 'pending') {
    fadeOutAndRemove(`.game-card[data-game-id="${currentChangesId}"]`, currentChangesId);
  } else {
    const card = document.querySelector(`.game-card[data-game-id="${currentChangesId}"]`);
    if (card) card.outerHTML = renderGameCard(result.data);
  }

  changesConfirmBtn.textContent = 'Send Request';
  currentChangesId = null;
}

// =============================================================================
// Helpers
// =============================================================================

function fadeOutAndRemove(selector, id) {
  const card = document.querySelector(selector);
  if (card) {
    card.style.transition = 'opacity 0.3s';
    card.style.opacity = '0';
    setTimeout(() => {
      card.remove();
      allGames = allGames.filter(g => g.id !== id);
      if (allGames.length === 0) gamesEmptyEl.hidden = false;
      const count = parseInt(pendingCountEl.textContent) || 0;
      if (count > 0) pendingCountEl.textContent = count - 1;
    }, 300);
  }
}
</script>
