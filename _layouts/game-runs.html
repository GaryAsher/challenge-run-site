---
layout: default
---

{% assign game = site.games | where: "game_id", page.game_id | first %}
{% include game-header-tabs.html game=game active="runs" %}

<!-- =========================================================
     Page context from front matter
     ========================================================= -->
{% assign page_type = page.page_type | default: "tier_picker" %}
{% assign active_tier = page.category_tier | default: "" %}
{% assign active_tier_slug = page.tier_slug | default: "" %}
{% assign active_cat_slug = page.category_slug | default: "" | strip %}

<!-- =========================================================
     Tier configuration
     ========================================================= -->
{% assign tier_config = "" | split: "" %}
{% assign tier_full_runs = "full_runs||full-runs||Full Runs" %}
{% assign tier_mini_challenges = "mini_challenges||mini-challenges||Mini-Challenges" %}
{% assign tier_player_made = "player_made||player-made||Player-Made" %}
{% assign tier_config = tier_config | push: tier_full_runs | push: tier_mini_challenges | push: tier_player_made %}

<!-- =========================================================
     Base paths
     ========================================================= -->
{% assign game_base = game.url | default: "" %}
{% if game_base == "" %}
  {% assign game_base = "/games/" | append: page.game_id | append: "/" %}
{% endif %}
{% assign runs_base = game_base | append: "runs/" %}

<!-- =========================================================
     Determine which tiers have categories
     ========================================================= -->
{% assign has_full_runs = false %}
{% assign has_mini_challenges = false %}
{% assign has_player_made = false %}

{% if game.full_runs and game.full_runs.size > 0 %}
  {% assign has_full_runs = true %}
{% endif %}
{% if game.mini_challenges and game.mini_challenges.size > 0 %}
  {% assign has_mini_challenges = true %}
{% endif %}
{% if game.player_made and game.player_made.size > 0 %}
  {% assign has_player_made = true %}
{% endif %}

<!-- Legacy support: if categories_data exists but no tiered data, treat as full_runs -->
{% if has_full_runs == false and has_mini_challenges == false and has_player_made == false %}
  {% if game.categories_data and game.categories_data.size > 0 %}
    {% assign has_full_runs = true %}
  {% endif %}
{% endif %}

{% assign tier_count = 0 %}
{% if has_full_runs %}{% assign tier_count = tier_count | plus: 1 %}{% endif %}
{% if has_mini_challenges %}{% assign tier_count = tier_count | plus: 1 %}{% endif %}
{% if has_player_made %}{% assign tier_count = tier_count | plus: 1 %}{% endif %}

<!-- =========================================================
     Build category lists for current tier
     ========================================================= -->
{% assign current_tier_categories = "" | split: "" %}
{% assign category_pairs = "" | split: "" %}

{% if active_tier == "full_runs" or active_tier == "" %}
  {% if game.full_runs and game.full_runs.size > 0 %}
    {% assign current_tier_categories = game.full_runs %}
  {% elsif game.categories_data and game.categories_data.size > 0 %}
    {% assign current_tier_categories = game.categories_data %}
  {% endif %}
{% elsif active_tier == "mini_challenges" %}
  {% if game.mini_challenges and game.mini_challenges.size > 0 %}
    {% assign current_tier_categories = game.mini_challenges %}
  {% endif %}
{% elsif active_tier == "player_made" %}
  {% if game.player_made and game.player_made.size > 0 %}
    {% assign current_tier_categories = game.player_made %}
  {% endif %}
{% endif %}

<!-- Build category pairs for label lookup -->
{% for c in current_tier_categories %}
  {% assign pslug = c.slug | default: "" | strip %}
  {% if pslug != "" %}
    {% assign plabel = c.label | default: pslug | strip %}
    {% assign pair = pslug | append: "||" | append: plabel %}
    {% assign category_pairs = category_pairs | push: pair %}

    {% if c.children and c.children.size > 0 %}
      {% for ch in c.children %}
        {% assign cslug = ch.slug | default: "" | strip %}
        {% if cslug != "" %}
          {% assign full_slug = pslug | append: "/" | append: cslug %}
          {% assign clabel = ch.label | default: cslug | strip %}
          {% assign cpair = full_slug | append: "||" | append: clabel %}
          {% assign category_pairs = category_pairs | push: cpair %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endif %}
{% endfor %}

<!-- =========================================================
     Resolve active category label
     ========================================================= -->
{% assign active_cat_label = "" %}
{% assign parent_slug = "" %}
{% assign parent_label = "" %}
{% assign is_child_page = false %}

{% if active_cat_slug != "" %}
  {% if active_cat_slug contains "/" %}
    {% assign is_child_page = true %}
    {% assign parent_slug = active_cat_slug | split: "/" | first | strip %}
  {% else %}
    {% assign parent_slug = active_cat_slug %}
  {% endif %}

  {% for p in category_pairs %}
    {% assign parts = p | split: "||" %}
    {% assign s = parts[0] | strip %}
    {% assign lbl = parts[1] | default: s | strip %}
    {% if s == active_cat_slug %}
      {% assign active_cat_label = lbl %}
      {% break %}
    {% elsif s == parent_slug %}
      {% assign parent_label = lbl %}
    {% endif %}
  {% endfor %}

  {% if active_cat_label == "" %}
    {% assign active_cat_label = active_cat_slug %}
  {% endif %}
{% endif %}

<!-- Get child categories for current parent -->
{% assign child_pairs = "" | split: "" %}
{% if parent_slug != "" %}
  {% for c in current_tier_categories %}
    {% if c.slug == parent_slug and c.children and c.children.size > 0 %}
      {% for ch in c.children %}
        {% assign full_slug = parent_slug | append: "/" | append: ch.slug %}
        {% assign cpair = full_slug | append: "||" | append: ch.label %}
        {% assign child_pairs = child_pairs | push: cpair %}
      {% endfor %}
    {% endif %}
  {% endfor %}
{% endif %}

<!-- =========================================================
     Pull runs from the _runs collection
     ========================================================= -->
{% assign cleaned = "" | split: "" %}
{% for r in site.runs %}
  {% if r and r.game_id %}
    {% assign cleaned = cleaned | push: r %}
  {% endif %}
{% endfor %}

{% assign cleaned_for_game = cleaned | where: "game_id", page.game_id %}
{% assign runs = cleaned_for_game | sort: "date_completed" | reverse %}

<!-- Filter runs by tier if on tier_index or category page -->
{% if page_type == "tier_index" or page_type == "category" %}
  {% assign tier_filtered = "" | split: "" %}
  {% for r in runs %}
    {% assign run_tier = r.category_tier | default: "full_runs" %}
    {% if run_tier == active_tier %}
      {% assign tier_filtered = tier_filtered | push: r %}
    {% endif %}
  {% endfor %}
  {% assign runs = tier_filtered %}
{% endif %}

<!-- Filter runs by category if on category page -->
{% if page_type == "category" and active_cat_slug != "" %}
  {% assign prefix_check = active_cat_slug | append: "/" %}
  {% assign filtered = "" | split: "" %}
  {% for r in runs %}
    {% assign rs = r.category_slug | default: "" | strip %}
    {% if rs == active_cat_slug %}
      {% assign filtered = filtered | push: r %}
    {% else %}
      {% assign rs_len = rs | size %}
      {% assign prefix_len = prefix_check | size %}
      {% if rs_len >= prefix_len %}
        {% assign rs_head = rs | slice: 0, prefix_len %}
        {% if rs_head == prefix_check %}
          {% assign filtered = filtered | push: r %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endfor %}
  {% assign runs = filtered %}
{% endif %}

<!-- =========================================================
     Main Content
     ========================================================= -->
<div class="page-width">
  <div class="game-shell">
    <div class="card">
      <!-- =========================================================
           Tier Sub-Navigation (always show if tiers exist)
           ========================================================= -->
      {% if tier_count > 0 %}
        <nav class="tier-nav" aria-label="Category tiers">
          {% if has_full_runs %}
            {% assign is_active_tier = false %}
            {% if active_tier == "full_runs" or active_tier == "" and page_type != "tier_picker" %}
              {% assign is_active_tier = true %}
            {% endif %}
            <a href="{{ runs_base }}full-runs/" 
               class="tier-tab{% if is_active_tier %} is-active{% endif %}"
               {% if is_active_tier %}aria-current="page"{% endif %}>
              Full Runs
            </a>
          {% endif %}

          {% if has_mini_challenges %}
            <a href="{{ runs_base }}mini-challenges/" 
               class="tier-tab{% if active_tier == 'mini_challenges' %} is-active{% endif %}"
               {% if active_tier == 'mini_challenges' %}aria-current="page"{% endif %}>
              Mini-Challenges
            </a>
          {% endif %}

          {% if has_player_made %}
            <a href="{{ runs_base }}player-made/" 
               class="tier-tab{% if active_tier == 'player_made' %} is-active{% endif %}"
               {% if active_tier == 'player_made' %}aria-current="page"{% endif %}>
              Player-Made
            </a>
          {% endif %}
        </nav>
      {% endif %}

      <!-- =========================================================
           TIER PICKER PAGE (runs/index.html)
           ========================================================= -->
      {% if page_type == "tier_picker" %}
        <section class="tab-panel active" data-panel="runs">
          <div class="runs-header" style="margin-top: 1rem;">
            <p class="muted mt-0 mb-0">Select a category type to browse runs for {{ game.game_name }}.</p>
            <a href="{{ game_base }}submit/" class="btn btn--primary btn--submit">+ Submit a Run</a>
          </div>

          <div class="tier-cards">
            {% if has_full_runs %}
              <a href="{{ runs_base }}full-runs/" class="tier-card tier-card--full-runs">
                <h3 class="tier-card__title">üèÅ Full Runs</h3>
                <p class="tier-card__desc muted">Categories that require reaching an ending</p>
                <span class="tier-card__count">
                  {% assign count = 0 %}
                  {% if game.full_runs %}{% assign count = game.full_runs.size %}
                  {% elsif game.categories_data %}{% assign count = game.categories_data.size %}{% endif %}
                  {{ count }} categor{% if count == 1 %}y{% else %}ies{% endif %}
                </span>
              </a>
            {% endif %}

            {% if has_mini_challenges %}
              <a href="{{ runs_base }}mini-challenges/" class="tier-card tier-card--mini-challenges">
                <h3 class="tier-card__title">‚ö° Mini-Challenges</h3>
                <p class="tier-card__desc muted">In-game challenges without requiring an ending</p>
                <span class="tier-card__count">
                  {{ game.mini_challenges.size }} categor{% if game.mini_challenges.size == 1 %}y{% else %}ies{% endif %}
                </span>
              </a>
            {% endif %}

            {% if has_player_made %}
              <a href="{{ runs_base }}player-made/" class="tier-card tier-card--player-made">
                <h3 class="tier-card__title">üé® Player-Made</h3>
                <p class="tier-card__desc muted">Community-created challenges with arbitrary goals</p>
                <span class="tier-card__count">
                  {{ game.player_made.size }} categor{% if game.player_made.size == 1 %}y{% else %}ies{% endif %}
                </span>
              </a>
            {% endif %}

            {% if tier_count == 0 %}
              <div class="card">
                <p class="muted">No categories have been set up for this game yet.</p>
              </div>
            {% endif %}
          </div>
        </section>

      <!-- =========================================================
           TIER INDEX PAGE (runs/full-runs/index.html, etc.)
           Shows runs table directly with category filter at top
           ========================================================= -->
      {% elsif page_type == "tier_index" %}
        <section class="tab-panel active" data-panel="runs">
          <div class="runs-header" style="margin-top: 1rem;">
            <div class="runs-header__left">
              <!-- Category picker dropdown -->
              {% if current_tier_categories and current_tier_categories.size > 0 %}
                <div class="category-picker">
                  <label for="category-filter" class="muted">Category:</label>
                  <select id="category-filter" class="select category-picker__select" onchange="filterByCategory(this.value)">
                    <option value="">All {{ active_tier | replace: "_", " " | capitalize }}</option>
                    {% for cat in current_tier_categories %}
                      <option value="{{ cat.slug }}">{{ cat.label }}</option>
                      {% if cat.children and cat.children.size > 0 %}
                        {% for child in cat.children %}
                          <option value="{{ cat.slug }}/{{ child.slug }}">  ‚Ü≥ {{ child.label }}</option>
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              {% endif %}
            </div>
            <a href="{{ game_base }}submit/" class="btn btn--primary btn--submit">+ Submit a Run</a>
          </div>

          <!-- Column flags for runs table -->
          {% assign show_character = false %}
          {% assign character_label = "Character" %}
          {% if game.character_column and game.character_column.enabled %}
            {% assign show_character = true %}
            {% if game.character_column.label %}
              {% assign character_label = game.character_column.label %}
            {% endif %}
          {% endif %}

          {% assign show_glitches = false %}
          {% if game.glitches_data and game.glitches_data.size > 0 %}
            {% assign show_glitches = true %}
          {% endif %}

          <!-- Runs table for tier index -->
          {% if runs and runs.size > 0 %}
            <div class="table-wrap" style="margin-top: 1rem;">
              <table class="runs-table" id="tier-runs-table">
                <thead>
                  <tr>
                    <th>Runner</th>
                    <th>Category</th>
                    {% if show_character %}<th>{{ character_label }}</th>{% endif %}
                    <th>Challenge</th>
                    <th>Restrictions</th>
                    {% if show_glitches %}<th>Glitches Used</th>{% endif %}
                    <th class="th-filter th-time">
                      <div class="th-title"><span>Time{% if game.timing_method %} ({{ game.timing_method }}){% endif %}</span></div>
                    </th>
                    <th class="th-filter th-date">
                      <div class="th-title"><span>Date</span></div>
                    </th>
                    <th>Video</th>
                  </tr>
                </thead>
                <tbody id="runs-body">
                  {% for r in runs %}
                    {% comment %} Build challenge labels {% endcomment %}
                    {% assign challenge_labels = "" | split: "" %}
                    {% assign challenge_ids = "" | split: "" %}
                    
                    {% if r.standard_challenges and r.standard_challenges.size > 0 %}
                      {% for ch_id in r.standard_challenges %}
                        {% assign meta = site.data.challenges[ch_id] %}
                        {% assign ch_label = ch_id %}
                        {% if meta and meta.label %}{% assign ch_label = meta.label %}{% endif %}
                        {% for gc in game.challenges_data %}
                          {% if gc.slug == ch_id %}{% assign ch_label = gc.label %}{% endif %}
                        {% endfor %}
                        {% assign challenge_labels = challenge_labels | push: ch_label %}
                        {% assign challenge_ids = challenge_ids | push: ch_id %}
                      {% endfor %}
                    {% endif %}
                    
                    {% if r.community_challenge and r.community_challenge != "" %}
                      {% assign cc_label = r.community_challenge %}
                      {% for cc in game.community_challenges %}
                        {% if cc.slug == r.community_challenge %}{% assign cc_label = cc.label %}{% endif %}
                      {% endfor %}
                      {% assign challenge_labels = challenge_labels | push: cc_label %}
                      {% assign challenge_ids = challenge_ids | push: r.community_challenge %}
                    {% endif %}
                    
                    {% if challenge_ids.size == 0 and r.challenge_id %}
                      {% assign meta = site.data.challenges[r.challenge_id] %}
                      {% assign ch_label = r.challenge_id %}
                      {% if meta and meta.label %}{% assign ch_label = meta.label %}{% endif %}
                      {% assign challenge_labels = challenge_labels | push: ch_label %}
                      {% assign challenge_ids = challenge_ids | push: r.challenge_id %}
                    {% endif %}
                    
                    {% assign runner_label = r.runner | default: r.runner_id | default: "‚Äî" | replace: "_", " " %}

                    {% comment %} Get category label {% endcomment %}
                    {% assign cat_label = r.category | default: "" | strip %}
                    {% if cat_label == "" %}
                      {% assign s = r.category_slug | default: "" | strip %}
                      {% if s != "" %}
                        {% for p in category_pairs %}
                          {% assign parts = p | split: "||" %}
                          {% if parts[0] == s %}
                            {% assign cat_label = parts[1] | default: s | strip %}
                            {% break %}
                          {% endif %}
                        {% endfor %}
                        {% if cat_label == "" %}{% assign cat_label = s %}{% endif %}
                      {% endif %}
                    {% endif %}
                    {% if cat_label == "" %}{% assign cat_label = "‚Äî" %}{% endif %}

                    {% assign r_texts = "" | split: "" %}
                    {% if r.restrictions and r.restrictions != empty %}
                      {% if r.restrictions.first %}
                        {% assign r_texts = r.restrictions %}
                      {% elsif r.restrictions != "[]" and r.restrictions != "" %}
                        {% assign r_texts = r.restrictions | split: "," %}
                      {% endif %}
                    {% endif %}
                    {% assign r_clean = "" | split: "" %}
                    {% for rr in r_texts %}
                      {% assign t = rr | strip %}
                      {% if t != "" and t != "[]" %}{% assign r_clean = r_clean | push: t %}{% endif %}
                    {% endfor %}
                    {% assign r_texts = r_clean | uniq %}

                    {% assign video_url = r.video_url | default: r.video %}

                    <tr class="run-row"
                        data-category-slug="{{ r.category_slug | default: '' | escape }}">
                      <td data-label="Runner">
                        {% if r.runner_id %}
                          <a href="{{ '/runners/' | relative_url }}{{ r.runner_id }}/">{{ runner_label }}</a>
                        {% else %}
                          {{ runner_label }}
                        {% endif %}
                      </td>

                      <td data-label="Category">
                        <a href="{{ runs_base }}{{ active_tier_slug }}/{{ r.category_slug }}/">{{ cat_label }}</a>
                      </td>

                      {% if show_character %}
                        {% assign char_display = r.character | default: "‚Äî" %}
                        {% if r.character and r.character != "" %}
                          {% for char in game.characters_data %}
                            {% if char.slug == r.character %}{% assign char_display = char.label %}{% endif %}
                          {% endfor %}
                        {% endif %}
                        <td data-label="{{ character_label }}">{{ char_display }}</td>
                      {% endif %}

                      <td data-label="Challenge">
                        {% if challenge_labels and challenge_labels.size > 0 %}
                          <div class="cell-tags">{% for ch in challenge_labels %}<span class="tag">{{ ch }}</span>{% endfor %}</div>
                        {% else %}‚Äî{% endif %}
                      </td>

                      <td data-label="Restrictions">
                        {% if r_texts and r_texts.size > 0 %}
                          <div class="cell-tags">
                            {% for rr in r_texts %}
                              {% assign rest_label = rr %}
                              {% for rest in game.restrictions_data %}
                                {% if rest.slug == rr %}{% assign rest_label = rest.label %}{% endif %}
                              {% endfor %}
                              <span class="tag">{{ rest_label }}</span>
                            {% endfor %}
                          </div>
                        {% else %}‚Äî{% endif %}
                      </td>

                      {% if show_glitches %}
                        <td data-label="Glitches">
                          {% assign glitch_label = r.glitch_id | default: "" %}
                          {% if glitch_label != "" %}
                            {% for gl in game.glitches_data %}
                              {% if gl.slug == r.glitch_id %}{% assign glitch_label = gl.label %}{% endif %}
                              {% if gl.children %}
                                {% for child in gl.children %}
                                  {% if child.slug == r.glitch_id %}{% assign glitch_label = child.label %}{% endif %}
                                {% endfor %}
                              {% endif %}
                            {% endfor %}
                            <span class="tag">{{ glitch_label }}</span>
                          {% else %}‚Äî{% endif %}
                        </td>
                      {% endif %}

                      <td data-label="Time">{{ r.time_primary | default: r.time | default: "‚Äî" }}</td>
                      <td data-label="Date">
                        {% assign run_date = r.date_completed | default: r.date %}
                        {% if run_date %}{{ run_date | date: "%Y-%m-%d" }}{% else %}‚Äî{% endif %}
                      </td>
                      <td data-label="Video">
                        {% if video_url %}
                          {% assign video_source = "Link" %}
                          {% if video_url contains "youtube.com" or video_url contains "youtu.be" %}{% assign video_source = "YouTube" %}
                          {% elsif video_url contains "twitch.tv" %}{% assign video_source = "Twitch" %}
                          {% elsif video_url contains "bilibili.com" %}{% assign video_source = "Bilibili" %}
                          {% elsif video_url contains "vimeo.com" %}{% assign video_source = "Vimeo" %}{% endif %}
                          <a class="video-link" href="{{ video_url }}" target="_blank" rel="noopener">{{ video_source }}</a>
                        {% else %}‚Äî{% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="empty-state" style="margin-top: 1rem; padding: 2rem; text-align: center;">
              <p class="muted">No runs recorded yet in this tier.</p>
            </div>
          {% endif %}
        </section>

        <script>
        function filterByCategory(slug) {
          if (slug) {
            window.location.href = '{{ runs_base }}{{ active_tier_slug }}/' + slug + '/';
          }
        }
        </script>

      <!-- =========================================================
           Breadcrumb Navigation (for category pages)
           ========================================================= -->
      {% elsif page_type == "category" %}
        <div class="breadcrumb-nav" style="margin-top: 1rem; margin-bottom: 1rem;">
          <p class="muted" style="margin: 0;">
            <a href="{{ runs_base }}{{ active_tier_slug }}/">‚Üê Back to {{ active_tier | replace: "_", " " | capitalize }}</a>

            {% assign parts = active_cat_slug | split: "/" %}
            {% assign cur = "" %}
            {% for seg in parts %}
              {% assign seg_clean = seg | strip %}
              {% if seg_clean == "" %}{% continue %}{% endif %}

              {% if cur == "" %}
                {% assign cur = seg_clean %}
              {% else %}
                {% assign cur = cur | append: "/" | append: seg_clean %}
              {% endif %}

              {% assign crumb_label = "" %}
              {% for p in category_pairs %}
                {% assign kv = p | split: "||" %}
                {% assign s = kv[0] | strip %}
                {% if s == cur %}
                  {% assign crumb_label = kv[1] | default: cur | strip %}
                  {% break %}
                {% endif %}
              {% endfor %}
              {% if crumb_label == "" %}
                {% assign crumb_label = seg_clean %}
              {% endif %}

              <span class="muted"> / </span>

              {% if forloop.last %}
                <span>{{ crumb_label }}</span>
              {% else %}
                <a href="{{ runs_base }}{{ active_tier_slug }}/{{ cur | url_encode }}/">{{ crumb_label }}</a>
              {% endif %}
            {% endfor %}
          </p>
        </div>

        <section class="tab-panel active" data-panel="runs">
          <div class="runs-header">
            <p class="muted mt-0 mb-0">Showing runs in: <strong>{{ active_cat_label }}</strong></p>
            <a href="{{ game_base }}submit/" class="btn btn--primary btn--submit">+ Submit a Run</a>
          </div>

        <!-- Subcategory picker (if this category has children) -->
        {% if child_pairs and child_pairs.size > 0 %}
          <div class="card card--compact" style="margin-bottom: 1rem;">
            <p class="muted" style="margin: 0 0 0.5rem 0;">Pick a subcategory:</p>
            <div class="tag-picked">
              {% for p in child_pairs %}
                {% assign parts = p | split: "||" %}
                {% assign s = parts[0] | strip %}
                {% assign lbl = parts[1] | default: s | strip %}
                {% if s != "" %}
                  {% if s == active_cat_slug %}
                    <a class="tag-chip is-active" aria-current="page" href="{{ runs_base }}{{ active_tier_slug }}/{{ s | url_encode }}/">{{ lbl }}</a>
                  {% else %}
                    <a class="tag-chip" href="{{ runs_base }}{{ active_tier_slug }}/{{ s | url_encode }}/">{{ lbl }}</a>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <!-- Column flags -->
        {% assign show_character = false %}
        {% assign character_label = "Character" %}
        {% if game.character_column and game.character_column.enabled %}
          {% assign show_character = true %}
          {% if game.character_column.label %}
            {% assign character_label = game.character_column.label %}
          {% endif %}
        {% endif %}

        {% assign show_glitches = false %}
        {% if game.glitches_data and game.glitches_data.size > 0 %}
          {% assign show_glitches = true %}
        {% endif %}

        <div class="card card--compact">
          <!-- Search row -->
          <div class="runs-filters runs-filters--main">
            <div class="runs-filter runs-filter--search">
              <span class="muted filter-label-text">Search</span>
              <input
                id="q"
                class="filter"
                type="text"
                placeholder="Search {% if show_character %}{{ character_label | downcase }}, {% endif %}runner, challenge, restrictions{% if show_glitches %}, glitches{% endif %}..."
                autocomplete="off"
                inputmode="search"
                enterkeyhint="search"
              >
            </div>

            <div class="runs-filter">
              <button class="btn btn--filter-toggle" id="filter-toggle" type="button" aria-expanded="false" aria-controls="advanced-filters">
                <span class="filter-toggle__icon">‚ñº</span>
                <span class="filter-toggle__text">Advanced Filters</span>
              </button>
            </div>
          </div>

          <!-- Advanced filters -->
          <div class="runs-filters runs-filters--advanced" id="advanced-filters" hidden>
            {% if show_character %}
              <div class="runs-filter" data-filter-order="1">
                <span class="muted filter-label-text">{{ character_label }}</span>
                <select id="f-character" class="select filter th-caret" autocomplete="off">
                  <option value="">All</option>
                </select>
              </div>
            {% endif %}

            <div class="runs-filter" data-filter-order="2">
              <span class="muted filter-label-text">Challenge</span>
              <select id="f-challenge" class="select filter th-caret" autocomplete="off">
                <option value="">All</option>
              </select>
            </div>

            {% if game.restrictions_data and game.restrictions_data.size > 0 %}
              <div class="runs-filter" data-filter-order="3">
                <span class="muted filter-label-text">Restrictions</span>
                <select id="f-restrictions" class="select filter th-caret" autocomplete="off">
                  <option value="">All</option>
                </select>
              </div>
            {% endif %}

            {% if show_glitches %}
              <div class="runs-filter" data-filter-order="4">
                <span class="muted filter-label-text">Glitch Category</span>
                <select id="f-glitch" class="select filter th-caret" autocomplete="off">
                  <option value="">All</option>
                  {% for gl in game.glitches_data %}
                    <option value="{{ gl.slug }}">{{ gl.label }}</option>
                  {% endfor %}
                </select>
              </div>
            {% endif %}

            <div class="runs-filter runs-filter--reset">
              <button type="button" class="btn btn--outline btn--reset" id="reset-filters">
                Remove all filters
              </button>
            </div>
          </div>

          <div class="active-filters" id="active-filters"></div>
        </div>

        <div class="results-status" id="results-status">
          <span class="results-status__text" id="results-text"></span>
        </div>

        <!-- Runs table -->
        {% if runs and runs.size > 0 %}
          <div class="table-wrap">
            <table class="runs-table">
              <thead>
                <tr>
                  <th>Runner</th>
                  {% if show_character %}<th>{{ character_label }}</th>{% endif %}
                  <th>Challenge</th>
                  <th>Restrictions</th>
                  {% if show_glitches %}<th>Glitches Used</th>{% endif %}
                  <th class="th-filter th-time">
                    <div class="th-title"><span>Time{% if game.timing_method %} ({{ game.timing_method }}){% endif %}</span></div>
                    <div class="th-time-sort" aria-label="Sort by Time">
                      <button class="th-sort" id="th-time-asc" type="button" title="Sort fastest first">‚Üë</button>
                      <button class="th-sort" id="th-time-desc" type="button" title="Sort slowest first">‚Üì</button>
                    </div>
                  </th>
                  <th class="th-filter th-date">
                    <div class="th-title"><span>Date Accomplished</span></div>
                    <div class="th-date-sort" aria-label="Sort by Date">
                      <button class="th-sort" id="th-sort-asc" type="button" title="Sort oldest to newest">‚Üë</button>
                      <button class="th-sort" id="th-sort-desc" type="button" title="Sort newest to oldest">‚Üì</button>
                    </div>
                  </th>
                  <th>Video</th>
                </tr>
              </thead>
              <tbody id="runs-body">
                {% for r in runs %}
                  {% comment %} Build challenge labels {% endcomment %}
                  {% assign challenge_labels = "" | split: "" %}
                  {% assign challenge_ids = "" | split: "" %}
                  {% assign all_aliases = "" | split: "" %}
                  
                  {% if r.standard_challenges and r.standard_challenges.size > 0 %}
                    {% for ch_id in r.standard_challenges %}
                      {% assign meta = site.data.challenges[ch_id] %}
                      {% assign ch_label = ch_id %}
                      {% if meta and meta.label %}{% assign ch_label = meta.label %}{% endif %}
                      {% for gc in game.challenges_data %}
                        {% if gc.slug == ch_id %}{% assign ch_label = gc.label %}{% endif %}
                      {% endfor %}
                      {% assign challenge_labels = challenge_labels | push: ch_label %}
                      {% assign challenge_ids = challenge_ids | push: ch_id %}
                      {% if meta and meta.aliases %}
                        {% for a in meta.aliases %}{% assign all_aliases = all_aliases | push: a %}{% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  
                  {% if r.community_challenge and r.community_challenge != "" %}
                    {% assign cc_label = r.community_challenge %}
                    {% for cc in game.community_challenges %}
                      {% if cc.slug == r.community_challenge %}{% assign cc_label = cc.label %}{% endif %}
                    {% endfor %}
                    {% assign challenge_labels = challenge_labels | push: cc_label %}
                    {% assign challenge_ids = challenge_ids | push: r.community_challenge %}
                  {% endif %}
                  
                  {% if challenge_ids.size == 0 and r.challenge_id %}
                    {% assign meta = site.data.challenges[r.challenge_id] %}
                    {% assign ch_label = r.challenge_id %}
                    {% if meta and meta.label %}{% assign ch_label = meta.label %}{% endif %}
                    {% assign challenge_labels = challenge_labels | push: ch_label %}
                    {% assign challenge_ids = challenge_ids | push: r.challenge_id %}
                    {% if meta and meta.aliases %}{% assign all_aliases = meta.aliases %}{% endif %}
                  {% endif %}
                  
                  {% assign challenge_aliases = all_aliases | join: '||' %}
                  {% assign runner_label = r.runner | default: r.runner_id | default: "‚Äî" | replace: "_", " " %}

                  {% assign r_texts = "" | split: "" %}
                  {% if r.restrictions and r.restrictions != empty %}
                    {% if r.restrictions.first %}
                      {% assign r_texts = r.restrictions %}
                    {% elsif r.restrictions != "[]" and r.restrictions != "" %}
                      {% assign r_texts = r.restrictions | split: "," %}
                    {% endif %}
                  {% endif %}
                  {% assign r_clean = "" | split: "" %}
                  {% for rr in r_texts %}
                    {% assign t = rr | strip %}
                    {% if t != "" and t != "[]" %}{% assign r_clean = r_clean | push: t %}{% endif %}
                  {% endfor %}
                  {% assign r_texts = r_clean | uniq %}

                  {% assign video_url = r.video_url | default: r.video %}

                  <tr class="run-row"
                      data-runner="{{ r.runner_id | default: r.runner | default: '' | escape }}"
                      data-runner-name="{{ runner_label | default: '' | escape }}"
                      data-category-slug="{{ r.category_slug | default: '' | escape }}"
                      data-challenge-id="{{ challenge_ids | join: '||' | escape }}"
                      data-challenge-label="{{ challenge_labels | join: '||' | escape }}"
                      data-challenge-aliases="{{ challenge_aliases | escape }}"
                      {% if show_character %}data-character="{{ r.character | default: '' | escape }}"{% endif %}
                      data-restrictions="{{ r_texts | join: '||' | escape }}"
                      {% if show_glitches %}data-glitch="{{ r.glitch_id | default: '' | escape }}"{% endif %}
                      data-date="{{ r.date_completed | default: r.date | default: '' | escape }}"
                      data-time="{{ r.time_primary | default: r.time | default: '' | escape }}">
                    <td data-label="Runner">
                      {% if r.runner_id %}
                        <a href="{{ '/runners/' | relative_url }}{{ r.runner_id }}/">{{ runner_label }}</a>
                      {% else %}
                        {{ runner_label }}
                      {% endif %}
                    </td>

                    {% if show_character %}
                      {% assign char_display = r.character | default: "‚Äî" %}
                      {% if r.character and r.character != "" %}
                        {% for char in game.characters_data %}
                          {% if char.slug == r.character %}{% assign char_display = char.label %}{% endif %}
                        {% endfor %}
                      {% endif %}
                      <td data-label="{{ character_label }}">{{ char_display }}</td>
                    {% endif %}

                    <td data-label="Challenge">
                      {% if challenge_labels and challenge_labels.size > 0 %}
                        <div class="cell-tags">{% for ch in challenge_labels %}<span class="tag">{{ ch }}</span>{% endfor %}</div>
                      {% else %}‚Äî{% endif %}
                    </td>

                    <td data-label="Restrictions">
                      {% if r_texts and r_texts.size > 0 %}
                        <div class="cell-tags">
                          {% for rr in r_texts %}
                            {% assign rest_label = rr %}
                            {% for rest in game.restrictions_data %}
                              {% if rest.slug == rr %}{% assign rest_label = rest.label %}{% endif %}
                            {% endfor %}
                            <span class="tag">{{ rest_label }}</span>
                          {% endfor %}
                        </div>
                      {% else %}‚Äî{% endif %}
                    </td>

                    {% if show_glitches %}
                      <td data-label="Glitches">
                        {% assign glitch_label = r.glitch_id | default: "" %}
                        {% if glitch_label != "" %}
                          {% for gl in game.glitches_data %}
                            {% if gl.slug == r.glitch_id %}{% assign glitch_label = gl.label %}{% endif %}
                            {% if gl.children %}
                              {% for child in gl.children %}
                                {% if child.slug == r.glitch_id %}{% assign glitch_label = child.label %}{% endif %}
                              {% endfor %}
                            {% endif %}
                          {% endfor %}
                          <span class="tag">{{ glitch_label }}</span>
                        {% else %}‚Äî{% endif %}
                      </td>
                    {% endif %}

                    <td data-label="Time">{{ r.time_primary | default: r.time | default: "‚Äî" }}</td>
                    <td data-label="Date">
                      {% assign run_date = r.date_completed | default: r.date %}
                      {% if run_date %}{{ run_date | date: "%Y-%m-%d" }}{% else %}‚Äî{% endif %}
                    </td>
                    <td data-label="Video">
                      {% if video_url %}
                        {% assign video_source = "Link" %}
                        {% if video_url contains "youtube.com" or video_url contains "youtu.be" %}{% assign video_source = "YouTube" %}
                        {% elsif video_url contains "twitch.tv" %}{% assign video_source = "Twitch" %}
                        {% elsif video_url contains "bilibili.com" %}{% assign video_source = "Bilibili" %}
                        {% elsif video_url contains "vimeo.com" %}{% assign video_source = "Vimeo" %}{% endif %}
                        <a class="video-link" href="{{ video_url }}" target="_blank" rel="noopener">{{ video_source }}</a>
                      {% else %}‚Äî{% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty-state" style="padding: 2rem; text-align: center;">
            <p class="muted">No runs recorded yet for this category.</p>
          </div>
        {% endif %}
      </section>
    {% endif %}

    </div><!-- /.card -->
  </div>
</div>

<!-- Runs filter JavaScript (external file) -->
{% if page_type == "category" %}
<script src="{{ '/assets/js/runs-filter.js' | relative_url }}"></script>
{% endif %}
