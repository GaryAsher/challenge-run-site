---
layout: default
---

<!-- =========================================================
     Back link to Game page
     ========================================================= -->
<div class="page-width">
  <p class="muted page-back">
    <a href="{{ page.game_url | relative_url }}">← {{ page.game_name }}</a>
  </p>
</div>

<!-- =========================================================
     Page header
     ========================================================= -->
<div class="page-width">
  <h1>{{ page.game_name }} Runs</h1>
  <p class="muted">All recorded runs for this game.</p>
</div>

<!-- =========================================================
     Runs + Filters
     ========================================================= -->
<div class="page-width">

  {% assign runs = site.data.runs | where: "game_id", page.game_id %}

  {% if runs and runs.size > 0 %}

    <!-- =========================================================
         Filter controls
         ========================================================= -->
    {% assign challenge_ids = runs | map: "challenge_id" | compact | uniq | sort %}

    {%- comment -%}
    NOTE:
    This assumes each run has either:
      - restrictions: [ "Hestia Only", "No Hexes" ]   (array)   OR
      - restrictions: "Hestia Only, No Hexes"        (string)
    If your field name differs, update the assigns below and the <tr data-*> later.
    {%- endcomment -%}

    {% assign restrictions_raw = runs | map: "restrictions" | compact | uniq | sort %}

    <div class="card" style="margin: 0 0 1rem 0;">
      <div style="display: grid; gap: 0.75rem; grid-template-columns: 1fr;">

        <!-- Search -->
        <div>
          <label class="muted" for="q">Search</label>
          <input
            id="q"
            class="filter"
            type="text"
            placeholder="Search runner, category, challenge, restrictions..."
            autocomplete="off"
            inputmode="search"
            enterkeyhint="search"
          >
        </div>

        <!-- Dropdown row -->
        <div style="display: grid; gap: 0.75rem; grid-template-columns: repeat(3, minmax(0, 1fr));">

          <!-- Challenge -->
          <div>
            <label class="muted" for="challenge">Challenge</label>
            <select id="challenge" class="select" style="width: 100%;">
              <option value="">All</option>
              {% for cid in challenge_ids %}
                {% assign meta = site.data.challenges[cid] %}
                {% assign label = meta.label | default: cid %}
                <option value="{{ cid }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Restrictions -->
          <div>
            <label class="muted" for="restriction">Restrictions</label>
            <select id="restriction" class="select" style="width: 100%;">
              <option value="">All</option>
              {% for rr in restrictions_raw %}
                {%- comment -%}
                If rr is an array, Liquid will render it like: ["A", "B"].
                That is not ideal for a dropdown label, but it will still work
                because we match against the row's data-restrictions string.
                The recommended way is storing restrictions as an array AND also
                a pre-joined string field, but we are keeping your current setup.
                {%- endcomment -%}
                <option value="{{ rr | escape }}">{{ rr }}</option>
              {% endfor %}
            </select>
            <p class="muted" style="margin: 0.35rem 0 0 0; font-size: 0.95rem;">
              Tip: this filter matches the restriction text stored on the run row.
            </p>
          </div>

          <!-- Limit -->
          <div>
            <label class="muted" for="limit">Show</label>
            <select id="limit" class="select" style="width: 100%;">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="250">250</option>
              <option value="0">All</option>
            </select>
          </div>

        </div>

        <p class="muted" id="status" style="margin: 0;"></p>
      </div>
    </div>

    <!-- =========================================================
         Runs table (date sort)
         ========================================================= -->
    <div class="table-wrap">
      <table class="runs-table" id="runs-table">
        <thead>
          <tr>
            <th>Runner</th>
            <th>Category</th>
            <th>Challenge</th>
            <th>Restrictions</th>
            <th>Time</th>
            <th class="th-date">
              <span>Date</span>
              <span class="th-date-sort" aria-label="Sort Date">
                <button class="th-sort" id="date-asc" type="button" title="Sort oldest to newest">↑</button>
                <button class="th-sort" id="date-desc" type="button" title="Sort newest to oldest">↓</button>
              </span>
            </th>
            <th>Video</th>
          </tr>
        </thead>

        <tbody id="runs-body">
          {% for r in runs %}
            {% assign meta = site.data.challenges[r.challenge_id] %}
            {% assign challenge_label = meta.label | default: r.challenge_id %}

            {%- comment -%}
            Prefer human text:
            - If restrictions is an array: show tags and also build a joined text for data-restrictions
            - If restrictions is a string: use it directly
            Also supports legacy: restriction / restriction_ids if present
            {%- endcomment -%}

            {% assign rtexts = r.restrictions | default: empty %}
            {% assign rtext_joined = "" %}

            {% if rtexts and rtexts.size > 0 %}
              {% assign rtext_joined = rtexts | join: " | " %}
            {% else %}
              {% assign rtext_joined = r.restrictions | default: r.restriction | default: "" %}
            {% endif %}

            <tr
              class="run-row"
              data-runner="{{ r.runner | default: '' | downcase | escape }}"
              data-category="{{ r.category | default: '' | downcase | escape }}"
              data-challenge-id="{{ r.challenge_id | default: '' | escape }}"
              data-challenge-label="{{ challenge_label | downcase | escape }}"
              data-restrictions="{{ rtext_joined | downcase | escape }}"
              data-date="{{ r.date_completed | default: '' | escape }}"
              data-time="{{ r.time | default: '' | escape }}"
            >
              <td>
                {% if r.runner_id %}
                  <a href="{{ '/runners/' | relative_url }}{{ r.runner_id | slugify }}/">
                    {{ r.runner | default: r.runner_id }}
                  </a>
                {% else %}
                  {{ r.runner | default: "—" }}
                {% endif %}
              </td>

              <td>{{ r.category | default: "—" }}</td>

              <td>{{ challenge_label }}</td>

              <td>
                {% if rtexts and rtexts.size > 0 %}
                  {% for t in rtexts %}
                    <span class="tag">{{ t }}</span>
                  {% endfor %}
                {% else %}
                  {% if rtext_joined and rtext_joined != "" %}
                    <span class="tag">{{ rtext_joined }}</span>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                {% endif %}
              </td>

              <td>
                {% if r.time %}
                  {{ r.time }}
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>

              <td>{{ r.date_completed | default: "—" }}</td>

              <td>
                {% if r.video %}
                  <a href="{{ r.video }}" target="_blank" rel="noopener">Link</a>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- =========================================================
         Filtering + Date sort script
         ========================================================= -->
    <script>
(function () {
  const q = document.getElementById("q");
  const challenge = document.getElementById("challenge");
  const restriction = document.getElementById("restriction");
  const limit = document.getElementById("limit");
  const status = document.getElementById("status");

  const ascBtn = document.getElementById("date-asc");
  const descBtn = document.getElementById("date-desc");

  const tbody = document.getElementById("runs-body");
  const rows = Array.from(document.querySelectorAll(".run-row"));

  rows.forEach((r, i) => (r.dataset._i = String(i)));

  function norm(v) {
    return (v || "").toString().trim().toLowerCase();
  }

  function parseDateToNumber(s) {
    const v = (s || "").trim();
    if (!v) return NaN;

    const m = /^(\d{4})-(\d{2})-(\d{2})/.exec(v);
    if (m) {
      const y = parseInt(m[1], 10);
      const mo = parseInt(m[2], 10);
      const d = parseInt(m[3], 10);
      if (Number.isFinite(y) && Number.isFinite(mo) && Number.isFinite(d)) {
        return Date.UTC(y, mo - 1, d);
      }
    }

    const t = Date.parse(v);
    return Number.isFinite(t) ? t : NaN;
  }

  let dateSortDir = "desc";

  function updateDateButtons() {
    if (ascBtn) ascBtn.disabled = dateSortDir === "asc";
    if (descBtn) descBtn.disabled = dateSortDir === "desc";
  }

  function sortRowsByDate(list) {
    const dir = dateSortDir;

    return list.sort((a, b) => {
      const aDate = parseDateToNumber(a.dataset.date);
      const bDate = parseDateToNumber(b.dataset.date);

      const aBad = !Number.isFinite(aDate);
      const bBad = !Number.isFinite(bDate);

      if (aBad && bBad) {
        return (parseInt(a.dataset._i, 10) || 0) - (parseInt(b.dataset._i, 10) || 0);
      }
      if (aBad) return 1;
      if (bBad) return -1;

      if (aDate === bDate) {
        return (parseInt(a.dataset._i, 10) || 0) - (parseInt(b.dataset._i, 10) || 0);
      }

      return dir === "asc" ? aDate - bDate : bDate - aDate;
    });
  }

  function applyFilters() {
    const needle = norm(q && q.value);
    const ch = (challenge && challenge.value ? challenge.value.toString() : "");
    const rr = norm(restriction && restriction.value);
    const lim = parseInt(limit && limit.value ? limit.value : "10", 10);

    let matched = [];

    for (const row of rows) {
      const runner = row.dataset.runner || "";
      const cat = row.dataset.category || "";
      const chId = row.dataset.challengeId || "";
      const chLabel = row.dataset.challengeLabel || "";
      const restr = row.dataset.restrictions || "";

      const passesChallenge = !ch || chId === ch;
      const passesRestrictions = !rr || restr.includes(rr);

      const hay = (runner + " " + cat + " " + chLabel + " " + restr).trim();
      const passesSearch = !needle || hay.includes(needle);

      const show = passesChallenge && passesRestrictions && passesSearch;

      row.style.display = show ? "" : "none";
      if (show) matched.push(row);
    }

    matched = sortRowsByDate(matched);

    if (tbody) matched.forEach(r => tbody.appendChild(r));

    if (!isNaN(lim) && lim > 0) {
      matched.forEach((row, idx) => {
        row.style.display = idx < lim ? "" : "none";
      });
      if (status) status.textContent = "Showing " + Math.min(lim, matched.length) + " of " + matched.length + " matching runs.";
    } else {
      if (status) status.textContent = "Showing " + matched.length + " matching runs.";
    }
  }

  [q, challenge, restriction, limit].forEach(el => {
    if (!el) return;
    el.addEventListener("input", applyFilters);
    el.addEventListener("change", applyFilters);
  });

  if (ascBtn) {
    ascBtn.addEventListener("click", () => {
      dateSortDir = "asc";
      updateDateButtons();
      applyFilters();
    });
  }

  if (descBtn) {
    descBtn.addEventListener("click", () => {
      dateSortDir = "desc";
      updateDateButtons();
      applyFilters();
    });
  }

  updateDateButtons();
  applyFilters();
})();
    </script>

  {% else %}
    <div class="card">
      <p class="muted">No runs recorded yet.</p>
    </div>
  {% endif %}

</div>
