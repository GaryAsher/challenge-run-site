---
layout: default
---

{% include game-header-tabs.html game=page active="overview" %}

<!-- =========================================================
     Overview Tab - Restructured

     ORDERING (new spec):
     1. Modded/Base Game Links (if applicable)
     2. Game Description (content) - or placeholder if empty
     3. General Rules (accordion dropdown)
     4. Community Achievements
     5. Credits
     ========================================================= -->
<div class="page-width">
  <div class="game-shell">

    <section class="tab-panel active" data-panel="overview">

      <!-- =========================================================
           1. Modded/Base Game Links
           ========================================================= -->
      {% if page.is_modded and page.base_game %}
        {% assign base = site.games | where: "game_id", page.base_game | first %}
        {% if base %}
          <div class="game-link-banner game-link-banner--base">
            <span class="game-link-banner__icon">üéÆ</span>
            <span class="game-link-banner__text">This is a <strong>modded version</strong>. Looking for the vanilla game?</span>
            <a href="{{ base.url | relative_url }}" class="btn btn--small">View {{ base.game_name }}</a>
          </div>
        {% endif %}
      {% endif %}
      
      {% comment %} Check if this game has modded versions {% endcomment %}
      {% assign modded_versions = "" | split: "" %}
      {% for g in site.games %}
        {% if g.base_game == page.game_id and g.is_modded %}
          {% assign modded_versions = modded_versions | push: g %}
        {% endif %}
      {% endfor %}
      
      {% if modded_versions.size > 0 %}
        <div class="game-link-banner game-link-banner--modded">
          <span class="game-link-banner__icon">üîß</span>
          <span class="game-link-banner__text"><strong>Modded versions available!</strong> Run with custom content.</span>
          <div class="game-link-banner__links">
            {% for mod in modded_versions %}
              <a href="{{ mod.url | relative_url }}" class="btn btn--small btn--outline">{{ mod.game_name }}</a>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- =========================================================
           2. Game Description
           ========================================================= -->
      {% assign stripped_content = content | strip %}
      {% assign is_placeholder = false %}
      {% if stripped_content == "" or stripped_content contains "Game submitted via form" or stripped_content contains "Awaiting review" %}
        {% assign is_placeholder = true %}
      {% endif %}

      {% if is_placeholder %}
        <div class="card">
          <p class="muted"><em>üìù Game description needed. Want to help? <a href="{{ page.url | relative_url }}resources/">Visit the Resources tab</a> to learn how to contribute.</em></p>
        </div>
      {% elsif stripped_content != "" %}
        <div class="card">
          {{ content }}
        </div>
      {% endif %}

      <!-- =========================================================
           3. General Rules (Accordion)
           ========================================================= -->
      <div class="card card--compact mt-4" data-section-order="1">
        <details class="rules-accordion" open>
          <summary class="rules-accordion__header">
            <h2 class="rules-accordion__title">üìã General Rules</h2>
            <span class="accordion-icon">‚ñº</span>
          </summary>
          <div class="rules-accordion__content">
            {% if page.general_rules and page.general_rules.size > 0 %}
              <p class="muted mb-3">Core rules that apply to all {{ page.game_name }} runs:</p>
              <div class="md">
                {{ page.general_rules | markdownify }}
              </div>
            {% elsif site.data.default-rules.general_rules %}
              {% comment %} Fall back to global default-rules {% endcomment %}
              <p class="muted mb-3">Core rules that apply to all runs:</p>
              <div class="md">
                {{ site.data.default-rules.general_rules | markdownify }}
              </div>
            {% else %}
              <p class="muted mb-3">Core rules that apply to all runs:</p>
              <ul>
                <li><strong>Timing Method:</strong> {{ page.timing_method | default: "RTA (Real Time Attack)" }}</li>
                <li><strong>Video Required:</strong> All submissions must include video proof</li>
                <li><strong>No Cheats/Mods:</strong> External tools or gameplay-altering mods are not allowed</li>
              </ul>
            {% endif %}
            
            <p class="muted mt-3" style="font-size: 0.85rem;">
              <em>For detailed category rules, challenges, restrictions, and glitch policies, see the <a href="{{ page.url | relative_url }}rules/">Rules tab</a>.</em>
            </p>
          </div>
        </details>
      </div>

      <!-- =========================================================
           4. Community Achievements
           ========================================================= -->
      {% if page.community_achievements and page.community_achievements.size > 0 %}
        <div class="card card--compact mt-4" data-section-order="2">
          <h2 class="mb-2">üèÜ Community Achievements</h2>
          <p class="muted mb-3">Community-defined challenges tracked for this game.</p>
          
          {% comment %} Get all achievement completions for this game {% endcomment %}
          {% assign game_completions = "" | split: "" %}
          {% for ac in site.achievements %}
            {% if ac.game_id == page.game_id %}
              {% assign game_completions = game_completions | push: ac %}
            {% endif %}
          {% endfor %}
          
          <div class="community-achievements-game">
            {% for ach in page.community_achievements %}
              {% comment %} Count completions for this specific achievement {% endcomment %}
              {% assign ach_completions = "" | split: "" %}
              {% assign ach_in_progress = "" | split: "" %}
              {% for comp in game_completions %}
                {% if comp.achievement_slug == ach.slug %}
                  {% if comp.date_completed and comp.date_completed != "" %}
                    {% assign ach_completions = ach_completions | push: comp %}
                  {% else %}
                    {% assign ach_in_progress = ach_in_progress | push: comp %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {% assign completed_count = ach_completions.size %}
              {% assign in_progress_count = ach_in_progress.size %}
              {% assign total_tracking = completed_count | plus: in_progress_count %}
              
              <details class="achievement-game-item">
                <summary class="achievement-game-header">
                  <div class="achievement-game-header__left">
                    <span class="achievement-game-icon">{{ ach.icon | default: 'üèÜ' }}</span>
                    <div class="achievement-game-info">
                      <h3 class="achievement-game-title">{{ ach.title }}</h3>
                      <p class="achievement-game-desc">{{ ach.description }}</p>
                    </div>
                  </div>
                  <div class="achievement-game-header__right">
                    {% if ach.difficulty %}
                      <span class="difficulty difficulty--{{ ach.difficulty }}">{{ ach.difficulty | capitalize }}</span>
                    {% endif %}
                    <span class="achievement-game-stat">
                      <span class="achievement-game-stat__completed">{{ completed_count }} completed</span>
                      {% if in_progress_count > 0 %}
                        <span class="achievement-game-stat__progress">{{ in_progress_count }} in progress</span>
                      {% endif %}
                    </span>
                    <span class="accordion-icon">‚ñº</span>
                  </div>
                </summary>
                <div class="achievement-game-content">
                  {% if ach.requirements and ach.requirements.size > 0 %}
                    <div class="achievement-game-requirements">
                      <h4>Requirements</h4>
                      <ul>
                        {% for req in ach.requirements %}
                          <li>{{ req }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                  
                  {% if total_tracking > 0 %}
                    <div class="achievement-game-runners">
                      <h4>Runner Progress</h4>
                      <div class="achievement-runners-list">
                        {% comment %} Show completed runners first, sorted by date {% endcomment %}
                        {% assign sorted_completions = ach_completions | sort: "date_completed" %}
                        {% for comp in sorted_completions %}
                          {% assign runner = site.runners | where: "runner_id", comp.runner_id | first %}
                          {% assign runner_name = runner.runner_name | default: comp.runner_id %}
                          {% assign runner_avatar = runner.avatar | default: "/assets/img/site/default-runner.png" %}
                          <div class="achievement-runner-row achievement-runner-row--completed">
                            <a href="{{ runner.url | relative_url }}" class="achievement-runner-info">
                              <div class="achievement-runner-avatar" style="background-image: url('{{ runner_avatar | relative_url }}')"></div>
                              <span class="achievement-runner-name">{{ runner_name }}</span>
                            </a>
                            <div class="achievement-runner-progress">
                              <div class="progress-bar progress-bar--full">
                                <div class="progress-bar__fill" style="width: 100%"></div>
                              </div>
                              <span class="progress-bar__text">{{ ach.total_required | default: "?" }} / {{ ach.total_required | default: "?" }}</span>
                            </div>
                            <div class="achievement-runner-status">
                              <span class="achievement-status-badge achievement-status-badge--completed">‚úì Completed</span>
                              <span class="achievement-runner-date">{{ comp.date_completed }}</span>
                            </div>
                            {% if comp.proof_url and comp.proof_url != "" %}
                              <a href="{{ comp.proof_url }}" target="_blank" rel="noopener" class="btn btn--small">‚ñ∂ Proof</a>
                            {% endif %}
                          </div>
                        {% endfor %}
                        
                        {% comment %} Show in-progress runners {% endcomment %}
                        {% assign sorted_progress = ach_in_progress | sort: "current_progress" | reverse %}
                        {% for comp in sorted_progress %}
                          {% assign runner = site.runners | where: "runner_id", comp.runner_id | first %}
                          {% assign runner_name = runner.runner_name | default: comp.runner_id %}
                          {% assign runner_avatar = runner.avatar | default: "/assets/img/site/default-runner.png" %}
                          {% assign current = comp.current_progress | default: 0 %}
                          {% assign total = ach.total_required | default: 1 %}
                          {% assign percent = current | times: 100 | divided_by: total %}
                          <div class="achievement-runner-row achievement-runner-row--progress">
                            <a href="{{ runner.url | relative_url }}" class="achievement-runner-info">
                              <div class="achievement-runner-avatar" style="background-image: url('{{ runner_avatar | relative_url }}')"></div>
                              <span class="achievement-runner-name">{{ runner_name }}</span>
                            </a>
                            <div class="achievement-runner-progress">
                              <div class="progress-bar">
                                <div class="progress-bar__fill" style="width: {{ percent }}%"></div>
                              </div>
                              <span class="progress-bar__text">{{ current }} / {{ total }}</span>
                            </div>
                            <div class="achievement-runner-status">
                              <span class="achievement-status-badge achievement-status-badge--progress">In Progress</span>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% else %}
                    <div class="achievement-game-empty">
                      <p class="muted">No runners tracking this achievement yet. Be the first!</p>
                    </div>
                  {% endif %}
                </div>
              </details>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- =========================================================
           5. Credits
           ========================================================= -->
      <div class="card card--compact mt-4" data-section-order="3">
        <h2 class="mb-2">Credits</h2>
        {% if page.credits and page.credits.size > 0 %}
          <p class="muted mb-3">Contributors who helped establish this game's challenge run definitions:</p>
          <ul class="credits-list">
            {% for credit in page.credits %}
              <li>
                {% if credit.url %}
                  <a href="{{ credit.url }}" target="_blank" rel="noopener">{{ credit.name }}</a>
                {% else %}
                  {{ credit.name }}
                {% endif %}
                {% if credit.role %}<span class="muted"> ‚Äî {{ credit.role }}</span>{% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted">No credits listed yet.</p>
        {% endif %}
      </div>

      <!-- =========================================================
           6. Suggest an Update
           ========================================================= -->
      <div class="card card--compact mt-4" id="suggest-update-section">
        <h2 class="mb-2">üìù Suggest an Update</h2>
        <p class="muted mb-3">Notice something incorrect or missing on this page? Let us know and we'll get it fixed.</p>
        
        <!-- Not signed in state -->
        <div id="suggest-not-signed-in">
          <p class="muted"><a href="{{ '/sign-in/' | relative_url }}">Sign in</a> to suggest an update to this page.</p>
        </div>
        
        <!-- Signed in form -->
        <div id="suggest-form-wrap" hidden>
          <form id="suggest-update-form" class="suggest-update-form">
            <div class="suggest-update-form__field">
              <label class="form-label" for="suggest-section">What area needs updating?</label>
              <select id="suggest-section" class="form-input" required>
                <option value="">Select a section...</option>
                <option value="game-description">Game Description</option>
                <option value="full-runs">Full Runs / Categories</option>
                <option value="mini-challenges">Mini Challenges</option>
                <option value="rules">Rules or Definitions</option>
                <option value="achievements">Achievements</option>
                <option value="credits">Credits</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div class="suggest-update-form__field">
              <label class="form-label" for="suggest-type">What kind of change?</label>
              <select id="suggest-type" class="form-input" required>
                <option value="">Select type...</option>
                <option value="incorrect">Something is incorrect</option>
                <option value="missing">Something is missing</option>
                <option value="outdated">Information is outdated</option>
                <option value="typo">Typo or formatting issue</option>
                <option value="suggestion">General suggestion</option>
              </select>
            </div>
            
            <div class="suggest-update-form__field">
              <label class="form-label" for="suggest-details">Describe the issue *</label>
              <textarea id="suggest-details" class="form-input" rows="4" maxlength="1000" required placeholder="Be as specific as possible. For example: 'The Hitless category incorrectly states you cannot take environmental damage, but the community consensus is...'"></textarea>
              <p class="form-help"><span id="suggest-count">0</span>/1000</p>
            </div>
            
            <div id="suggest-message" class="suggest-message" hidden></div>
            
            <button type="submit" class="btn btn--primary" id="suggest-submit-btn">
              <span class="btn__text">Submit Suggestion</span>
              <span class="btn__loading" hidden>
                <span class="spinner spinner--small"></span>
                Submitting...
              </span>
            </button>
          </form>
          
          <!-- Success state -->
          <div id="suggest-success" hidden>
            <div class="suggest-success-msg">
              <span>‚úÖ</span>
              <div>
                <strong>Thanks for your suggestion!</strong>
                <p class="muted">A moderator will review it shortly.</p>
              </div>
            </div>
            <button type="button" class="btn btn--small mt-3" onclick="document.getElementById('suggest-success').hidden=true;document.getElementById('suggest-update-form').hidden=false;document.getElementById('suggest-update-form').reset();">
              Submit Another
            </button>
          </div>
        </div>
      </div>
      
      <style>
      .suggest-update-form { display: flex; flex-direction: column; gap: 1rem; }
      .suggest-update-form__field { display: flex; flex-direction: column; gap: 0.25rem; }
      .suggest-update-form .form-label { font-size: 0.85rem; font-weight: 600; }
      .suggest-update-form .form-input { font-size: 0.9rem; padding: 0.5rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--fg); font-family: inherit; }
      .suggest-update-form .form-input:focus { outline: none; border-color: var(--accent); }
      .suggest-update-form textarea { resize: vertical; min-height: 80px; }
      .suggest-message { padding: 0.6rem 0.75rem; border-radius: 6px; font-size: 0.85rem; }
      .suggest-message--error { background: rgba(231, 76, 60, 0.15); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.3); }
      .suggest-message--success { background: rgba(46, 204, 113, 0.15); color: #2ecc71; border: 1px solid rgba(46, 204, 113, 0.3); }
      .suggest-success-msg { display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.25); border-radius: var(--radius-sm); }
      .suggest-success-msg span:first-child { font-size: 1.5rem; }
      .suggest-success-msg p { margin: 0.25rem 0 0 0; font-size: 0.85rem; }
      </style>
      
      <script type="module">
      import { CRCAuth } from '{{ "/assets/js/auth.js" | relative_url }}';
      
      const GAME_ID = {{ page.game_id | jsonify }};
      const GAME_NAME = {{ page.game_name | jsonify }};
      
      (async function() {
        await CRCAuth.init();
        
        if (!CRCAuth.isSignedIn()) return;
        
        // Show form, hide sign-in prompt
        document.getElementById('suggest-not-signed-in').hidden = true;
        document.getElementById('suggest-form-wrap').hidden = false;
        
        // Character count
        const details = document.getElementById('suggest-details');
        const count = document.getElementById('suggest-count');
        details.addEventListener('input', () => { count.textContent = details.value.length; });
        
        // Form submission
        document.getElementById('suggest-update-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const btn = document.getElementById('suggest-submit-btn');
          const btnText = btn.querySelector('.btn__text');
          const btnLoading = btn.querySelector('.btn__loading');
          const msgEl = document.getElementById('suggest-message');
          
          msgEl.hidden = true;
          btn.disabled = true;
          btnText.hidden = true;
          btnLoading.hidden = false;
          
          try {
            const supabase = CRCAuth.getSupabaseClient();
            const user = CRCAuth.getUser();
            const profile = CRCAuth.getProfile();
            
            if (!supabase || !user) throw new Error('Not signed in');
            
            const { error } = await supabase.from('game_update_requests').insert({
              game_id: GAME_ID,
              game_name: GAME_NAME,
              user_id: user.id,
              runner_id: profile?.runner_id || null,
              section: document.getElementById('suggest-section').value,
              update_type: document.getElementById('suggest-type').value,
              details: details.value.trim(),
              status: 'pending',
              page_url: window.location.pathname
            });
            
            if (error) throw error;
            
            document.getElementById('suggest-update-form').hidden = true;
            document.getElementById('suggest-success').hidden = false;
            
          } catch (err) {
            msgEl.textContent = err.message || 'Failed to submit. Please try again.';
            msgEl.className = 'suggest-message suggest-message--error';
            msgEl.hidden = false;
          } finally {
            btn.disabled = false;
            btnText.hidden = false;
            btnLoading.hidden = true;
          }
        });
      })();
      </script>

    </section>

  </div>
</div>
